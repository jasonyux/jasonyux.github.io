<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>COMS4111 Intro to Databases | Lecture Notes</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="COMS4111 Intro to Databases" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An inexhaustive collection of markdown/latex(PDF) notes that I took since college." />
<meta property="og:description" content="An inexhaustive collection of markdown/latex(PDF) notes that I took since college." />
<link rel="canonical" href="/lectures/2020@columbia/COMS4111_Intro_to_Databases.html/" />
<meta property="og:url" content="/lectures/2020@columbia/COMS4111_Intro_to_Databases.html/" />
<meta property="og:site_name" content="Lecture Notes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-22T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="COMS4111 Intro to Databases" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-04-22T00:00:00-04:00","datePublished":"2021-04-22T00:00:00-04:00","description":"An inexhaustive collection of markdown/latex(PDF) notes that I took since college.","headline":"COMS4111 Intro to Databases","mainEntityOfPage":{"@type":"WebPage","@id":"/lectures/2020@columbia/COMS4111_Intro_to_Databases.html/"},"url":"/lectures/2020@columbia/COMS4111_Intro_to_Databases.html/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/lectures/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/lectures/feed.xml" title="Lecture Notes" /></head>
<body><header class="site-header">

	<div class="wrapper"><a class="site-title" rel="author" href="/lectures/">Lecture Notes</a>

		<nav class="site-nav">
			<input type="checkbox" id="nav-trigger" class="nav-trigger" />
			<label for="nav-trigger">
			<span class="menu-icon">
				<svg viewBox="0 0 18 15" width="18px" height="15px">
				<path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
				</svg>
			</span>
			</label>

			<div class="trigger">
				<a class="page-link" href="/">Home</a>
				<a class="page-link" href="/projects">Projects</a>
				<a class="page-link" href="/learning">Blog</a>
				<a class="page-link" href="/research">Research</a>
				<span class="page-link" href="#">[Education]</span>
			</div>
		</nav>
	</div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <head>
	<script>
		MathJax = {
		  tex: {
			inlineMath: [['$', '$'], ['\\(', '\\)']],
			displayMath: [['$$', '$$'], ['\\[', '\\]']]
		  }
		};
	</script>
	<script id="MathJax-script" async
		src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
	</script>
  </head>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">COMS4111 Intro to Databases</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-04-22T00:00:00-04:00" itemprop="datePublished">
        Apr 22, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <style type="text/css">@page { margin-left: 12em; } img {width: 50%;}</style>

<h1 id="week-1---logistics-and-intro">Week 1 - Logistics and Intro</h1>

<ul>
  <li><strong>Course Website</strong> http://www.cs.columbia.edu/~biliris/4111/21s/index.html</li>
  <li><strong>Exams</strong> are open book</li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>Some terms to know:</p>

<blockquote>
  <p><strong>Definitions:</strong></p>

  <ul>
    <li><strong>Database</strong>
      <ul>
        <li>a very large, integrated (relational) collection of <em>shared</em> data</li>
      </ul>
    </li>
    <li><strong>DBMS</strong> - database management system
      <ul>
        <li>software that can manage database systems, with the <em>advantage</em> of reducing application development time, concurrent accesses, recovery from crashes, etc.</li>
      </ul>
    </li>
    <li><strong>Data Models</strong>
      <ul>
        <li>a collection of concepts/structure for describing the data
          <ul>
            <li><em>for example,</em> is it a graph (social network data)? A tree? A table?</li>
          </ul>
        </li>
      </ul>
    </li>
    <li><strong>Schema</strong>
      <ul>
        <li>a description of a <em>particular collection of data</em>, using the data model</li>
        <li>It defines <em>how the data is organized</em> and <em>how the relations among them are associated</em>. It formulates all the constraints that are to be applied on the data.</li>
      </ul>
    </li>
    <li><strong>Relational Data Model</strong>
      <ul>
        <li>basically a set of inter-related tables containing your data</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>The <strong>levels of abstraction</strong> used in this course:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_12-46-20.png" style="zoom: 67%;" /></p>

<p>where:</p>

<ul>
  <li><strong>Physical Database Schema</strong> − This schema pertains to the actual storage of data and its <em>form of storage</em> like files, indices, etc. It defines how the data will be stored in a secondary storage.</li>
  <li><strong>Conceptual/Logical Database Schema</strong> − This schema defines all the <em>logical constraints</em> that need to be applied on the data stored. It <em>defines tables, views, and integrity constraints</em>.</li>
</ul>

<p><strong><em>For example:</em></strong></p>

<p>Consider a simple university database:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_12-51-25.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>the <strong>Enrolled</strong> table connects the <strong>Students</strong> and <strong>Courses</strong> table</li>
  <li>so the <em>conceptual</em> schema tells you the <em>organization</em> of the table</li>
</ul>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_12-52-47.png" style="zoom:50%;" /></p>

<p>and:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_12-53-10.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>this would be a <strong>computed table</strong> based on the actual tables we have (<em>defined in the conceptual schema</em>)</li>
</ul>

<blockquote>
  <p><strong>Definition: Data Independence</strong></p>

  <ul>
    <li>From the above, it can be implied that we need our application to be insulated from how the data is structured, so that the <em>structure/organization should be intact</em>
      <ul>
        <li><strong>logical data independence</strong> - protection from changes in <em>logical</em> structure of data</li>
        <li><strong>physical data independence</strong> - protection from changes in <em>physical</em> structure of data</li>
      </ul>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Definition: Transactions in Database</strong></p>

  <ul>
    <li>Transactions (a query/insert/… in database) is either <strong>committed or aborted</strong> (all-or-none)</li>
    <li>This means it is important for having a <strong>concurrency control</strong>
      <ul>
        <li>Lock based protocol</li>
        <li>Time-stamp protocol</li>
        <li>Validation based protocol</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>This means that we will have the following structure for a <strong>DBMS</strong>:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_13-03-42.png" style="zoom:50%;" /></p>

<h2 id="overview-of-database-design">Overview of Database Design</h2>

<p><strong>Conceptual Design</strong> (using <strong>ER Model</strong>)</p>

<ul>
  <li>What are the entities and relationships in the enterprise?</li>
  <li>What are the integrity constraints or business rules that hold?</li>
  <li>Can map an ER diagram into a relational schema?</li>
</ul>

<p><strong>Physical Database Design and Tuning</strong></p>

<ul>
  <li>Considering <em>typical workloads</em> and further <em>refine the database design</em></li>
</ul>

<h2 id="er-diagram-basics">ER Diagram Basics</h2>

<p>What is an ER Model? Why do we need it?</p>

<ul>
  <li>in short, it provides an abstract way of <em>understanding the model</em> without touching the data</li>
</ul>

<blockquote>
  <p><strong>Definition</strong></p>

  <ul>
    <li><strong>Entity</strong>
      <ul>
        <li>real-world <em>object</em>, described using a set of <em>attributes</em></li>
      </ul>
    </li>
    <li><strong>Entity Set</strong>
      <ul>
        <li>a <em>collection</em> of entities that have the same <em>attribute fields</em></li>
        <li>each entity set has a <em>key</em> (could be a composite key as well)</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong><em>For example:</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_13-46-40.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li><strong>employee</strong> would be an <em>entity</em></li>
  <li>
    <p><strong>employees</strong> would be a <em>table</em> containing the entity <strong>employee</strong></p>
  </li>
  <li>the <em>primary key</em> would be the <strong>ssn</strong></li>
</ul>

<blockquote>
  <p><strong>Definition</strong></p>

  <ul>
    <li><strong>Relationship</strong>
      <ul>
        <li>Association among two or more entities.</li>
      </ul>
    </li>
    <li><strong>Relationship Set</strong>
      <ul>
        <li>A collection of similar relationships</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong><em>For example:</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_13-51-00.png" alt="" /></p>

<p>where:</p>

<ul>
  <li><strong>Entity</strong> would be in square</li>
  <li><strong>Relationship</strong> would be in a diamond</li>
  <li><strong>Attributes</strong> would be in circle</li>
</ul>

<h3 id="key-and-participation-constraints">Key and Participation Constraints</h3>

<p><strong>Before</strong> going to the details, first we talk about some notations:</p>

<p>The following relations are possible between one entity <strong>E</strong> another entity <strong>E’</strong>:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-13-18.png" alt="" /></p>

<p>and in a more abstracted way:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-15-08.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>an <strong>arrow with head</strong> means <em>upper-bounded with the 1-1 relationship</em></li>
  <li>a <strong>bold line</strong> means a <em>strong requirement that each entity <strong>must have</strong> a relation</em></li>
</ul>

<p><strong><em>For Example:</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-21-06.png" style="zoom:50%;" /></p>

<hr />

<p>Now, we can go to key and participation constraints:</p>

<blockquote>
  <p><strong>Key Constraint</strong></p>

  <p>the above diagram actually is a key constraint:</p>

  <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-21-06.png" style="zoom:50%;" /></p>

  <p>where:</p>

  <ul>
    <li>since each department can participate at most one time in the relationship, <strong>each department</strong> <strong><em>has</em> <em>most one</em> manager (or zero manager)</strong> = <strong>key constraint</strong></li>
    <li>each employee can <strong>manage zero or more departments</strong></li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Participation Constraint:</strong></p>

  <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-36-36.png" style="zoom: 50%;" /></p>

  <p>where we see it means:</p>

  <ul>
    <li><strong>Each department</strong> <strong><em>must</em></strong> have <strong>a manager</strong>, because it participates exactly one = <strong>participation constraint</strong></li>
    <li>The participation constraint of <strong>Departments</strong> in <strong>Manages</strong> is said to be <strong>total</strong> (vs. partial).</li>
  </ul>
</blockquote>

<p><strong><em>For example:</em></strong></p>

<p>Consider a more complicated case:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-38-40.png" style="zoom:50%;" /></p>

<p>where, for the <strong>works_in</strong> relationship:</p>

<ul>
  <li>each <strong>Department</strong> <strong><em>participates</em></strong> at least once, meaning <strong>each department <em>has</em> at least one employee</strong></li>
  <li>each <strong>Employee</strong> works in at least one <strong>Department</strong></li>
</ul>

<hr />

<p>Some summaries:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_14-57-49.png" style="zoom:50%;" /></p>

<h3 id="weak-entities">Weak Entities</h3>

<blockquote>
  <p><strong>Definition</strong></p>

  <ul>
    <li>A <strong>weak entity</strong> can be <strong>identified uniquely</strong> only by <strong>considering the <em>primary key of another (owner) entity</em></strong>.
      <ul>
        <li>so that the <strong>weak entity does not “exist” automatically if the owner is deleted</strong></li>
        <li>Owner entity set and weak entity set must participate in a one-to-one or one-to–many relationship set (one owner, one or many weak entities; each weak entity has a single owner).</li>
        <li>Weak entity set must have total participation in this identifying relationship set.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong><em>For example:</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_15-12-33.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>the entity <strong>Dependent</strong> (<em>weak entity</em>) depends completely on the existence of an <strong>Employee</strong></li>
  <li>once a <strong>Policy/Employee</strong> is deleted, the <strong>Dependents</strong> of that policy/employee will automatically be disregarded</li>
</ul>

<h3 id="is-a-hierarchy">“Is A” Hierarchy</h3>

<p>This is basically the same concept in OOP programming, in the context that:</p>

<ul>
  <li>children <strong>inherits the attributes</strong> of the parent</li>
</ul>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-15_15-17-10.png" style="zoom:67%;" /></p>

<p>However, if using this design, you need to consider the following:</p>

<blockquote>
  <p><strong>Overlap constraints</strong>:</p>

  <ul>
    <li>Can Joe be an <code class="language-plaintext highlighter-rouge">Hourly_Emps</code> <strong>as well as</strong> a <code class="language-plaintext highlighter-rouge">Contract_Emps</code> entity? (Allowed/disallowed)</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Covering constraints</strong>:</p>

  <ul>
    <li>Does every <code class="language-plaintext highlighter-rouge">Employees</code> entity also <strong>have to be</strong> an <code class="language-plaintext highlighter-rouge">Hourly_Emps</code> or a <code class="language-plaintext highlighter-rouge">Contract_Emps</code> entity?(Yes/no)</li>
  </ul>
</blockquote>

<p><strong>Reasons for using ISA:</strong></p>

<ul>
  <li>To add <em>descriptive attributes</em> specific to a <em>subclass</em> easily.
    <ul>
      <li>e.g. easily look up an <code class="language-plaintext highlighter-rouge">Hourly_Emp</code> information (name) in the <code class="language-plaintext highlighter-rouge">Employee</code> table</li>
    </ul>
  </li>
  <li>To identify entities that participate in a <em>relationship</em>.</li>
</ul>

<h1 id="week-2">Week 2</h1>

<h2 id="er-diagram-continued">ER Diagram Continued</h2>

<h3 id="aggregation">Aggregation</h3>

<blockquote>
  <p><strong>General Constraint:</strong></p>

  <ul>
    <li>Usually, <strong>you should not relate relationships</strong>, you should only relate entities.</li>
  </ul>
</blockquote>

<p>But what if you kind of need to?</p>

<p><strong><em>For Example:</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_12-16-37.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>we want <em>the <code class="language-plaintext highlighter-rouge">Employee</code></em> to monitor not only the project, but also how the <strong>budget flow</strong> in this sponsorship. This means the <code class="language-plaintext highlighter-rouge">Employee</code> <strong>monitors</strong> <code class="language-plaintext highlighter-rouge">pbudget</code>+<code class="language-plaintext highlighter-rouge">since</code>+<code class="language-plaintext highlighter-rouge">budget</code>
    <ul>
      <li><strong>Practically, you could just have an aggregate entity consists of <code class="language-plaintext highlighter-rouge">pid</code>, <code class="language-plaintext highlighter-rouge">did</code>, <code class="language-plaintext highlighter-rouge">since</code></strong></li>
    </ul>
  </li>
  <li>so what we do is to <strong>view/aggregate the entire <code class="language-plaintext highlighter-rouge">Project</code>+<code class="language-plaintext highlighter-rouge">Sponsors</code>+<code class="language-plaintext highlighter-rouge">Department</code> as one entity</strong></li>
</ul>

<blockquote>
  <p><strong>Definition: Aggregation</strong></p>

  <ul>
    <li>Allows us to treat a relationship set as an entity set for purposes of participation in (other) relationships.</li>
  </ul>
</blockquote>

<h3 id="conceptual-design-using-er-model">Conceptual Design Using ER Model</h3>

<p>Design <strong>choices</strong>:</p>

<ul>
  <li>Should a concept be modeled as an entity or an attribute or a relationship?</li>
  <li>Identifying relationships: Binary or ternary? Aggregation?</li>
</ul>

<p><strong>Constraints</strong> in the ER Model:</p>

<ul>
  <li>A lot of data semantics can (and should) be captured.
    <ul>
      <li>But some constraints cannot be captured in ER diagrams.</li>
    </ul>
  </li>
</ul>

<h4 id="entity-vs-attribute">Entity vs. Attribute</h4>

<hr />

<p><strong><em>For Example:</em> Design Choice</strong></p>

<p>Should <code class="language-plaintext highlighter-rouge">address</code> be an <em>attribute</em> of <code class="language-plaintext highlighter-rouge">Employees</code> or an <em>entity</em> (connected to Employees by a relationship)?</p>

<p><strong>Ans</strong>: depends upon the <strong>use we want to make of address information</strong>, and the <strong>semantics</strong> of the data:</p>

<ul>
  <li>If we have <strong>several</strong> addresses per employee, <code class="language-plaintext highlighter-rouge">address</code> must be an <strong>entity</strong></li>
  <li>If the <strong>structure/components of it</strong> (city, street, etc.) is <strong>important</strong>, e.g., we want to retrieve employees in a given city, address must be modeled as an <strong>entity</strong> (since attribute values are atomic).</li>
  <li>If all you need it to <strong>lookup/retrieve its entirety</strong>, then an <strong>attribute</strong> would suffice</li>
</ul>

<hr />

<h4 id="entity-vs-relationship">Entity vs. Relationship</h4>

<p><strong><em>For Example</em></strong></p>

<p>Consider the case: A manager gets a <strong>separate discretionary budget for each dept</strong></p>

<ol>
  <li>First ER Diagram
    <ul>
      <li>works</li>
    </ul>
  </li>
</ol>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-08-28.png" style="zoom: 67%;" /></p>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>the <strong>relational attribute</strong> <code class="language-plaintext highlighter-rouge">dbudget</code> (discretionary budget) depends on both the <code class="language-plaintext highlighter-rouge">Employee</code> and the <code class="language-plaintext highlighter-rouge">Department</code>. Hence, it is <em>not</em> an attribute of <code class="language-plaintext highlighter-rouge">Department</code> (e.g. a department might not have a manager, then there will be no <code class="language-plaintext highlighter-rouge">budget</code>)</li>
  </ul>
</blockquote>

<p>Consider the case:  A manager gets a discretionary budget that <strong>covers all his/her managed depts</strong></p>

<ul>
  <li>then, the <strong>above diagram</strong> is <strong>bad</strong>, because:
    <ul>
      <li><strong>Redundancy</strong>: <code class="language-plaintext highlighter-rouge">dbudget</code> stored for each dept managed by manager.</li>
      <li><strong>Misleading</strong>: Suggests <code class="language-plaintext highlighter-rouge">dbudget</code> associated with department-mgr combination.</li>
    </ul>
  </li>
  <li><strong>In short,</strong> the <code class="language-plaintext highlighter-rouge">dbuget</code> depends on <em>only the <code class="language-plaintext highlighter-rouge">Employee</code> who manages at least one departments</em></li>
</ul>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-17-52.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>the constraint above is: each <code class="language-plaintext highlighter-rouge">Manager</code> manages <strong>at least one</strong> <code class="language-plaintext highlighter-rouge">Department</code>. Hence, we have a thick line.</li>
</ul>

<h4 id="binary-vs-ternary-relationship">Binary vs. Ternary Relationship</h4>

<blockquote>
  <p><strong>In most of the time</strong></p>

  <ul>
    <li>A relationship would be no more than ternary, unless it IS EXTREMELY complicated</li>
  </ul>
</blockquote>

<p><strong><em>For Example:</em> Binary Relationship</strong></p>

<p>Consider: If each <code class="language-plaintext highlighter-rouge">policy</code> is owned by just <strong>1 employee</strong>, and <strong>each dependent</strong> is tied to the covering policy</p>

<ol>
  <li>This diagram would be <strong>inaccurate</strong>
    <ul>
      <li>we cannot constraint both: <code class="language-plaintext highlighter-rouge">policy</code> can only be owned by <strong>one</strong> <code class="language-plaintext highlighter-rouge">employee</code> <strong><em>and</em></strong> <code class="language-plaintext highlighter-rouge">policy</code> can have <strong>multiple</strong> <code class="language-plaintext highlighter-rouge">dependents</code>, i.e. <strong>the constraint is different for the relationships</strong></li>
    </ul>
  </li>
</ol>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-30-06.png" style="zoom:50%;" /></p>

<ol>
  <li>This diagram would work:
    <ul>
      <li>now, since the constraint is different, we separated them into:
        <ul>
          <li>each <code class="language-plaintext highlighter-rouge">policy</code> is owned by <strong>one</strong> <code class="language-plaintext highlighter-rouge">purchaser</code></li>
          <li><code class="language-plaintext highlighter-rouge">policy</code> can have <strong>multiple</strong> <code class="language-plaintext highlighter-rouge">dependents</code></li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-30-13.png" style="zoom:50%;" /></p>

<hr />

<p><strong><em>For Example:</em> Ternary Relationship</strong></p>

<p>Consider: <code class="language-plaintext highlighter-rouge">Orders</code> relates entity sets <code class="language-plaintext highlighter-rouge">Suppliers</code>, <code class="language-plaintext highlighter-rouge">Departments</code> and <code class="language-plaintext highlighter-rouge">Parts</code></p>

<ul>
  <li>An order <code class="language-plaintext highlighter-rouge">&lt;S,D,P&gt;</code> indicates: a supplier <code class="language-plaintext highlighter-rouge">S</code> supplies to a department <code class="language-plaintext highlighter-rouge">D</code> <code class="language-plaintext highlighter-rouge">qtyof</code> a part <code class="language-plaintext highlighter-rouge">P</code> at a certain <code class="language-plaintext highlighter-rouge">cost</code> on a certain <code class="language-plaintext highlighter-rouge">date</code>.</li>
  <li><strong>All of them have no constraints</strong></li>
</ul>

<p>Then this would work:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-39-42.png" alt="" /></p>

<hr />

<blockquote>
  <p><strong>Summary:</strong></p>

  <ul>
    <li><strong>When the relationships involved <em>have the same constraint</em></strong>, then ternary relationship would work</li>
    <li><strong>Otherwise</strong>, you need to separate the relationships</li>
  </ul>
</blockquote>

<p><strong><em>For Example:</em> Additional Constraints</strong></p>

<p>Consider: <code class="language-plaintext highlighter-rouge">Orders</code> relates entity sets <code class="language-plaintext highlighter-rouge">Suppliers</code>, <code class="language-plaintext highlighter-rouge">Departments</code> and <code class="language-plaintext highlighter-rouge">Parts</code>, <strong>with these additional constraints</strong></p>

<ul>
  <li>A <code class="language-plaintext highlighter-rouge">department</code> maintains a <strong>list of approved suppliers</strong> who are the only ones that can supply parts to the department</li>
  <li>Each <code class="language-plaintext highlighter-rouge">supplier</code> maintains <strong>a list of parts that can supply</strong></li>
</ul>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-55-03.png" style="zoom: 50%;" /></p>

<p>where:</p>

<ul>
  <li><strong>again</strong>, since you should not relate <em>relationships</em>, you have the <strong>aggregates</strong></li>
  <li><strong>however, a diagram cannot represent:</strong> the <code class="language-plaintext highlighter-rouge">supplier</code> of the <code class="language-plaintext highlighter-rouge">department</code> and the <code class="language-plaintext highlighter-rouge">supplier</code> of the <code class="language-plaintext highlighter-rouge">parts</code> is the <strong><em>same</em></strong> in one order. <strong>Therefore, for that you can only write a note in your diagram</strong></li>
</ul>

<p>Or alternatively:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_13-57-58.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>an <code class="language-plaintext highlighter-rouge">INO</code> would be useful for retrieving</li>
  <li>each <code class="language-plaintext highlighter-rouge">Invoice</code> here can include <strong>more than one “orders”</strong>, so you can have <strong>multiple <code class="language-plaintext highlighter-rouge">SD+SP</code> associated with one <code class="language-plaintext highlighter-rouge">invoice</code></strong></li>
</ul>

<h3 id="summaries-on-er-model">Summaries on ER Model</h3>

<ul>
  <li>Conceptual design follows requirements analysis
    <ul>
      <li>Yields a high-level description of data to be stored</li>
    </ul>
  </li>
  <li>ER model popular for conceptual design
    <ul>
      <li>Constructs are expressive, close to the way people think about their applications</li>
    </ul>
  </li>
  <li>Basic <strong>constructs</strong>: entities, relationships, and attributes (of entities and relationships).</li>
  <li>Think about <strong>constraints</strong></li>
  <li>Some <strong>additional constructs</strong>: weak entities, ISA hierarchies, and aggregation.</li>
</ul>

<blockquote>
  <p><strong>Note</strong>:</p>

  <ul>
    <li>There are many possible variations on ER model.</li>
  </ul>
</blockquote>

<h2 id="relational-model-and-database">Relational Model and Database</h2>

<p>By far, the relational model/database is the <strong>most widely used</strong>.</p>

<p>Major vendors:</p>

<ul>
  <li>Oracle, 44% market share (source: Gartner)</li>
  <li>IBM (DB2 and Informix), 22%</li>
  <li>Microsoft (SQL Server), 18%</li>
  <li>SAP (bought Sybase in 2010), 4.1%</li>
  <li>Teradata, 3.3%</li>
</ul>

<p>A major <strong>strength</strong> of the relational model:</p>

<ul>
  <li>supports simple, powerful <strong>querying</strong> of data.</li>
  <li>Queries can be written intuitively, and the <strong>DBMS</strong> is responsible for <strong>efficient</strong> evaluation</li>
</ul>

<h3 id="definitions">Definitions</h3>

<blockquote>
  <p><strong>Relational database</strong>:</p>

  <ul>
    <li>a set of relations (tables)</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>A relation (table)</strong></p>

  <ul>
    <li>is a set of tuples (<strong>rows</strong>)
      <ul>
        <li><strong>Schema</strong>: name of relation, name and type of each <strong>column</strong>, <strong>constraints</strong>.
          <ul>
            <li>e.g.  <code class="language-plaintext highlighter-rouge">Students(sidstring, namestring, loginstring, ageinteger, gpareal)</code>.</li>
            <li>#columns= degree / arity</li>
          </ul>
        </li>
        <li><strong>Instance</strong>: the actual table (i.e., its rows) at a particular point in time.</li>
      </ul>
    </li>
    <li>All <strong>rows</strong> in a table are <strong>distinct</strong>.
      <ul>
        <li><em>columns could be the same</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong><em>For Example</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_14-22-20.png" alt="" /></p>

<h2 id="basic-sql-query-language">Basic SQL Query Language</h2>

<p><strong><em>For Example:</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_14-22-20.png" alt="" /></p>

<p><strong>To find all 18 year old students</strong>, we write:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Students</span> <span class="k">WHERE</span> <span class="n">age</span><span class="o">=</span><span class="mi">18</span>
</code></pre></div></div>

<p>or</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Students</span> <span class="n">S</span> <span class="k">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="mi">18</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">S</code> is used when you need to avoid <strong>ambiguities</strong> when querying multiple tables</li>
</ul>

<h3 id="crud-relationstables-in-sql">CRUD Relations/Tables in SQL</h3>

<p>To <strong>create</strong> a table:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Students</span><span class="p">(</span><span class="n">sid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">name</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">login</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">age</span> <span class="nb">INTEGER</span><span class="p">,</span><span class="n">gpa</span> <span class="nb">REAL</span><span class="p">)</span>  
</code></pre></div></div>

<p>To <strong>delete</strong> a table</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">Students</span>
</code></pre></div></div>

<p>To <strong>alter</strong> a table design:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Students</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">firstYear</span><span class="p">:</span> <span class="nb">integer</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>The schema of <code class="language-plaintext highlighter-rouge">Students</code> is altered if you <strong>change the structure</strong></li>
    <li>In the above, the structure is changed by adding a new field
      <ul>
        <li>every tuple in the current instance is <strong>extended with a <code class="language-plaintext highlighter-rouge">null</code> value in the new field</strong>.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>To <strong>update data</strong> into a table:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span>  <span class="n">Students</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gpa</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">53688</span><span class="p">,</span> <span class="err">‘</span><span class="n">Smith</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="n">smith</span><span class="o">@</span><span class="n">ee</span><span class="err">’</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">3</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>or</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">Students</span> <span class="n">S</span> <span class="k">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="err">‘</span><span class="n">Smith</span><span class="err">’</span>
</code></pre></div></div>

<h3 id="integrity-constraints">Integrity Constraints</h3>

<p>You can specify <strong>constraints</strong> in your table, such that:</p>

<ul>
  <li>IC condition that must be <strong>true for any instance of the database</strong>
    <ul>
      <li>ICs are <strong><em>specified</em></strong> when schema is defined</li>
      <li>ICs are <strong><em>checked</em></strong> when relations are modified</li>
    </ul>
  </li>
  <li>A <strong>legal</strong> instance of a relation is one that satisfies all specified ICs</li>
</ul>

<h4 id="primary-key-constraint">Primary Key Constraint</h4>

<blockquote>
  <p><strong>Key</strong></p>

  <ul>
    <li>A <strong>set of fields</strong> is a key for a relation if:
      <ol>
        <li>No two distinct tuples can have same values in all key fields, and</li>
        <li>This is any subset of the key becomes non-distinct, i.e. <strong><em>cannot be further decomposed</em></strong>
          <ul>
            <li>e.g. <code class="language-plaintext highlighter-rouge">uni</code> would be a <strong>key</strong></li>
          </ul>
        </li>
      </ol>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Superkey</strong></p>

  <ul>
    <li>superkey is basically a <strong>union/superset</strong> of <strong>keys</strong>
      <ul>
        <li>e.g. <code class="language-plaintext highlighter-rouge">uni+lastname</code> would be a <strong>superkey</strong></li>
      </ul>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Candidate and Primary Key</strong></p>

  <ul>
    <li>Candidate key: any of the keys
      <ul>
        <li>there can be multiple candidate keys in a table</li>
      </ul>
    </li>
    <li>Primary key: one of the keys chosen DBA
      <ul>
        <li><strong>there can only be one Primary key in a table</strong></li>
      </ul>
    </li>
  </ul>
</blockquote>

<h4 id="primaryuniquenot-null">Primary/Unique/Not null</h4>

<p><strong>Syntaxes</strong>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">att1</span><span class="p">,</span> <span class="n">att2</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UNIQUE</span> <span class="p">(</span><span class="n">att1</span><span class="p">,</span> <span class="n">att2</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">att</span> <span class="k">NOT</span> <span class="k">NULL</span>
</code></pre></div></div>

<hr />

<p><strong><em>For example:</em> Primary Key</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Enrolled</span> <span class="p">(</span>
    <span class="n">sid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">cid</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">grade</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> 
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span><span class="n">cid</span><span class="p">)</span> 
<span class="p">)</span>
</code></pre></div></div>

<p><strong>means</strong></p>

<ul>
  <li>For a given student and course, there is a single grade, or:</li>
  <li><strong>A student can only get <em>one grade</em> in an enrolled course</strong></li>
</ul>

<hr />

<p><strong><em>For example:</em> Unique</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Enrolled</span> <span class="p">(</span>
    <span class="n">sid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">cid</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">grade</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">),</span>
    <span class="k">UNIQUE</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">grade</span><span class="p">)</span> 
<span class="p">)</span>
</code></pre></div></div>

<p><strong>means</strong></p>

<ul>
  <li><strong>A student can only take one course</strong>, and</li>
  <li><strong>No two students can have the same grade in a course</strong></li>
</ul>

<hr />

<p><strong><em>For Example:</em> Not Null</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Students</span> <span class="p">(</span>
    <span class="n">age</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span>  
</code></pre></div></div>

<h4 id="foreign-keys">Foreign Keys</h4>

<p>Foreign keys keep <strong>referential integrity</strong></p>

<blockquote>
  <p><strong>Foreign Key</strong></p>

  <ul>
    <li><strong>Fields</strong> in one tuple that is used to <strong>refer to another tuple’s <code class="language-plaintext highlighter-rouge">PRIMARY KEY</code> or <code class="language-plaintext highlighter-rouge">UNIQUE</code></strong>.
      <ul>
        <li>Like a logical pointer, and it <strong>must exists</strong>. Otherwise, some optional actions will be taken (see below)</li>
      </ul>
    </li>
    <li>Referential integrity is achieved if all <strong>foreign key constraints</strong> are enforced, i.e., no dangling references.</li>
  </ul>
</blockquote>

<p><strong><em>For example</em></strong></p>

<p>Consider the following <strong><em>referential integrity needed</em></strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-22_14-55-15.png" style="zoom: 50%;" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Enrolled</span><span class="p">(</span>
    <span class="n">sid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>  
    <span class="n">cid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>  
    <span class="n">grade</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Students</span> 
<span class="p">)</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>the last line written in full is <code class="language-plaintext highlighter-rouge">FOREIGN KEY (sid) REFERENCES Students (sid)</code></li>
</ul>

<hr />

<p><strong>Now, to enforce referential integrity, consider</strong>:</p>

<ul>
  <li>What should be done if an <code class="language-plaintext highlighter-rouge">Enrolled</code> tuple with a non-existent student id is inserted?</li>
  <li>What should be done if a <code class="language-plaintext highlighter-rouge">Students</code> tuple is deleted?</li>
</ul>

<p><strong>SQL/99 supports all 4 options on deletes and updates.</strong></p>

<ul>
  <li><strong><em>Default</em></strong> is NO ACTION (delete/update is rejected)
    <ul>
      <li>e.g. you cannot delete <code class="language-plaintext highlighter-rouge">53666</code> of <code class="language-plaintext highlighter-rouge">Enrolled</code> or <code class="language-plaintext highlighter-rouge">Student</code></li>
    </ul>
  </li>
  <li><strong><em>CASCADE</em></strong> (also delete all tuples that refer to deleted tuple)
    <ul>
      <li>e.g. deleting <code class="language-plaintext highlighter-rouge">53666</code> in <code class="language-plaintext highlighter-rouge">Enrolled</code> will also delete <code class="language-plaintext highlighter-rouge">53666</code> in <code class="language-plaintext highlighter-rouge">Student</code></li>
    </ul>
  </li>
  <li><strong><em>SET NULL /SET DEFAULT</em></strong> (sets foreign key value of referencing tuple)</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">TABLEEnrolled</span><span class="p">(</span>
    <span class="n">sid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">cid</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">grade</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">sid</span><span class="p">)</span>
    <span class="k">REFERENCES</span> <span class="n">Students</span>
    	<span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
    	<span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">SET</span> <span class="k">DEFAULT</span> 
<span class="p">)</span>
</code></pre></div></div>

<h3 id="views">Views</h3>

<blockquote>
  <p><strong>View</strong></p>

  <ul>
    <li>A view is basically a ‘fictitious table’, such that
      <ul>
        <li>all of its data are <strong>computed at real time from another table <em>at the time it is accessed</em></strong></li>
        <li>hence, it only stores definitions</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong>Syntaxes</strong></p>

<ul>
  <li>Creating a <code class="language-plaintext highlighter-rouge">view</code></li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span>  <span class="k">VIEW</span>  <span class="n">YoungGoodStudents</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gpa</span><span class="p">)</span> <span class="k">AS</span><span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">gpa</span>
    <span class="k">FROM</span>  <span class="n">Students</span> <span class="n">S</span>
    <span class="k">WHERE</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="k">and</span> <span class="n">S</span><span class="p">.</span><span class="n">gpa</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">0</span>
<span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Deleting a <code class="language-plaintext highlighter-rouge">view</code></li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">VIEW</span> <span class="n">YoungGoodStudents</span>
</code></pre></div></div>

<p><strong>Since <code class="language-plaintext highlighter-rouge">view</code> <em>dependent</em> on actual tables</strong>:</p>

<ul>
  <li>How to handle <code class="language-plaintext highlighter-rouge">DROP TABLE</code> if there’s a view on the table?
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DROP TABLE</code> command has options to let the user specify this.</li>
    </ul>
  </li>
</ul>

<h1 id="week-3">Week 3</h1>

<h2 id="er-to-relational-database">ER to Relational Database</h2>

<p><strong>How to we map what we have done in ER Diagram into Database?</strong></p>

<h3 id="entity-sets-to-tables">Entity Sets to Tables</h3>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_11-25-57.png" style="zoom:150%;" /></p>

<p>with:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Employees</span> <span class="p">(</span>
    <span class="n">ssn</span>	<span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
    <span class="n">name</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">age</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="relationship-sets-to-tables">Relationship Sets to Tables</h3>

<p><strong>Now, relationships</strong> are basically tables with mostly <strong>foreign keys</strong>.</p>

<ul>
  <li>but now, we need to think about how to map the 1-to-many/many-to-1.,,, relationship</li>
</ul>

<p><strong>Many-to-Many Relationship</strong>:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_11-28-04.png" style="zoom:67%;" /></p>

<p>with:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Works_In</span><span class="p">(</span>
    <span class="n">ssn</span>	<span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
    <span class="n">did</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">since</span>	<span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">,</span> <span class="n">did</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">did</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Departments</span>
<span class="p">)</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">PRIMARY KEY (ssn, did)</code> essentially implements the <strong>many-to-many</strong> constraint</li>
</ul>

<p><strong>Key Constraint/ At Most 1 Participation</strong></p>

<p>So that <code class="language-plaintext highlighter-rouge">Departments</code> can participate <em>at most once</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_11-33-06.png" style="zoom:67%;" /></p>

<p>with:</p>

<ul>
  <li>
    <p><em>three-table solution</em></p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Manages</span> <span class="p">(</span>
    <span class="n">did</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">ssn</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>    <span class="o">//</span> <span class="n">ok</span> <span class="n">if</span> <span class="k">NULL</span><span class="o">?</span> <span class="k">No</span><span class="p">.</span> <span class="k">Then</span> <span class="n">the</span> <span class="n">Manages</span> <span class="k">table</span> <span class="n">does</span> <span class="k">not</span> <span class="n">make</span> <span class="n">sense</span>
    <span class="n">since</span>  <span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">did</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">did</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Departments</span>
<span class="p">)</span>
</code></pre></div>    </div>

    <p>so that if it <em>appears on this table</em>, there is one manager. If a department does not have a manager, it is <em>not in this table</em> (<strong>this is the sole purpose of a relationship table</strong>)</p>
  </li>
  <li>
    <p><em>two-table solution</em></p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Dept_Mngr</span><span class="p">(</span>
    <span class="n">did</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">dnameCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">budget</span>  <span class="nb">REAL</span><span class="p">,</span> 
    <span class="n">ssn</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="o">//</span> <span class="n">ok</span> <span class="n">if</span> <span class="k">NULL</span><span class="p">.</span> <span class="n">Represents</span> <span class="n">a</span> <span class="n">Dept</span> <span class="k">without</span> <span class="n">Manager</span>
    <span class="n">since</span>  <span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">did</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span>
<span class="p">)</span>
</code></pre></div>    </div>

    <p>since each <code class="language-plaintext highlighter-rouge">Dept</code> has a unique manager, combine <code class="language-plaintext highlighter-rouge">Manages</code> and <code class="language-plaintext highlighter-rouge">Depts</code> into one table.</p>

    <ul>
      <li>now, a <code class="language-plaintext highlighter-rouge">Dept</code> can <em>at most have one</em> manager since it is an <code class="language-plaintext highlighter-rouge">attribute</code> that is <code class="language-plaintext highlighter-rouge">nullable</code></li>
    </ul>
  </li>
</ul>

<p><strong>Total Participation Constraint (=1/One to One)</strong></p>

<p>Now, using the <code class="language-plaintext highlighter-rouge">Dept_Mngr</code> table is simply:</p>

<ul>
  <li>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Dept_Mngr</span><span class="p">(</span>
    <span class="n">did</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">dname</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">budget</span>  <span class="nb">REAL</span><span class="p">,</span>
    <span class="n">ssn</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">since</span>  <span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">did</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">NO</span> <span class="n">ACTION</span>
<span class="p">)</span>
</code></pre></div>    </div>

    <p>now, we have <code class="language-plaintext highlighter-rouge">ssn</code> being <code class="language-plaintext highlighter-rouge">NOT NULL</code>, so that each department has <em>exactly one manager</em></p>

    <ul>
      <li>if it is one-to-one, then <strong>it is basically an attribute</strong></li>
    </ul>
  </li>
  <li>
    <p>This means a <em>relationship table</em> would not capture the constraint anymore:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Manages</span> <span class="p">(</span>
    <span class="n">ssn</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">did</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">since</span>  <span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">did</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">did</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Departments</span>
<span class="p">)</span> <span class="o">//</span> <span class="n">Does</span> <span class="k">not</span> <span class="k">work</span>
</code></pre></div>    </div>

    <p>there is <em>no constraint that forces ALL entries of <code class="language-plaintext highlighter-rouge">Dept</code></em> to appear here</p>
  </li>
</ul>

<p><strong>Total Participation Constraint ($\ge$1)</strong></p>

<p><em>Without <code class="language-plaintext highlighter-rouge">Check</code> constraint</em>, this is not possible.</p>

<ul>
  <li>
    <p>Consider the following:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Dept_Mngr</span><span class="p">(</span>
    <span class="n">did</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">dname</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">budget</span>  <span class="nb">REAL</span><span class="p">,</span>
    <span class="n">ssn</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="o">//</span> <span class="n">ssn</span> <span class="k">is</span> <span class="n">a</span> <span class="n">PK</span><span class="p">,</span> <span class="n">so</span> <span class="k">no</span> <span class="n">need</span> <span class="k">to</span> <span class="k">NOT</span> <span class="k">NULL</span>
    <span class="n">since</span>  <span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">ssn</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">NO</span> <span class="n">ACTION</span>
<span class="p">)</span>
</code></pre></div>    </div>

    <p>this would work physically, but there would be <strong>redundancy</strong>, which would be a <em>source of error for CRUD</em></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">dname CHAR(20)</code> and <code class="language-plaintext highlighter-rouge">budget  REAL</code> would be <em>repeated</em></li>
    </ul>
  </li>
  <li>
    <p>Similarily:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">//</span><span class="mi">3</span> <span class="n">tables</span> <span class="p">(</span><span class="n">Emp</span><span class="p">,</span> <span class="n">Dept</span><span class="p">,</span> <span class="n">Manages</span><span class="p">)</span>
<span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Manages</span> <span class="p">(</span>
    <span class="n">ssn</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
    <span class="n">did</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">since</span>  <span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">ssn</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">did</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Departments</span>
<span class="p">)</span>
</code></pre></div>    </div>

    <p>which would not work since a <strong>relationship table cannot force total participation</strong></p>
  </li>
</ul>

<h3 id="weak-entity-to-tables">Weak Entity to Tables</h3>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>A weak entity should only make sense by considering the <strong>PK of the owner</strong>
      <ul>
        <li>depends entirely on the existence of an owner</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>Consider:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_12-18-22.png" style="zoom:50%;" /></p>

<p>with:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">//</span> <span class="n">Dependents</span> <span class="k">and</span> <span class="n">Policy</span> <span class="k">are</span> <span class="n">translated</span> <span class="k">into</span> <span class="n">ONE</span> <span class="k">TABLE</span>
<span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Dep_Policy</span> <span class="p">(</span>
    <span class="n">pname</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">age</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">cost</span>  <span class="nb">REAL</span><span class="p">,</span>
    <span class="n">ssn</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">ssn</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span>
    <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>Weak entity set and identifying relationship set are <strong>translated into a single table</strong>.
    <ul>
      <li>so that <em>entries in <code class="language-plaintext highlighter-rouge">Dependents</code> will also be deleted</em> when the owner is gone</li>
    </ul>
  </li>
  <li>When the owner entity is deleted, all <strong>owned weak entities must also be deleted</strong>.</li>
</ul>

<p><strong><em>Alternatively:</em></strong></p>

<p>if you want to <strong>keep the three table structure</strong>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Policies</span> <span class="p">(</span>
    <span class="n">policyid</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">cost</span>  <span class="nb">REAL</span><span class="p">,</span>
    <span class="n">ssn</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">policyid</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ssn</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Employees</span><span class="p">,</span>
    <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Dependents</span><span class="p">(</span>
    <span class="n">pname</span>  <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">age</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">policyid</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">policyid</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">policyid</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Policies</span><span class="p">,</span>
    <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span>
</code></pre></div></div>

<p>so that:</p>

<ul>
  <li>When the owner entity is deleted, all <strong>owned weak entities together with policy are also be deleted</strong>.</li>
</ul>

<h2 id="compact-sql-notation">Compact SQL Notation</h2>

<p>This is only for <strong>writing to quickly clarify the design</strong>. This will not compile.</p>

<p>Examples include:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_12-23-25.png" style="zoom:67%;" /></p>

<blockquote>
  <p><strong>Note</strong>:</p>

  <ul>
    <li><strong>Never omit</strong> the always crucial <code class="language-plaintext highlighter-rouge">PK</code>, <code class="language-plaintext highlighter-rouge">UNIQUE</code>, <code class="language-plaintext highlighter-rouge">NOT NULL</code> and <code class="language-plaintext highlighter-rouge">FK</code> constraints</li>
  </ul>
</blockquote>

<h2 id="isa-hierarchies">ISA Hierarchies</h2>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>This is basically the OOP concept of inheritance</li>
    <li>Additionally, some constraints here include:
      <ul>
        <li>Overlap constraints: can an entry go into both children?</li>
        <li>Covering constraints: does an entry in parent forces an entry in at least one of the children?</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong>In general</strong>, this is not supported naturally by <em>relational database</em>, but there are some approaches:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_12-28-19.png" alt="" /></p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Emps(ssn, name, age, PK(ssn))</code></p>

    <p><code class="language-plaintext highlighter-rouge">Hourly_Emps(h_wages, h_worked, ssn, PK(ssn), FK(ssn) -&gt; Empson delete cascade)</code></p>

    <p><code class="language-plaintext highlighter-rouge">Contract_Emps(c_id, ssn, PK(ssn), FK(ssn) -&gt; Emps on delete cascade)</code></p>

    <p>so that you basically manually creates the ISA relationship</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Hourly_Emps(ssn, name, age, h_wages, h_worked)</code></p>

    <p><code class="language-plaintext highlighter-rouge">Contract_Emps(ssn, name, age, c_id)</code></p>

    <p>this makes queries easier, but there <strong>may be</strong> <em>redundancy</em></p>
  </li>
</ol>

<p>However, the above design all depends on:</p>

<ul>
  <li>Overlap constraint: being both <code class="language-plaintext highlighter-rouge">Hourly_Emps</code> and <code class="language-plaintext highlighter-rouge">Contract_Emps</code>
    <ul>
      <li><em>redundancy</em> for the second design</li>
      <li>if not, <em>no redundancy</em></li>
    </ul>
  </li>
</ul>

<h2 id="er-design-examples">ER Design Examples</h2>

<h3 id="orders-example-1">Orders example #1</h3>

<p>Consider the following ER:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_12-40-02.png" /></p>

<p>and we need that:</p>

<ul>
  <li>the supplier in the <code class="language-plaintext highlighter-rouge">ApprovedBy</code> aggregate is the <strong>same as</strong> the one in the <code class="language-plaintext highlighter-rouge">Supplies</code> aggregate</li>
</ul>

<p>then the <strong>SQL tables</strong> would be:</p>

<ul>
  <li>
    <p>Entities:</p>

    <p><code class="language-plaintext highlighter-rouge">Suppliers (sid, sname)</code></p>

    <p><code class="language-plaintext highlighter-rouge">Parts (pid, pname)</code></p>

    <p><code class="language-plaintext highlighter-rouge">Departments (did, dname)</code></p>
  </li>
  <li>
    <p>Relationships:</p>

    <p><code class="language-plaintext highlighter-rouge">ApprovedBy(sid, did, FK(sid) -&gt; Suppliers, FK(did) -&gt; Departments)</code></p>

    <p><code class="language-plaintext highlighter-rouge">Supplies (sid, pid, FK(sid) -&gt; Suppliers, FK(pid) -&gt; Parts)</code></p>
  </li>
  <li>
    <p>Aggregate</p>

    <p>``Orders (sid, did, pid, qty, cost, date,`</p>

    <p><code class="language-plaintext highlighter-rouge">PK(sid, did, pid, qty, cost, date)</code></p>

    <p><code class="language-plaintext highlighter-rouge">FK(sid, did) -&gt; ApprovedBy,</code></p>

    <p><code class="language-plaintext highlighter-rouge">FK(sid, pid) -&gt; Supplies)</code></p>

    <p>where:</p>

    <ul>
      <li>there is <strong>only one <code class="language-plaintext highlighter-rouge">sid</code></strong></li>
      <li><code class="language-plaintext highlighter-rouge">Orders</code> relates to both <code class="language-plaintext highlighter-rouge">ApprovedBy</code> aggregate <strong>and</strong> <code class="language-plaintext highlighter-rouge">Supplies</code> aggregate by the two <code class="language-plaintext highlighter-rouge">FK</code></li>
    </ul>
  </li>
</ul>

<h3 id="orders-example-2">Orders example #2</h3>

<p>Consider this example:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_12-45-46.png" alt="" /></p>

<p>where:</p>

<ul>
  <li>
    <p>Entities: same as above</p>
  </li>
  <li>
    <p>Relationship: same as above</p>
  </li>
  <li>
    <p>Aggregate:</p>

    <p><code class="language-plaintext highlighter-rouge">Invoice(INO, </code></p>

    <p><code class="language-plaintext highlighter-rouge">sid NOT NULL, did NOT NULL, pid NOT NULL, qty, cost, date,</code></p>

    <p><code class="language-plaintext highlighter-rouge">PK(INO),</code></p>

    <p><code class="language-plaintext highlighter-rouge">FK(sid, did) -&gt; ApprovedBy,</code></p>

    <p><code class="language-plaintext highlighter-rouge">FK(sid, pid) -&gt; Supplies)</code></p>

    <p>where:</p>

    <ul>
      <li>the idea is basically the same as before, the only advantage is that it <em>only requires <code class="language-plaintext highlighter-rouge">PK(INO)</code> to get an entry</em>, as compared to the previous <code class="language-plaintext highlighter-rouge">PK(sid, did, pid, qty, cost, date)</code></li>
    </ul>
  </li>
</ul>

<h2 id="relational-query-languages">Relational Query Languages</h2>

<blockquote>
  <p><strong>Query Languages</strong></p>

  <ul>
    <li>Query languages:  Allow manipulation and retrieval of data from a database.</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Query</strong></p>

  <ul>
    <li>Queries are applied <em>to tables</em>, and they <em>output tables</em>
      <ul>
        <li>i.e. the <em>schema</em> of the input and the output of a query is <strong>always the same</strong>, but the data inside might be different depending on data changes in the actual schema</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="relational-algebra">Relational Algebra</h3>

<p>In short, all <strong>tables</strong> are essentially <strong>sets</strong>, since each entry/row is unique.</p>

<p>Therefore, we have the following operations in SQL:</p>

<p><strong>Basic operations:</strong></p>

<ul>
  <li>Selection ($\sigma$): Selects a subset of rows from relation.</li>
  <li>Projection ($\pi$):   Deletes unwanted columns from relation.</li>
  <li>Cross-product ($\times$):  Allows us to combine two relations.</li>
  <li>Set-difference  ($\setminus$ or $-$):  Tuples in reln. 1, but not in reln. 2.</li>
  <li>Union ($\cup$):  Tuples in reln. 1 and in reln. 2.</li>
</ul>

<p><strong>Additional operations</strong>:</p>

<ul>
  <li>Intersection $\cap$, <em>join</em>, division, renaming:  Not essential, but (very!) useful.</li>
</ul>

<p>Since each operation returns a relation, operations can be <em>composed</em>! (<strong>Algebra is “closed”</strong>.)</p>

<h4 id="operators-definitions">Operators Definitions</h4>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-11-41.png" style="zoom: 50%;" /></p>

<hr />

<p><strong>Projection</strong></p>

<ul>
  <li>
\[\pi_{sname, rating} (S2)\]

    <p>gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-13-57.png" alt="" /></p>
  </li>
  <li>
\[\pi_{age}(S2)\]

    <p>gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-14-34.png" alt="" /></p>
  </li>
</ul>

<hr />

<p><strong>Selection</strong></p>

<ul>
  <li>
\[\sigma_{rating&gt;8}(S2)\]

    <p>gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-15-25.png" style="zoom:50%;" /></p>
  </li>
  <li>
\[\pi_{sname, rating}(\sigma_{rating&gt;8}(S2))\]

    <p>gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-16-26.png" style="zoom:50%;" /></p>
  </li>
</ul>

<hr />

<p><strong>Set Operations are trivial</strong></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-17-10.png" style="zoom: 80%;" /></p>

<p>but note:</p>

<ul>
  <li>the only thing you need to make sure is that <em>all entries are unique</em></li>
  <li><em>tables need to be union-compatible</em>
    <ul>
      <li>contains the same number of attributes</li>
      <li>attributes are of the compatible type</li>
      <li>so that each row can be compared</li>
    </ul>
  </li>
</ul>

<hr />

<p><strong>Cartesian Product</strong></p>

<p>Consider:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-21-33.png" style="zoom:50%;" /></p>

<ul>
  <li>
\[S1 \times R1\]

    <p>gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-23-19.png" style="zoom:50%;" /></p>

    <p>where:</p>

    <ul>
      <li>
        <p><em>Conflict</em>:  Both <code class="language-plaintext highlighter-rouge">S1</code> and <code class="language-plaintext highlighter-rouge">R1</code> have a field called <code class="language-plaintext highlighter-rouge">sid</code>. (but the cartesian product does not care)</p>

        <ul>
          <li>usually here you would <em>rename</em>:
\(\rho(C(1\to sid1, 5\to sid2),S1\times R1)\)</li>
        </ul>
      </li>
      <li>
        <p>the cartesian product itself is usually <em>useless</em>. You will need to do some additionally operations.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p><strong>Joins</strong></p>

<ul>
  <li>
    <p><strong>Condition join</strong> is a combination of <em>cartesian product</em> and <em>selection</em>
\(\sigma_{condition}(R \times S) \equiv R \bowtie_{condition} S\)</p>
  </li>
  <li>
    <p>for example:
\(S1 \bowtie_{S1.sid &lt; R1.sid}R1\)
gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-32-18.png" style="zoom: 50%;" /></p>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>This might be able to compute more efficiently</li>
  </ul>
</blockquote>

<ul>
  <li>
    <p><strong>Equi-Join</strong> is a selection based on some equality</p>
  </li>
  <li>
    <p>for example:
\(S1 \bowtie_{sid}R1\)
gives:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-34-05.png" style="zoom: 50%;" /></p>
  </li>
  <li>
    <p><strong>Natural Join</strong> Equijoin on <em>all</em> <em>common</em> fields (fields with the same <em>name</em> and the same <em>type</em>)</p>
  </li>
  <li>
    <p>for example:
\(S1 \bowtie R1\)
gives the same:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-01-29_13-34-05.png" style="zoom: 50%;" /></p>

    <p>since <code class="language-plaintext highlighter-rouge">sid</code> is the only common field for table <code class="language-plaintext highlighter-rouge">S1</code> and table <code class="language-plaintext highlighter-rouge">R1</code></p>
  </li>
</ul>

<hr />

<p><strong>Division</strong></p>

<ul>
  <li>
    <p>Let <code class="language-plaintext highlighter-rouge">A</code> have 2 fields, <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code>; <code class="language-plaintext highlighter-rouge">B</code>have only field <code class="language-plaintext highlighter-rouge">y</code>:
\(A/B = \{ \lang x\rang\, |\, \exist\lang x,y\rang \in A,\,\forall \lang y\rang \in B\}\)</p>
  </li>
  <li>
    <p>i.e., <code class="language-plaintext highlighter-rouge">A/B</code> contains all <code class="language-plaintext highlighter-rouge">x</code> tuples (sailors) <em>such that for every <code class="language-plaintext highlighter-rouge">y</code> tuple</em> (boat) in B, <em>there is an <code class="language-plaintext highlighter-rouge">xy</code> tuple in A.</em></p>
  </li>
  <li>
    <p>i.e. returns <code class="language-plaintext highlighter-rouge">x</code> in <code class="language-plaintext highlighter-rouge">A</code> <strong>if and only if it has/tuples with all <code class="language-plaintext highlighter-rouge">y</code> in <code class="language-plaintext highlighter-rouge">B</code></strong></p>
  </li>
  <li>
    <p><strong>Not supported as a primitive operator</strong>. To express this as <em>standard</em> operation we had before:</p>

    <p>Idea:  For A/B, <code class="language-plaintext highlighter-rouge">x</code> value is disqualified if by attaching <code class="language-plaintext highlighter-rouge">y</code> value from B, we obtain an <code class="language-plaintext highlighter-rouge">xy</code> tuple that is <em>not in</em> A.
\(\pi_x(A) - \pi_x(\,(\pi_x(A)\times B)-A \,)\)
where:</p>

    <ul>
      <li>$ \pi_x(\,(\pi_x(A)\times B)-A \,)$ signifies the <em>disqualified</em> <code class="language-plaintext highlighter-rouge">x</code> values (<code class="language-plaintext highlighter-rouge">xy</code> tuple that is <em>not in</em> A.)</li>
    </ul>
  </li>
  <li>
    <p>for example:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-05_11-47-02.png" alt="" /></p>
  </li>
</ul>

<h4 id="example">Example</h4>

<p><em>For Example:</em> Find names of sailors who’ve reserved boat #103</p>

<ul>
  <li>so we have a <code class="language-plaintext highlighter-rouge">Sailors</code> and a <code class="language-plaintext highlighter-rouge">Reserves</code> table</li>
</ul>

<p><em>Solution</em>:</p>

<ol>
  <li>
    <p>The straight-forward approach
\(\pi_{sname}((\sigma_{bid=103}Reserves)\bowtie Sailors)\)</p>
  </li>
  <li>
    <p>Splitting the above into <em>individual steps</em>:
\(\begin{align*}
&amp;\rho(Temp1,\,\sigma_{bid=103}Reserves))\\
&amp;\rho(Temp2,\,Temp1 \bowtie Sailors)\\
&amp;\pi_{sname}(Temp2)
\end{align*}\)</p>
  </li>
  <li>
    <p>The <em>“formula”</em> approach (since many times, you simply joins first):
\(\pi_{sanme}(\sigma_{bid=103}(Reserves \bowtie Sailors))\)</p>
  </li>
</ol>

<blockquote>
  <p><strong>Choosing Which Query to Use</strong></p>

  <ol>
    <li>The expression itself must be correct
      <ul>
        <li>in the above case, all of them</li>
      </ul>
    </li>
    <li>The expression must be <em>easy to read/understand for yourself</em>
      <ul>
        <li>so that it there is an error, you can see it immediately</li>
      </ul>
    </li>
    <li>Do not care about performance yet
      <ul>
        <li>DBMS has <em>internal query optimization</em> made for you</li>
      </ul>
    </li>
  </ol>
</blockquote>

<hr />

<p><em>For Example</em>: Find names of sailors who’ve reserved a red boat.</p>

<ul>
  <li>So we have three tables, <code class="language-plaintext highlighter-rouge">Sailors</code>, <code class="language-plaintext highlighter-rouge">Reserves</code>, and <code class="language-plaintext highlighter-rouge">Boat</code></li>
</ul>

<p><em>Solution</em>:</p>

<ol>
  <li>
    <p>The straight-forward approach:
\(\pi_{sname}( (\sigma_{color=red}Boats)\bowtie Reserves \bowtie Sailors )\)</p>
  </li>
  <li>
    <p>The <em>“formula”</em> approach
\(\pi_{sname}(\sigma_{color=red}(Sailors \bowtie_{sid}Reserves \bowtie_{bid} Boats))\)</p>
  </li>
  <li>
    <p>etc.</p>
  </li>
</ol>

<hr />

<p><em>For Example</em>: Find names of sailors who’ve reserved a red or a green boat.</p>

<p><em>Solution</em>:</p>

<ol>
  <li>
    <p>The straight-forward approach:
\(\pi_{sname}( (\sigma_{color=red\,\or\,color=green}Boats)\bowtie Reserves \bowtie Sailors )\)</p>
  </li>
  <li>
    <p>The <em>“formula”</em> approach
\(\pi_{sname}(\sigma_{color=red\,\or\,color=green}(Sailors \bowtie_{sid}Reserves \bowtie_{bid} Boats))\)</p>
  </li>
  <li>
    <p>Computing the red and green boat separately, and then <em>union</em> the names</p>
  </li>
</ol>

<hr />

<p><em>For Example</em>: Find names of sailors who’ve reserved a red and a green boat.</p>

<p><em>Solution</em>:</p>

<ol>
  <li>
    <p>if this question is changed to <em>and</em> instead of <em>or</em>, then:</p>

    <ul>
      <li>changing $\or$ to $\and$ for solution 1 and 2 would <em>not work</em>, because <code class="language-plaintext highlighter-rouge">color</code> is a <em>singular value</em></li>
    </ul>
  </li>
  <li>
    <p>changing the <em>union</em> to <em>intersect</em> would not work either, because:</p>

    <ul>
      <li>if there is <code class="language-plaintext highlighter-rouge">sname=Mike, uid=1</code> who borrowed <code class="language-plaintext highlighter-rouge">red</code> boat, and a <code class="language-plaintext highlighter-rouge">sname=Mike, uid=2</code> who borrowed <code class="language-plaintext highlighter-rouge">green</code> boat, then the intersection will <em>also give <code class="language-plaintext highlighter-rouge">Mike</code></em> as the result, which is <em>wrong</em></li>
      <li>therefore, you should use <strong>primary keys</strong> before the last step</li>
    </ul>

\[\begin{align*}
\pi_{sname}(\pi_{sname,sid} (\sigma_{red} (S \bowtie R \bowtie B)) \cap \pi_{sname,sid} (\sigma_{green} (S \bowtie R \bowtie B)))
\end{align*}\]

    <p>where:</p>

    <ul>
      <li>$\pi_{sname,sid} (\sigma_{red} (S \bowtie R \bowtie B))$ selects <em>correctly <strong>unique sailors who have reserved red boat</strong></em></li>
      <li>$\pi_{sname,sid} (\sigma_{green} (S \bowtie R \bowtie B))$ selects <em>correctly <strong>unique sailors who have reserved green boat</strong></em></li>
    </ul>
  </li>
</ol>

<hr />

<p><em>For Example</em>: Find the names of sailors who’ve reserved all boats</p>

<p><em>Solution</em>:</p>

<ol>
  <li>
    <p>Using division:
\(\begin{align*}
&amp;\rho(Tempsids, (\pi_{sid, bid} Reserves)/(\pi_{bid} Boats))
\end{align*}\)
which gets all <code class="language-plaintext highlighter-rouge">sid</code> who has <em>reserved all boats</em>, since:</p>

    <ul>
      <li>$(\pi_{sid, bid} Reserves)/(\pi_{bid} Boats)$ returns a tuple $\lang sid, bid\rang$ $\iff$ a $\lang sid \rang$ in $Reserves$ contains <em>columns</em> $\lang sid, bid\rang$ for all $\lang bid \rang$ in $Boats$</li>
    </ul>

    <p>lastly, we do:
\(\pi_{sanme}(Tempsids \bowtie Sailors)\)
to <em>fetch the names</em>.</p>
  </li>
</ol>

<h1 id="sql-queries">SQL Queries</h1>

<h2 id="basic-sql-structures">Basic SQL Structures</h2>

<blockquote>
  <p><strong>Basic Select Queries</strong></p>

  <ul>
    <li>
      <p>It has the following structure</p>

      <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-05_13-19-31.png" style="zoom:50%;" /></p>

      <p>where:</p>

      <ul>
        <li>by default,  SQL <em>will not remove duplicates</em> from the query result. Therefore, sometimes you need to  <em>specify</em> <code class="language-plaintext highlighter-rouge">[DISTINCT]</code> flag.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><strong>Basic Select Query Mechanism</strong></p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">From </code>relation-list</strong> could be a <em>list of relation/table names</em>
    <ul>
      <li>in that case, it computes the <em>cartesian product of the given tables</em></li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">WHERE</code> qualification</strong> are comparisons using operators such as $&gt;,&lt;.=,etc$, connected with <code class="language-plaintext highlighter-rouge">AND/OR/NOT</code>
    <ul>
      <li>in this case, it performs <em>selection</em></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">SELECT</code> <strong>target-list</strong> is a list of attributes of relations you wanted to have from the <em>relation-list</em>
    <ul>
      <li>performs the <em>projection</em></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">[DISTINCT]</code> removes duplicate rows</li>
  <li><code class="language-plaintext highlighter-rouge">ORDER BY</code> just alters the sequence of the result presented</li>
</ol>

<p><em>For Example</em>:</p>

<p>Find the name of sailor who has rent the boat <code class="language-plaintext highlighter-rouge">103</code>.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span> 
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span> <span class="k">AND</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="mi">103</span>
</code></pre></div></div>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-05_13-32-40.png" style="zoom:50%;" /></p>

<hr />

<p><em>For Example</em>:</p>

<p>Consider the following query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span>
</code></pre></div></div>

<p>will the result contain <em>duplicate <code class="language-plaintext highlighter-rouge">sid</code></em>?</p>

<ul>
  <li><em>Answer:</em> yes, because a sailor could have reserved multiple boats, and by default <code class="language-plaintext highlighter-rouge">SELECT</code> statements do not remove duplicate results</li>
</ul>

<h2 id="join-syntax">Join Syntax</h2>

<h3 id="inner-join">Inner Join</h3>

<p>The below are all <strong>equivalent</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span> <span class="k">AND</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="mi">103</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>    <span class="n">Sailors</span> <span class="n">S</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">R</span> <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="mi">103</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>    <span class="n">Sailors</span> <span class="n">S</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">R</span> <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="mi">103</span>
</code></pre></div></div>

<h2 id="expression-and-strings">Expression and Strings</h2>

<p><em>For Example:</em></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">age1</span><span class="o">=</span><span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> 
	<span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="k">AS</span> <span class="n">age2</span><span class="p">,</span> 
	<span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="o">||</span> <span class="err">‘</span><span class="o">@</span><span class="n">columbia</span><span class="p">.</span><span class="n">edu</span><span class="err">’</span> <span class="k">AS</span> <span class="n">email</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span> <span class="k">LIKE</span> <span class="err">‘</span><span class="n">B_</span><span class="o">%</span><span class="n">B</span><span class="err">’</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">age1=S.age-5</code> computes <code class="language-plaintext highlighter-rouge">S.age-5</code> and <strong>renames</strong> the column to <code class="language-plaintext highlighter-rouge">age1</code></li>
  <li><code class="language-plaintext highlighter-rouge">2*S.age AS age2</code> computes <code class="language-plaintext highlighter-rouge">2*S.age</code> and <strong>renames</strong> the column to <code class="language-plaintext highlighter-rouge">age2</code></li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">S.sid||‘@columbia.edu’ AS email</code> concatenates <code class="language-plaintext highlighter-rouge">S.sid</code> with <code class="language-plaintext highlighter-rouge">@columbia.edu</code> and <strong>renames</strong> the column to <code class="language-plaintext highlighter-rouge">email</code></p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">LIKE</code> is used for string matching.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">_</code> stands for <em>any one character</em> and <code class="language-plaintext highlighter-rouge">%</code> stands for <em>0 or more arbitrary characters</em>.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">CAST</code> is used for type casting
    <ul>
      <li><code class="language-plaintext highlighter-rouge">CAST (S.rating as float)</code></li>
    </ul>
  </li>
</ul>

<h2 id="set-operations">Set Operations</h2>

<blockquote>
  <p><strong>Basic Syntax of Set Operations</strong></p>

  <ul>
    <li>
      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query1</span> <span class="k">UNION</span> <span class="p">[</span><span class="k">ALL</span><span class="p">]</span> <span class="n">query2</span>
<span class="n">query1</span> <span class="k">INTERSECT</span> <span class="p">[</span><span class="k">ALL</span><span class="p">]</span> <span class="n">query2</span>
<span class="n">query1</span> <span class="k">EXCEPT</span> <span class="p">[</span><span class="k">ALL</span><span class="p">]</span> <span class="n">query2</span>
</code></pre></div>      </div>

      <p>where:</p>

      <ul>
        <li>by default, <em>duplicates are eliminated</em> unless <code class="language-plaintext highlighter-rouge">ALL</code> is specified!
          <ul>
            <li>in this the only operation in SQL that automatically eliminates duplicates</li>
          </ul>
        </li>
        <li>of course, set operations work only when they are <em>union compatible</em> (same columns and types)</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p>Find <code class="language-plaintext highlighter-rouge">sid</code>s of sailors who’ve reserved a <code class="language-plaintext highlighter-rouge">red</code> or a <code class="language-plaintext highlighter-rouge">green</code> boat.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>  <span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">red</span><span class="err">’</span>
<span class="k">UNION</span>
<span class="k">SELECT</span>  <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>  <span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">green</span><span class="err">’</span>
</code></pre></div></div>

<p>alternatively, <strong>only using <code class="language-plaintext highlighter-rouge">WHERE</code></strong>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>	<span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span>	<span class="k">AND</span>	<span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">red</span><span class="err">’</span> <span class="k">OR</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">green</span><span class="err">’</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<p><em>For Example</em></p>

<p>Find <code class="language-plaintext highlighter-rouge">sid</code>s of sailors who’ve reserved a red boat <em>but not</em> a green boat.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>  <span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">red</span><span class="err">’</span>
<span class="k">EXCEPT</span>
<span class="k">SELECT</span>  <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>  <span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">green</span><span class="err">’</span>
</code></pre></div></div>

<p>alternatively, <strong>only using</strong> <code class="language-plaintext highlighter-rouge">WHERE</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">R1</span><span class="p">.</span><span class="n">sid</span>
<span class="k">FROM</span>	<span class="n">Boats</span> <span class="n">B1</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R1</span><span class="p">,</span><span class="n">Boats</span> <span class="n">B2</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R2</span>
<span class="k">WHERE</span>	<span class="n">R1</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R2</span><span class="p">.</span><span class="n">sid</span> <span class="k">AND</span> <span class="n">R1</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B1</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span> <span class="n">R2</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B2</span><span class="p">.</span><span class="n">bid</span> 
	<span class="k">AND</span> <span class="p">(</span><span class="n">B1</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">red</span><span class="err">’</span> <span class="k">AND</span> <span class="k">NOT</span> <span class="n">B2</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">green</span><span class="err">’</span><span class="p">)</span>
</code></pre></div></div>

<p>note that we needed two pairs to tables, <code class="language-plaintext highlighter-rouge">Boats B1, Reserves R1,Boats B2, Reserves R2</code>, since for a table there is only <em>one value for <code class="language-plaintext highlighter-rouge">color</code></em></p>

<ul>
  <li>i.e. each record can only capture one <code class="language-plaintext highlighter-rouge">color</code>. Therefore, we need <em>two tables</em> and <em>combine the result using <code class="language-plaintext highlighter-rouge">sid</code> and <code class="language-plaintext highlighter-rouge">bid</code>.</em> (<code class="language-plaintext highlighter-rouge">R1.sid=R2.sid AND R1.bid=B1.bid AND R2.bid=B2.bid </code>)</li>
</ul>

<h2 id="nested-queries">Nested Queries</h2>

<p>Nested Queries can happen in basically any where, including:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SELECT</code></li>
  <li><code class="language-plaintext highlighter-rouge">FROM</code></li>
  <li><code class="language-plaintext highlighter-rouge">WHERE</code></li>
  <li>etc.</li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>
      <p>In general, since we have a nested query, the scope of <em>variables</em> look like.</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SOME</span> <span class="n">QUERY</span> <span class="k">with</span> <span class="n">Var</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>For example:</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> 	<span class="n">S</span><span class="p">.</span><span class="n">sname</span> <span class="cm">/* only S is visiable */</span>
<span class="k">FROM</span> 	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span> 	<span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span>  <span class="n">R</span><span class="p">.</span><span class="n">sid</span> <span class="cm">/* S and R is visible */</span>
                  <span class="k">FROM</span>  <span class="n">Reserves</span> <span class="n">R</span>
                  <span class="k">WHERE</span>  <span class="n">R</span><span class="p">.</span><span class="n">bid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="cm">/* S, R, B are all visible */</span>
                                   <span class="k">FROM</span> <span class="n">Boats</span> <span class="n">B</span>
                                   <span class="k">WHERE</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="n">red</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>where:</p>

      <ul>
        <li>
          <p>again, we are doing:</p>

          <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SOME</span> <span class="n">OTHER</span> <span class="n">QUERY</span> <span class="k">RESULT</span><span class="p">)</span>
</code></pre></div>          </div>

          <p>and that the <em>return type</em> of <code class="language-plaintext highlighter-rouge">SOME OTHER QUERY RESULT</code> has to match the type/format of <code class="language-plaintext highlighter-rouge">S.sid</code></p>
        </li>
      </ul>
    </li>
  </ul>

</blockquote>

<h3 id="nested-queries-and-in">Nested Queries and IN</h3>

<blockquote>
  <p><strong>IN</strong></p>

  <ul>
    <li>essentially, <code class="language-plaintext highlighter-rouge">xxx IN (some query)</code> means only <em>keeping values of <code class="language-plaintext highlighter-rouge">xxx</code> if it is the set of <code class="language-plaintext highlighter-rouge">some query</code></em>
      <ul>
        <li>and since this is basically a <em>set operation</em>, the types of <code class="language-plaintext highlighter-rouge">xxx</code> and <code class="language-plaintext highlighter-rouge">some query</code> has to be <em>union compatible</em></li>
      </ul>
    </li>
    <li>the negation will be <code class="language-plaintext highlighter-rouge">NOT IN</code></li>
  </ul>
</blockquote>

<p>Consider the problem:</p>

<ul>
  <li>Find names of sailors who’ve reserved boat <code class="language-plaintext highlighter-rouge">#103</code>:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="k">IN</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span>
    <span class="k">FROM</span> <span class="n">Reserves</span> <span class="n">R</span>
    <span class="k">WHERE</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span> <span class="o">=</span> <span class="mi">103</span>
<span class="p">)</span>
</code></pre></div></div>

<h4 id="rewriting-intersect-with-in">Rewriting INTERSECT with IN</h4>

<p>Consider:</p>

<ul>
  <li>Find id/name of sailors who’ve reserved both a red <em>and</em> a green boat:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> 	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span>	<span class="n">R2</span><span class="p">.</span><span class="n">sid</span>
                  <span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B2</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R2</span>
                  <span class="k">WHERE</span>  <span class="n">R2</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B2</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span>  <span class="n">B2</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">red</span><span class="err">’</span><span class="p">)</span> 
                  <span class="k">AND</span>
        <span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span>  <span class="n">R2</span><span class="p">.</span><span class="n">sid</span>
                  <span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B2</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R2</span>
                  <span class="k">WHERE</span>  <span class="n">R2</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B2</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span>  <span class="n">B2</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">green</span><span class="err">’</span><span class="p">)</span> 
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>
    <p>basically you are doing <code class="language-plaintext highlighter-rouge">S.sid</code> is in <em>both the sets</em> (results of the inner queries)</p>
  </li>
  <li>
    <p>Similarly, <code class="language-plaintext highlighter-rouge">EXCEPT</code>/``MINUS<code class="language-plaintext highlighter-rouge"> queries re-written using </code>NOT IN`.</p>
  </li>
</ul>

<h3 id="nested-queries-and-from">Nested Queries and FROM</h3>

<p>Consider the same problem</p>

<ul>
  <li>Find names of sailors who’ve reserved boat ``#103`:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">sid</span> <span class="k">FROM</span> <span class="n">Reserves</span> <span class="k">WHERE</span> <span class="n">bid</span><span class="o">=</span><span class="mi">103</span><span class="p">)</span> <span class="n">T</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">T</span><span class="p">.</span><span class="n">sid</span>
</code></pre></div></div>

<p>notice that:</p>

<ul>
  <li>
    <p>the line:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">sid</span> <span class="k">FROM</span> <span class="n">Reserves</span> <span class="k">WHERE</span> <span class="n">bid</span><span class="o">=</span><span class="mi">103</span><span class="p">)</span> <span class="n">T</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">T</span><span class="p">.</span><span class="n">sid</span>
</code></pre></div>    </div>

    <p>did a <strong>natural join on <code class="language-plaintext highlighter-rouge">sid</code></strong> from the two tables <code class="language-plaintext highlighter-rouge">S,T</code></p>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>
      <p><strong>if and only if</strong> the inner query <code class="language-plaintext highlighter-rouge">SELECT sid FROM Reserves WHERE bid=103</code> results in <strong>only one row/result</strong>, then it would be also correct to say:</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">sid</span> <span class="k">FROM</span> <span class="n">Reserves</span> <span class="k">WHERE</span> <span class="n">bid</span><span class="o">=</span><span class="mi">103</span><span class="p">)</span> <span class="n">T</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">T</span>
</code></pre></div>      </div>
    </li>
  </ul>
</blockquote>

<h3 id="multi-level-nested-queries">Multi-level Nested Queries</h3>

<p>Consider:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> 	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span> 	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span> 	<span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span>  <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
                  <span class="k">FROM</span>  <span class="n">Reserves</span> <span class="n">R</span>
                  <span class="k">WHERE</span>  <span class="n">R</span><span class="p">.</span><span class="n">bid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">B</span><span class="p">.</span><span class="n">bid</span>
                                   <span class="k">FROM</span> <span class="n">Boats</span> <span class="n">B</span>
                                   <span class="k">WHERE</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="n">red</span><span class="p">)</span>
</code></pre></div></div>

<p>and it basically does “<em>Find names of sailors who have reserved a red boat</em>”.</p>

<h3 id="nested-queries-with-correlation">Nested Queries with Correlation</h3>

<blockquote>
  <p><strong>Exists and Unique</strong></p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">EXISTS</code> checks for empty set
      <ul>
        <li>returns true if <em>table is not empty</em></li>
      </ul>
    </li>
    <li><code class="language-plaintext highlighter-rouge">UNIQUE</code> checks for duplicate tuples
      <ul>
        <li>returns true if there are <em>no duplicate tuples or the table is empty</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>Consider the problem</p>

<ul>
  <li>Find names of sailors who’ve reserved boat <code class="language-plaintext highlighter-rouge">#103</code>:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>   <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span>	<span class="o">*</span>
                <span class="k">FROM</span>	<span class="n">Reserves</span> <span class="n">R</span>
                <span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="mi">103</span> <span class="k">AND</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="p">)</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>
    <p>this is nested query with <strong>correlation</strong>, because the <em>inner query</em> <code class="language-plaintext highlighter-rouge">WHERE R.bid=103 AND S.sid=R.sid</code> <em>correlates/uses</em> <code class="language-plaintext highlighter-rouge">S.sid</code> which is of the <em>outer query</em></p>
  </li>
  <li>
    <p>therefore, since it used <code class="language-plaintext highlighter-rouge">S.sid=R.sid</code>, this is what happened:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>   <span class="nv">"If each S.sid EXISTS IN (SELECT	*
                		 	     FROM	Reserves R
               					 WHERE	R.bid=103 AND S.sid=R.sid)"</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Similarly:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>   <span class="k">UNIQUE</span> <span class="p">(</span><span class="k">SELECT</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span>
                <span class="k">FROM</span>	<span class="n">Reserves</span> <span class="n">R</span>
                <span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="mi">103</span> <span class="k">AND</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="p">)</span>
</code></pre></div></div>

<p>Finds sailors with <em>at most one reservation</em> for boat ``#103<code class="language-plaintext highlighter-rouge">. Since </code>UNIQUE<code class="language-plaintext highlighter-rouge"> returns </code>TRUE` if and only if the row is <em>unique or empty</em>.</p>

<ul>
  <li>
    <p>and the correlation <code class="language-plaintext highlighter-rouge">S.sid=R.sid</code> can be translated to:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>   <span class="nv">"If each S.sid has UNIQUE data of (SELECT	R.bid
               							FROM	Reserves R
                						WHERE	R.bid=103 AND S.sid=R.sid)"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="nested-queries-with-set-comparison">Nested Queries with Set Comparison</h3>

<blockquote>
  <p><strong><code class="language-plaintext highlighter-rouge">ANY</code>, <code class="language-plaintext highlighter-rouge">ALL</code> Operations</strong></p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">&lt;op&gt; ANY</code> returns true to the row if <em>any</em> of the comparison is true</li>
    <li><code class="language-plaintext highlighter-rouge">&lt;op&gt; ALL </code>returns true to the row if <em>all</em> of the comparison is true</li>
  </ul>
</blockquote>

<p>For example:</p>

<ul>
  <li>Find sailors whose rating is greater than that of <em>some sailor</em> called “Mike”</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="o">*</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="k">ANY</span> <span class="p">(</span><span class="k">SELECT</span>	<span class="n">S2</span><span class="p">.</span><span class="n">rating</span>
                        <span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S2</span>
                        <span class="k">WHERE</span>	<span class="n">S2</span><span class="p">.</span><span class="n">sname</span><span class="o">=</span><span class="err">‘</span><span class="n">Mike</span><span class="err">’</span><span class="p">)</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">S.rating &gt; ANY (SELECT S2.rating ...)</code> returns <code class="language-plaintext highlighter-rouge">true</code> to a row of <code class="language-plaintext highlighter-rouge">Sailors S</code> if <code class="language-plaintext highlighter-rouge">S.rating</code> is larger than <em>any</em> <code class="language-plaintext highlighter-rouge">S2.rating</code> entry in the subquery’s table.</li>
</ul>

<h2 id="division-in-sql">Division in SQL</h2>

<p>In short, division is <em>not supported naturally</em>. Therefore, you need to do complicated queries.</p>

<p><em>For Example</em></p>

<ul>
  <li>Find sailors who’ve reserved <em>all</em> boats.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>  	<span class="k">NOT</span> <span class="k">EXISTS</span>
		<span class="p">((</span><span class="k">SELECT</span>	<span class="n">B</span><span class="p">.</span><span class="n">bid</span>
          <span class="k">FROM</span>  <span class="n">Boats</span> <span class="n">B</span><span class="p">)</span>
         <span class="k">EXCEPT</span>
         <span class="p">(</span><span class="k">SELECT</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span>
          <span class="k">FROM</span>	<span class="n">Reserves</span> <span class="n">R</span>
          <span class="k">WHERE</span> <span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">))</span>
</code></pre></div></div>

<p>which basically does:</p>

<ul>
  <li>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>  	<span class="k">NOT</span> <span class="k">EXISTS</span>
		<span class="p">(</span> <span class="n">ALL_BOAT_IDs</span>
         <span class="k">EXCEPT</span> <span class="p">(</span><span class="n">Minus</span><span class="p">)</span>
           <span class="n">ALL_BOAT_IDs_RESERVED_BY_A_SAILOR</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>then <code class="language-plaintext highlighter-rouge">NOT EXISTS</code> does:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>  	<span class="k">TRUE</span> <span class="n">IF_BELOW_IS_EMPTY</span>
		<span class="p">(</span> <span class="n">ALL_BOAT_IDs</span>
         <span class="k">EXCEPT</span> <span class="p">(</span><span class="n">Minus</span><span class="p">)</span>
           <span class="n">ALL_BOAT_IDs_RESERVED_BY_A_SAILOR</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>usually, when a query involves the <em>ALL</em> condition, the natural thinking shout be using <code class="language-plaintext highlighter-rouge">DIVISION</code></li>
    <li>However, since <code class="language-plaintext highlighter-rouge">DIVISION</code> is not supported naturally, when need to often <em>compute the opposite, and minus it</em>.</li>
  </ul>
</blockquote>

<h2 id="aggregate-operators">Aggregate Operators</h2>

<blockquote>
  <p><strong>Supported Aggregates</strong></p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">COUNT(*), COUNT( [DISTINCT] A)</code>
      <ul>
        <li>counts the <em>number of rows/distinct rows</em> of a <em>all columns/column A</em></li>
      </ul>
    </li>
    <li><code class="language-plaintext highlighter-rouge">SUM( [DISTINCT] A)</code></li>
    <li><code class="language-plaintext highlighter-rouge">AVG( [DISTINCT] A)</code></li>
    <li><code class="language-plaintext highlighter-rouge">MAX(A), MIN(A)</code></li>
  </ul>
</blockquote>

<blockquote>
  <p><em>Reminder</em>:</p>

  <ul>
    <li>the <code class="language-plaintext highlighter-rouge">SELECT</code> part of a query is executed the <strong>last</strong>.</li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<ul>
  <li>
    <p>Number of sailors</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span>  <span class="n">Sailors</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>Average age of all sailors whose rating is 10:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="k">AVG</span> <span class="p">(</span><span class="n">age</span><span class="p">)</span>
<span class="k">FROM</span>	<span class="n">Sailors</span>
<span class="k">WHERE</span> 	<span class="n">rating</span><span class="o">=</span><span class="mi">10</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Name of sailors with maximum/highest rating</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> 	<span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">FROM</span> 	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">S2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> 
                    <span class="k">FROM</span>  	<span class="n">Sailors</span> <span class="n">S2</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="advanced-sql-constraints">Advanced SQL Constraints</h1>

<p>Some basic SQL constraints have been covered in <a href="#Integrity-Constraints">Integrity Constraints</a>.</p>

<h2 id="check-constraints">CHECK Constraints</h2>

<blockquote>
  <p><strong>Check Constraint</strong></p>

  <ul>
    <li>Attribute-based <code class="language-plaintext highlighter-rouge">CHECK</code> constraints involve a single attribute
      <ul>
        <li>it is basically a <em>boolean expression,</em> and it <em>must evaluate to true for all rows of an attribute</em> that has this constraint.</li>
      </ul>
    </li>
    <li>If the constraint does not mention any attribute, it <em>applies to the entire table</em>
      <ul>
        <li>e.g. if you use things like <code class="language-plaintext highlighter-rouge">CHECK((SELECT COUNT(*) FROM Sailors) &lt; 100)</code></li>
      </ul>
    </li>
    <li>If any table in the <code class="language-plaintext highlighter-rouge">CHECK</code> constraint is <strong>empty</strong> (i.e. just created with no data yet), then <code class="language-plaintext highlighter-rouge">CHECK</code> constraints automatically evaluate to true
      <ul>
        <li>e.g. <code class="language-plaintext highlighter-rouge">CHECK((SELECT COUNT(*) FROM Sailors) &gt; 100)</code> is true for empty table</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>   <span class="n">Sailors</span> <span class="p">(</span>
    <span class="n">sid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">rating</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">age</span> <span class="nb">REAL</span> <span class="k">CHECK</span><span class="p">(</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* all rows must have age &gt;= 17 */</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span>	<span class="n">valid_ratings</span>
    <span class="k">CHECK</span><span class="p">(</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">)</span>   
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">CHECK</code> constraints can optionally be named. For example:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CONSTRAINT</span>	<span class="n">valid_ratings</span>
<span class="k">CHECK</span><span class="p">(</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>the position of <code class="language-plaintext highlighter-rouge">CHECK</code> constraints does not matter. It can be at the end as well.</p>
  </li>
</ul>

<p><em>For Example</em>:</p>

<p>You can also check tuples:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>   <span class="n">Sailors</span> <span class="p">(</span>
    <span class="n">sid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">rating</span> <span class="nb">INTEGER</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">age</span> <span class="nb">REAL</span> <span class="k">CHECK</span><span class="p">(</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* all rows must have age &gt;= 17 */</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">),</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">AND</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">),</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">AND</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">)</span>
<span class="p">)</span>   
</code></pre></div></div>

<h3 id="check-with-sql-queries">CHECK with SQL Queries</h3>

<p><em>For Example</em></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>   <span class="n">Sailors</span> <span class="p">(</span>
    <span class="n">sid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">rating</span> <span class="nb">INTEGER</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">age</span> <span class="nb">REAL</span> <span class="k">CHECK</span><span class="p">(</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* all rows must have age &gt;= 17 */</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">),</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">AND</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">),</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">AND</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">),</span>
    <span class="k">CHECK</span><span class="p">((</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>   
</code></pre></div></div>

<p>which constraints the number of sailors to 100.</p>

<blockquote>
  <p><strong>Note</strong>:</p>

  <ul>
    <li>
      <p>By the definition of <code class="language-plaintext highlighter-rouge">CHECK</code>, the below will be true for empty table</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>   <span class="n">Sailors</span> <span class="p">(</span>
    <span class="n">sid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">rating</span> <span class="nb">INTEGER</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">age</span> <span class="nb">REAL</span> <span class="k">CHECK</span><span class="p">(</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* all rows must have age &gt;= 17 */</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">),</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">AND</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">),</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">AND</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">),</span>
    <span class="k">CHECK</span><span class="p">((</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="cm">/* true for empty table */</span>
<span class="p">)</span>   
</code></pre></div>      </div>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="n">Reserves</span> <span class="p">(</span>
    <span class="n">sid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">bid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">day</span>	<span class="nb">DATE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span><span class="k">day</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Sailors</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">bid</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Boats</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">noInterlakeRes</span> <span class="cm">/* this checks for each row of Reserves table */</span>
    <span class="k">CHECK</span><span class="p">(</span> <span class="s1">'Interlake'</span> <span class="o">&lt;&gt;</span> <span class="p">(</span><span class="k">SELECT</span>  <span class="n">B</span><span class="p">.</span><span class="n">bnameFROM</span>  <span class="n">Boats</span> <span class="n">B</span> <span class="k">WHERE</span>  <span class="n">B</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">bid</span><span class="p">)</span> <span class="p">)</span> 
<span class="p">)</span>
</code></pre></div></div>

<p>which basically means you <em>cannot reserve the boat ‘Interlake’</em></p>

<ul>
  <li>note that <code class="language-plaintext highlighter-rouge">(SELECT  B.bnameFROM  Boats B WHERE  B.bid=bid)</code> returns only a <em>single row</em> for each <code class="language-plaintext highlighter-rouge">bid</code>, so you can directly compare with a string ‘Interlake’.</li>
</ul>

<h3 id="check-with-assertion">CHECK with Assertion</h3>

<p>In short, when you have a <code class="language-plaintext highlighter-rouge">CHECK</code> constraining multiple tables, the problem comes:</p>

<ol>
  <li>in which table should you put the constraint?</li>
  <li>If any table in the <code class="language-plaintext highlighter-rouge">CHECK</code> constraint is <strong>empty</strong>, then <code class="language-plaintext highlighter-rouge">CHECK</code> constraints automatically evaluate to true. This will cause buggy behavior</li>
</ol>

<blockquote>
  <p><strong>Assertion</strong></p>

  <ul>
    <li>Often used for creating <code class="language-plaintext highlighter-rouge">CHECK</code> constraints for multiple tables</li>
    <li>Does not automatically evaluate to <code class="language-plaintext highlighter-rouge">true</code> if any table is <em>empty</em>
      <ul>
        <li>hence fixes the bug</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example:</em> The Wrong Approach</p>

<p>I want to create a small club, which that number of sailors + boat $&lt;$ 100</p>

<ul>
  <li>
    <p>the Wrong Approach:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>   <span class="n">Sailors</span> <span class="p">(</span>
    <span class="n">sid</span>	<span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">rating</span>  <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">age</span>  <span class="nb">REAL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">sid</span><span class="p">),</span>
    <span class="k">CHECK</span> <span class="p">(</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Boats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>    </div>

    <p>which will be buggy if one of the table <code class="language-plaintext highlighter-rouge">Sailors/Boats</code> is empty, this will be always true</p>
  </li>
  <li>
    <p>the Correct Approach:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">ASSERTION</span>  <span class="n">smallClub</span> <span class="k">CHECK</span>  <span class="p">(</span>
    <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Boats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span> 
<span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="using-assertion-for-total-participation">Using Assertion for Total Participation</h4>

<p><em>For Example</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-12_13-36-32.png" style="zoom:67%;" /></p>

<p>where we need:</p>

<ul>
  <li>each sailor reserves at least one boat (total participation)</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">ASSERTION</span>  <span class="n">BusySailors</span> <span class="p">(</span>
	<span class="k">CHECK</span> <span class="p">(</span>
        <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">sid</span>
                    <span class="k">FROM</span> <span class="n">Sailors</span>
                    <span class="k">WHERE</span> <span class="n">sid</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">sid</span>
                                      <span class="k">FROM</span> <span class="n">Reserves</span> <span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>which basically means:</p>

<ul>
  <li>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">ASSERTION</span>  <span class="n">BusySailors</span> <span class="p">(</span>
	<span class="k">CHECK</span> <span class="p">(</span>
        <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="n">SAILOR_SID_WHO_HAS_NOT_NOT_RESERVED_A_BOAT</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>then the <code class="language-plaintext highlighter-rouge">NOT EXISTS</code> means:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">ASSERTION</span>  <span class="n">BusySailors</span> <span class="p">(</span>
	<span class="k">CHECK</span> <span class="p">(</span>
        <span class="n">IS_EMPTY</span> <span class="p">(</span><span class="n">SAILOR_SID_WHO_HAS_NOT_NOT_RESERVED_A_BOAT</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="advanced-sql-queries">Advanced SQL Queries</h1>

<h2 id="group-by">Group By</h2>

<p>So far, we’ve applied aggregate operators to all (qualifying) tuples.  Sometimes, we want to <strong>apply the aggregate operators to each of several groups of tuples</strong>.</p>

<ul>
  <li>e.g. <code class="language-plaintext highlighter-rouge">AVERAGE</code> GPA for students based on different ages (group)</li>
</ul>

<p><em>For Example</em></p>

<ul>
  <li>Task: Find the age of the youngest sailor for <em>each rating level</em>.</li>
</ul>

<p>You would like to do this (but you cannot):</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_12-48-21.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>it does not work for all times because:
    <ol>
      <li>often, we do not know what <em>range of</em> $i$ would this take</li>
      <li>often, the values of $i$ might not be integers/equally spaced</li>
    </ol>
  </li>
</ul>

<p>Therefore, we need to solve it by using <code class="language-plaintext highlighter-rouge">GROUP BY</code></p>

<blockquote>
  <p><strong>Queries with Group By</strong></p>

  <ul>
    <li>
      <p>Now, it looks like this:</p>

      <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_13-12-59.png" style="zoom:50%;" /></p>

      <p>and it evaluates from:</p>

      <ol>
        <li><code class="language-plaintext highlighter-rouge">FROM</code> (trivial)</li>
        <li><code class="language-plaintext highlighter-rouge">WHERE</code> (trivial)</li>
        <li><code class="language-plaintext highlighter-rouge">SELECT</code>, basically a projection, but it must <strong>make sense for groups</strong>. Target-list/<strong>Result list</strong> here <strong>must</strong> contains/<strong>returns either:</strong>
          <ul>
            <li>attribute names <em>mentioned in <code class="language-plaintext highlighter-rouge">grouping-list</code></em>, or</li>
            <li>terms with <em>aggregate operations</em> (e.g., <code class="language-plaintext highlighter-rouge">MIN (S.age</code>)).
              <ul>
                <li>aggregates are actually <strong>evaluated in the end</strong></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><code class="language-plaintext highlighter-rouge">GROUP BY</code> <strong>sort the result from the previous 3 steps</strong> into groups
          <ul>
            <li>if you have multiple qualifications, then it <em>sorts qualification iteratively</em> (e.g. first sort by <code class="language-plaintext highlighter-rouge">qualif_1</code>, then inside those groups, sort by <code class="language-plaintext highlighter-rouge">qualif_2</code>, … etc)</li>
          </ul>
        </li>
        <li><code class="language-plaintext highlighter-rouge">HAVING</code> uses <strong>group qualification</strong>, which is basically <strong>qualification expression evaluated inside EACH GROUP</strong>
          <ul>
            <li>such as the average age of sailors <em>in each group</em> must be &gt; 25</li>
            <li>therefore, this also <strong>must use attributes in the <code class="language-plaintext highlighter-rouge">GROUP BY</code></strong> or <strong>aggregates</strong></li>
          </ul>
        </li>
        <li>(optionally) <code class="language-plaintext highlighter-rouge">ORDER BY</code> orders the output table from the above</li>
      </ol>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p>Task: Find the average rating <em>for each sailor age</em></p>

<p>Solution:</p>

<ul>
  <li>
    <p>when you see the term <em>for each</em>, very probably you need to create groups</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">,</span>  <span class="k">AVG</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span>
<span class="k">FROM</span>  <span class="n">Sailors</span> <span class="n">S</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span>
</code></pre></div>    </div>

    <p>note that:</p>

    <ul>
      <li>the select looks for <code class="language-plaintext highlighter-rouge">S.age,  AVG(S.rating)</code>, which is <strong>exactly</strong>
        <ul>
          <li>attribute names <em>mentioned in <code class="language-plaintext highlighter-rouge">grouping-list</code></em>, or</li>
          <li>terms with <em>aggregate operations</em> (e.g., <code class="language-plaintext highlighter-rouge">MIN (S.age</code>)`).</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p><em>For Example</em></p>

<p>Task: Find the average rating for each sailor age greater than 25</p>

<p>Solution:</p>

<ul>
  <li>
    <p>simply:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">,</span>  <span class="k">AVG</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span>
<span class="k">FROM</span>  <span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="o">&gt;</span> <span class="mi">25</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<p><em>For Example</em></p>

<p>Task: Find the average rating for each sailor age with <em>more than 4 sailors of that age</em></p>

<p>Solution:</p>

<ul>
  <li>
    <p>Basically, we need each group have more than 4 members:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">,</span>  <span class="k">AVG</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span>
<span class="k">FROM</span>  <span class="n">Sailors</span> <span class="n">S</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">S</span><span class="p">.</span><span class="n">age</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span>
</code></pre></div>    </div>

    <p>where notice that:</p>

    <ul>
      <li>the <code class="language-plaintext highlighter-rouge">HAVING COUNT(*) &gt; 4</code> will be discarding <em>GROUPS</em> from <code class="language-plaintext highlighter-rouge">GROUP BY</code> that has total member less than 4</li>
    </ul>
  </li>
</ul>

<hr />

<p><em>For Example</em></p>

<p><strong>Task</strong>: Find the age of the youngest sailor with age &gt; 18, for each rating with at least 2 such sailors (age older than 18).</p>

<p><strong>Solution</strong>:</p>

<ul>
  <li>
    <p>the trick is to filter <code class="language-plaintext highlighter-rouge">age&gt;18</code> early:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span>  <span class="k">MIN</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">S</span><span class="p">.</span><span class="n">rating</span>
<span class="k">HAVING</span>	<span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Under the hood</strong>, this is what happens:</p>

<ol>
  <li>
    <p>the <code class="language-plaintext highlighter-rouge">FROM</code> step is skipped</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">WHERE	S.age &gt; 18</code></p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_13-46-05.png" style="zoom:50%;" /></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SELECT	S.rating,  MIN(S.age)</code></p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_13-47-34.png" style="zoom:50%;" /></p>

    <p>notice that the <em>aggregate operators are not evaluated at this point</em></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">GROUP BY  S.rating</code></p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_13-50-33.png" style="zoom: 80%;" /></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">HAVING	COUNT(*) &gt; 1</code> which <em>eliminates by GROUPS</em></p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_13-51-38.png" style="zoom: 67%;" /></p>
  </li>
  <li>
    <p>(<strong>Book-keeping</strong>) the <em>aggregate operator is executed</em> ` MIN(S.age)`:</p>

    <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_13-53-16.png" style="zoom: 67%;" /></p>
  </li>
</ol>

<hr />

<p><em>For Example</em>:</p>

<p><strong>Task</strong>: For each red boat, print the bid and the number of reservations for this boat</p>

<p><strong>Solution</strong>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">B</span><span class="p">.</span><span class="n">bid</span><span class="p">,</span>  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_of_reservations</span>
<span class="k">FROM</span>	<span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="k">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">‘</span><span class="n">red</span><span class="err">’</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">B</span><span class="p">.</span><span class="n">bid</span>
</code></pre></div></div>

<p>Alternatively:</p>

<ul>
  <li>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">B</span><span class="p">.</span><span class="n">bid</span><span class="p">,</span>  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_of_reservations</span>
<span class="k">FROM</span>	<span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
<span class="k">WHERE</span>	<span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">bid</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">B</span><span class="p">.</span><span class="n">bid</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span>
<span class="k">HAVING</span>	<span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="s1">'red'</span>
</code></pre></div>    </div>

    <p>which does:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">GROUP BY  B.bid, B.color</code> first, and then filter it using <code class="language-plaintext highlighter-rouge">HAVING</code></li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="group-by-with-correlated-queries">Group By With Correlated Queries</h3>

<blockquote>
  <p><em>Reminder</em>:</p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">HAVING</code> uses <strong>group qualification</strong>, which is basically <strong>qualification expression evaluated inside EACH GROUP</strong>
      <ul>
        <li>such as the average age of sailors <em>in each group</em> must be &gt; 25</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em>:</p>

<p><strong>Task:</strong> Find the age of the youngest sailor with age &gt; 18, for each rating with <em>at least 2 sailors (of any age)</em></p>

<p><strong>Solution</strong>:</p>

<ul>
  <li>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span>  <span class="k">MIN</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">S</span><span class="p">.</span><span class="n">rating</span>
<span class="k">HAVING</span>	<span class="mi">1</span>  <span class="o">&lt;</span>  <span class="p">(</span><span class="k">SELECT</span>	<span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span>
               <span class="k">FROM</span>		<span class="n">Sailors</span> <span class="n">S2</span>
               <span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="o">=</span><span class="n">S2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>where we <em>have to use nested <strong>correlated</strong> SQL queries</em>:</p>

    <ul>
      <li>
        <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span>  <span class="k">MIN</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">S</span><span class="p">.</span><span class="n">rating</span>
<span class="k">HAVING</span>	<span class="nv">"FOR EACH GROUP, 1  &lt;  (SELECT	COUNT (*)
                               FROM		Sailors S2
                               WHERE	S.rating_of_each_group =S2.rating)"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p><em>Alternatively</em>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span>  <span class="k">MIN</span> <span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">FROM</span>	<span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">rating</span> 
                    <span class="k">FROM</span> <span class="n">Sailors</span>
                    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">rating</span>
                    <span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="n">ValidRatings</span>
<span class="k">WHERE</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span><span class="o">=</span><span class="n">ValidRatings</span><span class="p">.</span><span class="n">rating</span> <span class="k">AND</span> <span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span>
<span class="k">GROUP</span> <span class="k">BY</span>	<span class="n">S</span><span class="p">.</span><span class="n">rating</span>
</code></pre></div></div>

<p>where you are basically:</p>

<ol>
  <li>computing <em>ratings with at least 2 sailors</em> first</li>
  <li>filtering the ages to $&gt;$ 18</li>
  <li>group them by each rating, and find minimum</li>
</ol>

<h2 id="null-values">Null Values</h2>

<p>Basically, since we have <code class="language-plaintext highlighter-rouge">NULL</code> values in SQL, we need to do <strong>logical comparisons</strong> with 3-values.</p>

<p><strong>AND</strong></p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th><strong>T</strong></th>
      <th><strong>F</strong></th>
      <th><strong>N</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>T</strong></td>
      <td>T</td>
      <td>F</td>
      <td><em>N</em></td>
    </tr>
    <tr>
      <td><strong>F</strong></td>
      <td>F</td>
      <td>F</td>
      <td><em>F</em></td>
    </tr>
    <tr>
      <td><strong>N</strong></td>
      <td><em>N</em></td>
      <td><em>F</em></td>
      <td><em>N</em></td>
    </tr>
  </tbody>
</table>

<h2 id="other-joins">Other Joins</h2>

<h3 id="outer-joins">Outer Joins</h3>

<blockquote>
  <p><strong>Outer Joins</strong></p>

  <ul>
    <li>rows included even if there is no match. This row is also indicated with <code class="language-plaintext highlighter-rouge">Null</code> fields</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Left Outer Join</strong></p>

  <ul>
    <li>rows in the <em>left table</em> that <strong>do not match any row</strong> in the right table <strong>appear exactly once</strong>, with column from the right table assigned <strong><code class="language-plaintext highlighter-rouge">NULL</code> values</strong>.
      <ul>
        <li>if there is a match, then there could be multiple values since it is just a cartesian product + selection</li>
      </ul>
    </li>
    <li>same as <strong>Left Join</strong></li>
  </ul>
</blockquote>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>In the end, <code class="language-plaintext highlighter-rouge">JOIN</code>s are just doing a cartesian product and a $\sigma$</li>
  </ul>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span>
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">S</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">R</span> <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
</code></pre></div></div>

<p>so that:</p>

<ul>
  <li><strong>every row</strong> of the <em>left table</em> appears in the result</li>
  <li>if rows <em>from the left table</em> did not match any in the join, then <strong>it still appears but has <code class="language-plaintext highlighter-rouge">null</code></strong>
    <ul>
      <li>regular join will <em>not have this functionality</em></li>
    </ul>
  </li>
</ul>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_18-53-58.png" alt="" /></p>

<blockquote>
  <p><strong>RIGHT OUTER JOIN:</strong></p>

  <ul>
    <li>the reverse</li>
  </ul>

  <p><strong>FULL OUTER JOIN:</strong></p>

  <ul>
    <li>both, left and right</li>
  </ul>
</blockquote>

<h3 id="examples">Examples</h3>

<p><strong>Task</strong>: For each <em>boat color</em>, print the number of reservations for boats of that color (e.g., (red, 10), (blue, 3), (pink, 0))</p>

<p><strong>Solution</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">Boats</span> <span class="n">B</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">R</span> <span class="k">ON</span> <span class="n">B</span><span class="p">.</span><span class="n">bid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">bid</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>remember that each boat can only have <em>one color</em></li>
</ul>

<hr />

<p><strong>Task:</strong> Print the <code class="language-plaintext highlighter-rouge">sid</code> <em>and name</em> of every sailor and the number of reservations the sailor has made.</p>

<p><strong>Solution</strong>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">bid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">S</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">R</span> <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note that</strong></p>

  <ul>
    <li>whenever you have <code class="language-plaintext highlighter-rouge">GROUP BY some_id</code>, no matter how many attributes you add afterwards, it <em>will not affect the result</em></li>
  </ul>
</blockquote>

<hr />

<p><strong>Task:</strong> Print the <code class="language-plaintext highlighter-rouge">sid</code> of every sailor and the number of <em>different</em> boats the sailor has reserved.</p>

<p><strong>Solution</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">SR</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">SR</span><span class="p">.</span><span class="n">bid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span>
      <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">S</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">R</span> <span class="k">ON</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="p">)</span> <span class="n">SR</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">SR</span><span class="p">.</span><span class="n">sid</span> 
</code></pre></div></div>

<h2 id="values">Values</h2>

<p>Basically this is used to create <em>a constant table</em></p>

<p><em>For Example</em>:</p>

<p>Creates a constant table</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'one'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'two'</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'three'</span><span class="p">)</span>
</code></pre></div></div>

<p>Insert into:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Sailors</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="err">‘</span><span class="n">dustin</span><span class="err">’</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</code></pre></div></div>

<p>Some trick other tricks:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">TopSailors</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sname</span>
    <span class="k">FROM</span> <span class="n">Sailors</span> 
    <span class="k">WHERE</span> <span class="n">ratings</span> <span class="o">&gt;=</span> <span class="mi">10</span>
    <span class="k">UNION</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2264</span><span class="p">,</span> <span class="err">’</span><span class="n">Alex</span> <span class="n">Biliris</span><span class="err">’</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="building-up-complicated-sql-statements">Building up Complicated SQL Statements</h2>

<p>Consider the statement:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">bid</span><span class="p">),</span>
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s3</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s3</span> <span class="k">WHERE</span> <span class="n">s3</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="p">,</span>
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
     <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r4</span><span class="p">.</span><span class="n">bid</span><span class="p">)</span> <span class="k">as</span> <span class="n">cnt</span>
           <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s4</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r4</span> <span class="k">ON</span> <span class="n">s4</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r4</span><span class="p">.</span><span class="n">sid</span>
           <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s4</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s4</span><span class="p">.</span><span class="n">age</span>
           <span class="k">HAVING</span> <span class="n">s4</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">))</span> 
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="o">&gt;</span> 
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s2</span> <span class="k">WHERE</span> <span class="n">s2</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span>
</code></pre></div></div>

<p>To parse it, we should <strong>break it into parts</strong></p>

<p><strong>Part 1</strong>:</p>

<p><em>For each sailor</em> with <em>rating higher than the average rating</em> of all sailors, print the name, rating, <em>number of boats she has reserved</em></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">bid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span> <span class="o">&gt;</span> 
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s2</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span>
</code></pre></div></div>

<p><strong>Part 2</strong>:</p>

<p>For each sailor with rating higher than the average rating of <strong>all sailors of the same age</strong>, print the name, rating, number of boats she has reserved</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">bid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span> <span class="o">&gt;</span> 
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s2</span> <span class="k">WHERE</span> <span class="n">s2</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="cm">/* added here */</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span>
</code></pre></div></div>

<p>notice the <em>correlated query</em>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">(SELECT AVG(s2.rating) FROM Sailors s2 WHERE s2.age=s.age) </code></li>
</ul>

<p><strong>Part 3</strong></p>

<p>For each sailor with rating higher than the average rating of all sailors of the same age, print the name, rating, number of boats she has reserved, <strong>and the average rating of sailors of the same age</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">bid</span><span class="p">),</span>
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s3</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s3</span> <span class="k">WHERE</span> <span class="n">s3</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="cm">/* A COMPUTED COLUMN */</span>
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span> <span class="o">&gt;</span> 
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s2</span> <span class="k">WHERE</span> <span class="n">s2</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span>
</code></pre></div></div>

<p>notice that the <em>correlated query</em> is now at <code class="language-plaintext highlighter-rouge">SELECT</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">(SELECT AVG(s3.rating) FROM Sailors s3 WHERE s3.age=s.age) </code> which <strong>computes the value for each matching <code class="language-plaintext highlighter-rouge">s3.age=s.age</code></strong></li>
</ul>

<p><strong>Part 4</strong></p>

<p>For each sailor with rating higher than the average rating of all sailors of the same age, print the name, rating, number of boats she has reserved, and the average rating of sailors of the same age <strong>and average number of reserved boats by sailors of the same age</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">bid</span><span class="p">),</span>
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s3</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s3</span> <span class="k">WHERE</span> <span class="n">s3</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="p">,</span>
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="cm">/* added nested query */</span>
     <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">r4</span><span class="p">.</span><span class="n">bid</span><span class="p">)</span> <span class="k">as</span> <span class="n">cnt</span>
           <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s4</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r4</span> <span class="k">ON</span> <span class="n">s4</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r4</span><span class="p">.</span><span class="n">sid</span>
           <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s4</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s4</span><span class="p">.</span><span class="n">age</span>
           <span class="k">HAVING</span> <span class="n">s4</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">))</span> 
<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Reserves</span> <span class="n">r</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span><span class="o">&gt;</span> 
	<span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s2</span><span class="p">.</span><span class="n">rating</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">s2</span> <span class="k">WHERE</span> <span class="n">s2</span><span class="p">.</span><span class="n">age</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">rating</span>
</code></pre></div></div>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-02-19_19-34-11.png" style="zoom:50%;" /></p>

<h2 id="with---auxiliary-sql">With - Auxiliary SQL</h2>

<p>This is a <strong>trick</strong> so that you can give <strong>names to temporary tables AND use them!</strong></p>

<p>Basically, you use a <em>subquery</em>, and <em>name</em> it:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">RedBoats</span> <span class="k">AS</span> <span class="p">(</span>
	<span class="k">SELECT</span> <span class="o">*</span>
    <span class="k">FROM</span> <span class="n">Boats</span> <span class="k">WHERE</span> <span class="n">color</span> <span class="o">=</span> <span class="err">‘</span><span class="n">red</span><span class="err">’</span>
<span class="p">),</span>  <span class="cm">/* comma, additional WITH query */</span>
	<span class="n">RedBoatReservations</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">bid</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">cnt</span>
    <span class="k">FROM</span> <span class="n">Reserves</span> 
    <span class="k">WHERE</span> <span class="n">bid</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">bid</span> <span class="k">FROM</span> <span class="n">RedBoats</span><span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">bid</span><span class="p">)</span> <span class="cm">/* no comma, one main SQL expected */</span>
<span class="k">SELECT</span> <span class="n">bid</span> <span class="k">FROM</span> <span class="n">RedBoatReservations</span>
<span class="k">WHERE</span> <span class="n">cnt</span><span class="o">&gt;</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">RedBoatReservations</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>Not all systems support <code class="language-plaintext highlighter-rouge">WITH</code>, but this is <em>obviously very useful</em> since it can:
      <ul>
        <li>make your SQL look easier to understand</li>
        <li>avoid <em>repetitive queries</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<h1 id="security-and-authorization">Security and Authorization</h1>

<p>Basically the <strong>goal is to make sure</strong>:</p>

<ul>
  <li><strong>Secrecy</strong>: Users should not be able to <em>see</em> things they are <em>not supposed to</em>.
    <ul>
      <li>E.g., A student can’t see other students’grades.</li>
    </ul>
  </li>
  <li><strong>Integrity</strong>: Users should not be able to <em>modify</em> things they are <em>not supposed to</em>.
    <ul>
      <li>E.g., Only instructors can assign grades.</li>
    </ul>
  </li>
  <li><strong>Availability</strong>: Users should be able to see and modify things they are <em>allowed</em> to.</li>
</ul>

<h2 id="access-control">Access Control</h2>

<blockquote>
  <p><strong>Access Control</strong></p>

  <ul>
    <li>Based on the concept of access rights or <strong>privileges</strong> for objects
      <ul>
        <li>e.g. privileges to <code class="language-plaintext highlighter-rouge">select/update</code> a table, etc.</li>
        <li>this is achieved by the <code class="language-plaintext highlighter-rouge">GRANT</code> <strong>command</strong></li>
      </ul>
    </li>
    <li><em>Creator of a table</em> or a view automatically <em>gets all privileges</em> on it.</li>
  </ul>
</blockquote>

<h3 id="grant-and-revoke">GRANT and Revoke</h3>

<blockquote>
  <p><strong>Grant Command</strong></p>

  <ul>
    <li>
      <p>The command looks like:</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">privileges</span> <span class="k">ON</span> <span class="k">object</span> <span class="k">TO</span> <span class="n">users</span> <span class="p">[</span><span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">]</span>
</code></pre></div>      </div>

      <p>where:</p>

      <ul>
        <li><code class="language-plaintext highlighter-rouge">privileges </code> can be the following:
          <ul>
            <li><code class="language-plaintext highlighter-rouge">SELECT</code></li>
            <li><code class="language-plaintext highlighter-rouge">INSERT/UPDATE (col-name)</code>
              <ul>
                <li>can insert/update tuples with non-null or non-default values in this column.</li>
              </ul>
            </li>
            <li><code class="language-plaintext highlighter-rouge">DELETE</code></li>
            <li><code class="language-plaintext highlighter-rouge">REFERENCES (col-name)</code>
              <ul>
                <li>can define foreign keys (to the <strong><code class="language-plaintext highlighter-rouge">col-name</code> of other tables</strong>). This is actually <em>powerful</em>, in that the foreign table <em>might not be able to delete/update</em> is there is <code class="language-plaintext highlighter-rouge">ON DELET NO ACTION</code>, or equivalent.</li>
                <li>this also means that <strong>by default</strong>, you can only foreign key in our own granted access tables</li>
              </ul>
            </li>
            <li><code class="language-plaintext highlighter-rouge">ALL</code> all privileges the issuer of <code class="language-plaintext highlighter-rouge">GRANT</code> has</li>
          </ul>
        </li>
        <li><code class="language-plaintext highlighter-rouge">object</code> can be a table, a view, or an entire database</li>
        <li><code class="language-plaintext highlighter-rouge">users</code> will be the  <em>logged in</em><code class="language-plaintext highlighter-rouge">username</code> in the DBMS</li>
        <li><code class="language-plaintext highlighter-rouge">GRANT OPTION</code>:
          <ul>
            <li>If a user has a privilege with the <code class="language-plaintext highlighter-rouge">GRANT  OPTION</code>, the user can <em>pass/propagate privilege on to other users</em> (with or without passing on the GRANT OPTION).</li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <p>However, only <strong>owner</strong> can execute <code class="language-plaintext highlighter-rouge">CREATE</code>, <code class="language-plaintext highlighter-rouge">ALTER</code>, and <code class="language-plaintext highlighter-rouge">DROP</code>.</p>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="n">Sailors</span> <span class="k">TO</span> <span class="n">Horatio</span>
</code></pre></div></div>

<p>where Horatio can <em>query</em> <code class="language-plaintext highlighter-rouge">Sailors</code> or <em>insert</em> tuples into it.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">Sailors</span> <span class="k">TO</span> <span class="n">Yuppy</span> <span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span>
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">Yuppy</code> can <em>delete</em> tuples, and also <em>authorize others</em> to do so.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">UPDATE</span> <span class="p">(</span><span class="n">rating</span><span class="p">)</span> <span class="k">ON</span> <span class="n">Sailors</span> <span class="k">TO</span> <span class="n">Dustin</span><span class="p">,</span> <span class="n">Yuppy</span>
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">Dustin</code> and <code class="language-plaintext highlighter-rouge">Yuppy</code> can u<em>pdate (only) the <code class="language-plaintext highlighter-rouge">rating</code> field</em> of <code class="language-plaintext highlighter-rouge">Sailors</code> table.</p>

<hr />

<blockquote>
  <p><strong>Revoke</strong></p>

  <ul>
    <li>When a privilege is revoked from <code class="language-plaintext highlighter-rouge">X</code>, it is also revoked from <strong>all users who got it solely from <code class="language-plaintext highlighter-rouge">X</code>.</strong></li>
  </ul>
</blockquote>

<h3 id="grant-and-revoke-on-views">Grant and Revoke on Views</h3>

<p>Since Views have some <em>dependencies of the underlying table</em>:</p>

<ol>
  <li>If the creator of a view <strong>loses</strong> the <code class="language-plaintext highlighter-rouge">SELECT</code> privilege on an <strong>underlying table</strong>, the view is <strong>dropped</strong></li>
  <li>If the creator of a view <strong>loses</strong> a privilege held with the <code class="language-plaintext highlighter-rouge">grant option</code> on an underlying table, (s)he loses the privilege on the view as well; <strong>so do users who were granted that privilege</strong> on the view (it will cascade/propagate)!</li>
</ol>

<h3 id="views-and-security">Views and Security</h3>

<blockquote>
  <p><strong>Advantages of using Views</strong></p>

  <ul>
    <li>Views can be used to present necessary information (or a summary), while <em>hiding details in underlying relation(s)</em>.</li>
    <li>Creator of view has a privilege on the view if (s)he has at least the <code class="language-plaintext highlighter-rouge">SELECT</code> privilege <em>on all underlying tables</em>.</li>
  </ul>
</blockquote>

<p>Together with <code class="language-plaintext highlighter-rouge">GRANT</code>/``REVOKE` commands, views are a very powerful access control tool.</p>

<h2 id="authorization-graph">Authorization Graph</h2>

<p>This is how the <strong>system</strong> actually keeps track of all the authorizations.</p>

<blockquote>
  <p><strong>Authorization Graph</strong></p>

  <ul>
    <li>Authorization Graph Components:
      <ul>
        <li><strong>Nodes</strong> are users</li>
        <li><strong>Arcs/Edges</strong> are privileges passed from one user to the other</li>
        <li><strong>Labels</strong> are the privileges</li>
      </ul>
    </li>
    <li>The system starts with a “``system<code class="language-plaintext highlighter-rouge">” node as a “</code>user`” <em>granting privileges</em>.
      <ul>
        <li>And <strong>for all times</strong>, <strong>all edges/privileges</strong> must be reachable from the <code class="language-plaintext highlighter-rouge">system</code> node. If not, the unreachable privilege will be removed as well.</li>
      </ul>
    </li>
    <li>Cycles are possible</li>
  </ul>
</blockquote>

<h2 id="role-based-authorization">Role-Based Authorization</h2>

<p>The idea is simple:</p>

<ul>
  <li><strong>privileges</strong> are assigned to <strong>roles</strong>.</li>
  <li>which can then be <strong>assigned to a single user or a group of users</strong>.</li>
</ul>

<p>This means that</p>

<ul>
  <li><em>Roles</em> can then be granted to users and to other roles (<em>propagation</em>).</li>
  <li>Reflects how real organizations work.</li>
</ul>

<h1 id="database-application-development">Database Application Development</h1>

<p>This section will talk about:</p>

<ul>
  <li>SQL in application code</li>
  <li>Embedded SQL</li>
  <li>Cursors</li>
  <li>Dynamic SQL</li>
  <li>Via drivers– API calls (eg, JDBC, SQLJ)</li>
  <li>Stored procedures</li>
</ul>

<p>The aim is to talk about: <strong>how to build an application from databases</strong></p>

<h2 id="sql-in-application-code">SQL in Application Code</h2>

<p>In general, there are two approaches:</p>

<ol>
  <li><strong>Embed SQL</strong> in the host language (Embedded SQL, <em>SQLJ</em>)
    <ul>
      <li>in the end, there will be a preprocessor that converts your related code to SQL statements</li>
    </ul>
  </li>
  <li>Create <strong>special API</strong> to call SQL commands (<em>JDBC</em>)
    <ul>
      <li>queries using APIs</li>
    </ul>
  </li>
</ol>

<p>However, this might be a problem:</p>

<blockquote>
  <p><strong>Impedance Mismatch</strong></p>

  <ul>
    <li>SQL relations are <em>(multi-) sets of records</em>, with <strong>no a priori bound on the number of records</strong>.</li>
    <li>No such data structure exist traditionally in procedural programming languages such as C++.
      <ul>
        <li>(Though now: STL)</li>
      </ul>
    </li>
    <li>SQL supports a mechanism, called <strong>cursor</strong>, to handle this.
      <ul>
        <li>i.e. we are <em>retrieving the data in steps</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="embedded-sql">Embedded SQL</h3>

<p>Approach: <em>Embed</em> SQL in the host language.</p>

<ul>
  <li>A preprocessor <em>converts the SQL statements</em> into special API calls.</li>
  <li>Then a regular compiler is used to compile the code.</li>
</ul>

<p><strong>Language constructs</strong>:</p>

<ul>
  <li>
    <p><strong>Connecting</strong> to a database:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXEC SQL CONNECT
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Declaring</strong> variables</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXEC SQL BEGIN (END) DECLARE SECTION
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Statements</strong></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXEC SQL Statement
</code></pre></div>    </div>
  </li>
</ul>

<p><em>For Example: C Application Code</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span>
<span class="kt">char</span> <span class="n">c_sname</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="kt">long</span> <span class="n">c_sid</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">c_rating</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">c_age</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span>
</code></pre></div></div>

<p>so that the SQL interpreter/convertor knows that:</p>

<ul>
  <li>
    <p>the following variables</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="n">c_sname</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="kt">long</span> <span class="n">c_sid</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">c_rating</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">c_age</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>can be <strong>used in queries</strong></p>
  </li>
</ul>

<p>Then, you can do:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SELECT</span>
<span class="n">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">age</span> <span class="n">INTO</span> <span class="o">:</span><span class="n">c_sname</span><span class="p">,</span> <span class="o">:</span><span class="n">c_age</span>
<span class="n">FROM</span> <span class="n">Sailors</span> <span class="n">S</span>
<span class="n">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">Sid</span> <span class="o">=</span> <span class="o">:</span><span class="n">c_sid</span>
</code></pre></div></div>

<p>where the <code class="language-plaintext highlighter-rouge">INTO</code> keywords stores the queried data into host/code variables.</p>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>For <code class="language-plaintext highlighter-rouge">C</code>, there are two special “error” variables:
      <ul>
        <li><code class="language-plaintext highlighter-rouge">SQLCODE</code> (<code class="language-plaintext highlighter-rouge">long</code>, is negative if an error has occurred)</li>
        <li><code class="language-plaintext highlighter-rouge">SQLSTATE</code> (<code class="language-plaintext highlighter-rouge">char[6]</code>, predefined codes for common errors)</li>
      </ul>
    </li>
    <li>However, a problem is that you sometimes <strong>don’t know how many queried data will be returned</strong>
      <ul>
        <li>therefore, you need <strong>Cursors</strong></li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="cursor">Cursor</h3>

<p>The idea is simple:</p>

<ol>
  <li><strong>Declare</strong> a cursor on a relation or query statement</li>
  <li><strong>Open/Call</strong> that cursor, and repeatedly <strong>fetch</strong> a tuple then <strong>move</strong> the cursor, until all tuples have been retrieved.
    <ul>
      <li>basically, you will have an <code class="language-plaintext highlighter-rouge">iterator</code></li>
      <li>Can also modify/delete tuple pointed to by a cursor.</li>
    </ul>
  </li>
</ol>

<p><em>For Example</em></p>

<p>Cursor that gets names of sailors who’ve reserved a red boat, in <em>alphabetical</em> order</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">DECLARE</span> <span class="n">sinfo</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
    <span class="n">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span>
    <span class="n">FROM</span> <span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="n">Boats</span> <span class="n">B</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
    <span class="n">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">sid</span> <span class="n">AND</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">bid</span> <span class="n">AND</span> <span class="n">B</span><span class="p">.</span><span class="n">color</span><span class="o">=</span><span class="err">'</span><span class="n">red</span><span class="err">'</span>
    <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="cm">/* some other code */</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">sinfo</span>
</code></pre></div></div>

<p>In terms of full code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="n">SQLSTATE</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span>
	<span class="kt">char</span> <span class="n">c_sname</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">short</span> <span class="n">c_minrating</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">c_age</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span>

<span class="n">c_minrating</span> <span class="o">=</span> <span class="n">random</span><span class="p">();</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">DECLARE</span> <span class="n">sinfo</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
    <span class="n">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">age</span>
    <span class="n">FROM</span> <span class="n">Sailors</span> <span class="n">S</span>
    <span class="n">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">rating</span> <span class="o">&gt;</span> <span class="o">:</span><span class="n">c_minrating</span>
    <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span>
<span class="k">do</span><span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">FETCH</span> <span class="n">sinfo</span> <span class="n">INTO</span> <span class="o">:</span><span class="n">c_sname</span><span class="p">,</span> <span class="o">:</span><span class="n">c_age</span><span class="p">,</span> <span class="cm">/* does the data iteration */</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s is %d years old</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c_sname</span><span class="p">,</span> <span class="n">c_age</span><span class="p">);</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">SQLSTATE</span> <span class="o">!=</span> <span class="err">'</span><span class="mo">02000</span><span class="err">'</span><span class="p">);</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">sinfo</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SQLSTATE == '02000'</code> means the <em>end of input/cursor</em></li>
</ul>

<h3 id="dynamic-sql">Dynamic SQL</h3>

<p>The idea is that:</p>

<ul>
  <li>the SQL query strings are now <em>dynamic in compile time</em>, based on some of your coding logic</li>
  <li>an example would be the <code class="language-plaintext highlighter-rouge">MyBatis</code> dynamic SQL I used in Spring Boot Projects</li>
</ul>

<h2 id="drivers-and-database-apis">Drivers and Database APIs</h2>

<p>This is the other approach of using <strong>Drivers/APIs</strong></p>

<ul>
  <li>Rather than modify compiler, add library with database calls (API)</li>
  <li>Pass SQL strings from language, presents result sets in a language-friendly way (CBC, JDBC, and others)</li>
  <li>Supposedly <strong>DBMS-neutral</strong>
    <ul>
      <li>a “driver” traps the calls and <em>translates them into DBMS-specific code</em>, by their <strong>specific Drivers</strong></li>
      <li>e.g. the code you write will be the same, but if you <em>change your DBMS</em>, you need to <em>change your drivers</em></li>
    </ul>
  </li>
</ul>

<h2 id="stored-procedures">Stored Procedures</h2>

<p>This is actually <strong>the third approach</strong> of doing this. The idea of a <strong>stored procedure</strong> is:</p>

<ul>
  <li>the application related query is <strong>stored and executed in the DBMS directly</strong>
    <ul>
      <li>of course, they can still have <em>parameters passed in from your code</em></li>
    </ul>
  </li>
  <li>therefore, this is executed in the process space of the server</li>
</ul>

<p><em>For Example</em></p>

<p>First, we <strong>create and store the needed query in DBMS</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">ShowNumReservations</span>
	<span class="k">SELECT</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
	<span class="k">FROM</span> <span class="n">Sailors</span> <span class="n">S</span><span class="p">,</span> <span class="n">Reserves</span> <span class="n">R</span>
	<span class="k">WHERE</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">sid</span>
	<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">S</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">S</span><span class="p">.</span><span class="n">sname</span>
</code></pre></div></div>

<p>where this is just a plain SQL. The more interesting case would be:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">IncreaseRating</span><span class="p">(</span><span class="k">IN</span> <span class="n">sailor_sid</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="k">IN</span> <span class="n">increase</span> <span class="nb">INTEGER</span><span class="p">)</span>
    <span class="k">UPDATE</span> <span class="n">Sailors</span>
    	<span class="k">SET</span> <span class="n">rating</span> <span class="o">=</span> <span class="n">rating</span> <span class="o">+</span> <span class="n">increase</span>
    	<span class="k">WHERE</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">sailor_sid</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">IN</code> means <strong>input parameter form the caller</strong></li>
</ul>

<p>In general:</p>

<ul>
  <li>Stored procedures can have parameters with mode <code class="language-plaintext highlighter-rouge">IN</code>, <code class="language-plaintext highlighter-rouge">OUT</code>, <code class="language-plaintext highlighter-rouge">INOUT</code></li>
</ul>

<h3 id="sqlpsm">SQL/PSM</h3>

<p>Most DBMSs allow users to write <strong>stored procedures</strong> in a simple, <strong>general-purpose language (close to SQL)</strong></p>

<ul>
  <li>examples would be <em>SQL/PSM standard</em></li>
</ul>

<p>The syntax looks like the following:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-13_13-33-16.png" style="zoom:50%;" /></p>

<h1 id="triggers---server-programming">Triggers - Server Programming</h1>

<p>A procedure that <em>starts automatically when a specified change occurs</em></p>

<ul>
  <li>Changes could be: <code class="language-plaintext highlighter-rouge">INSERT</code>, <code class="language-plaintext highlighter-rouge">UPDATE</code>, <code class="language-plaintext highlighter-rouge">DELETE</code> (others too)</li>
</ul>

<blockquote>
  <p><strong>Triggers</strong></p>

  <ul>
    <li>
      <p>Think of triggers having three parts (ECA Components)</p>

      <ul>
        <li><strong>Event</strong> associated with the trigger</li>
        <li><strong>Condition</strong> (optional) – should it be fired?</li>
        <li><strong>Action</strong> – the trigger procedure/function/what should be executed</li>
      </ul>
    </li>
    <li>
      <p>Can be attached to <em>both tables and views</em></p>
    </li>
    <li>
      <p>Some possible timings that you can specify for a trigger to happen is</p>

      <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-13_13-53-01.png" style="zoom:80%;" /></p>

      <p>where:</p>

      <ul>
        <li><code class="language-plaintext highlighter-rouge">before</code> means before the evaluation of the <code class="language-plaintext highlighter-rouge">event</code></li>
        <li><code class="language-plaintext highlighter-rouge">after</code> means after</li>
        <li><code class="language-plaintext highlighter-rouge">instead of</code> means, <em>exactly at the point when trigger condition is met</em>, <strong>stop the execution of your program</strong>, and <strong>start trigger</strong></li>
        <li><code class="language-plaintext highlighter-rouge">synchronous</code> means execute the trigger right after your program/event</li>
        <li><code class="language-plaintext highlighter-rouge">asynchronous</code> means execute the trigger asynchronously when the condition is met. So it does not stop the execution of your program</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>However, sometimes you might need to <strong>consider</strong>:</p>

<ul>
  <li>
    <p>Trigger should happen at what <strong>granularity</strong> of invocation? Record (row) level or statement level?</p>

    <ul>
      <li>A <em>row-level trigger</em> is invoked once for each row affected by the triggering statement</li>
      <li>A <em>statement-level trigger</em> is invoked only once, regardless of the number of rows affected by the triggering statement</li>
    </ul>
  </li>
  <li>
    <p>Hard to determine <strong>chain</strong> of events</p>

    <ul>
      <li>cascading triggers</li>
      <li><em>recursive invocation (potentially endless)</em> of the same triggers possible</li>
    </ul>
  </li>
  <li>
    <p><strong>Transactional</strong> issues; trigger could be seen as</p>

    <ul>
      <li>part of the triggering statement or</li>
      <li>independent action</li>
    </ul>

    <p>i.e. should the <em>trigger be aborted if the transaction is aborted?</em></p>
  </li>
</ul>

<blockquote>
  <p><strong>Difference between Constraints and Triggers</strong></p>

  <ul>
    <li><strong>Constraints</strong> describe what the database’s state is (they have to be <code class="language-plaintext highlighter-rouge">TRUE</code> or else … )
      <ul>
        <li>The effects of constraints are known – no mystery if a constraint is violated (gives error)</li>
        <li>They do not change the state of the database</li>
      </ul>
    </li>
    <li><strong>Triggers</strong> are <strong>programs</strong> - very <em>flexible</em> mechanism
      <ul>
        <li>theoretically, you might not be entirely sure what happens when a trigger is executed</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="order-of-execution">Order of Execution</h2>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>Triggers can be configured at many different timings</li>
    <li>The granularity of trigger could be row level of statement level</li>
  </ul>
</blockquote>

<ul>
  <li><strong>Statement</strong>-level BEFORE triggers
    <ul>
      <li>fire before the statement starts to do anything</li>
    </ul>
  </li>
  <li><strong>Statement</strong>-level AFTER triggers
    <ul>
      <li>fire at the very end of the statement</li>
    </ul>
  </li>
  <li><strong>Row</strong>-level BEFORE triggers
    <ul>
      <li>fire immediately before a row is operated on</li>
    </ul>
  </li>
  <li><strong>Row</strong>-level AFTER triggers
    <ul>
      <li>fire at the end of the each row operation (before statement-level AFTER triggers)</li>
    </ul>
  </li>
  <li><strong>Row</strong>-level INSTEAD OF triggers (<em>on views only</em>)
    <ul>
      <li>fire immediately as each row in the view is identified as needing to be operated on.</li>
    </ul>
  </li>
</ul>

<p>If <strong>more than one trigger is defined</strong> for the same event/relation</p>

<ul>
  <li>execute them In <strong>alphabetical order</strong> by trigger name!</li>
</ul>

<h3 id="condition-in-triggers">Condition in Triggers</h3>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>Recall that a triggers having three parts (ECA Components)
      <ul>
        <li><strong>Event</strong> associated with the trigger</li>
        <li><strong>Condition</strong> (optional) – should it be fired?</li>
        <li><strong>Action</strong> – the trigger procedure/function/what should be executed</li>
      </ul>
    </li>
    <li>Now, we want to look at what <strong>conditions</strong> can be specified</li>
  </ul>
</blockquote>

<p>Commonly:</p>

<blockquote>
  <p><strong>`WHEN Condition</strong></p>

  <ul>
    <li>
      <p>If it exists, the condition needs to be true for the trigger to fire</p>

      <ul>
        <li>e.g., <code class="language-plaintext highlighter-rouge">WHEN time-of-day() &gt; 9:30:05</code></li>
      </ul>
    </li>
    <li>
      <p>Only for <strong>row-level <code class="language-plaintext highlighter-rouge">AFTER</code> triggers</strong>, the trigger’s condition can examine the values of the columns of</p>

      <ul>
        <li>the <strong>OLD row</strong> (<em>before</em> an UPDATE or DELET)</li>
        <li>and the <strong>NEW row</strong> (<em>after</em> an UPDATE or DELET)</li>
      </ul>

      <p>in order words, you can <strong>use the parameters <code class="language-plaintext highlighter-rouge">old</code> and <code class="language-plaintext highlighter-rouge">new</code>:</strong></p>

      <ul>
        <li>e.g. <code class="language-plaintext highlighter-rouge">WHEN new.salary &gt; 10*old.salary</code>.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="examples-of-triggers">Examples of Triggers</h2>

<p><strong>Syntax</strong>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">name</span> 
	<span class="p">[</span><span class="k">BEFORE</span> <span class="o">|</span> <span class="k">AFTER</span> <span class="o">|</span> <span class="k">INSTEAD</span> <span class="k">OF</span> <span class="p">]</span> <span class="n">event_list</span> <span class="k">ON</span> <span class="k">table</span> 
	<span class="p">[</span><span class="k">WHEN</span> <span class="n">trigger_qualifications</span><span class="p">]</span> 
	<span class="p">[</span><span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">procedure</span> <span class="o">|</span> 
     <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">STATEMENT</span> <span class="k">procedure</span> <span class="p">]</span> 
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><strong>Event</strong> -&gt; <code class="language-plaintext highlighter-rouge">event_list ON table </code>
    <ul>
      <li>activates the trigger</li>
    </ul>
  </li>
  <li><strong>Condition</strong> -&gt; <code class="language-plaintext highlighter-rouge">WHEN trigger_qualifications</code>
    <ul>
      <li>should it be fired?</li>
    </ul>
  </li>
  <li><strong>Action</strong> -&gt; <code class="language-plaintext highlighter-rouge">[FOR EACH ROW procedure | FOR EACH STATEMENT procedure ] </code>
    <ul>
      <li>the actual procedure to run</li>
    </ul>
  </li>
</ul>

<p>Then some examples would be:</p>

<p><em>For Example</em></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">init_count</span> <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Students</span> 
	<span class="k">DECLARE</span> <span class="k">count</span> <span class="nb">INTEGER</span><span class="p">;</span> <span class="cm">/* like a GLOBAL VARIABLE */</span>
	<span class="k">BEGIN</span> 
		<span class="k">count</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span> 
	<span class="k">END</span> 
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>
    <p>the <strong>Event</strong> is <code class="language-plaintext highlighter-rouge">BEFORE INSERT ON Students</code></p>
  </li>
  <li>
    <p>the <strong>Action</strong> is:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="k">count</span> <span class="nb">INTEGER</span><span class="p">;</span> 
<span class="k">BEGIN</span> 
	<span class="k">count</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span> 
<span class="k">END</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>the <code class="language-plaintext highlighter-rouge">DECLARE count INTEGER;</code> is like a global variable declared</p>
  </li>
</ul>

<p>and then</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">incr_count</span> <span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Students</span>
	<span class="k">WHEN</span> <span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>  
	<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>  
	<span class="k">BEGIN</span> 
		<span class="k">count</span> <span class="p">:</span><span class="o">=</span> <span class="k">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> 
	<span class="k">END</span>
</code></pre></div></div>

<hr />

<p><em>For Example</em></p>

<p>If we want to populate data into <em>another table automatically</em>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">stats</span> <span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Students</span> 
	<span class="k">REFERENCING</span> <span class="k">NEW</span> <span class="k">TABLE</span> <span class="n">Stats</span>  <span class="cm">/* if we want to modify/deal with other tables */</span>
	<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">STATEMENT</span> 
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Stats</span>
    	<span class="k">SELECT</span> <span class="n">age</span><span class="p">,</span> <span class="k">AVG</span><span class="p">(</span><span class="n">gpa</span><span class="p">)</span> 
    	<span class="k">FROM</span> <span class="n">Students</span> 
    	<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">age</span> 
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>now, after you insert <em>new data into <code class="language-plaintext highlighter-rouge">Students</code></em>, the table <code class="language-plaintext highlighter-rouge">Stats</code> will <strong>also be populated</strong></li>
</ul>

<h1 id="normal-forms">Normal Forms</h1>

<p>This section talks about Schema Refinement and Normal Forms.</p>

<blockquote>
  <p><strong>The Evils of Redundancy</strong></p>

  <ul>
    <li><strong>Redundancy</strong> is at the root of several problems associated with relational schemas:
      <ul>
        <li>redundant storage, insert/delete/update anomalies</li>
      </ul>
    </li>
    <li><strong>Main refinement</strong> technique:  <strong>decomposition</strong> (replacing ABCD with, say, AB and BCD, or ACD and ABD).
      <ul>
        <li>in  the end, we should have tables with a <strong>single, clear</strong> <em>functional dependency</em>.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="functional-dependency">Functional Dependency</h2>

<blockquote>
  <p><strong>Functional Dependency</strong></p>

  <ul>
    <li>A functional dependency $X  \to  Y$ holds over relation $R$ if, for <em>every instance</em> $r$ of $R$:
      <ul>
        <li>i.e. given two tuples in $r$, <strong>if the $X$ values agree, then the $Y$ values must also agree.</strong>  (X and Y are sets of attributes.). An example would be $X$ being the <em>primary key of a table $r$</em></li>
      </ul>
    </li>
    <li>In fact, this means if $K$ is a <em>candidate key</em> of $R$, then $K \to R$</li>
  </ul>
</blockquote>

<p>Note that the above notation $X → Y$ is read as:</p>

<ul>
  <li>$X$ functionally determines $Y$</li>
  <li>or $Y$ functionally depends on $X$</li>
</ul>

<p><em>For Example</em></p>

<p>Consider the schema:</p>

<ul>
  <li>Consider relation obtained from <code class="language-plaintext highlighter-rouge">Hourly_Emps (ssn, name, lot, rating, hrly_wages, hrs_worked)</code></li>
</ul>

<p>We denote this relation schema by <strong>listing the attributes</strong>:  <code class="language-plaintext highlighter-rouge">SNLRWH</code></p>

<ul>
  <li>This is really the <em>set of attributes</em> <code class="language-plaintext highlighter-rouge">{S,N,L,R,W,H}</code></li>
</ul>

<p>Then some <strong>functional dependencies include</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ssn</code> is the key:    $S \to SNLRWH $</li>
  <li><code class="language-plaintext highlighter-rouge">rating</code> determines <code class="language-plaintext highlighter-rouge">hourly_wages</code>:  $R \to W$</li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>the reverse is often not true, i.e. you <em>might not</em> have $W \to R$
      <ul>
        <li>if $R = 10 \to W =100$, and $R=11 \to W=110$</li>
        <li>obviously, reversing does not work</li>
      </ul>
    </li>
  </ul>
</blockquote>

<hr />

<p><em>For Example: Functional Dependency</em></p>

<p>Instead of having:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_11-45-10.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>$R\to W$, so that $W$ actually <strong>does not depend no $S$, but $R$!</strong></li>
</ul>

<p>then you have the following problem <em>due to redundancy</em></p>

<blockquote>
  <p><strong>Update anomaly</strong>:</p>

  <ul>
    <li>Can we change $W$ in <em>just the1st tuple</em> of $SNLRWH$? (without messing up the mapping $R\to W$)</li>
  </ul>

  <p><strong>Insertion anomaly</strong>:</p>

  <ul>
    <li>What if we want to insert an employee and don’t know the hourly wage for his rating?</li>
  </ul>

  <p><strong>Deletion anomaly</strong>:</p>

  <ul>
    <li>If we delete all employees with rating $5$, we lose the information about the wage for rating $5$!</li>
  </ul>
</blockquote>

<p>Therefore:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_11-47-00.png" style="zoom:50%;" /></p>

<p>where now:</p>

<ul>
  <li>
    <p>the <strong>table makes it clear that</strong>: $S \to R$, and then $R \to W$</p>
  </li>
  <li>
    <p>no <em>redundancy and clear functional dependencies</em></p>
  </li>
</ul>

<blockquote>
  <p><strong>Checking Functional Decomposition</strong></p>

  <ul>
    <li>
      <p>we have decomposed the schema to better forms. To check if it is correct:</p>

      <ol>
        <li>
          <p><strong>perform a <code class="language-plaintext highlighter-rouge">JOIN</code></strong> and see if the table matches the original one</p>
        </li>
        <li>
          <p>the two tables solution means that it <strong>must be</strong></p>

          <ul>
            <li>$S \to R$</li>
            <li>$R \to W$</li>
          </ul>

          <p>hence two tables. But if $R \text{ and } H\to W$, then the above design would not work</p>
        </li>
      </ol>
    </li>
  </ul>
</blockquote>

<h3 id="properties-of-functional-dependency">Properties of Functional Dependency</h3>

<p>Some obvious ones are</p>

<blockquote>
  <p><strong>Armstrong’s Axioms</strong></p>

  <ul>
    <li>Armstrong’s Axioms (X, Y, Z are sets of attributes):
      <ul>
        <li><strong>Reflexivity</strong>:  If  $Y \subseteq X$,  then   $X \to Y$
          <ul>
            <li>e.g. $Y =  BC, X=ABC$, then obviously $ABC \to BC$</li>
          </ul>
        </li>
        <li><strong>Augmentation</strong>:  If  $X \to Y$,  then   $XZ \to YZ$   for any Z
          <ul>
            <li>(Note: the opposite is not true!)</li>
          </ul>
        </li>
        <li><strong>Transitivity</strong>:  If  $X \to Y$  and  $Y \to Z$,  then   $X \to Z$</li>
      </ul>
    </li>
    <li>Following from the axioms are:
      <ul>
        <li><strong>Union</strong>:   If $X \to Y$  and  $X \to Z$, then  $X \to YZ$</li>
        <li><strong>Decomposition</strong>:  If $X \to YZ$,   then  $X \to Y$  and  $X \to Z$</li>
      </ul>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Closure Property</strong></p>

  <ul>
    <li>the set of all FDs are <strong>closed</strong>.
      <ul>
        <li>recall that closure means if $F$ is the set of FDs, and I apply functional dependencies on the elements of the set, am I <em>still inside $F$</em>? (not getting anything new).</li>
        <li>e.g. $F = {A \to B,  B \to C,  C D \to E }$ , can you <em>cannot get</em> $A\to E$. Otherwise it is <em>not closed.</em></li>
      </ul>
    </li>
    <li>proof see page 9-10 of PPT</li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_12-05-00.png" style="zoom:80%;" /></p>

<p>Then, this means that:</p>

<ul>
  <li>$JP \to CSJDPQV$
    <ul>
      <li>because $JP \to C$,  $C \to CSJDPQV$   using <strong>transitivity</strong></li>
    </ul>
  </li>
  <li>and then $SDJ \to JP$
    <ul>
      <li>because $SD \to P$, using <strong>augmentation</strong></li>
    </ul>
  </li>
  <li>and hence that $SDJ \to CSJDPQV$
    <ul>
      <li>because $SDJ \to JP$,   $JP \to  CSJDPQV$</li>
    </ul>
  </li>
</ul>

<p>So I get <em>two primary keys</em></p>

<ol>
  <li>$JP \to CSJDPQV$</li>
  <li>$SDJ \to CSJDPQV$</li>
</ol>

<hr />

<p><em>For Example: Closure</em></p>

<p>Consider:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_12-49-07.png" style="zoom: 33%;" /></p>

<p>then we can get:
\(F_A^+ = \{ A \to A, A\to BE, A\to ABCDE\}\)
where:</p>

<ul>
  <li>$A \to ABCDE$ is derived from the given FDs in the set $R$, since
    <ul>
      <li>$A \to ABE$ is clear,</li>
      <li><strong>then using</strong> $(2)$, means $A \to ABCE$,</li>
      <li><strong>then using</strong> $(3)$, means $A \to ABCDE$</li>
    </ul>
  </li>
</ul>

<h2 id="boyce-codd-normal-form">Boyce-Codd Normal Form</h2>

<blockquote>
  <p><strong>Why Normal Forms</strong></p>

  <ul>
    <li>If a relation is in a certain normal form (BCNF, 3NF etc.), it is known that certain kinds of problems are avoided/minimized.</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>BCNF</strong></p>

  <ul>
    <li>relation $R$ is in BCNF if, for all $X\to A$  in the close of $F$ (i.e. $F^+$)
      <ul>
        <li>$A \in X$   (called a trivial FD),</li>
        <li>or $X$ contains a <em>key</em> for R (i.e., X is a superkey)</li>
      </ul>
    </li>
    <li>In other words, R is in BCNF if the <strong>only non-trivial FDs</strong> that hold over R are <strong>key constraints</strong>.
      <ul>
        <li>i.e. only dependencies are the <em>single primary key</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="third-normal-form">Third Normal Form</h2>

<p>This basically is the most used form for designing database.</p>

<ul>
  <li>though there are still some <em>redundancy</em></li>
</ul>

<blockquote>
  <p><strong>Third Normal Form</strong></p>

  <ul>
    <li>Relation $R$ with FDs $F$ is in 3NF if, for all $X \to A$  in $F^+$
      <ul>
        <li>$A \in X$   (called a trivial FD),</li>
        <li>$X$ contains a <em>key</em> for R (i.e., X is a superkey)</li>
        <li><strong>$A$ is part of some key for $R$.</strong></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>note that:</p>

<ul>
  <li>obviously if $R$ is in BCNF, it is also in 3NF.</li>
</ul>

<h2 id="problems-with-decomposition">Problems with Decomposition</h2>

<blockquote>
  <p><strong>Three Problems with Decomposition</strong></p>

  <ol>
    <li>Some queries become more <em>expensive</em>.</li>
    <li><strong>Lossless-join</strong>:
      <ul>
        <li>Given instances of the decomposed relations, we may not be able to <em>reconstruct the corresponding instance</em> of the original relation!</li>
      </ul>
    </li>
    <li><strong>Dependency preserving</strong>:
      <ul>
        <li>Checking some dependencies may require joining the instances of the decomposed relations.</li>
      </ul>
    </li>
  </ol>
</blockquote>

<p>note that:</p>

<ul>
  <li>3NF does not have those problems, but BCNF will</li>
  <li>but 3NF might be redundant, yet BCNF will not</li>
</ul>

<h3 id="lossless-join-decomposition">Lossless Join Decomposition</h3>

<blockquote>
  <p><strong>Lossless Join</strong></p>

  <ul>
    <li>Decomposition of $R$ into $X$ and $Y$ is lossless-join w.r.t. a set of FDs $F$ if, for <em>every instance $r$ that satisfies $F$</em>:
      <ul>
        <li>$\pi_x(r) \bowtie \pi_y(r) = r$</li>
        <li>i.e. we can reconstruct $r$ if decomposed in $X,Y$</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p>The following decomposition is <em>not lossless</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_12-34-07.png" alt="" /></p>

<p>since joining back gives</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_12-34-37.png" alt="" /></p>

<h3 id="dependency-preserving-decomposition">Dependency Preserving Decomposition</h3>

<blockquote>
  <p><strong>Dependency Preserving</strong></p>

  <ul>
    <li>(Intuitive) If $R$ is decomposed into $X$, $Y$ and $Z$, and we enforce the FDs that hold on X, on Y and on Z, then all FDs that were given to hold on R must also hold
      <ul>
        <li>i.e. if $R$ has FDs of $F^+$, then it must be that the union $F_X^+ \cup F_Y^+ \cup F_Z^+ = F^+$, so that functional dependencies are not <em>lost</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<ul>
  <li>relation $ABC$, with functional dependencies $A \to B, B\to C, C\to A$</li>
</ul>

<p>If we have decomposed into</p>

<ul>
  <li>$AB$, $BC$</li>
</ul>

<p>then we see that the functional dependency:</p>

<ul>
  <li>$C \to A$ <em>is not preserved</em></li>
</ul>

<h1 id="object-relational-dbms">Object Relational DBMS</h1>

<p>First, let us look at Object Oriented vs Relational</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_12-59-10.png" style="zoom: 67%;" /></p>

<p>so that most of them is not there.</p>

<p>Now, the <strong>implemented Object-Relational DBMS</strong> have</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_13-00-30.png" style="zoom:67%;" /></p>

<p><em>For Example</em></p>

<p>In ORDBMS, then Schema <strong>may</strong> look like this</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_13-02-03.png" style="zoom: 33%;" /></p>

<p>and the SQL <strong>may</strong> look like:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_13-05-50.png" style="zoom:33%;" /></p>

<p>where the new functionalities would be:</p>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td><strong>User-defined functions</strong> (e.g., sunset) and operators (e.g.,</td>
          <td>20</td>
          <td>)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li><strong>Composite data types</strong> (e.g., document, point)</li>
  <li><strong>Performance</strong>: a query optimizer aware of “expensive functions” like sunset</li>
</ul>

<h2 id="ordbms-ddl-statements">ORDBMS DDL Statements</h2>

<p>Most straightforward by an example:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_13-20-52.png" style="zoom: 67%;" /></p>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">REF IS SYSTEM GENERATED</code> means that you want the <em>system to generate reference ids</em>, so that you can “dereference” it and <em>find the object</em></li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">CREATE TABLE Theaters OF theater_t REF is tid SYSTEM GENERATED </code> means the table <em>contains rows of <code class="language-plaintext highlighter-rouge">theater_t</code></em>, and the reference (column) of each object is called <code class="language-plaintext highlighter-rouge">tid</code>, which is <code class="language-plaintext highlighter-rouge">SYSTEM GENERATED</code></p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">CREATE TABLE Nowshowing (film integer, theater ref(theater_t) SCOPE Theaters,...) </code> means that
    <ul>
      <li><code class="language-plaintext highlighter-rouge">theater ref(theater_t)</code> means a column <code class="language-plaintext highlighter-rouge">theater</code> <em>contains a pointer/reference to ANY object of type <code class="language-plaintext highlighter-rouge">theater_t</code></em></li>
      <li><code class="language-plaintext highlighter-rouge">theater ref(theater_t) SCOPE Theaters</code> means that column can <strong>only point</strong> to <code class="language-plaintext highlighter-rouge">theater_t</code> objects in the table <code class="language-plaintext highlighter-rouge">Theaters</code></li>
    </ul>
  </li>
  <li>` stars VARCHAR(25) ARRAY [10], ` means an array of size 10 containing <code class="language-plaintext highlighter-rouge">VARCHAR(25)</code>
    <ul>
      <li>then accessing the first name would be of table <code class="language-plaintext highlighter-rouge">File f</code> by <code class="language-plaintext highlighter-rouge">f.stars[0]</code> in a query</li>
    </ul>
  </li>
</ul>

<h2 id="inheritance">Inheritance</h2>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>in the end, the ORDBMS combines:
      <ul>
        <li>the <em>structuring</em> idea from Objected-Oriented</li>
        <li>the actual queries/storage from the relational DBMS
          <ul>
            <li>so that in the end, everything is <em>still about tables/sets</em></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-20_13-30-25.png" style="zoom: 67%;" /></p>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">UNDER theater_t (menu text)</code> means <strong>extending</strong><code class="language-plaintext highlighter-rouge">theater_t</code> type, and <em>adding an attribute</em> <code class="language-plaintext highlighter-rouge">menu</code> of type <code class="language-plaintext highlighter-rouge">text</code>
    <ul>
      <li>this is structure inheritance</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">CREATE TABLE Theater_Cafes ... UNDER Theaters</code> means the table <code class="language-plaintext highlighter-rouge">Theater_Cafes</code> is a <strong>subset</strong> of the table <code class="language-plaintext highlighter-rouge">Theaters</code>
    <ul>
      <li>hence, by default, queries over <code class="language-plaintext highlighter-rouge">Theaters</code> are <strong>also evaluated over <code class="language-plaintext highlighter-rouge">Theater_cafes</code></strong> (and all other potential subclasses at the time of evaluation)</li>
      <li>if you don’t want to do that, you can use <code class="language-plaintext highlighter-rouge">ONLY</code></li>
    </ul>
  </li>
</ul>

<h1 id="storage-and-indexing">Storage and Indexing</h1>

<p>This section is about <strong>performance</strong>. First, we need to understand how this is stored.</p>

<blockquote>
  <p><strong>Main memory (RAM)</strong> –while fast</p>

  <ul>
    <li>It is volatile –we lose data between runs</li>
    <li>100x more expensive than HD, 20x than SSD</li>
  </ul>

  <p><strong>Solid state drive (SSD, flash)</strong></p>

  <ul>
    <li>Limit max capacity (2-4TB?)</li>
    <li>faster than HD, more durable than HD, no noise</li>
  </ul>
</blockquote>

<p><strong>Typical storage hierarchy</strong>:</p>

<ol>
  <li>Main memory (RAM) for currently used data.</li>
  <li>(Solid state, not widely used yet but it will soon)</li>
  <li>Disks for the main database (secondary storage).</li>
  <li>(In the past) Tapes for archiving older versions of the data (tertiary storage); not used for the operational part of the DB.</li>
</ol>

<h2 id="hard-disk">Hard Disk</h2>

<blockquote>
  <p><strong>Components of a Disk</strong></p>

  <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_11-45-52.png" style="zoom:50%;" /></p>

  <p>where:</p>

  <ul>
    <li><strong>read/write head</strong> writes and reads data from platters
      <ul>
        <li>only one of the heads will read/write at any time</li>
        <li>the <em>smallest unit of reading is a Block size</em> - a multiple of sector size (which is fixed).</li>
      </ul>
    </li>
    <li><strong>platters</strong> spin (e.g. at 90rps)</li>
    <li><strong>arm assembly</strong> is moved in or out to position  a head on a desired track. Tracks under heads  make    a cylinder(imaginary!).</li>
  </ul>
</blockquote>

<p>Now, for <strong>software</strong> such as DBMS, (e.g. Oracle), we use a <strong>page</strong> as the minimal unit of data access</p>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>A <strong>page</strong> is a multiple of disk blocks – the page size is determined by the DBMS or any other software using disks e.g. OS.
      <ul>
        <li>Examples: 4K, 8K, 16K.</li>
        <li><em>READ</em>: transfer data (a number of <em>disk blocks</em>) from disk <em>to main memory (RAM).</em></li>
        <li><em>WRITE</em>: transfer data (a number of <em>disk blocks</em>) from RAM <em>to disk.</em></li>
        <li>Both are <strong>high-cost operations</strong>, relative to in-memory operations, so must be planned carefully!</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>We care about this because:</p>

<ul>
  <li>Unlike RAM, time to retrieve a disk page varies <strong>depending</strong> upon <strong>location</strong> on <strong>disk</strong>.</li>
  <li>Therefore, relative placement of pages on disk has <strong>major impact on DBMS performance!</strong></li>
</ul>

<h3 id="accessing-a-disk-page">Accessing a Disk Page</h3>

<blockquote>
  <p><strong>Time to Access a Disk Block</strong></p>

  <ul>
    <li>Time to access (read/write) a disk block:
      <ol>
        <li><strong>seek time</strong> (moving arms to position disk head on track) +</li>
        <li><strong>rotational delay</strong> (waiting for block to rotate under head) +</li>
        <li><strong>transfer time</strong> (actually moving data to/from disk surface)</li>
      </ol>
    </li>
  </ul>
</blockquote>

<p><strong>Seek time</strong> and rotational delay <strong>dominate</strong>.</p>

<ul>
  <li><strong>Seek time</strong> varies from about 1 to 20msec</li>
  <li>Rotational delay varies from 0 to 10msec</li>
  <li>Transfer rate is about 1msec per 4KB page</li>
</ul>

<p>So we want to optimize for <strong>performance</strong>, so we want to:</p>

<ul>
  <li>
    <p>if possible, attempt to <em>reduce seek time</em></p>
  </li>
  <li>
    <p><strong>reduce number of disk access <code class="language-plaintext highlighter-rouge">I/O</code></strong></p>
  </li>
</ul>

<p><em>For Example</em></p>

<blockquote>
  <p>Usually, we assuming that a <strong>page in OS</strong> correspond to <strong>continuous blocks in disk</strong></p>
</blockquote>

<p>If we want to read <em>one page</em> of<code class="language-plaintext highlighter-rouge">page_id=1</code> in <strong>one request/system call</strong></p>

<ul>
  <li>the # disk access would be 1</li>
</ul>

<p>If we want to read <em>8 pages</em> starting from <code class="language-plaintext highlighter-rouge">page_id=5</code> in <strong>one request/system call</strong></p>

<ul>
  <li>still 1 disk access, since data is <strong>contiguous</strong></li>
</ul>

<p>If we want to read <em>8 pages</em> starting from <code class="language-plaintext highlighter-rouge">page_id=5</code> in <strong>eight request/system calls</strong></p>

<ul>
  <li>then 8 disk accesses</li>
</ul>

<p>If we want to read the entire database in <strong>one request/system call</strong></p>

<ul>
  <li>then there will be <strong>many disk accesses</strong>, since the database is of course not an entire, consecutive pages in the hard disk</li>
</ul>

<hr />

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>For a sequential scan, pre-fetching several pages at a time is a big win!</li>
  </ul>
</blockquote>

<h2 id="disk-space-management">Disk Space Management</h2>

<p><strong>Lowest layer</strong> of DBMS software <strong>manages space on disk</strong>.</p>

<p><strong>Higher levels</strong> call upon this layer to:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">allocate(int n)</code>: <strong>allocate</strong> <code class="language-plaintext highlighter-rouge">n</code> pages, return the page id of the first page of the sequence of <code class="language-plaintext highlighter-rouge">n</code> pages
    <ul>
      <li>i.e. <code class="language-plaintext highlighter-rouge">allocate(8)</code> would give you the first page of <em>eight consecutive pages</em>, yet <code class="language-plaintext highlighter-rouge">8*allocate(1)</code> would <em>not be guaranteed</em> to give you eight consecutive pages</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">deallocate(int pid, int n)</code>: <strong>free</strong> <code class="language-plaintext highlighter-rouge">n</code> consecutive pages starting at page id <code class="language-plaintext highlighter-rouge">pid</code></li>
</ul>

<p>Additionally, there is of course a <strong>“page cache”</strong>:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_13-05-32.png" style="zoom: 80%;" /></p>

<p>where:</p>

<ul>
  <li>database uses its own “page cache”, though the idea is the same
    <ul>
      <li>it is not using the OS’s page cache, in order for <em>portability and compatibility</em> on different devices</li>
    </ul>
  </li>
  <li>additionally, if we implement this on a <em>database level</em>, we can also:
    <ul>
      <li><strong>pin</strong> a page in buffer pool, <strong>force a page</strong> to disk (important for implementing CC &amp; recovery)</li>
      <li><strong>adjust replacement policy</strong>, and pre-fetch pages based on access patterns in typical DB operations</li>
    </ul>
  </li>
</ul>

<h3 id="page-formats-variable-length-records">Page Formats: Variable Length Records</h3>

<p>This is how the DMBS manages its actual data in pages:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_13-25-16.png" style="zoom:50%;" /></p>

<p>where there are <strong>three approach</strong> <em>identify</em> memory with a database record. When a new database record is inserted</p>

<ol>
  <li>a <strong>new logical id</strong> will be created (which maps to the physical address), then the id is the <em>logical id</em>
    <ul>
      <li>so to find the actual data, you need to do <strong>two things</strong>, translate the mapping and access the address</li>
      <li>however, this is <strong>more flexible</strong> since if you moved the data, you only need to change the <em>mapping</em></li>
    </ul>
  </li>
  <li>the id of the record will be the <em>physical address</em>
    <ul>
      <li>to find the actual data, you just need to do <strong>one thing</strong></li>
      <li>however, this is <strong>less flexible</strong> (as id cannot change) if you have moved some data</li>
    </ul>
  </li>
  <li>the id is a <strong>combination of the actual page id and a slot number</strong> (basically an offset)
    <ul>
      <li>this is the <strong>diagram in the above</strong>, you use <code class="language-plaintext highlighter-rouge">rid</code> for id</li>
      <li>then, you have <strong>both the physical address of page</strong>, but also <strong>flexibility WITHIN the page</strong> (i.e. you can change the offset/slot number)</li>
    </ul>
  </li>
</ol>

<h3 id="files-of-records">Files of Records</h3>

<p>Page or block is OK when doing I/O, but <strong>higher levels</strong> of DBMS operate on <strong>records</strong>, and <strong>files of records.</strong></p>

<blockquote>
  <p><strong>File:</strong></p>

  <ul>
    <li>A <em>collection of pages</em>, each containing a collection of records.</li>
    <li>Must support the ability to:
      <ul>
        <li>insert/delete/modify record</li>
        <li>read a particular record (specified using record id)</li>
        <li><em>scan</em> all records (possibly with some conditions on the records to be retrieved)
          <ul>
            <li>e.g. <code class="language-plaintext highlighter-rouge">select ... from ...</code></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>Then, the questions comes down to how the DMBS:</p>

<ul>
  <li><strong>stores files of records</strong> (i.e. collection of pages that contains your data) in the memory</li>
</ul>

<h3 id="unordered-heap-file">Unordered (Heap) File</h3>

<p>As <strong>file</strong> grows and shrinks, disk pages are allocated and de-allocated.</p>

<p>To support record level operations, we must:</p>

<ul>
  <li>keep track of the pages in a file</li>
  <li>keep track of free space on pages</li>
  <li>keep track of the records on a page (e.g. via <code class="language-plaintext highlighter-rouge">rid</code>)</li>
</ul>

<p><em>Example: Heap File Implemented as List</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_13-35-01.png" style="zoom:50%;" /></p>

<hr />

<p><em>Example:</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_13-40-25.png" style="zoom:67%;" /></p>

<hr />

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>In both of the above implementation, finding a <em>specific page</em> requires <strong>$O(N)$ Disk Accesses</strong>, where $N=\text{number of pages of the file/a header}$</li>
  </ul>
</blockquote>

<h2 id="index-file">Index File</h2>

<blockquote>
  <p><strong>Search Key</strong></p>

  <ul>
    <li>It has nothing to do with a primary key/any key in a table</li>
    <li>It is the <strong>key that DBMS can then use to perform search faster</strong>
      <ul>
        <li>e.g. you want to look up students with <code class="language-plaintext highlighter-rouge">gpa&gt;3.0</code>, then you should build an <strong>index with search key =<code class="language-plaintext highlighter-rouge">gpa</code></strong></li>
        <li>Any subset of the fields of a relation can built to be the search key for an index on the relation.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Index</strong></p>

  <ul>
    <li>An <strong>index</strong> on a file speeds up selections <strong>on the search key fields</strong> for the index.</li>
    <li>An index contains a collection of <strong>data entries</strong>, and supports efficient retrieval of <strong>all data entries <code class="language-plaintext highlighter-rouge">k*</code></strong> with a <strong>given key value <code class="language-plaintext highlighter-rouge">k</code>.</strong>
      <ul>
        <li>for example, <code class="language-plaintext highlighter-rouge">k=3.0</code> could have data entry <code class="language-plaintext highlighter-rouge">k*</code> which contains <em>all records of student with <code class="language-plaintext highlighter-rouge">gpa=3.0=k</code></em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p>If you want find <em>all students with <code class="language-plaintext highlighter-rouge">gpa&gt;3.0</code></em>, then</p>

<ol>
  <li>build an index on the search key = <code class="language-plaintext highlighter-rouge">gpa</code></li>
  <li>do a binary search (assuming index is sorted)</li>
</ol>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_14-02-20.png" alt="" /></p>

<p>where now the <strong>search operation will be $O(log(N))$ of Disk Accesses!</strong></p>

<h3 id="hash-based-indexing">Hash-Based Indexing</h3>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_14-09-49.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li>
    <p>we have a hash function $h(k)$, which takes a parameter $k=key$:
\(h(k) \text{ mod } N\)</p>
  </li>
  <li>
    <p>then the Disk Access is in $O(M)$ for <strong>look ups</strong>, where $M$ is the <strong>number of overflow pages in a bucket</strong></p>

    <ul>
      <li>in general, this will be small ($O(M) \approx 1.2$), but we can optimize anyway by:</li>
      <li><em>increase the number of buckets</em></li>
      <li>hash function that <em>evenly distribute the entries</em></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p><strong>Advantage</strong></p>

  <ul>
    <li>In other words, Hash-Based indexing is <em>really fast for equality searches</em></li>
  </ul>

  <p><strong>Disadvantage</strong></p>

  <ul>
    <li>this is bad if we need $\le$ or $\ge$, because we have eventually <em>lost the $key$ information into $h(k) \text{ mod } N$</em>
      <ul>
        <li>therefore, we would need $O(N)$ again for range searches to look at <em>entries in every bucket</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="b-tree-indexes">B+ Tree Indexes</h3>

<blockquote>
  <p><em>Reminder: Binary Tree</em></p>

  <ul>
    <li>anything on the <strong>left</strong> is smaller than the parent, and the <strong>right</strong> larger or equal to the parent</li>
    <li>since this <em>might be be balanced</em>, the tree could just have a really large height</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>B+ Tree</strong></p>

  <ul>
    <li>
      <p>the idea is that each <strong>non-leaf node contains</strong></p>

      <ol>
        <li>
          <p>a list of <code class="language-plaintext highlighter-rouge">(pointers, key)</code> to the children, where <code class="language-plaintext highlighter-rouge">key</code> is the key of that children. Also called the <strong>index entry</strong></p>
        </li>
        <li>
          <p>the list inside each node is <strong>sorted</strong></p>

          <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_14-52-41.png" style="zoom: 67%;" /></p>
        </li>
      </ol>
    </li>
    <li>
      <p>the <strong>leaf node contains</strong></p>
    </li>
    <li>
      <p>the <em>actual data entry</em> (i.e. records/pages)</p>
    </li>
    <li>
      <p>this tree is <strong>balanced</strong></p>

      <p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_14-29-56.png" style="zoom:50%;" /></p>

      <p>notice that the <strong>leaf nodes are also connected</strong>, so that it will be easy to implement $\ge$ or $\le$ search</p>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_14-34-13.png" style="zoom: 67%;" /></p>

<p>where notice that:</p>

<ul>
  <li>
    <p>each <code class="language-plaintext highlighter-rouge">p_key</code> in the <strong>parent entry</strong> point to the child node who <strong>only contains <code class="language-plaintext highlighter-rouge">key &lt; p_key</code></strong></p>
  </li>
  <li>
    <p>then the Disk Access is <code class="language-plaintext highlighter-rouge">O(levels)</code>, in <strong>real life</strong>, this will be $O(level) \approx 3$ (<strong>this will be for equality look up</strong>)</p>
    <ul>
      <li>assumes that each node is of size <code class="language-plaintext highlighter-rouge">8K</code>, and each pair of <code class="language-plaintext highlighter-rouge">(pointer, key)</code> is <code class="language-plaintext highlighter-rouge">8B</code>, then we have in most cases <code class="language-plaintext highlighter-rouge">3</code> levels</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p><strong>Note that</strong></p>

  <ul>
    <li>the <code class="language-plaintext highlighter-rouge">index_entry</code> <strong>only contains</strong>:
      <ol>
        <li>the key</li>
        <li>the pointer to next level</li>
      </ol>

      <p>It does <strong>not</strong> contain the data record/row</p>
    </li>
    <li>
      <p>Therefore, you can technically find information <strong>on the last level</strong></p>

      <ul>
        <li>so that Range Queries become easy</li>
      </ul>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Advantage</strong></p>

  <ul>
    <li>For each <strong>equality search</strong>, in real life, <code class="language-plaintext highlighter-rouge">O(3)</code> <strong>Disk Access</strong> (i.e. how many times we need to go down)
      <ul>
        <li>binary search in the list is done in <em>computer</em>, so does not count towards Disk Access</li>
      </ul>
    </li>
    <li>For each $\le$, $\ge$ <strong>search</strong>, we would have <code class="language-plaintext highlighter-rouge">O(3)+O(M)</code>, for <code class="language-plaintext highlighter-rouge">M</code> being the actual number of entries satisfying the predicate
      <ul>
        <li>e.g. if we needed <code class="language-plaintext highlighter-rouge">age &gt; 24</code>, and there are <code class="language-plaintext highlighter-rouge">10</code> entries for that, then we have <code class="language-plaintext highlighter-rouge">3+10=13</code> Disk Accesses</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="primary-and-secondary-index">Primary and Secondary Index</h3>

<p>The above did two algorithms did not specify <strong>how the index entry stores the data records/address of the data record</strong></p>

<p>in fact, the two approaches are:</p>

<ol>
  <li><strong>Primary Index</strong>: index entry <code class="language-plaintext highlighter-rouge">k*</code> contains the data</li>
  <li><strong>Secondary Index</strong> the index entry <code class="language-plaintext highlighter-rouge">k*</code> contains the <code class="language-plaintext highlighter-rouge">rid</code> of the data (i.e. the pointer to it)</li>
</ol>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-02_22-35-14.png" style="zoom: 50%;" /></p>

<p>where:</p>

<ul>
  <li>for example, if for a entry we have <code class="language-plaintext highlighter-rouge">k=3</code>, then <code class="language-plaintext highlighter-rouge">data_record = [actual record of that Student with gpa=k=3]</code></li>
</ul>

<blockquote>
  <p><strong>Advantage for Primary Index</strong></p>

  <ul>
    <li>Fast, <em>saves one Disk Access</em> as the data is already there</li>
  </ul>

  <p><strong>Disadvantage for Primary Index</strong></p>

  <ul>
    <li>Makes the <em>data entries large</em></li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Advantage for Secondary Index</strong></p>

  <ul>
    <li>Makes the <em>data entries small</em></li>
  </ul>

  <p><strong>Disadvantage for Secondary Index</strong></p>

  <ul>
    <li>Need <em>one more extra Disk Access</em></li>
  </ul>
</blockquote>

<h2 id="clusters">Clusters</h2>

<p>Clustering requires some <strong>mathematical order</strong> present in the data records</p>

<blockquote>
  <p><strong>Clustered Index</strong></p>

  <ul>
    <li>If <strong>order of data records</strong> is the same as, or `close to’, <strong>order of data entries</strong>, then called clustered index.</li>
  </ul>
</blockquote>

<p><em>For Example</em>:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_15-22-27.png" style="zoom: 67%;" /></p>

<p>In general, <strong>clustered index</strong> would be faster, because: if I am fetching <code class="language-plaintext highlighter-rouge">key=pga&gt;=3,0</code>, and that we <strong>know there are $10$ data records that matches that</strong></p>

<ul>
  <li>having clustered index means we have <code class="language-plaintext highlighter-rouge">3</code> Data Access + <strong><code class="language-plaintext highlighter-rouge">1</code> System call</strong> to fetch all the $10$ <strong>consecutive data records</strong>
    <ul>
      <li>e.g. if it happens that the 10 records are on the same page, then <code class="language-plaintext highlighter-rouge">1</code> System call = 1 Disk Access here</li>
    </ul>
  </li>
  <li>having un-clustered index means we have <code class="language-plaintext highlighter-rouge">3</code> Data Access + <strong><code class="language-plaintext highlighter-rouge">10</code> System</strong> calls/Disk Accesses to fetch since they are <strong>discontinuous</strong></li>
</ul>

<h2 id="composite-indices">Composite Indices</h2>

<blockquote>
  <p><strong>Composite Keys</strong></p>

  <ul>
    <li>Composite Search Keys: Search on a <strong>combination of fields.</strong>
      <ul>
        <li>for example if we have search key = <code class="language-plaintext highlighter-rouge">&lt;sal, age&gt;</code>
          <ul>
            <li>then <strong>Equality query</strong> may look like <code class="language-plaintext highlighter-rouge">age=20 AND sal=75</code></li>
            <li><strong>Rane query</strong> may look like <code class="language-plaintext highlighter-rouge">age=20</code> or <code class="language-plaintext highlighter-rouge">age=20 AND sal &gt; 10</code></li>
          </ul>
        </li>
      </ul>
    </li>
    <li>Data entries in <strong>sorted by search key</strong> to support range queries.
      <ul>
        <li>e.g. by Lexicographic order, or Spatial order.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_15-29-16.png" style="zoom:50%;" /></p>

<p>==TODO== this should be data entries? Yes, should be data entries</p>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>a data entry with key <code class="language-plaintext highlighter-rouge">&lt;sal, age&gt;</code> would be <em>different from</em> the key <code class="language-plaintext highlighter-rouge">&lt;age, sal&gt;</code>, where for the former, <code class="language-plaintext highlighter-rouge">sal</code> is <strong>compared first</strong>, and then <code class="language-plaintext highlighter-rouge">age</code></li>
  </ul>
</blockquote>

<h2 id="performance-summary">Performance Summary</h2>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-03-27_15-36-53.png" style="zoom:67%;" /></p>

<p>remember the above is about <strong>number of Disk Accesses</strong></p>

<h2 id="index-selection-guidelines">Index Selection Guidelines</h2>

<ol>
  <li>Attributes in <code class="language-plaintext highlighter-rouge">WHERE</code> clause are candidates for index keys
    <ul>
      <li><strong>Exact</strong> match condition suggests <strong>hash</strong> index.</li>
      <li><strong>Range query</strong> suggests <strong>tree</strong> index.
        <ul>
          <li>Clustering is especially useful for range queries; can also help on equality queries if there are many duplicates.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Before creating an index, must also consider the impact on updates in the workload!
    <ul>
      <li>Trade-off: Indexes can make queries go faster, <strong>updates slower</strong>.  Require disk space, too.</li>
    </ul>
  </li>
</ol>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>Try to choose indexes that benefit as many queries as possible.  Since <strong>only one index can be clustered per relation</strong>, choose it based on important queries that would benefit the most from clustering.</li>
  </ul>
</blockquote>

<h2 id="index-syntax">Index Syntax</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="p">[</span><span class="k">UNIQUE</span><span class="p">]</span> <span class="k">INDEX</span> <span class="k">index</span><span class="o">-</span><span class="n">name</span> 
<span class="k">ON</span> <span class="n">Students</span> <span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">gpa</span><span class="p">)</span>
<span class="k">WITH</span> <span class="k">STRUCTURE</span> <span class="o">=</span> <span class="p">[</span><span class="n">BTREE</span> <span class="o">|</span> <span class="n">HASH</span> <span class="o">|</span> <span class="p">...]</span>
<span class="p">[</span><span class="k">WHERE</span> <span class="o">&lt;</span><span class="n">predicate</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">[WHERE &lt;predicate&gt;]</code> means that only if the record <em>matches the predicate</em>, it will be placed into the <code class="language-plaintext highlighter-rouge">INDEX</code></li>
  <li><code class="language-plaintext highlighter-rouge">CREATE [UNIQUE] INDEX</code> means that the <em>entry of a key will only contain ONE record</em></li>
</ul>

<h1 id="query-evaluation-optimization">Query Evaluation Optimization</h1>

<p>If we want to keep <strong>all of our data in a sorted manner</strong>, when one storage we want to use would be:</p>

<ul>
  <li>B+ Tree with <em>primary index</em> storage (not secondary index since that would no be the storage anymore)</li>
</ul>

<p>Keeping data in some order will <strong>help us later with query optimization</strong></p>

<blockquote>
  <p><strong>Query Plan</strong></p>

  <ul>
    <li>how we should compute that query, e.g. in what order</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Overview of Query Evaluation</strong></p>

  <ol>
    <li>For a given query, <strong>what plans</strong> are considered?
      <ul>
        <li>obviously not all of them, which would take very long</li>
      </ul>
    </li>
    <li>How is the <strong>cost of each plan</strong> estimated?
      <ul>
        <li>the aim here is to quickly <em>estimate</em></li>
      </ul>
    </li>
  </ol>

  <p><strong>Ideally</strong>: Want to find best plan.</p>

  <p><strong>Practically</strong>: Avoid worst plans!</p>
</blockquote>

<p>Before discussing the System R Approach, lets look at something else related.</p>

<p>Some common techniques for <em>evaluating relational operators</em> could be:</p>

<blockquote>
  <p><strong>Common Techniques of Evaluating/Computing Queries</strong></p>

  <ul>
    <li><strong>Indexing</strong>: if there is a <code class="language-plaintext highlighter-rouge">WHERE</code>, then we should use some sort of indexing to get the data back</li>
    <li><strong>Iteration</strong>: sometimes, we need to scan all tuples/rows</li>
    <li><strong>Partitioning</strong>: by sorting or hashing, we can partition the input tuples and replace an expensive operation by similar operations on smaller inputs
      <ul>
        <li>i.e. breaking up the query into smaller, more efficient parts</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>Note the above talks about how the <strong>query itself might be evaluated</strong></p>

<h2 id="statistics-and-catalogs">Statistics and Catalogs</h2>

<p>Before going to talk about optimization, we need to know <strong>what is available for us</strong> in the DBMS</p>

<blockquote>
  <p><strong>System Catalogs</strong></p>

  <p>This is maintained by the DMBS, and typically contain at least:</p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge"># tuples</code> (NTuples) and  <code class="language-plaintext highlighter-rouge"># pages</code> (NPages) for each relation.</li>
    <li><code class="language-plaintext highlighter-rouge"># distinct key values</code> (NKeys) and NPages for each index.</li>
    <li>Index height, low/high key values (Low/High) for each tree index.</li>
  </ul>

  <p>Catalogs updated <strong>periodically</strong>.</p>

  <ul>
    <li>Updating whenever data changes is too expensive; lots of approximation anyway, so <em>slight inconsistency is ok</em>.</li>
    <li>Usually meta information might not be updated timely</li>
  </ul>
</blockquote>

<h3 id="system-catalogs">System Catalogs</h3>

<p>Basically, they are <strong>system tables</strong> that store additional information on the relations you have.</p>

<blockquote>
  <p><strong>System Catalogs</strong></p>

  <p>For each index, it <strong>stores</strong>:</p>

  <ul>
    <li>structure (e.g., B+ tree) and search key fields</li>
  </ul>

  <p>For each relation, it <strong>stores</strong>:</p>

  <ul>
    <li>name, file structure (e.g., Heap file)</li>
    <li>attribute name and type, for each attribute</li>
    <li>index name, for each index</li>
    <li>integrity constraints</li>
  </ul>

  <p>For each view, it <strong>stores</strong>:</p>

  <ul>
    <li>view name and definition</li>
  </ul>

  <p><strong>Plus</strong> statistics, authorization, buffer pool size, etc.</p>
</blockquote>

<p><em>For Example</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-02_21-40-28.png" style="zoom:50%;" /></p>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">rel_name</code> means in <em>which table is the <code class="language-plaintext highlighter-rouge">attr_name</code> belonging to</em></li>
  <li>usually, those tables will also contain <em>data about themselves</em></li>
</ul>

<h2 id="access-path">Access Path</h2>

<blockquote>
  <p><strong>Access Path</strong></p>

  <ul>
    <li>an access path is about <em>how to actually retrieve tuple/rows</em> of a table
      <ul>
        <li>e.g. should I scan through everything in the Heap, or should I index into a Hash Table?</li>
        <li>i.e. how to <em>figure out where the data is</em></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p><strong>(B)Tree Indexes</strong> for with primary/secondary indexes built on a <em>composite search key</em> <code class="language-plaintext highlighter-rouge">&lt;a,b,c&gt;</code></p>

<ul>
  <li>then, every time when we are querying a <em>prefix in the search key</em>, for example <code class="language-plaintext highlighter-rouge">WHERE a=5 AND b=3</code>, we <strong>can use</strong> it</li>
  <li>if we are querying <code class="language-plaintext highlighter-rouge">WHERE a=5 AND c=3</code>, then this indexing <strong>cannot be used</strong></li>
</ul>

<p><strong>Hash Index</strong> index built on a <em>composite search key <code class="language-plaintext highlighter-rouge">&lt;a,b,c&gt;</code></em></p>

<ul>
  <li>then, the only query that we can use here is <code class="language-plaintext highlighter-rouge">WHERE a=5 AND b=6 AND c=7</code></li>
  <li>all the rest queries <strong>cannot be used</strong></li>
</ul>

<hr />

<blockquote>
  <p><strong>Summary</strong></p>

  <ul>
    <li>B+ Tree works when a <code class="language-plaintext highlighter-rouge">WHERE</code> query involve only attributes in a <em>prefix of the search key</em></li>
    <li>Hash Table works when a <code class="language-plaintext highlighter-rouge">WHERE</code> query involves <em>every attribute in the search key</em></li>
  </ul>
</blockquote>

<h3 id="conjunctive-normal-form">Conjunctive Normal Form</h3>

<p>One problem that we avoided in the example above is for <em>queries using <code class="language-plaintext highlighter-rouge">OR</code></em></p>

<p>Consider:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WHERE</span> <span class="p">(</span><span class="k">day</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="o">/</span><span class="mi">94</span> <span class="k">AND</span> <span class="n">rname</span><span class="o">=</span><span class="err">‘</span><span class="n">Paul</span><span class="err">’</span><span class="p">)</span> <span class="k">OR</span> <span class="n">bid</span><span class="o">=</span><span class="mi">5</span> <span class="k">OR</span> <span class="n">sid</span><span class="o">=</span><span class="mi">3</span>
</code></pre></div></div>

<p>To “simplify” this, we can <strong>convert it to conjunctive normal form (CNF)</strong></p>

<ul>
  <li>i.e. where each term is connected by <code class="language-plaintext highlighter-rouge">OR</code> only</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WHERE</span> <span class="p">(</span> <span class="k">day</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="o">/</span><span class="mi">94</span> <span class="k">OR</span> <span class="n">bid</span><span class="o">=</span><span class="mi">5</span> <span class="k">OR</span> <span class="n">sid</span><span class="o">=</span><span class="mi">3</span> <span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">rname</span><span class="o">=</span><span class="err">‘</span><span class="n">Paul</span><span class="err">’</span> <span class="k">OR</span> <span class="n">bid</span><span class="o">=</span><span class="mi">5</span> <span class="k">OR</span> <span class="n">sid</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 
</code></pre></div></div>

<h2 id="selection-most-selective-access-path">(Selection) Most Selective Access Path</h2>

<p>This is basically to deal with <strong>selection $\sigma$</strong>.</p>

<p>Then, one idea of optimization is to find the <strong>most selective access path</strong></p>

<blockquote>
  <p><strong>Most Selective Access Path</strong></p>

  <ul>
    <li>An index or file scan that we estimate will require the <strong>fewest page I/Os</strong>
      <ul>
        <li>i.e. <em>fewest steps to compute that</em> -&gt; fewest records returned = easier to deal with later</li>
      </ul>
    </li>
    <li>Terms that match this index <strong>reduce the number of tuples retrieved</strong>; other terms are used to discard some retrieved tuples,</li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p>If we have something generic:
\(\sigma_{T_1 \and T_2 \and T_3 \and ...}(\text{Some Table})\)
where:</p>

<ul>
  <li>matching $T_1$ has only <strong>one records</strong></li>
  <li>matching $T_2$ has 100 records</li>
</ul>

<p>Then obviously we should <strong>start with evaluating $T_1$</strong>, which is the <strong>most selective access path</strong> in this case</p>

<ul>
  <li>then you might just need <em>only a few Disk Access to fetch records that match $T_1$,</em> and that’s it</li>
</ul>

<hr />

<blockquote>
  <p><strong>In Summary</strong></p>

  <p>This means that we need to think about and <strong>estimate</strong>:</p>

  <ul>
    <li>How <strong>fast the $T_1$ can be evaluated</strong></li>
    <li>How <strong>big</strong> does the result look like <strong>after evaluating $T_1$</strong></li>
  </ul>
</blockquote>

<h3 id="using-an-index-for-selection">Using an Index for Selection</h3>

<p>Consider the example:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-02_22-39-14.png" style="zoom:50%;" /></p>

<p>where we need to find <code class="language-plaintext highlighter-rouge">sname</code> start with <code class="language-plaintext highlighter-rouge">A</code> or <code class="language-plaintext highlighter-rouge">B</code> basically</p>

<ol>
  <li>we go down the B Tree, e.g. the Left Most Data Record</li>
  <li>Look up our System Table to know if it is a <em>primary/secondary index</em></li>
  <li>Range query <em>towards right</em> until a name starting with <code class="language-plaintext highlighter-rouge">C</code></li>
</ol>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>if we don’t have a B+-Tree, or the search key is <em>not <code class="language-plaintext highlighter-rouge">sname</code></em>, then we <strong>cannot/should not</strong> use it for selection</li>
  </ul>
</blockquote>

<p>Now, we know what the <em>access path</em> looks like. We now need to think/estimate the <strong>size of return values</strong></p>

<blockquote>
  <p><strong>Approximation for Size of Return Values</strong></p>

  <ul>
    <li>For this course, the <strong>only strategy</strong> we will use is <strong>assuming uniform distribution</strong></li>
  </ul>
</blockquote>

<p>Therefore, in this case, the <em>estimated size</em> is:
\(\frac{2}{26}=\frac{1}{13} \approx 10\% \text{ of the total number of records}\)
Then, say we have 10,000 tuples on 100 B-tree pages:</p>

<ul>
  <li>with a <em>clustered</em> index, cost is little more than 100 I/Os;</li>
  <li>if <em>un-clustered</em>, up to 10,000 I/Os!</li>
</ul>

<h2 id="projection-optimization">Projection Optimization</h2>

<p>Now, we wan to <strong>optimize projection</strong> $\Pi$</p>

<p><em>For Example</em>:</p>

<p>Consider the query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span>
<span class="k">FROM</span> <span class="n">Reserves</span> <span class="n">R</span>
</code></pre></div></div>

<p>The <strong>only</strong> way to optimize is:</p>

<ul>
  <li>if we happen to have a <strong>Hash Table/B-Tree whose search key is <code class="language-plaintext highlighter-rouge">&lt;sid, bid&gt;</code></strong>, then I can <strong>just look at/scan the search key</strong> without needing to read the record
    <ul>
      <li>i.e. we are only <em>scanning through the search keys</em>, this is also called the <strong>Index Only Evaluation</strong></li>
    </ul>
  </li>
  <li>Basically, this is optimization because the <em>number of total pages of data records in Heap</em> $&gt;$ <em>number of total pages of search keys in Heap</em></li>
</ul>

<p>Otherwise, we need to <em>scan the entire Heap</em></p>

<hr />

<p>Now, what is <strong><code class="language-plaintext highlighter-rouge">distinct</code></strong> is specified?</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">R</span><span class="p">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">bid</span>
<span class="k">FROM</span> <span class="n">Reserves</span> <span class="n">R</span>
</code></pre></div></div>

<p>if we scan the entire Heap, this will be costly because:</p>

<ul>
  <li>we need to somehow figure out if each record <em>is duplicated</em>, which can be done by <em>sorting the records in the end</em>, but overall costly</li>
</ul>

<p><strong>One</strong> ways to optimize is to use a <em>Hash Table</em>:</p>

<ol>
  <li>create a Hash Table with search key/bucket <code class="language-plaintext highlighter-rouge">&lt;sid, bid&gt;</code></li>
  <li>as we fetch each record from Heap, we dump it into the Hash Table</li>
  <li>In the end, we just need to do a <strong>Index Only Evaluation</strong> on the Hash Table we created</li>
</ol>

<h2 id="join-optimization">Join Optimization</h2>

<blockquote>
  <p><em>Reminder</em></p>

  <ul>
    <li>
      <p>A join looks like $R \bowtie_{i=j} S$, and we needed to basically do a <strong>cartesian product</strong> like:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">R</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">each</span> <span class="nb">tuple</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">s</span><span class="p">.</span><span class="n">j</span><span class="p">):</span>
            <span class="n">add</span> <span class="o">&lt;</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="o">&gt;</span> <span class="n">to</span> <span class="n">result</span>
</code></pre></div>      </div>

      <p>so basically the cost is huge.</p>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em>:</p>

<p>Let us have two tables $R$, and $S$, where:</p>

<ul>
  <li>$M_R$ is the <em>number of pages in $R$</em></li>
  <li>$M_S$ is the <em>number of pages in $S$</em></li>
  <li>$p$ is the <em>number of data records/tuples per page</em></li>
</ul>

<p>Then:</p>

<ul>
  <li>
    <p>the brute force no-index JOIN will need:
\(M_R + [(M_R \times p) \times(M_S \times p)]\)
since we need to</p>

    <ol>
      <li>read in one of the entire table</li>
      <li>read <em>one record at a time</em> for this algorithm for search</li>
    </ol>
  </li>
</ul>

<p>However, since the idea is to <strong>add the result if there is a MATCHING</strong> from a record in table R and a (or many) record in S, we could do:</p>

<ul>
  <li>
    <p>if we have a ==B-Tree indexing== on the column of <em>one of the relation</em>
\(M_R + [(M_R \times p) \times 3]\)</p>

    <ul>
      <li>this makes sense because for each record of $R$, we just needed <em>$3$ Disk Access (B-Tree traversal)</em> to find out if there is an <strong>equivalent</strong> entry on $S$</li>
      <li>we <em>only needed to read the entire table $R$</em> ($M_R$ Disk Accesses since we read by page) in the beginning, and THEN do the search.</li>
    </ul>
  </li>
  <li>
    <p>if we have a ==Hash Table== indexing, then obviously:
\(M_R + [(M_R \times p) \times 1]\)</p>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>Since each record on $R$ could match <em>multiple records</em> on $S$, then clustering can <em>still help even if it is equality search</em>
      <ul>
        <li>if clustered, then all records of <code class="language-plaintext highlighter-rouge">&lt;i=1, j=1&gt;</code> are close to each other, so fetching them is easy $\approx 1$ Disk Access</li>
        <li>if un-clustered, still need to look at <em>each <code class="language-plaintext highlighter-rouge">RID</code></em>, so more Disk Accesses are needed</li>
      </ul>
    </li>
    <li>Since the above provides a formula, we can <strong>basically estimate the I/O cost using the above</strong></li>
  </ul>
</blockquote>

<h3 id="sort-merge">Sort-Merge</h3>

<p>If the two tables $S$ and $R$ are <em>sorted</em>, we can do the following:</p>

<p><img src="https://bertwagner.com/wp-content/uploads/2018/12/Merge-Join-1.gif" alt="" /></p>

<p>where we have <em>two pointers</em>:</p>

<ul>
  <li>if the pointer on the Left Table is on value <strong>smaller than</strong> the pointer on the Right Table, move the left (increase it) <strong>until hit</strong></li>
  <li>if the pointer on the Left Table is on value <strong>large than</strong> the pointer on the Right Table, move the right (increase it) <strong>until hit</strong></li>
</ul>

<p>Therefore, the cost is (on <strong>average</strong>):
\(M_S + M_R\)
since we just needed to scan the records <em>per page of both table</em>, no need to Disk I/O it per record, so cost is $M_S + M_R$</p>

<p>In general, if we <strong>include the cost of sorting</strong>
\(N\log(N) + M\log(M) + (N+M)\)</p>

<blockquote>
  <p><strong>Worst Case Scenario</strong></p>

  <ul>
    <li>
      <p>if we happen to have <em>each</em> row of first table matching <em>all entries of second table</em>, then the cost is actually:
\(M_S \times M_R\)</p>
    </li>
    <li>
      <p>but then the <em>cost of sorting</em> is none</p>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>In practice</strong></p>

  <ul>
    <li>We can use the approximation, since this is <em>happening commonly in reality</em>:
\(3 \times N + 3 \times M + (N+M)\)</li>
  </ul>
</blockquote>

<p>in fact, the more often case is that you have <strong>indexes built on both tables</strong>, but the tables themselves are not sorted</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-03_00-09-47.png" style="zoom: 67%;" /></p>

<p>where the sorting is basically already one in the <em>data entries</em>, then the <strong>cost is (best case)</strong>
\(\text{total # pages of Left B-Tree's Leaf Nodes   } + \text{   total # pages of Right B-Tree's Leaf Nodes}\)</p>

<blockquote>
  <p><strong>Take away message</strong></p>

  <ul>
    <li>if we have some sort of index, we can <em>always find a way to speed up the <code class="language-plaintext highlighter-rouge">JOIN</code> some way</em></li>
  </ul>
</blockquote>

<h3 id="reduction-factor">Reduction Factor</h3>

<p>Consider the query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">attribute_list</span>
<span class="k">FROM</span> <span class="n">relation</span> <span class="n">list</span>
<span class="k">WHERE</span> <span class="n">term1</span> <span class="k">AND</span> <span class="p">...</span> <span class="k">AND</span> <span class="n">termk</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Reduction Factor</strong></p>

  <ul>
    <li>
      <p>Reduction factor (RF) associated with each <code class="language-plaintext highlighter-rouge">term</code> reflects the <em>impact of the term in reducing result size</em>.
\(RF_i=\frac{\text{# records matching term$_i$}}{\text{total # of records}}\)</p>

      <ul>
        <li>for example, if you have something like <code class="language-plaintext highlighter-rouge">WHERE id=1</code>, then the reduction factor is (<em>assuming <code class="language-plaintext highlighter-rouge">id</code> is a primary key</em>):
\(\frac{\text{1}}{\text{total # of records}}\)</li>
      </ul>
    </li>
    <li>
      <p>This means that the <em>number of data records returned</em> can be approximated to be
\(\text{# Result} \approx (\text{Max # Tuples}) \times \Pi_{RF}\)
where:</p>

      <ul>
        <li>$\Pi_{RF}$ means the <strong>product of all reduction factors</strong></li>
        <li>Implicit assumption that terms are independent</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><em>For Example</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-03_00-36-15.png" style="zoom: 50%;" /></p>

<p>where:</p>

<ul>
  <li>technically, there could be other ways to <strong>generate the Relational Algebra Tree</strong> as well</li>
</ul>

<p><strong>The most straight-forward Approach</strong> would be:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-03_00-39-38.png" style="zoom:67%;" /></p>

<p>where:</p>

<ul>
  <li>“on the fly” means we are <strong>computing this while computing <code class="language-plaintext highlighter-rouge">JOIN</code></strong>. Therefore, no cost</li>
</ul>

<p><strong>Cost</strong>:
\(\text{Cost} \approx \text{Cost of Join}\)</p>

<hr />

<p><em>Alternative Plan 1</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-03_00-44-51.png" style="zoom:67%;" /></p>

<p>so we basically <strong>decided to do $\sigma$</strong> first</p>

<p><strong>Cost</strong>:
\(\text{Cost} \approx( \text{Cost of $\sigma_{bid=100}$} + \text{Write to $T_1$}) + ( \text{Cost of $\sigma_{rating&gt;5}$} + \text{Write to $T_2$})+ (\text{Sort-Merge Join $T_1, T_2$})\)
basically the join would be faster</p>

<hr />

<p><em>Alternative Plan 2 With Index</em></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-03_00-50-32.png" style="zoom: 67%;" /></p>

<p>where:</p>

<ol>
  <li>build the Hash Table, and at the <strong>same</strong> time, <em>do the $\sigma_{bid=100}$</em></li>
  <li>Do the matching/<code class="language-plaintext highlighter-rouge">JOIN</code> by scanning through <code class="language-plaintext highlighter-rouge">Sailors</code> and <strong>use the built Hash Table for look up</strong>
    <ul>
      <li>at the same time, compute $\sigma_{rating&gt;5}$</li>
    </ul>
  </li>
</ol>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">Join</code> column <code class="language-plaintext highlighter-rouge">sid</code> is a <strong>key</strong> for <code class="language-plaintext highlighter-rouge">Sailors</code>.–At most one matching tuple. Therefore, <strong>un-clustered index</strong> on <code class="language-plaintext highlighter-rouge">sid</code> OK</li>
  </ul>
</blockquote>

<p><strong>Cost</strong>
\(\text{Cost} \approx( \text{Cost of building Hash Table}) + ( \text{Cost of Joining with Hash Table})\)</p>

<h2 id="summary">Summary</h2>

<ol>
  <li>A query is evaluated by <em>converting it to a tree of operators</em> and <em>evaluating the operators</em> in the tree.</li>
  <li>Two parts to optimizing a query:
    <ul>
      <li>Consider a set of alternative <strong>plans</strong>.
        <ul>
          <li>Must prune search space; typically, left-deep plans only.</li>
        </ul>
      </li>
      <li>Must estimate <strong>cost</strong> of each plan that is considered.
        <ul>
          <li>Must estimate <strong>size</strong> of result AND <strong>cost</strong> for each plan node.</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="transactions">Transactions</h1>

<p>A transaction is the DBMS’s abstract view of a user program:  <strong>a sequence of reads and writes</strong> (because that all what a Database do).</p>

<p>This is extremely  useful when you are doing some sort of <strong>concurrent execution</strong>, or having some sort of <strong>atomic operation</strong></p>

<h2 id="atomicity-of-transactions">Atomicity of Transactions</h2>

<p>A transaction might <strong>commit</strong> after completing all its actions, or it could <strong>abort</strong> (or be aborted by the DBMS) after executing some actions.</p>

<ul>
  <li>therefore, either this thing ==executed completely==, or ==none==</li>
</ul>

<blockquote>
  <p><strong>Atomicity of Transactions</strong></p>

  <ul>
    <li>Transactions are executing <strong>all</strong> its actions in <strong>one step</strong>, or <strong>not</strong> executing <strong>any actions at all</strong>
      <ul>
        <li>i.e. all in or nothing</li>
        <li>this is achieved by DBMS logs, which records all actions, so that it can ==undo/roll back== the <strong>uncommitted</strong>/aborted transactions. (The idea is exactly the same as <em>journaling in OS</em>)</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><u>*For Example:*</u></p>

<p>Since the log of DBMS is basically the same idea as <em>journaling OS</em>, consider the case when:</p>

<ul>
  <li>your DBMS says you have successfully committed</li>
  <li>data all in your Cache, not yet flushed to HDD/SSD</li>
  <li>powered off your computer</li>
</ul>

<p>Then, technically <em>data is not there</em> even if you committed.</p>

<p>However, the next time you boot up:</p>

<ul>
  <li>DBMS checks the log, and the <strong>commits</strong> to see if the Disks have it</li>
  <li>if not, ==redo the committed transactions== so the disk is up-to-date</li>
</ul>

<p>Therefore, it’s basically the same idea as <em>journaling in OS</em>.</p>

<h2 id="acid-properties-of-transactions">ACID Properties of Transactions</h2>

<blockquote>
  <p><strong>Properties of Transactions</strong></p>

  <ul>
    <li><strong>Atomicity</strong>:  All actions in the Transactions happen, or none happen</li>
    <li><strong>Consistency</strong>:  If each Transactions is consistent, and the DB starts consistent, it ends up consistent.</li>
    <li><strong>Isolation</strong>:  Execution of one Transactions is isolated from that of other Transactions.
      <ul>
        <li>even if you have <em>concurrent</em> transactions, the read/write should be still consistent</li>
      </ul>
    </li>
    <li><strong>Durability</strong>:  If a Transactions commits, its effects persist.</li>
  </ul>
</blockquote>

<p>In reality:</p>

<ul>
  <li>the Concurrency Control Manager guarantees <strong>C&amp;I</strong></li>
  <li>the Recovery Manager guarantees <strong>A&amp;D</strong></li>
</ul>

<h2 id="concurrency-control">Concurrency Control</h2>

<p>Consider the two transactions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>T1: BEGIN   A=A+100,   B=B-100   END
T2: BEGIN   A=1.06*A,  B=1.06*B  END
</code></pre></div></div>

<p>which <em>intends to</em></p>

<ul>
  <li>first transaction is transferring $100 from B’s account to A’s account.</li>
  <li>second is crediting both accounts with a 6% interest payment.</li>
</ul>

<p>==If both are submitted together==, i .e. concurrency, we need to make sure the <strong>net effect</strong> is that these two transactions running ==serially== in some order.</p>

<p><u>*For Example:*</u></p>

<p>possible interleaving (i.e., a possible schedule):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">T1:</span>  <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="o">+</span><span class="mi">100</span><span class="p">,</span>			<span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="o">-</span><span class="mi">100</span>   
<span class="n">T2</span><span class="o">:</span>       	 <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">.</span><span class="mo">06</span><span class="o">*</span><span class="n">A</span><span class="p">,</span>  		<span class="n">B</span><span class="o">=</span><span class="mi">1</span><span class="p">.</span><span class="mo">06</span><span class="o">*</span><span class="n">B</span>
</code></pre></div></div>

<p>which has the good net effect.</p>

<p>However, the following <strong>would not work</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T1</span><span class="p">:</span>  <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="o">+</span><span class="mi">100</span><span class="p">,</span>        			<span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="o">-</span><span class="mi">100</span>   
<span class="n">T2</span><span class="p">:</span>       	 <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">.</span><span class="mi">06</span><span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mi">1</span><span class="p">.</span><span class="mi">06</span><span class="o">*</span><span class="n">B</span>
</code></pre></div></div>

<blockquote>
  <p>In the system’s point of view, this is what happens in the wrong case:</p>

  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T1</span><span class="p">:</span>  <span class="n">R</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>						<span class="n">R</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> 
<span class="n">T2</span><span class="p">:</span> 			<span class="n">R</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> 
</code></pre></div>  </div>

  <p>basically as a sequence of read and writes.</p>
</blockquote>

<h3 id="scheduling-transactions">Scheduling Transactions</h3>

<p>A schedule is a basically a series of (scheduled) executions.</p>

<blockquote>
  <p><strong>Schedules</strong></p>

  <ul>
    <li><strong>Serial</strong> schedule: Schedule that does not interleave the actions of different transactions.
      <ul>
        <li>simplest thing. Nothing special to do.</li>
      </ul>
    </li>
    <li><strong>Equivalent</strong> schedules:  For any database state, the effect (on the set of objects in the database) of executing the first schedule is <em>identical to the effect</em> of executing the second schedule.</li>
    <li><strong>Serializable</strong> schedule:  A schedule that is equivalent to some serial execution of the transactions.
      <ul>
        <li>A concurrent (<strong>interleaved</strong>) execution of two or more transactions is ==correct== if their ==execution is serializable==</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>The above defined what it means to have some <em>correct</em> concurrent transactions.</p>

<p><u>*For Example*</u></p>

<p>Consider the case:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">T1:</span> <span class="n">a</span><span class="o">=</span><span class="n">read</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>	<span class="n">Commit</span>     <span class="c1">// add 4 to x</span>
<span class="n">T2</span><span class="o">:</span> <span class="n">b</span><span class="o">=</span><span class="n">read</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">b</span><span class="p">);</span>	<span class="n">Commit</span>   <span class="c1">// multiply x by 10 </span>
</code></pre></div></div>

<p>Then, we can have some possible <em>results</em>:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-09_17-43-26.png" style="zoom:67%;" /></p>

<p>where:</p>

<ul>
  <li>the ==result== of 1 and 2 are <em>serializable</em>, because they are <strong>serial</strong> (in transaction) already $\to$ both are possibly ==correct==</li>
  <li>thee ==result== of 3 is <em>not serializable</em>, since the only two possible serialized result is $x=40,x=4$ $\to$ this one is ==incorrect==</li>
</ul>

<h3 id="anomalies-of-interleaved-execution">Anomalies of Interleaved Execution</h3>

<p>Basically, this is the problem of:</p>

<ul>
  <li>if you have <em>simultaneous read/write to the same data</em> $\iff$ critical section in OS</li>
</ul>

<p><u>*For Example: Dirty Read*</u></p>

<p><img src="\lectures\images\typora-user-images\image-20210409175430039.png" alt="image-20210409175430039" style="zoom:67%;" /></p>

<p>where:</p>

<ul>
  <li>we see that the problem is $T_2$ is <strong>reading uncommitted data</strong>, and it has committed the value that is supposed to be <strong>rolled back</strong>!</li>
  <li>again, the central cause is that those <strong>transactions are NOT atomic WHEN concurrent</strong> (reminder: think about the <code class="language-plaintext highlighter-rouge">lock</code>s in OS)</li>
</ul>

<hr />

<p><u>*For Example: Read-Write Conflicts*</u></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-09_18-06-42.png" style="zoom: 67%;" /></p>

<p>where:</p>

<ul>
  <li>basically, the problem of isolation.</li>
  <li>in short, it is the same problem of $T_1$ accessing some data and $T_2$ changing it without any sort of locks</li>
</ul>

<hr />

<p><u>*For Example: Overwriting Uncommitted Data*</u></p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-09_18-08-22.png" style="zoom: 67%;" /></p>

<p>where:</p>

<ul>
  <li>again, same problem of two transactions accessing the same data at the same time without locks</li>
</ul>

<h3 id="conflicting-operations">Conflicting Operations</h3>

<p>From the above examples, we can conclude what are some <strong>conflicted/critical operations</strong>.</p>

<blockquote>
  <p><strong>Conflicting Operations</strong></p>

  <ul>
    <li>Two operations conflict if it <strong>matters</strong> in which <strong>order</strong> they are performed.</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Read/Write Conflicts</strong></p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">R(x)</code>: ==conflicts== with <code class="language-plaintext highlighter-rouge">W(x)</code>
      <ul>
        <li>e.g. [Read-Write Conflicts] $T_1$ does read to <code class="language-plaintext highlighter-rouge">x</code>,  $T_2$ does write to <code class="language-plaintext highlighter-rouge">x</code>, and $T_1$ does read to <code class="language-plaintext highlighter-rouge">x</code></li>
      </ul>
    </li>
    <li><code class="language-plaintext highlighter-rouge">W(x)</code>: ==conflicts== with both <code class="language-plaintext highlighter-rouge">R(x)</code> and <code class="language-plaintext highlighter-rouge">W(x)</code>
      <ul>
        <li>e.g. [Dirty Read]  $T_1$ does write to <code class="language-plaintext highlighter-rouge">x</code>, and $T_2$ does read to <code class="language-plaintext highlighter-rouge">x</code></li>
        <li>e.g. [Overwriting] $T_1$ does a write to <code class="language-plaintext highlighter-rouge">x</code>, then $T_2$ also does a write to <code class="language-plaintext highlighter-rouge">x</code></li>
      </ul>
    </li>
  </ul>

  <p>All of the above are conflicts if ==the conflict operation of $T_2$ happened INSIDE/BEFORE $T_1$ commits==</p>
</blockquote>

<p>Basically, only <code class="language-plaintext highlighter-rouge">R(x)</code> does not conflict with <code class="language-plaintext highlighter-rouge">R(x)</code>.</p>

<h3 id="testing-for-serializability">Testing for Serializability</h3>

<p>Now, we know what could goes to conflict, we need to have a way to decide <strong>which scheduling is serializable</strong>.</p>

<ul>
  <li>i.e. which scheduling has the <em>same effect as a serialized transaction</em></li>
</ul>

<blockquote>
  <p><strong>Precedence Graph</strong></p>

  <ul>
    <li>A directed graph in which
      <ul>
        <li><strong>nodes</strong> represent transactions in a schedule $S$ (T1, T2, etc)</li>
        <li>An edge $T_i \to T_j$, $i \neq j$, means that one of $T_i$’s operations <strong>precedes</strong> and <strong>conflicts</strong> ==one== of $T_j$’s ops.</li>
      </ul>
    </li>
    <li>A schedule $S$ is ==serializable== if its $PG$ has <strong>no cycles.</strong></li>
  </ul>
</blockquote>

<p><u>*For Example:*</u>
\(S = R_1(x)R_2(x)W_1(x)W_2(x)\)
where we see that:</p>

<ul>
  <li>there are <strong>two concurrent transactions</strong></li>
</ul>

<p>Drawing the PG graph, we see:</p>

<p><img src="D:\Dropbox\SEAS2020\Spring Semester\Intro to Databases\notes\images\Snipaste_2021-04-09_18-41-09.png" style="zoom: 50%;" /></p>

<p>where:</p>

<ul>
  <li>$T_1 \to T_2$ because $R_1(x)$ precedes $W_2(x)$ (also, $W_1(x)$ precedes $W_2(x)$)</li>
  <li>$T_2 \to T_1$ because $R_2(x)$ precedes $W_1(x)$</li>
</ul>

<p>There is a cycle, so this <strong>schedule is not serializable</strong>.</p>

<blockquote>
  <p><strong>Understanding</strong></p>

  <p>This works simply because:</p>

  <ul>
    <li>If ==an edge $T_i \to T_j$ exists== in the precedence graph, then, in any serial schedule $S′$ ==equivalent== to $S$, we will have ==$T_i$ must appear before $T_j$.==
      <ul>
        <li>i.e. $T_1$ <strong>precedes</strong> $T_2$, this means the <strong>net result is equivalent to $T_2$ happening after</strong> $T_1$</li>
        <li>i.e. the work that $T_2$ did <strong>overwrites</strong> the work of $T_1$, so net result is equivalent to $T_2$ happening serially after.</li>
      </ul>
    </li>
    <li>Therefore, if you have a cycle, then it is not serializable.</li>
  </ul>
</blockquote>

<h3 id="equivalent-serial-schedule">Equivalent Serial Schedule</h3>

<p>Now, if we have a <em>serializable schedule</em>, when we should be able to <strong>do a topological sort</strong> that produces (<strong>one of the possible</strong>) ==serialized== transactions.</p>

<blockquote>
  <p><strong>Topological Sort</strong></p>

  <ul>
    <li>recursively find nodes with <code class="language-plaintext highlighter-rouge">indegree=0</code>
      <ul>
        <li>remove the node, and decrease all the <em>connected</em> nodes with <code class="language-plaintext highlighter-rouge">--indegree</code></li>
      </ul>
    </li>
  </ul>
</blockquote>

<p><u>*For Example:*</u></p>

<p>Consider:
\(S = R_1(x)R_2(y)R_3(z)W_3(z)R_1(z)R_2(z)W_4(x)W_4(y)\)
where we see conflicts:</p>

<ul>
  <li>$R_1(x)$ conflicts $W_4(x)$, <strong>hence $T_1 \to T_4$</strong></li>
  <li>$R_2(y)$ conflicts $W_4(y)$, <strong>hence</strong> $T_2 \to T_4$</li>
  <li>$W_3(z)$ conflicts $R_1(z)$, <strong>hence</strong> $T_3 \to T_1$</li>
  <li>$W_3(z)$ conflicts $R_2(z)$, <strong>hence</strong> $T_3 \to T_2$</li>
</ul>

<p>So our graph looks like</p>

<pre><code class="language-mermaid">graph LR
    T1 --&gt; T4
    T2 --&gt; T4
    T3 --&gt; T1
    T3 --&gt; T2
</code></pre>

<p>Therefore, you will have the <strong>topological sorting of</strong>:</p>

<ul>
  <li>$T_3 \to T_1 \to T_2 \to T_4$</li>
  <li>or $T_3 \to T_2 \to T_1 \to T_4$</li>
</ul>

<p>both of the above would be <strong>equivalent</strong></p>

<blockquote>
  <p><strong>Understanding</strong></p>

  <ul>
    <li>recall that If <strong>an edge $T_i \to T_j$ exists</strong> in the precedence graph, then, in any serial schedule $S′$ equivalent to $S$, we will have <strong>$T_i$ must appear before $T_j$</strong>.
      <ul>
        <li>i.e. $T_1$ <strong>precedes</strong> $T_2$, this means the net result is equivalent to $T_2$ happening serially after $T_1$</li>
        <li>i.e. the work that $T_2$ did <strong>overwrites</strong> the work of $T_1$, so net result is <strong>equivalent to $T_2$ happening serially after.</strong></li>
      </ul>
    </li>
    <li>Therefore, if $T_i$ has <code class="language-plaintext highlighter-rouge">indegree=0</code>, then $T_i$ basically ==precedes everyone==
      <ul>
        <li>i.e. the <strong>net equivalent serial version</strong> will have $T_1$ going first</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="lock-based-concurrency-control">Lock-Based Concurrency Control</h2>

<p>This is <strong>one way</strong> of how we could implement the idea mentioned above.</p>

<blockquote>
  <p><strong>Strick Two-Phase Locking Protocol</strong></p>

  <ul>
    <li>Each Transaction must obtain
      <ul>
        <li>a <code class="language-plaintext highlighter-rouge">S</code> or <code class="language-plaintext highlighter-rouge">R</code> ==(shared) lock== on object before <strong>reading</strong>
          <ul>
            <li>i.e. <code class="language-plaintext highlighter-rouge">R(x)</code> followed by <code class="language-plaintext highlighter-rouge">R(x)</code> is ok (of different transactions)</li>
          </ul>
        </li>
        <li>an <code class="language-plaintext highlighter-rouge">X</code> or <code class="language-plaintext highlighter-rouge">W</code> ==(exclusive) lock== on object before <strong>writing</strong>.
          <ul>
            <li>i.e. <code class="language-plaintext highlighter-rouge">R(x)</code> followed by <code class="language-plaintext highlighter-rouge">W(x)</code> is <strong>not</strong> ok (of different transactions)</li>
            <li>i.e. <code class="language-plaintext highlighter-rouge">W(x)</code> followed by <code class="language-plaintext highlighter-rouge">W(x)</code> is <strong>not</strong> ok (of different transactions)</li>
          </ul>
        </li>
      </ul>
    </li>
    <li>All <strong>locks</strong> held by a transaction are <strong>released</strong> when the ==transaction completes==
      <ul>
        <li>(Non-strict) 2PL Variant: Release locks anytime, but cannot acquire locks after releasing any lock.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>Therefore, we can easily generate a <strong>compatibility of locks</strong></p>

<table>
  <thead>
    <tr>
      <th>T1/T2</th>
      <th>Read(x)</th>
      <th>Write(x)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Read(x)</strong></td>
      <td>Compatible</td>
      <td>Not Compatible</td>
    </tr>
    <tr>
      <td><strong>Write(x)</strong></td>
      <td>Not Compatible</td>
      <td>Not Compatible</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>Advantage</strong></p>

  <ul>
    <li>Strict 2PL allows <strong>serializable schedules.</strong></li>
  </ul>

  <p><strong>Disadvantage</strong></p>

  <ul>
    <li>(Non-strict) 2PL also allows only serializable schedules, but involves more complex <strong>abort processing</strong></li>
    <li>Need to deal with <strong>deadlocks</strong></li>
  </ul>
</blockquote>

<p>Anyway we are back to the idea from OS, where we have <code class="language-plaintext highlighter-rouge">mutex</code> locks. Therefore, we need to think about problems such as:</p>

<ul>
  <li>deadlocks</li>
</ul>

<h3 id="deadlocks">Deadlocks</h3>

<p>Consider the case:</p>

<table>
  <thead>
    <tr>
      <th>T2</th>
      <th>T2</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>R(x)</td>
      <td> </td>
      <td>Granted <code class="language-plaintext highlighter-rouge">R(x)</code> lock</td>
    </tr>
    <tr>
      <td> </td>
      <td>R(y)</td>
      <td>Granted <code class="language-plaintext highlighter-rouge">R(y)</code> lock</td>
    </tr>
    <tr>
      <td>W(y)</td>
      <td> </td>
      <td>Blocked until <code class="language-plaintext highlighter-rouge">R(y)</code> released</td>
    </tr>
    <tr>
      <td> </td>
      <td>W(x)</td>
      <td>Blocked until <code class="language-plaintext highlighter-rouge">R(x)</code> released -&gt; ==Deadlock==</td>
    </tr>
  </tbody>
</table>

<p>Basically, the situation is:</p>

<pre><code class="language-mermaid"> sequenceDiagram
    T1-&gt;&gt;T2: Grabs Lock(x)
    T2-&gt;&gt;T1: Grabs Lock(y)
    T1-&gt;T2: Lock(y) ?
    T1-&gt;T2: Lock(x) ?
    Note over T1,T2: A Deadlock
</code></pre>

<hr />

<p>An even simpler case is:</p>

<table>
  <thead>
    <tr>
      <th>T2</th>
      <th>T2</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>R(x)</td>
      <td> </td>
      <td>Granted <code class="language-plaintext highlighter-rouge">R(x)</code> lock</td>
    </tr>
    <tr>
      <td> </td>
      <td>R(x)</td>
      <td>Granted <code class="language-plaintext highlighter-rouge">R(x)</code> lock</td>
    </tr>
    <tr>
      <td>W(x)</td>
      <td> </td>
      <td>Blocked until <code class="language-plaintext highlighter-rouge">R(x)</code> released</td>
    </tr>
    <tr>
      <td> </td>
      <td>W(x)</td>
      <td>Blocked until <code class="language-plaintext highlighter-rouge">R(x)</code> released -&gt; ==Deadlock==</td>
    </tr>
  </tbody>
</table>

<hr />

<blockquote>
  <p><strong><em>Reminder: Deadlocks</em></strong> [from OS]</p>

  <p>A deadlock situation can arise if the following four conditions <strong>hold simultaneously</strong> in a system:</p>

  <ol>
    <li>there is some form of <em>mutual exclusion</em> (e.g. locks for a resource)</li>
    <li>there is some form of <em>hold and wait</em> (e.g. holding <code class="language-plaintext highlighter-rouge">lock1</code> and waiting for <code class="language-plaintext highlighter-rouge">lock2</code>)
      <ul>
        <li>basically, you are grabbing multiple locks.</li>
      </ul>
    </li>
    <li>a <strong><em>circular wait</em></strong> (e.g. process $P_1$ waits for $P_2$, and $P_2$ waits for $P_1$)
      <ul>
        <li>in a sense, this implies rule 1 and 2 as well</li>
      </ul>
    </li>
    <li><em>no preemption</em> (e.g. timeouts for locks)</li>
  </ol>
</blockquote>

<blockquote>
  <p><strong>Possible Solution for DBMS</strong></p>

  <ul>
    <li>The scheduler must <strong>abort some transactions</strong> to resolve a deadlock
      <ul>
        <li>the brute force solution</li>
      </ul>
    </li>
    <li>then <strong>restart</strong> the aborted transaction</li>
  </ul>
</blockquote>

<h1 id="final">Final</h1>

<blockquote>
  <p><strong>Info</strong></p>

  <ul>
    <li>Thursday, April 22 at 10:10 am (Alternative exam at <strong>9 pm</strong>)</li>
    <li>
      <p>online, cumulative, open book/notes, and access to the internet is allowed.</p>
    </li>
    <li>90 minutes</li>
  </ul>
</blockquote>

<p>Topics included in the exam (<strong>Deck = PowerPoint Number</strong>)</p>

<ol>
  <li>Lectures #1 to #6. Included: all topics, decks 01-, 02-, 03-, 04a- and 04b- (slides 1-19 only). These are exactly the topics covered in the midterm exam.</li>
  <li>Lectures #7 and #8. Included: Triggers (deck 04c), Security and Authorization (deck 06), Object-Relational DBMS (deck 08); general concepts at the level of detail discussed in class. You will not be asked to write your own trigger statements or Object-Relational SQL statements. 
Excluded: all other topics, namely, Normalization (deck 07), and Embedded SQL, APIs are excluded.</li>
  <li>Lectures #9 to #10. Included: Storage and indexing (deck 30) and Query processing (deck 40), at the level of detail discussed in class.</li>
  <li>Lecture #11 to #12: Included: Transaction Processing, only the first part that deals with Concurrency Control and at the level of detail covered in class (deck 50, slides &lt;= 16 only). Excluded: Recovery (deck 50, slides &gt; 16) and everything in Lecture #12.</li>
</ol>

<p>==Difficulty==:</p>

<ul>
  <li><strong>Homework</strong> level.</li>
  <li>B+-Tree would be by default level <code class="language-plaintext highlighter-rouge">3</code> for lookup</li>
</ul>

<p>==Difference== between Midterm</p>

<ul>
  <li>Query optimization (indexes and storages)</li>
  <li>Transactions</li>
</ul>

<h1 id="beyond-cs4111">Beyond CS4111</h1>

<blockquote>
  <p><strong>This section is of course not included in the final</strong></p>
</blockquote>

<p>Some topics below are also discussed in ==4112==:</p>

<ul>
  <li>Main memory and <strong>SSDs databases</strong></li>
  <li>Parallel/multicore databases - <em>more delicate on concurrencies</em></li>
  <li>Distributed databases</li>
  <li>Decentralized (peer-to-peer), <strong>blockchain</strong></li>
  <li>Data mining (basically <strong>statistics</strong>)</li>
  <li>Big data, data analytics, data warehousing, decision support</li>
</ul>

<p>Some topics discussed in ==6111==:</p>

<ul>
  <li>Information retrieval &amp; databases (<strong>Web search, i.e. Google Search</strong>, web scrapers, XML)</li>
  <li>NoSQL (became <strong>NOSQL</strong>) databases, document, <strong>graph databases</strong>, key-value
    <ul>
      <li>NOSQL - not only SQL, which means it also supports programming languages for query</li>
    </ul>
  </li>
  <li>Column-store databases</li>
</ul>

<h2 id="samples-of-newer-dbms">Samples of Newer DBMS</h2>

<ul>
  <li>StreamBase (streaming data, acquired by TIBCO, 2013)</li>
  <li>MongoDB (document)</li>
  <li>Redis(open-source, in-memory key-value)</li>
  <li>From AWS: Aurora (RDBMS), DynamoDB(NoSQL), DocumentDB (Doc DB), ElastiCache (in-memory), Neptune (graph), <strong>QLDB</strong> (blockchain), <strong>Redshift</strong> (data warehousing), Timestream (time series)</li>
</ul>

<h1 id="useful-tricks">Useful Tricks</h1>

<p>Auto-generated column in PostgreSQL</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">"Piazza"</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">cid</span> <span class="k">ADD</span> <span class="k">generated</span> <span class="n">always</span> <span class="k">as</span> <span class="k">identity</span> <span class="p">(</span><span class="k">START</span> <span class="k">WITH</span> <span class="mi">13</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="good-queries">Good Queries</h2>

<p>Setup:</p>

<ul>
  <li>student(<strong>sid</strong>, sname, sex, age, year, gpa)</li>
  <li>dept(<strong>dname</strong>, numphds)</li>
  <li>prof(<strong>pname</strong>, dname, FK(dname)-&gt;dept)</li>
  <li>course(<strong>cno</strong>, cname, <strong>dname</strong>, FK(dname)-&gt;dept)</li>
  <li>major(<strong>dname</strong>, <strong>sid</strong>, FK(dname)-&gt;dept, FK(sid)-&gt;student)</li>
  <li>section(<strong>dname</strong>, <strong>cno</strong>, <strong>sectno</strong>, pname, FK(dname, cno)-&gt;course, FK(pname)-&gt;prof)</li>
  <li>enroll(<strong>sid</strong>, grade, <strong>dname</strong>, <strong>cno</strong>, sectno, FK(sid)-&gt;student, FK(dname,cno,sectno)-&gt;section)</li>
</ul>

<hr />

<p>Print the name of students who have enrolled in ==all courses== offered by the ‘Chemical Engineering’ department.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">From</span> <span class="n">Student</span> <span class="n">s</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">(</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="k">c</span><span class="p">.</span><span class="n">cno</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">dname</span> 
   <span class="k">FROM</span> <span class="n">course</span> <span class="k">c</span> 
   <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">dname</span><span class="o">=</span><span class="s1">'Chemical Engineering'</span><span class="p">)</span>
   <span class="k">EXCEPT</span>
   <span class="p">(</span><span class="k">SELECT</span> <span class="k">c</span><span class="p">.</span><span class="n">cno</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">dname</span> 
    <span class="k">FROM</span> <span class="n">course</span> <span class="k">c</span>
    <span class="k">JOIN</span> <span class="n">enroll</span> <span class="n">e</span> <span class="k">on</span> <span class="n">e</span><span class="p">.</span><span class="n">cno</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">cno</span>
    <span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">sid</span> <span class="k">AND</span> <span class="k">c</span><span class="p">.</span><span class="n">dname</span><span class="o">=</span><span class="s1">'Chemical Engineering'</span><span class="p">)</span> <span class="cm">/* inner query -&gt; nested loop */</span>
<span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>
      <p>this can be further simplified to:</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">From</span> <span class="n">Student</span> <span class="n">s</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">(</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="k">c</span><span class="p">.</span><span class="n">cno</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">dname</span> 
   <span class="k">FROM</span> <span class="n">course</span> <span class="k">c</span> 
   <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">dname</span><span class="o">=</span><span class="s1">'Chemical Engineering'</span><span class="p">)</span>
   <span class="k">EXCEPT</span>
   <span class="p">(</span><span class="k">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">cno</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">dname</span>
    <span class="k">FROM</span> <span class="n">enroll</span> <span class="n">e</span>
    <span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">sid</span> <span class="cm">/* AND e.dname='Chemical Engineering' */</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>      </div>
    </li>
  </ul>
</blockquote>

<hr />

<p>Print the name and age of the student(s) with the highest GPA in ==their exact age group==</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">student</span> <span class="n">s</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">18</span> <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">gpa</span> <span class="o">&gt;=</span> <span class="k">ALL</span><span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">s1</span><span class="p">.</span><span class="n">gpa</span>
    <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
    <span class="k">WHERE</span> <span class="n">s1</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">age</span> <span class="cm">/* inner query -&gt; nested loop */</span>
<span class="p">)</span>
</code></pre></div></div>

<p>alternatively:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">student</span> <span class="n">s</span>
<span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">18</span> <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">gpa</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">gpa</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
    <span class="k">WHERE</span> <span class="n">s1</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">age</span> <span class="cm">/* inner query -&gt; nested loop */</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<p>For each department with more than 8 students majoring in the department, print the following information about the student(s) with the highest GPA within the department</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">student</span> <span class="n">s</span>
<span class="k">JOIN</span> <span class="n">major</span> <span class="n">m</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span> <span class="k">IN</span> <span class="p">(</span> <span class="cm">/* For each department with more than 8 students */</span>
    <span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
    <span class="k">FROM</span> <span class="n">major</span> <span class="n">m</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
    <span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> 
	<span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">gpa</span> <span class="o">=</span> <span class="p">(</span> <span class="cm">/* highest GPA within the department */</span>
        <span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">gpa</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
        <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m1</span> <span class="k">ON</span> <span class="n">s1</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="n">sid</span>
        <span class="k">WHERE</span> <span class="n">m1</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
        <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">m1</span><span class="p">.</span><span class="n">dname</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>Step 1:</p>

<ul>
  <li>get the <strong>students</strong> who are majoring in a department where there are “more than 8 students majoring in the department”</li>
</ul>

<p>Step 2:</p>

<ul>
  <li>==for each student==, find the <strong>department’s corresponding</strong> <code class="language-plaintext highlighter-rouge">MAX(GPA)</code></li>
</ul>

<hr />

<blockquote>
  <p><strong>Rising stars.</strong></p>

  <ul>
    <li>We want to collect statistics about rising stars: these are students who are younger than the average age of students majoring in the same department and who have a GPA that is at least 20% higher than the average GPA of students majoring in the same department. For each department with at least 3 students majoring in the department, print the department name, the total number of students majoring in the department and the average age and average GPA of all students majoring in this department, followed by the same information for the rising stars of this department (i.e., the number of rising stars in the department as well as their average age and average GPA). Consider only those departments that have at least one rising star majoring in the department.</li>
  </ul>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">RisingStar</span> <span class="k">AS</span><span class="p">(</span>
    <span class="k">SELECT</span> <span class="o">*</span>
    <span class="k">FROM</span> <span class="n">student</span> <span class="n">s</span>
    <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">sid</span>
    <span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">age</span>  <span class="o">&lt;</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
        <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m1</span> <span class="k">ON</span> <span class="n">s1</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="n">sid</span>
        <span class="k">WHERE</span> <span class="n">m1</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
    <span class="p">)</span> <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">gpa</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">gpa</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
        <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m1</span> <span class="k">ON</span> <span class="n">s1</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="n">sid</span>
        <span class="k">WHERE</span> <span class="n">m1</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
    <span class="p">)</span>
<span class="p">)</span> 
<span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">dname</span><span class="p">),</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">gpa</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_gpa</span><span class="p">,</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_age</span><span class="p">,</span> 
	<span class="p">(</span> <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">RisingStar</span> <span class="n">r</span> <span class="k">WHERE</span> <span class="n">r</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rs_count</span><span class="p">,</span>  
	<span class="p">(</span> <span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">gpa</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">RisingStar</span> <span class="n">r</span> <span class="k">WHERE</span> <span class="n">r</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rs_gpa_avg</span><span class="p">,</span>
<span class="k">FROM</span> <span class="n">student</span> <span class="n">s</span>
<span class="k">JOIN</span> <span class="n">major</span> <span class="n">m</span> <span class="k">on</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">sid</span>
<span class="k">WHERE</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">r</span><span class="p">.</span><span class="n">dname</span> <span class="k">FROM</span> <span class="n">RisingStar</span> <span class="n">r</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>
</code></pre></div></div>

<p>where this is clear so that:</p>

<ul>
  <li>
    <p>“<strong>students</strong> who are younger than the average age of students majoring in the same department and who have a GPA that is at least 20% higher than the average GPA of students majoring in the same department” is achieved by:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">RisingStar</span> <span class="k">AS</span><span class="p">(</span>
    <span class="k">SELECT</span> <span class="o">*</span>
    <span class="k">FROM</span> <span class="n">student</span> <span class="n">s</span>
    <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m</span> <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">sid</span>
    <span class="k">WHERE</span> <span class="n">s</span><span class="p">.</span><span class="n">age</span>  <span class="o">&lt;</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
        <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m1</span> <span class="k">ON</span> <span class="n">s1</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="n">sid</span>
        <span class="k">WHERE</span> <span class="n">m1</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
    <span class="p">)</span> <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">gpa</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">gpa</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">student</span> <span class="n">s1</span>
        <span class="k">JOIN</span> <span class="n">major</span> <span class="n">m1</span> <span class="k">ON</span> <span class="n">s1</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="n">sid</span>
        <span class="k">WHERE</span> <span class="n">m1</span><span class="p">.</span><span class="n">dname</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">dname</span>
    <span class="p">)</span>
<span class="p">)</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>“For each department with at least 3 students majoring in the <strong>department</strong>, …” is achieved by the latter part of the query</p>
  </li>
</ul>

<h2 id="check-constraint">Check Constraint</h2>

<p><img src="\lectures\images\typora-user-images\image-20210422172531602.png" alt="image-20210422172531602" style="zoom: 67%;" /></p>

<p>To enforce <strong>total participation or $\ge 1$ participation</strong>, for the <code class="language-plaintext highlighter-rouge">Employee</code> and <code class="language-plaintext highlighter-rouge">WorksIn</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">ASSERTION</span> <span class="n">EmployeesMustWorkSomewhere</span> <span class="p">(</span>
    <span class="k">CHECK</span> <span class="p">(</span>
        <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span>
            <span class="k">SELECT</span> <span class="n">ssn</span>  
            <span class="k">FROM</span> <span class="n">Employee</span> 
            <span class="k">WHERE</span> <span class="n">snn</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">snn</span> <span class="k">FROM</span> <span class="n">WorksIn</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="function">Function</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"compute_total_sub_posts"</span><span class="p">()</span>
  <span class="k">RETURNS</span> <span class="nv">"pg_catalog"</span><span class="p">.</span><span class="nv">"trigger"</span> <span class="k">AS</span> <span class="err">$</span><span class="n">BODY</span><span class="err">$</span>
<span class="k">DECLARE</span>
    <span class="n">curr</span> <span class="n">RECORD</span><span class="p">;</span>
    <span class="n">parent</span> <span class="n">RECORD</span><span class="p">;</span>
    <span class="n">curr_cid</span> <span class="n">int8</span><span class="p">;</span>
    <span class="n">parent_cid</span> <span class="n">int8</span><span class="p">;</span>
    <span class="n">action_type</span> <span class="n">int4</span><span class="p">;</span> <span class="c1">-- 0:old, 1: new</span>
<span class="k">BEGIN</span>
    <span class="n">raise</span> <span class="n">notice</span> <span class="s1">'OLD: %, NEW: %'</span><span class="p">,</span> <span class="k">OLD</span><span class="p">,</span> <span class="k">NEW</span><span class="p">;</span>
    <span class="n">raise</span> <span class="n">notice</span> <span class="s1">'OLD.child_cid: %, NEW.child_cid: %'</span><span class="p">,</span> <span class="k">OLD</span><span class="p">.</span><span class="n">child_cid</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">child_cid</span><span class="p">;</span>

    <span class="c1">-- check action that activates the trigger</span>
    <span class="n">if</span> <span class="k">OLD</span> <span class="k">is</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">then</span>
        <span class="n">action_type</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">curr_cid</span> <span class="p">:</span><span class="o">=</span> <span class="k">OLD</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
    <span class="n">elsif</span> <span class="k">NEW</span> <span class="k">is</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">then</span>
        <span class="n">action_type</span> <span class="p">:</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">curr_cid</span> <span class="p">:</span><span class="o">=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>


    <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="n">pz</span> <span class="k">WHERE</span> <span class="n">pz</span><span class="p">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">curr_cid</span> <span class="k">INTO</span> <span class="n">curr</span><span class="p">;</span>
    <span class="k">SELECT</span> <span class="n">cid</span> <span class="k">FROM</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza_Thread"</span> <span class="k">WHERE</span> <span class="n">child_cid</span> <span class="o">=</span> <span class="n">curr</span><span class="p">.</span><span class="n">cid</span> <span class="k">INTO</span>  <span class="n">parent_cid</span><span class="p">;</span>

    <span class="c1">-- if it is deleted, we use the parent to start with</span>
    <span class="c1">-- if is old:</span>
          <span class="c1">-- current = parent of current</span>
    <span class="n">if</span> <span class="n">action_type</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span>
          <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="n">pz</span> <span class="k">WHERE</span> <span class="n">pz</span><span class="p">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">parent_cid</span> <span class="k">INTO</span> <span class="n">curr</span><span class="p">;</span>
    <span class="k">end</span> <span class="n">if</span><span class="p">;</span>

    <span class="c1">-- initialization</span>
    <span class="k">update</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="k">set</span> <span class="n">c_inode</span><span class="p">.</span><span class="n">comment_words</span> <span class="o">=</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="nv">"comment"</span><span class="p">)</span> <span class="k">where</span> <span class="n">cid</span><span class="o">=</span><span class="n">curr</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
    <span class="k">update</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="k">set</span> <span class="n">c_inode</span><span class="p">.</span><span class="n">likes</span> <span class="o">=</span> <span class="n">curr</span><span class="p">.</span><span class="n">upvote</span> <span class="k">where</span> <span class="n">cid</span><span class="o">=</span><span class="n">curr</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
    <span class="k">update</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="k">set</span> <span class="n">c_inode</span><span class="p">.</span><span class="n">dislikes</span> <span class="o">=</span> <span class="n">curr</span><span class="p">.</span><span class="n">downvote</span> <span class="k">where</span> <span class="n">cid</span><span class="o">=</span><span class="n">curr</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
    <span class="c1">-- end of init</span>

    <span class="n">raise</span> <span class="n">notice</span> <span class="s1">'curr: %'</span><span class="p">,</span> <span class="n">curr</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>

    <span class="n">while</span> <span class="n">curr</span> <span class="k">is</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">loop</span>

		<span class="n">if</span> <span class="n">action_type</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span>
			<span class="k">update</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> 
				<span class="k">set</span> <span class="n">c_inode</span><span class="p">.</span><span class="n">total_sub_posts</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_inode</span><span class="p">).</span><span class="n">total_sub_posts</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">where</span> <span class="n">cid</span><span class="o">=</span><span class="n">curr</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
              <span class="c1">-- curr.c_inode.total_sub_posts++;</span>
		<span class="n">elsif</span> <span class="n">action_type</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span>
			<span class="k">update</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> 
				<span class="k">set</span> <span class="n">c_inode</span><span class="p">.</span><span class="n">total_sub_posts</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_inode</span><span class="p">).</span><span class="n">total_sub_posts</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">where</span> <span class="n">cid</span><span class="o">=</span><span class="n">curr</span><span class="p">.</span><span class="n">cid</span><span class="p">;</span>
			<span class="k">end</span> <span class="n">if</span><span class="p">;</span>

        	<span class="c1">-- current = parent of current</span>
         <span class="k">SELECT</span> <span class="n">cid</span> <span class="k">FROM</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza_Thread"</span> <span class="k">WHERE</span> <span class="n">child_cid</span> <span class="o">=</span> <span class="n">curr</span><span class="p">.</span><span class="n">cid</span> <span class="k">into</span> <span class="n">parent_cid</span><span class="p">;</span>
         <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="n">pz</span> <span class="k">WHERE</span> <span class="n">pz</span><span class="p">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">parent_cid</span> <span class="k">INTO</span> <span class="n">curr</span><span class="p">;</span>

    <span class="k">end</span> <span class="n">loop</span><span class="p">;</span>

<span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$</span><span class="n">BODY</span><span class="err">$</span>
  <span class="k">LANGUAGE</span> <span class="n">plpgsql</span> <span class="k">VOLATILE</span>
  <span class="n">COST</span> <span class="mi">100</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li>
    <p>this function is <strong>specifically used for <code class="language-plaintext highlighter-rouge">Trigger</code></strong></p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">OLD</code> will refer to the data after <code class="language-plaintext highlighter-rouge">DELETE</code></li>
  <li><code class="language-plaintext highlighter-rouge">NEW</code> will refer to the data after <code class="language-plaintext highlighter-rouge">INSERT</code></li>
  <li>if we are doing this for <code class="language-plaintext highlighter-rouge">UPDATE</code>, then both <code class="language-plaintext highlighter-rouge">NEW</code> and <code class="language-plaintext highlighter-rouge">OLD</code> will be not null</li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <ul>
    <li>the keywords are ==only== available for the trigger with <code class="language-plaintext highlighter-rouge">AFTER event_list ON table </code></li>
  </ul>
</blockquote>

<h2 id="trigger">Trigger</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="nv">"total_sub_posts"</span> 
<span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">OR</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"Piazza_Thread"</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
<span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="nv">"xy2437"</span><span class="p">.;</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">"compute_total_sub_posts"()</code> is a <strong>function</strong> that I created in the previous section</li>
</ul>

<h2 id="composite-type">Composite Type</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="nv">"xy2437"</span><span class="p">.</span><span class="nv">"c_inode"</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="nv">"comment_words"</span> <span class="n">tsvector</span><span class="p">,</span>
  <span class="nv">"total_sub_posts"</span> <span class="n">int4</span><span class="p">,</span>
  <span class="nv">"likes"</span> <span class="n">int8</span><span class="p">,</span>
  <span class="nv">"dislikes"</span> <span class="n">int8</span>
<span class="p">);</span>
</code></pre></div></div>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tsvector</code> basically can <strong>convert a string to ==words== as their occurrences</strong></li>
</ul>

<blockquote>
  <p><strong>Note: Using Full Text Search for <code class="language-plaintext highlighter-rouge">tsvector</code></strong></p>

  <ul>
    <li>
      <p>basically the <code class="language-plaintext highlighter-rouge">@@</code> syntax:</p>

      <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">nickname</span><span class="p">,</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">evtname</span><span class="p">,</span>
	<span class="n">pc</span><span class="p">.</span><span class="nv">"comment"</span><span class="p">,</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">downvote</span><span class="p">,</span>
	<span class="n">pc</span><span class="p">.</span><span class="nv">"timestamp"</span> 
<span class="k">FROM</span>
	<span class="nv">"Piazza_Comments"</span> <span class="n">pc</span> 
<span class="k">WHERE</span>
	<span class="n">pc</span><span class="p">.</span><span class="n">cid</span> <span class="k">IN</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="n">cid</span> <span class="k">FROM</span> <span class="n">xy2437</span><span class="p">.</span><span class="nv">"Piazza"</span> <span class="k">WHERE</span> <span class="p">(</span> <span class="n">c_inode</span> <span class="p">).</span><span class="n">comment_words</span> <span class="o">@@</span><span class="s1">'fuck'</span> <span class="p">::</span> <span class="n">tsquery</span> <span class="p">)</span>
</code></pre></div>      </div>

      <p>which searches for all comments that <strong>contains the word <code class="language-plaintext highlighter-rouge">'fuck'</code></strong></p>
    </li>
  </ul>
</blockquote>

  </div><a class="u-url" href="/lectures/2020@columbia/COMS4111_Intro_to_Databases.html/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/lectures/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Lecture Notes</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Lecture Notes</li><li><a class="u-email" href="mailto:jasonyux17@gmail.com">jasonyux17@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jasonyux"><svg class="svg-icon"><use xlink:href="/lectures/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jasonyux</span></a></li><li><a href="https://www.linkedin.com/in/xiao-yu2437"><svg class="svg-icon"><use xlink:href="/lectures/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">xiao-yu2437</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>An inexhaustive collection of markdown/latex(PDF) notes that I took since college. </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
