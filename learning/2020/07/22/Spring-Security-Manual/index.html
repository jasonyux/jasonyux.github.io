<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/learning/images/logo-180x180.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/learning/images/logo-32x32.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/learning/images/logo-16x16.jpg">

<link rel="stylesheet" href="/learning/css/main.css">


<link rel="stylesheet" href="/learning/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jasonyux.github.io","root":"/learning/","scheme":"Pisces","version":"8.0.0-rc.3","exturl":false,"sidebar":{"position":"left","width":350,"display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="IMPORTANT:Some of the content here is a personal summary&#x2F;abbreviation of contents on the Offical Spring Security Documentation. Feel free to refer to the official site if you think some of the sectio">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security (OAuth2) Manual">
<meta property="og:url" content="https://jasonyux.github.io/2020/07/22/Spring-Security-Manual/index.html">
<meta property="og:site_name" content="From a Beginner to a Disaster">
<meta property="og:description" content="IMPORTANT:Some of the content here is a personal summary&#x2F;abbreviation of contents on the Offical Spring Security Documentation. Feel free to refer to the official site if you think some of the sectio">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchain.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/delegatingfilterproxy.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchainproxy.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/securityfilterchain.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/multi-securityfilterchain.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/exceptiontranslationfilter.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/securitycontextholder.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/providermanager.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/abstractauthenticationprocessingfilter.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/loginurlauthenticationentrypoint.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_5.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/usernamepasswordauthenticationfilter.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/daoauthenticationprovider.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_5.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/access-decision-voting.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/after-invocation.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authorization/filtersecurityinterceptor.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_5.png">
<meta property="og:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_6.png">
<meta property="article:published_time" content="2020-07-23T02:36:09.000Z">
<meta property="article:modified_time" content="2020-11-03T13:12:10.712Z">
<meta property="article:author" content="Xiao Yu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchain.png">

<link rel="canonical" href="https://jasonyux.github.io/2020/07/22/Spring-Security-Manual/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Spring Security (OAuth2) Manual | From a Beginner to a Disaster</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before, .use-motion .logo-line-after {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/learning/" class="brand" rel="start">
      <i class="logo-line-before"></i>
      <h1 class="site-title">From a Beginner to a Disaster</h1>
      <i class="logo-line-after"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Xiao.Y</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/learning/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/learning/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-Intro"><span class="nav-number">1.</span> <span class="nav-text">Spring Security Intro</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Getting-Spring-Security"><span class="nav-number">2.</span> <span class="nav-text">Getting Spring Security</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-Features"><span class="nav-number">3.</span> <span class="nav-text">Spring Security Features</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Authentication-Support"><span class="nav-number">3.1.</span> <span class="nav-text">Authentication Support</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Password-Storage-and-Encoding"><span class="nav-number">3.2.</span> <span class="nav-text">Password Storage and Encoding</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Password-Storage-History"><span class="nav-number">3.2.1.</span> <span class="nav-text">Password Storage History</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DelegatingPasswordEncoder"><span class="nav-number">3.2.2.</span> <span class="nav-text">DelegatingPasswordEncoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Encode-with-Spring-Boot-CLI"><span class="nav-number">3.2.3.</span> <span class="nav-text">Encode with Spring Boot CLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Password-Storage-Format"><span class="nav-number">3.2.4.</span> <span class="nav-text">Password Storage Format</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Password-Matching"><span class="nav-number">3.2.5.</span> <span class="nav-text">Password Matching</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Password-Encoders"><span class="nav-number">3.3.</span> <span class="nav-text">Password Encoders</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BCryptPasswordEncoder"><span class="nav-number">3.3.1.</span> <span class="nav-text">BCryptPasswordEncoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Argon2PasswordEncoder"><span class="nav-number">3.3.2.</span> <span class="nav-text">Argon2PasswordEncoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pbkdf2PasswordEncoder"><span class="nav-number">3.3.3.</span> <span class="nav-text">Pbkdf2PasswordEncoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SCryptPasswordEncoder"><span class="nav-number">3.3.4.</span> <span class="nav-text">SCryptPasswordEncoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Other-PasswordEncoders"><span class="nav-number">3.3.5.</span> <span class="nav-text">Other PasswordEncoders</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Protection-Against-Exploits"><span class="nav-number">3.4.</span> <span class="nav-text">Protection Against Exploits</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cross-Site-Request-Forgery"><span class="nav-number">3.4.1.</span> <span class="nav-text">Cross Site Request Forgery</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Protecting-Against-CSRF-Attacks"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">Protecting Against CSRF Attacks</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Synchronizer-Token-Pattern"><span class="nav-number">3.4.1.1.1.</span> <span class="nav-text">Synchronizer Token Pattern</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Same-Site-Attribute"><span class="nav-number">3.4.1.1.2.</span> <span class="nav-text">Same Site Attribute</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#When-to-use-CSRF-Protection"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">When to use CSRF Protection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CSRF-Considerations"><span class="nav-number">3.4.1.3.</span> <span class="nav-text">CSRF Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Logging-in"><span class="nav-number">3.4.1.3.1.</span> <span class="nav-text">Logging in</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Logging-Out"><span class="nav-number">3.4.1.3.2.</span> <span class="nav-text">Logging Out</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CSRF-and-Session-Timeouts"><span class="nav-number">3.4.1.3.3.</span> <span class="nav-text">CSRF and Session Timeouts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Multipart-File-Upload"><span class="nav-number">3.4.1.3.4.</span> <span class="nav-text">Multipart (File Upload)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-HTTP-Headers"><span class="nav-number">3.4.2.</span> <span class="nav-text">Security HTTP Headers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Default-Security-Headers"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">Default Security Headers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cache-Control"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">Cache Control</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Content-Type-Options"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">Content Type Options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-Strict-Transport-Security"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">HTTP Strict Transport Security</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-Frame-Options"><span class="nav-number">3.4.2.5.</span> <span class="nav-text">X-Frame-Options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-XSS-Protection"><span class="nav-number">3.4.2.6.</span> <span class="nav-text">X-XSS-Protection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Content-Security-Policy"><span class="nav-number">3.4.2.7.</span> <span class="nav-text">Content Security Policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Referrer-Policy"><span class="nav-number">3.4.2.8.</span> <span class="nav-text">Referrer Policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Feature-Policy"><span class="nav-number">3.4.2.9.</span> <span class="nav-text">Feature Policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Clear-Site-Data"><span class="nav-number">3.4.2.10.</span> <span class="nav-text">Clear Site Data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Custom-Headers"><span class="nav-number">3.4.2.11.</span> <span class="nav-text">Custom Headers</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redirecting-HTTP"><span class="nav-number">4.</span> <span class="nav-text">Redirecting HTTP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redirect-to-HTTPS"><span class="nav-number">4.1.</span> <span class="nav-text">Redirect to HTTPS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Proxy-Server-Configuration"><span class="nav-number">4.2.</span> <span class="nav-text">Proxy Server Configuration</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-Project-Modules"><span class="nav-number">5.</span> <span class="nav-text">Spring Security Project Modules</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Servlet-Security-The-Big-Picture"><span class="nav-number">6.</span> <span class="nav-text">Servlet Security: The Big Picture</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#A-Review-of-Filters"><span class="nav-number">6.1.</span> <span class="nav-text">A Review of Filters</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DelegatingFilterProxy"><span class="nav-number">6.2.</span> <span class="nav-text">DelegatingFilterProxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FilterChainProxy"><span class="nav-number">6.2.1.</span> <span class="nav-text">FilterChainProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SecurityFilterChain"><span class="nav-number">6.2.2.</span> <span class="nav-text">SecurityFilterChain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Filters"><span class="nav-number">6.2.3.</span> <span class="nav-text">Security Filters</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ExceptionTranslationFilter"><span class="nav-number">6.3.</span> <span class="nav-text">ExceptionTranslationFilter</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Realizations"><span class="nav-number">7.</span> <span class="nav-text">Realizations</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Boot-Spring-Security"><span class="nav-number">7.1.</span> <span class="nav-text">Spring Boot + Spring Security</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot-Auto-Configurations"><span class="nav-number">7.1.1.</span> <span class="nav-text">Spring Boot Auto Configurations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Authentication-Realizations"><span class="nav-number">7.2.</span> <span class="nav-text">Authentication Realizations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Form-Authentication"><span class="nav-number">7.2.1.</span> <span class="nav-text">Basic Form Authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Configuring-your-Spring-Security"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">Configuring your Spring Security</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Authentication-with-Spring-Security"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">Authentication with Spring Security</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication-Mechanism"><span class="nav-number">7.2.2.</span> <span class="nav-text">Authentication Mechanism</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AuthenticationManager"><span class="nav-number">7.2.2.1.</span> <span class="nav-text">AuthenticationManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ProviderManager"><span class="nav-number">7.2.2.2.</span> <span class="nav-text">ProviderManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AuthenticationProvider"><span class="nav-number">7.2.2.3.</span> <span class="nav-text">AuthenticationProvider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AuthenticationEntryPoint"><span class="nav-number">7.2.2.4.</span> <span class="nav-text">AuthenticationEntryPoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AbstractAuthenticationProcessingFilter"><span class="nav-number">7.2.2.5.</span> <span class="nav-text">AbstractAuthenticationProcessingFilter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Username-Password-Authentication"><span class="nav-number">7.2.2.6.</span> <span class="nav-text">Username&#x2F;Password Authentication</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Form-Authentication-Mechanism"><span class="nav-number">7.2.3.</span> <span class="nav-text">Form Authentication Mechanism</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DaoAuthenticationProvider"><span class="nav-number">7.2.3.1.</span> <span class="nav-text">DaoAuthenticationProvider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UserDetails-and-UserDetailsService"><span class="nav-number">7.2.3.2.</span> <span class="nav-text">UserDetails and UserDetailsService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PasswordEncoder"><span class="nav-number">7.2.3.3.</span> <span class="nav-text">PasswordEncoder</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication-with-Session"><span class="nav-number">7.2.4.</span> <span class="nav-text">Authentication with Session</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-Creation-Mechanism"><span class="nav-number">7.2.4.1.</span> <span class="nav-text">Session Creation Mechanism</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maximum-Session"><span class="nav-number">7.2.4.2.</span> <span class="nav-text">Maximum Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-Timeout"><span class="nav-number">7.2.4.3.</span> <span class="nav-text">Session Timeout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-Tracking"><span class="nav-number">7.2.4.4.</span> <span class="nav-text">Session Tracking</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-Fixation"><span class="nav-number">7.2.4.5.</span> <span class="nav-text">Session Fixation</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Remember-Me"><span class="nav-number">7.2.5.</span> <span class="nav-text">Remember Me</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Remember-Me-Cookie"><span class="nav-number">7.2.5.1.</span> <span class="nav-text">Remember Me - Cookie</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Remember-Me-Persistence"><span class="nav-number">7.2.5.2.</span> <span class="nav-text">Remember Me - Persistence</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prevent-Brute-Force-Authentication"><span class="nav-number">7.2.6.</span> <span class="nav-text">Prevent Brute Force Authentication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication-with-Token"><span class="nav-number">7.2.7.</span> <span class="nav-text">Authentication with Token</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Authorization-Realizations"><span class="nav-number">7.3.</span> <span class="nav-text">Authorization Realizations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Authorization-using-SimpleGrantedAuthority"><span class="nav-number">7.3.1.</span> <span class="nav-text">Basic Authorization using SimpleGrantedAuthority</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Authorization-Mechanism"><span class="nav-number">7.3.2.</span> <span class="nav-text">Authorization Mechanism</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Authority-GrantedAuthority"><span class="nav-number">7.3.2.1.</span> <span class="nav-text">Authority&#x2F;GrantedAuthority</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pre-Invocation-Handling"><span class="nav-number">7.3.2.2.</span> <span class="nav-text">Pre-Invocation Handling</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AccessDecisionManager"><span class="nav-number">7.3.2.2.1.</span> <span class="nav-text">AccessDecisionManager</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Voting-Based-AccessDecisionManager"><span class="nav-number">7.3.2.2.2.</span> <span class="nav-text">Voting-Based AccessDecisionManager</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#RoleVoter"><span class="nav-number">7.3.2.2.2.1.</span> <span class="nav-text">RoleVoter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#AuthenticatedVoter"><span class="nav-number">7.3.2.2.2.2.</span> <span class="nav-text">AuthenticatedVoter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Custom-Voters"><span class="nav-number">7.3.2.2.2.3.</span> <span class="nav-text">Custom Voters</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Post-Invocation-Handling"><span class="nav-number">7.3.2.3.</span> <span class="nav-text">Post-Invocation Handling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Overall-Work-Flow"><span class="nav-number">7.3.2.4.</span> <span class="nav-text">Overall Work Flow</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Expression-Based-Access-Control"><span class="nav-number">7.3.3.</span> <span class="nav-text">Expression-Based Access Control</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Common-Built-in-Expressions"><span class="nav-number">7.3.3.1.</span> <span class="nav-text">Common Built-in Expressions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Referring-to-Custom-Method-in-Web-Security-Expressions"><span class="nav-number">7.3.3.2.</span> <span class="nav-text">Referring to Custom Method in Web Security Expressions</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Using-Path-Variable"><span class="nav-number">7.3.3.2.1.</span> <span class="nav-text">Using Path Variable</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Method-Based-Security-Expressions"><span class="nav-number">7.3.3.3.</span> <span class="nav-text">Method Based Security Expressions</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Using-PreAuthorize-and-PostAuthorize"><span class="nav-number">7.3.3.3.1.</span> <span class="nav-text">Using @PreAuthorize and @PostAuthorize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Using-PreFilter-and-PostFilter"><span class="nav-number">7.3.3.3.2.</span> <span class="nav-text">Using @PreFilter and @PostFilter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#The-PermissionEvaluator-interface-hasPermission"><span class="nav-number">7.3.3.3.3.</span> <span class="nav-text">The PermissionEvaluator interface&#x2F;hasPermission()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Using-Secure"><span class="nav-number">7.3.3.3.4.</span> <span class="nav-text">Using @Secure</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Domain-Object-Security-ACLs"><span class="nav-number">7.3.4.</span> <span class="nav-text">Domain Object Security (ACLs)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Registration-Realizations"><span class="nav-number">7.4.</span> <span class="nav-text">Registration Realizations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Form-Registration"><span class="nav-number">7.4.1.</span> <span class="nav-text">Basic Form Registration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Account-Verification-with-Email"><span class="nav-number">7.4.2.</span> <span class="nav-text">Account Verification with Email</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth2-0-Realizations"><span class="nav-number">7.5.</span> <span class="nav-text">OAuth2.0 Realizations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mechanism-Behind-the-Above-Implementation"><span class="nav-number">7.5.1.</span> <span class="nav-text">Mechanism Behind the Above Implementation</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xiao Yu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/learning/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonyux.github.io/2020/07/22/Spring-Security-Manual/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/learning/images/avatar.gif">
      <meta itemprop="name" content="Xiao Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="From a Beginner to a Disaster">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Security (OAuth2) Manual
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-22 22:36:09" itemprop="dateCreated datePublished" datetime="2020-07-22T22:36:09-04:00">2020-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-03 08:12:10" itemprop="dateModified" datetime="2020-11-03T08:12:10-05:00">2020-11-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <hr>
<p><strong>IMPORTANT</strong>:<br>Some of the content here is a personal summary/abbreviation of contents on the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/" target="_blank" rel="noopener">Offical Spring Security Documentation</a>. Feel free to refer to the official site if you think some of the sections written here are not clear.</p>
<hr>
<h1 id="Spring-Security-Intro"><a href="#Spring-Security-Intro" class="headerlink" title="Spring Security Intro"></a>Spring Security Intro</h1><p>Spring security is very useful for dealing with authorization, authentication, and protection against common attacks. It provides support for OAuth2, SAML2, and etc. Yet, as the title of this manual suggests, <strong>the following sections will focus on using OAuth2</strong> for authentication/authorization. </p>
<p>Technically, you do not necessarily need to use Spring Boot for using Spring Security. However, the sections below do <strong>assume that you are having a Spring Boot project</strong> to provide the backend services.</p>
<p>If you want more information on using tools other than OAuth2, or that you are not using Spring Boot as the backend API implementations, please visit the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/" target="_blank" rel="noopener">Official Reference</a>.</p>
<h1 id="Getting-Spring-Security"><a href="#Getting-Spring-Security" class="headerlink" title="Getting Spring Security"></a>Getting Spring Security</h1><p>If you are using Spring Security with Spring Boot, getting Spring Security playing in your application is simple.</p>
<p><strong>In summary</strong>, all you need to do is </p>
<ol>
<li>Import the <code>spring-boot-starter-security</code> in your <code>pom.xml</code><ul>
<li>You can either manually import the dependency, or select the <code>Spring Security</code> dependency in the Spring Initialzr</li>
<li>At this point, we are not yet using the <code>OAuth2 Resource Server</code> and <code>OAuth2 Client</code> yet. If you want, feel free to include those in your <code>pom.xml</code> as well.</li>
</ul>
</li>
</ol>
<p>The necessary dependency looks like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... other dependency elements ... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Again, its version has been already specified in the parent:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>If you want to use a specific version, you can specify it as well:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-security.version</span>&gt;</span>WHATEVER-VERSION-YOU-WANT-HERE<span class="tag">&lt;/<span class="name">spring-security.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> <p><strong>If you use a SNAPSHOT version</strong>, you need to ensure that you have the Spring Snapshot repository defined, as the following example shows:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... possibly other repository elements ... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshot<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshot Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<h1 id="Spring-Security-Features"><a href="#Spring-Security-Features" class="headerlink" title="Spring Security Features"></a>Spring Security Features</h1><p>Spring Security provides comprehensive support for <a href="#Authentication">authentication</a>, authorization, and protection against <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#exploits" target="_blank" rel="noopener">common exploits</a>. It also provides integration with other libraries to simplify its usage.</p>
<a id="more"></a>

<h2 id="Authentication-Support"><a href="#Authentication-Support" class="headerlink" title="Authentication Support"></a>Authentication Support</h2><p>Authentication is how we <strong>verify the identity of who is trying to access a particular resource</strong>. A common way to authenticate users is by requiring the user to enter a username and password. Once authentication is performed we know the identity and can perform authorization.</p>
<p>Spring Security provides built in support for authenticating users. Refer to the sections on <a href="#authentication">authentication</a> for details on what is supported for each stack.</p>
<h2 id="Password-Storage-and-Encoding"><a href="#Password-Storage-and-Encoding" class="headerlink" title="Password Storage and Encoding"></a>Password Storage and Encoding</h2><p>Spring Security’s <code>PasswordEncoder</code> interface is used to perform a <strong>one way transformation of a password to allow the password to be stored securely</strong>. Given <code>PasswordEncoder</code> is a one way transformation, it is not intended when the password transformation needs to be two way (i.e. storing credentials used to authenticate to a database). </p>
<p>Typically <code>PasswordEncoder</code> is used for <strong>storing a password that needs to be compared to a user provided password at the time of authentication</strong>.</p>
<h3 id="Password-Storage-History"><a href="#Password-Storage-History" class="headerlink" title="Password Storage History"></a>Password Storage History</h3><p>This section discusses a brief history of password storage: <strong>how attackers were able to crack the past systems, and what current strategies are</strong>.</p>
<blockquote>
<p>Throughout the years the standard mechanism for storing passwords has evolved. In the beginning passwords were stored in plain text. The passwords were assumed to be safe because the data store the passwords were saved in required credentials to access it. However, malicious users were able to find ways to get large “data dumps” of usernames and passwords using attacks like SQL Injection. As more and more user credentials became public security experts realized we needed to do more to protect users’ passwords.</p>
<p><strong>Developers were then encouraged to store passwords after running them through a one way hash such as SHA-256.</strong> When a user tried to authenticate, the hashed password would be compared to the hash of the password that they typed. This meant that the system only needed to store the one way hash of the password. If a breach occurred, then only the one way hashes of the passwords were exposed. Since the hashes were one way and it was computationally difficult to guess the passwords given the hash, it would not be worth the effort to figure out each password in the system. <strong>To defeat this new system malicious users decided to create lookup tables known as <a href="https://en.wikipedia.org/wiki/Rainbow_table" target="_blank" rel="noopener">Rainbow Tables</a>.</strong> Rather than doing the work of guessing each password every time, they computed the password once and stored it in a lookup table.</p>
<p><strong>To mitigate the effectiveness of Rainbow Tables, developers were encouraged to use salted passwords.</strong> Instead of using just the password as input to the hash function, random bytes (known as salt) would be generated for every users’ password. The salt and the user’s password would be ran through the hash function which produced a unique hash. The salt would be stored alongside the user’s password in clear text. Then when a user tried to authenticate, the hashed password would be compared to the hash of the stored salt and the password that they typed. The unique salt meant that Rainbow Tables were no longer effective because the hash was different for every salt and password combination.</p>
<p><strong>In modern times we realize that cryptographic hashes (like SHA-256) are no longer secure.</strong> The reason is that with modern hardware we can perform billions of hash calculations a second. This means that we can crack each password individually with ease.</p>
<p><strong>Developers are now encouraged to leverage adaptive one-way functions to store a password (e.g. feeding its output as input and adjust how many iterations to occur).</strong> Validation of passwords with adaptive one-way functions are intentionally resource (i.e. CPU, memory, etc) intensive. An adaptive one-way function allows configuring a “work factor” which can grow as hardware gets better. It is recommended that the “work factor” be tuned to take about 1 second to verify a password on your system. This trade off is to make it difficult for attackers to crack the password, but not so costly it puts excessive burden on your own system. Spring Security has attempted to provide a good starting point for the “work factor”, but users are encouraged to customize the “work factor” for their own system since the performance will vary drastically from system to system. Examples of adaptive one-way functions that should be used include <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authentication-password-storage-bcrypt" target="_blank" rel="noopener">bcrypt</a>, <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authentication-password-storage-pbkdf2" target="_blank" rel="noopener">PBKDF2</a>, <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authentication-password-storage-scrypt" target="_blank" rel="noopener">scrypt</a>, and <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authentication-password-storage-argon2" target="_blank" rel="noopener">argon2</a>.</p>
<p>Because adaptive one-way functions are intentionally resource intensive, validating a username and password for every request will degrade performance of an application significantly. There is nothing Spring Security (or any other library) can do to speed up the validation of the password since security is gained by making the validation resource intensive. Users are encouraged to exchange the long term credentials (i.e. username and password) for a short term credential (i.e. session, OAuth Token, etc). The short term credential can be validated quickly without any loss in security.</p>
<p>Source: <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authentication-password-storage-history" target="_blank" rel="noopener">https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authentication-password-storage-history</a></p>
</blockquote>
<h3 id="DelegatingPasswordEncoder"><a href="#DelegatingPasswordEncoder" class="headerlink" title="DelegatingPasswordEncoder"></a><code>DelegatingPasswordEncoder</code></h3><p>Prior to Spring Security 5.0 the default <code>PasswordEncoder</code> was <code>NoOpPasswordEncoder</code> which required plain text passwords. Based upon the <a href="#Password-Storage-History">Password Storage History</a> section you might expect that the default <code>PasswordEncoder</code> is now something like <code>BCryptPasswordEncoder</code>. However, this ignores three real world problems:</p>
<ul>
<li>There are many applications using old password encodings that cannot easily migrate</li>
<li>The best practice for password storage will change again.</li>
<li>As a framework Spring Security cannot make breaking changes frequently</li>
</ul>
<p>Instead Spring Security introduces <code>DelegatingPasswordEncoder</code> which solves all of the problems by:</p>
<ul>
<li>Ensuring that passwords are encoded using the current password storage recommendations</li>
<li><strong>Allowing for validating passwords in modern and legacy formats</strong></li>
<li>Allowing for upgrading the encoding in the future</li>
</ul>
<p>You can easily construct an instance of <code>DelegatingPasswordEncoder</code> using <code>PasswordEncoderFactories</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PasswordEncoder passwordEncoder =</span><br><span class="line">    PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br></pre></td></tr></table></figure>

<p><strong>Alternatively, you may create your own custom instance:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String idForEncode = <span class="string">"bcrypt"</span>;</span><br><span class="line">Map encoders = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">encoders.put(idForEncode, <span class="keyword">new</span> BCryptPasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">"noop"</span>, NoOpPasswordEncoder.getInstance());</span><br><span class="line">encoders.put(<span class="string">"pbkdf2"</span>, <span class="keyword">new</span> Pbkdf2PasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">"scrypt"</span>, <span class="keyword">new</span> SCryptPasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">"sha256"</span>, <span class="keyword">new</span> StandardPasswordEncoder());</span><br><span class="line"></span><br><span class="line">PasswordEncoder passwordEncoder = <span class="keyword">new</span> DelegatingPasswordEncoder(idForEncode, encoders);</span><br></pre></td></tr></table></figure>

<h3 id="Encode-with-Spring-Boot-CLI"><a href="#Encode-with-Spring-Boot-CLI" class="headerlink" title="Encode with Spring Boot CLI"></a>Encode with Spring Boot CLI</h3><p>This can be useful sometimes when you are testing some features of your application and needs a certain password to be encoded without running the entire application. This can be achieved in Spring Boot CLI:</p>
<p>For example:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring encodepassword password</span><br><span class="line">&#123;bcrypt&#125;$<span class="number">2</span>a$<span class="number">10</span>$X5wFBtLrL/kHcmrOGGTrGufsBX8CJ0WpQpF3pgeuxBB/H73BK1DW6</span><br></pre></td></tr></table></figure>

<p>However, this seems to only be able to provide hashes of type <code>bcrypt</code>.</p>
<h3 id="Password-Storage-Format"><a href="#Password-Storage-Format" class="headerlink" title="Password Storage Format"></a>Password Storage Format</h3><p>If you run the <code>passwordEncoder(&quot;password&quot;)</code> for each of the <code>PasswordEncoder</code> above, you will see the following output format:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;id&#125;encodedPassword</span><br></pre></td></tr></table></figure>

<p>For example, encoding the word <code>password</code> would give:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;bcrypt&#125;$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM&#x2F;BG </span><br><span class="line">&#123;noop&#125;password </span><br><span class="line">&#123;pbkdf2&#125;5d923b44a6d129f3ddf3e3c8d29412723dcbde72445e8ef6bf3b508fbf17fa4ed4d6b99ca763d8dc </span><br><span class="line">&#123;scrypt&#125;$e0801$8bWJaSu2IKSn9Z9kM+TPXfOc&#x2F;9bdYSrN1oD9qfVThWEwdRTnO7re7Ei+fUZRJ68k9lTyuTeUp4of4g24hHnazw&#x3D;&#x3D;$OAOec05+bXxvuu&#x2F;1qZ6NUR+xQYvYv7BeL1QxwRpY5Pc&#x3D;  </span><br><span class="line">&#123;sha256&#125;97cde38028ad898ebc02e690819fa220e88c62e0699403e94fff291cfffaf8410849f27605abcbc0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> Some users might be <strong>concerned that the storage format is provided for a potential hacker</strong>. This is not a concern because the storage of the password does not rely on the algorithm being a secret. Additionally, most formats are easy for an attacker to figure out without the prefix. For example, BCrypt passwords often start with <code>$2a$</code>.</li>
</ul>
</blockquote>
<h3 id="Password-Matching"><a href="#Password-Matching" class="headerlink" title="Password Matching"></a>Password Matching</h3><p>The <code>match()</code> method of the <code>PasswordEncoder</code> takes two arguements: the raw password, and the encoded password (in the format <code>{id}encodedPassword</code>).</p>
<p>For example, if you have the password <code>jason</code>, and the encoded hash of it is <code>{bcrypt}$2a$10$ZBDPr38ZlwyPGe/YNsOSHuBEU5TDeNisCds6zJolVW1pN4YEHb3YS</code> , then you do:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwordEncoder.matches(<span class="string">"jason"</span>,<span class="string">"&#123;bcrypt&#125;$2a$10$ZBDPr38ZlwyPGe/YNsOSHuBEU5TDeNisCds6zJolVW1pN4YEHb3YS"</span>));</span><br></pre></td></tr></table></figure>

<p>This behavior can be customized using <code>DelegatingPasswordEncoder.setDefaultPasswordEncoderForMatches(PasswordEncoder)</code>.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> However, if the <code>{id}</code> you put in as part of the argument does not exist in the list of encoders that you specified in the example above, it will throw an <code>IllegalArgumentException</code>. This behavior can be customized using <code>DelegatingPasswordEncoder.setDefaultPasswordEncoderForMatches(PasswordEncoder)</code>.</li>
</ul>
</blockquote>
<p>However, if you look into the <code>match()</code> method, you will realize that it checks whether if the password is a match for the hash by first looking at the <code>{id}</code> to determine which encoder to use. This means that <strong>if you hashed it with <code>bcrypt</code> somewhere in your code</strong>, come back here and <strong>put a hash of the same password with the <code>pbkdf2</code> encoder</strong>, it will <strong>still give a match</strong>.</p>
<h2 id="Password-Encoders"><a href="#Password-Encoders" class="headerlink" title="Password Encoders"></a>Password Encoders</h2><h3 id="BCryptPasswordEncoder"><a href="#BCryptPasswordEncoder" class="headerlink" title="BCryptPasswordEncoder"></a>BCryptPasswordEncoder</h3><p>The <code>BCryptPasswordEncoder</code> implementation uses the widely supported <a href="https://en.wikipedia.org/wiki/Bcrypt" target="_blank" rel="noopener">bcrypt</a> algorithm to hash the passwords. In order to make it more resistent to password cracking, <strong>bcrypt is deliberately slow</strong>. Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system. </p>
<p><strong>The default implementation of <code>BCryptPasswordEncoder</code> uses strength 10</strong> as mentioned in the Javadoc of <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/crypto/bcrypt/BCryptPasswordEncoder.html" target="_blank" rel="noopener">BCryptPasswordEncoder</a>. You are encouraged to tune and test the strength parameter on your own system so that it takes roughly 1 second to verify a password.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an encoder with strength 16</span></span><br><span class="line">BCryptPasswordEncoder encoder = <span class="keyword">new</span> BCryptPasswordEncoder(<span class="number">16</span>);</span><br><span class="line">String result = encoder.encode(<span class="string">"myPassword"</span>);</span><br><span class="line">assertTrue(encoder.matches(<span class="string">"myPassword"</span>, result));</span><br></pre></td></tr></table></figure>

<h3 id="Argon2PasswordEncoder"><a href="#Argon2PasswordEncoder" class="headerlink" title="Argon2PasswordEncoder"></a>Argon2PasswordEncoder</h3><p>The <code>Argon2PasswordEncoder</code> implementation uses the <a href="https://en.wikipedia.org/wiki/Argon2" target="_blank" rel="noopener">Argon2</a> algorithm to hash the passwords. <strong>Argon2 is the winner of the <a href="https://en.wikipedia.org/wiki/Password_Hashing_Competition" target="_blank" rel="noopener">Password Hashing Competition</a></strong>. In order to defeat password cracking on custom hardware, Argon2 is a deliberately slow algorithm that requires large amounts of memory. Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system. The current implementation if the <code>Argon2PasswordEncoder</code> requires BouncyCastle.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an encoder with all the defaults</span></span><br><span class="line">Argon2PasswordEncoder encoder = <span class="keyword">new</span> Argon2PasswordEncoder();</span><br><span class="line">String result = encoder.encode(<span class="string">"myPassword"</span>);</span><br><span class="line">assertTrue(encoder.matches(<span class="string">"myPassword"</span>, result));</span><br></pre></td></tr></table></figure>

<h3 id="Pbkdf2PasswordEncoder"><a href="#Pbkdf2PasswordEncoder" class="headerlink" title="Pbkdf2PasswordEncoder"></a>Pbkdf2PasswordEncoder</h3><p>The <code>Pbkdf2PasswordEncoder</code> implementation uses the <a href="https://en.wikipedia.org/wiki/PBKDF2" target="_blank" rel="noopener">PBKDF2</a> algorithm to hash the passwords. In order to defeat password cracking PBKDF2 is a deliberately slow algorithm. Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system. This algorithm is a good choice when FIPS certification is required.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an encoder with all the defaults</span></span><br><span class="line">Pbkdf2PasswordEncoder encoder = <span class="keyword">new</span> Pbkdf2PasswordEncoder();</span><br><span class="line">String result = encoder.encode(<span class="string">"myPassword"</span>);</span><br><span class="line">assertTrue(encoder.matches(<span class="string">"myPassword"</span>, result));</span><br></pre></td></tr></table></figure>

<h3 id="SCryptPasswordEncoder"><a href="#SCryptPasswordEncoder" class="headerlink" title="SCryptPasswordEncoder"></a>SCryptPasswordEncoder</h3><p>The <code>SCryptPasswordEncoder</code> implementation uses <a href="https://en.wikipedia.org/wiki/Scrypt" target="_blank" rel="noopener">scrypt</a> algorithm to hash the passwords. In order to defeat password cracking on custom hardware scrypt is a deliberately slow algorithm that requires large amounts of memory. Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an encoder with all the defaults</span></span><br><span class="line">SCryptPasswordEncoder encoder = <span class="keyword">new</span> SCryptPasswordEncoder();</span><br><span class="line">String result = encoder.encode(<span class="string">"myPassword"</span>);</span><br><span class="line">assertTrue(encoder.matches(<span class="string">"myPassword"</span>, result));</span><br></pre></td></tr></table></figure>

<h3 id="Other-PasswordEncoders"><a href="#Other-PasswordEncoders" class="headerlink" title="Other PasswordEncoders"></a>Other PasswordEncoders</h3><p>There are a significant number of other <code>PasswordEncoder</code> implementations that exist entirely for backward compatibility. They are all deprecated to indicate that they are no longer considered secure. However, there are no plans to remove them since it is difficult to migrate existing legacy systems.</p>
<h2 id="Protection-Against-Exploits"><a href="#Protection-Against-Exploits" class="headerlink" title="Protection Against Exploits"></a>Protection Against Exploits</h2><p>Spring Security provides protection against common exploits. Whenever possible, the protection is enabled by default. Below you will find high level description of the various exploits that Spring Security protects against.</p>
<p>The following sections discuss:</p>
<ul>
<li>Cross Site Request Forgery (CSRF)</li>
<li>Security HTTP Response Headers</li>
<li>HTTP</li>
</ul>
<h3 id="Cross-Site-Request-Forgery"><a href="#Cross-Site-Request-Forgery" class="headerlink" title="Cross Site Request Forgery"></a>Cross Site Request Forgery</h3><p>This is caused by the fact that authentication cookies associated with a site gets passed along in your request if you did not logout. This means that a website can forge an identical evil request using the authentication cookie passed along.</p>
<p>For example:</p>
<p>Consider that you are on a banking website, where you submitted a request of transferring money that looks like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">action</span>=<span class="string">"/transfer"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"amount"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"routingNumber"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"account"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">value</span>=<span class="string">"Transfer"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Then the request would look like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;transfer HTTP&#x2F;1.1</span><br><span class="line">Host: bank.example.com</span><br><span class="line">Cookie: JSESSIONID&#x3D;randomid</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">amount&#x3D;100.00&amp;routingNumber&#x3D;1234&amp;account&#x3D;9876</span><br></pre></td></tr></table></figure>

<p>Now pretend you authenticate to your bank’s website and then, <strong>without logging out, visit an evil website</strong>. The evil website contains an HTML page with the following form:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">action</span>=<span class="string">"https://bank.example.com/transfer"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"amount"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">value</span>=<span class="string">"100.00"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"routingNumber"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">value</span>=<span class="string">"evilsRoutingNumber"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"account"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">value</span>=<span class="string">"evilsAccountNumber"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">value</span>=<span class="string">"Win Money!"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>As a result, <strong>the same request would be generated, with the same cookie but destination account forged</strong>.</p>
<p>Worst yet, this whole process could have been automated using JavaScript. This means you didn’t even need to click on the button. Furthermore, it could just as easily happen when visiting an honest site that is a victim of a <a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" target="_blank" rel="noopener">XSS attack</a>. So how do we protect our users from such attacks?</p>
<h4 id="Protecting-Against-CSRF-Attacks"><a href="#Protecting-Against-CSRF-Attacks" class="headerlink" title="Protecting Against CSRF Attacks"></a>Protecting Against CSRF Attacks</h4><p>The reason that a CSRF attack is possible is that the HTTP request from the victim’s website and the request from the attacker’s website are exactly the same. This means there is no way to reject requests coming from the evil website and allow requests coming from the bank’s website. </p>
<p>To protect against CSRF attacks we need to <strong>ensure there is something in the request that the evil site is unable to provide so we can differentiate the two requests</strong>.</p>
<p>Spring provides two mechanisms to protect against CSRF attacks:</p>
<ul>
<li>The <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#csrf-protection-stp" target="_blank" rel="noopener">Synchronizer Token Pattern</a></li>
<li>Specifying the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#csrf-protection-ssa" target="_blank" rel="noopener">SameSite Attribute</a> on your session cookie</li>
</ul>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> Both protections require that <strong>Safe Methods Must be Idempotent</strong>:<ul>
<li>In order for either protection against CSRF (mentioned above) to work, the application must ensure that <a href="https://tools.ietf.org/html/rfc7231#section-4.2.1" target="_blank" rel="noopener">“safe” HTTP methods are idempotent</a>. This means that requests with the HTTP method <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>, and <code>TRACE</code> should not change the state of the application.</li>
</ul>
</li>
</ul>
</blockquote>
<h5 id="Synchronizer-Token-Pattern"><a href="#Synchronizer-Token-Pattern" class="headerlink" title="Synchronizer Token Pattern"></a>Synchronizer Token Pattern</h5><p>The predominant and most comprehensive way to protect against CSRF attacks is to use the <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern" target="_blank" rel="noopener">Synchronizer Token Pattern</a>. This solution is to ensure that each HTTP request requires, in addition to our session cookie, <strong>a secure random generated value called a CSRF token must be present in the HTTP request</strong>.</p>
<p>In summary, it works like this:</p>
<ol>
<li>When a user logged in, <strong>the server should generate a unique CSRF token</strong> associated with the user</li>
<li>When an HTTP request is submitted, it should also <strong>send the CSRF token</strong> that along with the request<ul>
<li><strong>The token should NOT be included in your cookie, or anything that will be automatically included in your browser</strong></li>
<li>You can, for example, include the token in your request header or parameter</li>
</ul>
</li>
<li>The server receiving the request will now check that CSRF token against the expected CSRF token. If the value does not match, reject the request.</li>
</ol>
<p>Just to state the take away message again: the key to this working is that <strong>the actual CSRF token should be in a part of the HTTP request that is not automatically included by the browser</strong>. For example, requiring the actual CSRF token in an HTTP parameter or an HTTP header will protect against CSRF attacks. Requiring the actual CSRF token in a cookie does not work because cookies are automatically included in the HTTP request by the browser.</p>
<p>For example, the request sent with CSRF token now will look like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;transfer HTTP&#x2F;1.1</span><br><span class="line">Host: bank.example.com</span><br><span class="line">Cookie: JSESSIONID&#x3D;randomid</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">amount&#x3D;100.00&amp;routingNumber&#x3D;1234&amp;account&#x3D;9876&amp;_csrf&#x3D;4bfd1575-3ad1-4d21-96c7-4ef2d9f86721</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li><code>4bfd1575-3ad1-4d21-96c7-4ef2d9f86721</code> is the CSRF token</li>
</ul>
<h5 id="Same-Site-Attribute"><a href="#Same-Site-Attribute" class="headerlink" title="Same Site Attribute"></a>Same Site Attribute</h5><p>An emerging way to protect against CSRF attack is to <strong>specify the <a href="https://tools.ietf.org/html/draft-west-first-party-cookies" target="_blank" rel="noopener">SameSite Attribute</a> on cookies</strong>. A server can specify the <code>SameSite</code> attribute when setting a cookie to indicate that the cookie should not be sent when coming from external sites.</p>
<p>However, since <strong>Spring Security does not directly control the creation of the session cookie, it does not provide support for the <code>SameSite</code> attribute</strong>. <a href="https://spring.io/projects/spring-session" target="_blank" rel="noopener">Spring Session</a> provides support for the <code>SameSite</code> attribute in servlet based applications. Spring Framework’s <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/server/session/CookieWebSessionIdResolver.html" target="_blank" rel="noopener">CookieWebSessionIdResolver</a> provides out of the box support for the <code>SameSite</code> attribute in WebFlux based applications.</p>
<p>In summary, this works by:</p>
<ol>
<li>When the user logged in/get authenticated, the cookie comes along with the authentication specifies where the cookies get sent<ul>
<li>For example, <strong>if specified <code>SameSite=Strict</code></strong>, then the <strong>cookie will NOT be passed along to different site/request coming from a different site</strong></li>
</ul>
</li>
</ol>
<p>An example, HTTP response header with the <code>SameSite</code> attribute might look like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: JSESSIONID&#x3D;randomid; Domain&#x3D;bank.example.com; Secure; HttpOnly; SameSite&#x3D;Lax</span><br></pre></td></tr></table></figure>

<p>Valid values for the <code>SameSite</code> attribute are:</p>
<ul>
<li><code>Strict</code> - when specified any request coming from the <a href="https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-2.1" target="_blank" rel="noopener">same-site</a> will include the cookie. Otherwise, the cookie will not be included in the HTTP request.</li>
<li><code>Lax</code> - when specified cookies will be sent when coming from the <a href="https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-2.1" target="_blank" rel="noopener">same-site</a> or when the request comes from top-level navigations and the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#csrf-protection-idempotent" target="_blank" rel="noopener">method is idempotent</a>. Otherwise, the cookie will not be included in the HTTP request.</li>
</ul>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>Setting the <code>SameSite</code> attribute to <code>Strict</code> provides a stronger defense but can confuse users</strong>. Consider <strong>a user that stays logged into a social media site hosted at <a href="https://social.example.com/" target="_blank" rel="noopener">https://social.example.com</a></strong>. The user receives <strong>an email at <a href="https://email.example.org/" target="_blank" rel="noopener">https://email.example.org</a> that includes a link to the social media site</strong>. If the user clicks on the link, they would rightfully expect to be authenticated to the social media site. However, <strong>if the <code>SameSite</code> attribute is <code>Strict</code> the cookie would not be sent and so the user would not be authenticated.</strong></li>
</ul>
</blockquote>
<p><strong>There are some important <a href="https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-5" target="_blank" rel="noopener">considerations</a> that one should be aware about when using <code>SameSite</code> attribute</strong> to protect against CSRF attacks.</p>
<p>One obvious consideration is that in order for the <code>SameSite</code> attribute to protect users, <strong>the browser must support the <code>SameSite</code> attribute</strong>. Most modern browsers do <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/headers/Set-Cookie#Browser_compatibility" target="_blank" rel="noopener">support the SameSite attribute</a>. However, older browsers that are still in use may not.</p>
<p>For this reason, it is generally recommended to use the <code>SameSite</code> attribute as a defense in depth rather than the sole protection against CSRF attacks.</p>
<h4 id="When-to-use-CSRF-Protection"><a href="#When-to-use-CSRF-Protection" class="headerlink" title="When to use CSRF Protection"></a>When to use CSRF Protection</h4><p>When should you use CSRF protection? It is recommended to <strong>use CSRF protection for any request that could be processed by a browser by normal/authenticated users</strong>. If you are only creating <strong>a service that is used by non-browser clients</strong>, you will likely want to <strong>disable CSRF protection</strong>.</p>
<h4 id="CSRF-Considerations"><a href="#CSRF-Considerations" class="headerlink" title="CSRF Considerations"></a>CSRF Considerations</h4><p>There are a few special considerations to consider when implementing protection against CSRF attacks.</p>
<h5 id="Logging-in"><a href="#Logging-in" class="headerlink" title="Logging in"></a>Logging in</h5><p>In order to protect against <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Forging_login_requests" target="_blank" rel="noopener">forging log in requests</a> <strong>the log in HTTP request should be protected against CSRF attacks</strong>. Protecting against forging log in requests is necessary <strong>so that a malicious user cannot read a victim’s sensitive information</strong>. The attack is executed by:</p>
<ul>
<li>A malicious user performs a CSRF login using the malicious user’s credentials. The victim is now authenticated as the malicious user.</li>
<li>The malicious user then tricks the victim to visit the compromised website and enter sensitive information</li>
<li><strong>The information is now associated to the malicious user’s account so the malicious user can login with their own credentials and view the victim’s sensitive information</strong></li>
</ul>
<p>A possible complication to ensuring login HTTP requests are protected against CSRF attacks is that the <strong>user might experience a session timeout that causes the request to be rejected.</strong> A session timeout is surprising to users who do not expect to need to have a session in order to log in. For more information refer to <a href="#CSRF-and-Session-Timeouts">CSRF and Session Timeouts</a>.</p>
<h5 id="Logging-Out"><a href="#Logging-Out" class="headerlink" title="Logging Out"></a>Logging Out</h5><p>In order to protect against forging log out requests, the log out HTTP request should be protected against CSRF attacks. Protecting against forging log out requests is necessary so a malicious user cannot read a victim’s sensitive information. For details on the attack refer to <a href="https://labs.detectify.com/2017/03/15/loginlogout-csrf-time-to-reconsider/" target="_blank" rel="noopener">this blog post</a>.</p>
<p>A possible complication to ensuring log out HTTP requests are protected against CSRF attacks is that the user might experience a session timeout that causes the request to be rejected. Please read on to the next section for more details.</p>
<h5 id="CSRF-and-Session-Timeouts"><a href="#CSRF-and-Session-Timeouts" class="headerlink" title="CSRF and Session Timeouts"></a>CSRF and Session Timeouts</h5><p><strong>More often than not, the expected CSRF token is stored in the session</strong>. This means that as soon as the session expires the server will not find an expected CSRF token and reject the HTTP request. There are a number of options to solve timeouts each of which come with trade offs.</p>
<ul>
<li><p>The best way to mitigate the timeout is by using JavaScript to <strong>request a CSRF token on form submission. The form is then updated with the CSRF token and submitted</strong>.</p>
</li>
<li><p>Another option is to have some JavaScript that lets the user know their session is about to expire. The user can click a button to continue and refresh the session.</p>
</li>
<li><p>Finally, the expected CSRF token could be stored in a cookie. This allows the expected CSRF token to outlive the session.</p>
<p>One might ask why the expected CSRF token isn’t stored in a cookie by default. This is because there are known exploits in which headers (i.e. specify the cookies) can be set by another domain. This is the same reason Ruby on Rails <a href="https://weblog.rubyonrails.org/2011/2/8/csrf-protection-bypass-in-ruby-on-rails/" target="_blank" rel="noopener">no longer skips CSRF checks when the header X-Requested-With is present</a>. See <a href="http://lists.webappsec.org/pipermail/websecurity_lists.webappsec.org/2011-February/007533.html" target="_blank" rel="noopener">this webappsec.org thread</a> for details on how to perform the exploit. Another disadvantage is that by removing the state (i.e. the timeout) you lose the ability to forcibly terminate the token if it is compromised.</p>
</li>
</ul>
<h5 id="Multipart-File-Upload"><a href="#Multipart-File-Upload" class="headerlink" title="Multipart (File Upload)"></a>Multipart (File Upload)</h5><p>This is a concern mainly caused by <strong>storing your CSRF token in the request body</strong>.</p>
<p>For example, if one of your request is uploading a file, the body of the HTTP request will be read (e.g. the file). However, since request body is also the place you store your <strong>CSRF token</strong>, this means that <strong>your body must be read to obtain actual CSRF token. However, reading the body means that the file will be uploaded which means an external site can upload a file.</strong></p>
<p>However, this is not too bad, as you can configure your program to delete that file once the request is rejected (that you found the CSRF token is invalid).</p>
<p>Yet, <strong>one approach is to Include CSRF Token in URL:</strong></p>
<ul>
<li>If allowing unauthorized users to upload temporary files is not acceptable, an alternative is to include the expected CSRF token as a query parameter in the action attribute of the form. <strong>The disadvantage to this approach is that query parameters can be leaked</strong>. <strong>More generally, it is considered best practice to place sensitive data within the body or headers to ensure it is not leaked</strong>. Additional information can be found in <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec15.html#sec15.1.3" target="_blank" rel="noopener">RFC 2616 Section 15.1.3 Encoding Sensitive Information in URI’s</a>.</li>
</ul>
<h3 id="Security-HTTP-Headers"><a href="#Security-HTTP-Headers" class="headerlink" title="Security HTTP Headers"></a>Security HTTP Headers</h3><p>There are many <a href="https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#tab=Headers" target="_blank" rel="noopener">HTTP response headers</a> that can be used to increase the security of web applications. This section is dedicated to the various HTTP response headers that Spring Security provides explicit support for. <strong>If necessary, Spring Security can also be configured to provide <a href="#Custom-Headers">custom headers</a></strong>.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>The following sections cover the basics of request headers and their options. To modify/add/remove request headers, please go to the <a href="#Applications">Applications</a> section.</strong></li>
</ul>
</blockquote>
<h4 id="Default-Security-Headers"><a href="#Default-Security-Headers" class="headerlink" title="Default Security Headers"></a>Default Security Headers</h4><p>Spring Security provides a default set of security related HTTP response headers to provide secure defaults.</p>
<p>The default for Spring Security is to include the following headers:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cache-Control</span>: no-cache, no-store, max-age=0, must-revalidate</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Expires</span>: 0</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br><span class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=31536000 ; includeSubDomains</span><br><span class="line"><span class="attribute">X-Frame-Options</span>: DENY</span><br><span class="line"><span class="attribute">X-XSS-Protection</span>: 1; mode=block</span><br></pre></td></tr></table></figure>

<p>If the defaults do not meet your needs, you can <strong>easily remove, modify, or add headers from these defaults</strong>. For additional details on each of these headers, refer to the corresponding sections:</p>
<ul>
<li><a href="#cache-control">Cache Control</a></li>
<li><a href="#content-type-options">Content Type Options</a></li>
<li><a href="#HTTP-Strict-Transport-Security">HTTP Strict Transport Security</a></li>
<li><a href="#X-Frame-Options">X-Frame-Options</a></li>
<li><a href="#X-XSS-Protection">X-XSS-Protection</a></li>
<li><a href="#Content-Security-Policy">Content-Security-Policy</a></li>
<li><a href="#Referrer-Policy">Referrer-Policy</a></li>
<li><a href="#Feature-Policy">Feature-Policy</a></li>
<li><a href="#Clear-Site-Data">Clear-Site-Data</a></li>
</ul>
<h4 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache Control"></a>Cache Control</h4><p><strong>Spring Security’s default is to disable caching to protect user’s content</strong>.</p>
<p>If a user authenticates to view sensitive information and then logs out, we don’t want a malicious user to be able to click the back button to view the sensitive information. The cache control headers that are sent by default are:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: no-cache, no-store, max-age&#x3D;0, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Expires: 0</span><br></pre></td></tr></table></figure>

<p>In order to be secure, <strong>Spring Security adds these headers by default</strong>. However, if your application provides it’s own cache control headers Spring Security will back out of the way. This allows for applications to ensure that static resources like CSS and JavaScript can be cached.</p>
<h4 id="Content-Type-Options"><a href="#Content-Type-Options" class="headerlink" title="Content Type Options"></a>Content Type Options</h4><p>Historically browsers, including Internet Explorer, would try to guess the content type of a request using <a href="https://en.wikipedia.org/wiki/Content_sniffing" target="_blank" rel="noopener">content sniffing</a>. This allowed browsers to <strong>improve the user experience by guessing the content type on resources that had not specified the content type</strong>. For example, if a browser encountered a JavaScript file that did not have the content type specified, it would be able to guess the content type and then execute it.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> There are many additional things one should do (i.e. only display the document in a distinct domain, ensure Content-Type header is set, sanitize the document, etc.) when allowing content to be uploaded. <strong>However, these measures are out of the scope of what Spring Security provides. It is also important to point out when disabling content sniffing, you must specify the content type in order for things to work properly.</strong></li>
</ul>
</blockquote>
<p><strong>The problem with content sniffing is that this allowed malicious users to use polyglots</strong> (i.e. a file that is valid as multiple content types) <strong>to execute XSS attacks</strong>. For example, some sites may allow users to submit a valid postscript document to a website and view it. A malicious user might create a <a href="http://webblaze.cs.berkeley.edu/papers/barth-caballero-song.pdf" target="_blank" rel="noopener">postscript document that is also a valid JavaScript file</a> and execute a XSS attack with it.</p>
<p><strong>Spring Security disables content sniffing by default</strong> by adding the following header to HTTP responses:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br></pre></td></tr></table></figure>

<h4 id="HTTP-Strict-Transport-Security"><a href="#HTTP-Strict-Transport-Security" class="headerlink" title="HTTP Strict Transport Security"></a>HTTP Strict Transport Security</h4><p>When you type in your bank’s website, do you enter mybank.example.com or do you enter <a href="https://mybank.example.com/" target="_blank" rel="noopener">https://mybank.example.com</a>? </p>
<p><strong>If you omit the https protocol, you are potentially vulnerable to <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" target="_blank" rel="noopener">Man in the Middle attacks</a>.</strong> Even if the website performs a redirect to <a href="https://mybank.example.com/" target="_blank" rel="noopener">https://mybank.example.com</a> <strong>a malicious user could intercept the initial HTTP request and manipulate the response</strong> (i.e. redirect to <a href="https://mibank.example.com/" target="_blank" rel="noopener">https://mibank.example.com</a> and steal their credentials).</p>
<p>Many users omit the https protocol and this is why <a href="https://tools.ietf.org/html/rfc6797" target="_blank" rel="noopener">HTTP Strict Transport Security (HSTS)</a> was created. <strong>Once mybank.example.com is added as a <a href="https://tools.ietf.org/html/rfc6797#section-5.1" target="_blank" rel="noopener">HSTS host</a>, a browser can know ahead of time that any request to mybank.example.com should be interpreted as <a href="https://mybank.example.com/" target="_blank" rel="noopener">https://mybank.example.com</a></strong>. This greatly reduces the possibility of a Man in the Middle attack occurring.</p>
<blockquote>
<p>In accordance with <a href="https://tools.ietf.org/html/rfc6797#section-7.2" target="_blank" rel="noopener">RFC6797</a>, the HSTS header is only injected into HTTPS responses. In order for the browser to acknowledge the header, the browser must first trust the CA that signed the SSL certificate used to make the connection (not just the SSL certificate).</p>
</blockquote>
<p><strong>One way for a site to be marked as a HSTS host is to have the host preloaded into the browser. Another is to add the <code>Strict-Transport-Security</code> header to the response.</strong> </p>
<p><strong>For example, Spring Security’s default behavior is to add the following header which instructs the browser to treat the domain as an HSTS host for a year</strong> (there are approximately 31536000 seconds in a year):</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=31536000 ; includeSubDomains ; preload</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li><strong>The optional <code>includeSubDomains</code> directive</strong> instructs the browser that <strong>subdomains</strong> (i.e. secure.mybank.example.com) <strong>should also be treated as an HSTS domain</strong>.</li>
<li>The optional <code>preload</code> directive instructs the browser that <strong>domain should be preloaded in browser as HSTS domain</strong>. For more details on HSTS preload please see <a href="https://hstspreload.org/" target="_blank" rel="noopener">https://hstspreload.org</a>.</li>
</ul>
<h4 id="X-Frame-Options"><a href="#X-Frame-Options" class="headerlink" title="X-Frame-Options"></a>X-Frame-Options</h4><p>Allowing your website to be added to a frame can be a security issue. </p>
<p>For example, using clever CSS styling <strong>users could be tricked into clicking on something that they were not intending (<a href="https://www.youtube.com/watch?v=3mk0RySeNsU" target="_blank" rel="noopener">video demo</a>).</strong> For example, a user that is logged into their bank might click a button that grants access to other users. This sort of attack is known as <a href="https://en.wikipedia.org/wiki/Clickjacking" target="_blank" rel="noopener">Clickjacking</a>.</p>
<blockquote>
<p>Another modern approach to dealing with clickjacking is to use <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#headers-csp" target="_blank" rel="noopener">Content Security Policy (CSP)</a>.</p>
</blockquote>
<p>There are a number ways to mitigate clickjacking attacks. For example, to protect legacy browsers from clickjacking attacks you can use <a href="https://www.owasp.org/index.php/Clickjacking_Defense_Cheat_Sheet#Best-for-now_Legacy_Browser_Frame_Breaking_Script" target="_blank" rel="noopener">frame breaking code</a>. While not perfect, the frame breaking code is the best you can do for the legacy browsers.</p>
<p><strong>A more modern approach to address clickjacking is to use <a href="https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options" target="_blank" rel="noopener">X-Frame-Options</a> header</strong>. <strong>By default Spring Security disables rendering pages within an iframe using with the following header</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Frame-Options: DENY</span><br></pre></td></tr></table></figure>

<p>However, <strong>the available options are</strong>:</p>
<ul>
<li><strong>deny:</strong> This directive stops the site from being rendered in <code>&lt;frame&gt;</code> i.e. <strong>site can’t be embedded into other sites</strong>.</li>
<li><strong>sameorigin:</strong> This directive allows the page to be rendered in the frame <strong>if and only if the frame has the same origin as the page</strong>.</li>
<li><strong>allow-from url:</strong> This directive <strong>has now became obsolete and shouldn’t be used</strong>. It is not supported by modern browser. In this the page can be rendered in the <code>&lt;frame&gt;</code> that is originated from specified URL.</li>
</ul>
<h4 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a>X-XSS-Protection</h4><p>Some browsers have built in support for filtering out <a href="https://www.owasp.org/index.php/Testing_for_Reflected_Cross_site_scripting_(OWASP-DV-001)" target="_blank" rel="noopener">reflected XSS attacks</a>. This is by no means foolproof, but does assist in XSS protection.</p>
<p><strong>The filtering is typically enabled by default, so adding the header typically just ensures it is enabled and instructs the browser what to do when a XSS attack is detected</strong>. For example, the filter might try to change the content in the least invasive way to still render everything. At times, this type of replacement can become a <a href="https://hackademix.net/2009/11/21/ies-xss-filter-creates-xss-vulnerabilities/" target="_blank" rel="noopener">XSS vulnerability in itself</a>. Instead, <strong>it is best to block the content rather than attempt to fix it</strong>. <strong>By default Spring Security blocks the content using the following header</strong>:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">X-XSS-Protection</span>: 1; mode=block</span><br></pre></td></tr></table></figure>

<h4 id="Content-Security-Policy"><a href="#Content-Security-Policy" class="headerlink" title="Content Security Policy"></a>Content Security Policy</h4><p><a href="https://www.w3.org/TR/CSP2/" target="_blank" rel="noopener">Content Security Policy (CSP)</a> is a mechanism that web applications can <strong>leverage to mitigate content injection vulnerabilities, such as cross-site scripting (XSS)</strong>. CSP is a declarative policy that provides a facility for web application authors to declare and ultimately inform the client (user-agent) about the sources from which the web application expects to load resources.</p>
<blockquote>
<p>Content Security Policy is not intended to solve all content injection vulnerabilities. Instead, CSP can be leveraged to help reduce the harm caused by content injection attacks. As a first line of defense, web application authors should validate their input and encode their output.</p>
</blockquote>
<p>A web application may employ the use of CSP by including one of the following HTTP headers in the response:</p>
<ul>
<li><code>Content-Security-Policy</code></li>
<li><code>Content-Security-Policy-Report-Only</code></li>
</ul>
<p>Each of these headers are used as a mechanism to deliver a security policy to the client. A security policy contains a set of security policy directives, each responsible for declaring the restrictions for a particular resource representation.</p>
<p>For example, a web application can <strong>declare that it expects to load scripts from specific, trusted sources, by including the following header in the response</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src https:&#x2F;&#x2F;trustedscripts.example.com</span><br></pre></td></tr></table></figure>

<p>An attempt to load a script from another source other than what is declared in the <code>script-src</code> directive will be blocked by the user-agent. Additionally, <strong>if the <a href="https://www.w3.org/TR/CSP2/#directive-report-uri" target="_blank" rel="noopener">report-uri</a> directive is declared in the security policy, then the violation will be reported by the user-agent to the declared URL</strong>.</p>
<p>For example, <strong>if a web application violates the declared security policy</strong>, the following response header will <strong>instruct the user-agent to send violation reports to the URL specified in the policy’s <code>report-uri</code> directive</strong>.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: script-src https://trustedscripts.example.com; report-uri /csp-report-endpoint/</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li><strong><a href="https://www.w3.org/TR/CSP2/#violation-reports" target="_blank" rel="noopener">Violation reports</a> are standard JSON structures</strong> that can be captured either by the web application’s own API or by a publicly hosted CSP violation reporting service, such as, <a href="https://report-uri.io/" target="_blank" rel="noopener">https://report-uri.io/</a>.</li>
</ul>
<p>However, sometimes for developing processes, you just want to test the filtering mechanism (this header is typically <strong>used when experimenting and/or developing security policies</strong> for a site.). <strong>This can be done with setting <code>Content-Security-Policy-Report-Only</code> instead of <code>Content-Security-Report</code>.</strong></p>
<p>For example, given the following response header, the policy declares that scripts may be loaded from one of two possible sources.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy-Report-Only</span>: script-src 'self' https://trustedscripts.example.com; report-uri /csp-report-endpoint/</span><br></pre></td></tr></table></figure>

<p>If the site violates this policy, by attempting to load a script from <em>evil.com</em>, <strong>the user-agent will send a violation report to the declared URL specified by the <em>report-uri</em> directive, <em>but still allow the violating resource to load nevertheless</em></strong>.</p>
<p>Applying Content Security Policy to a web application is often a non-trivial undertaking. The following resources may provide further assistance in developing effective security policies for your site.</p>
<p><a href="https://www.html5rocks.com/en/tutorials/security/content-security-policy/" target="_blank" rel="noopener">An Introduction to Content Security Policy</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP" target="_blank" rel="noopener">CSP Guide - Mozilla Developer Network</a></p>
<p><a href="https://www.w3.org/TR/CSP2/" target="_blank" rel="noopener">W3C Candidate Recommendation</a></p>
<h4 id="Referrer-Policy"><a href="#Referrer-Policy" class="headerlink" title="Referrer Policy"></a>Referrer Policy</h4><p><a href="https://www.w3.org/TR/referrer-policy" target="_blank" rel="noopener">Referrer Policy</a> is a mechanism that web applications can leverage to manage the referrer field, <strong>which contains the last page the user was on</strong>.</p>
<p><strong>Spring Security’s approach is to use <a href="https://www.w3.org/TR/referrer-policy/" target="_blank" rel="noopener">Referrer Policy</a> header</strong>:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referrer-Policy</span>: same-origin</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li>The <code>same-origin</code> policy specifies that <ul>
<li><strong>a full URL</strong>, <a href="https://www.w3.org/TR/referrer-policy/#strip-url" target="_blank" rel="noopener">stripped for use as a referrer</a>, <strong>is sent as referrer information when making <a href="https://www.w3.org/TR/referrer-policy/#same-origin-request" target="_blank" rel="noopener">same-origin requests</a> from a particular <a href="https://fetch.spec.whatwg.org/#concept-request-client" target="_blank" rel="noopener">client</a></strong>.</li>
<li><strong><a href="https://www.w3.org/TR/referrer-policy/#cross-origin-request" target="_blank" rel="noopener">Cross-origin requests</a>, on the other hand, will contain no referrer information</strong>. A <code>Referer</code> HTTP header will not be sent.</li>
</ul>
</li>
</ul>
<p>While the above is a common policy used, there are also other polices: <a href="https://www.w3.org/TR/referrer-policy/#referrer-policies" target="_blank" rel="noopener">https://www.w3.org/TR/referrer-policy/#referrer-policies</a>.</p>
<h4 id="Feature-Policy"><a href="#Feature-Policy" class="headerlink" title="Feature Policy"></a>Feature Policy</h4><p><a href="https://wicg.github.io/feature-policy/" target="_blank" rel="noopener">Feature Policy</a> is a mechanism that allows web developers to <strong>selectively enable, disable, and modify the behavior of certain APIs and web features</strong> in the browser.</p>
<p>For example:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Feature-Policy</span>: geolocation 'self'</span><br></pre></td></tr></table></figure>

<p>With Feature Policy, developers can opt-in to a set of “policies” for the browser to <strong>enforce on specific features used throughout your site. These policies restrict what APIs the site can access or modify the browser’s default behavior for certain features</strong>.</p>
<h4 id="Clear-Site-Data"><a href="#Clear-Site-Data" class="headerlink" title="Clear Site Data"></a>Clear Site Data</h4><p><a href="https://www.w3.org/TR/clear-site-data/" target="_blank" rel="noopener">Clear Site Data</a> is a mechanism by which <strong>any browser-side data related to the site</strong> - cookies, local storage, and the like - <strong>can be removed when an HTTP response contains this header</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Clear-Site-Data: &quot;cache&quot;, &quot;cookies&quot;, &quot;storage&quot;, &quot;executionContexts&quot;</span><br></pre></td></tr></table></figure>

<p><strong>This is a nice clean-up action to perform on logout.</strong></p>
<h4 id="Custom-Headers"><a href="#Custom-Headers" class="headerlink" title="Custom Headers"></a>Custom Headers</h4><p>Spring Security has mechanisms to make it convenient to add the more common security headers to your application. However, it also provides hooks to enable adding custom headers.</p>
<p>For more details on using custom headers, please visit the <a href="#Realizations">Realizations</a> section.</p>
<h1 id="Redirecting-HTTP"><a href="#Redirecting-HTTP" class="headerlink" title="Redirecting HTTP"></a>Redirecting HTTP</h1><h2 id="Redirect-to-HTTPS"><a href="#Redirect-to-HTTPS" class="headerlink" title="Redirect to HTTPS"></a>Redirect to HTTPS</h2><p>When a client uses HTTP, Spring Security can be configured to redirect to HTTPS. Please see the <a href="#HTTP-Realizations">HTTP Realizations</a> section.</p>
<h2 id="Proxy-Server-Configuration"><a href="#Proxy-Server-Configuration" class="headerlink" title="Proxy Server Configuration"></a>Proxy Server Configuration</h2><p>When using a proxy server it is <strong>important to ensure that you have configured your application properly</strong>. </p>
<p>For example, <strong>many applications will have a load balancer that responds to request for <a href="https://example.com/" target="_blank" rel="noopener">https://example.com/</a> by forwarding the request to an application server at <a href="https://192.168.0.1:8080/" target="_blank" rel="noopener">https://192.168.1:8080</a></strong>. Without proper configuration, the application server <strong>will not know that the load balancer exists and treat the request as though <a href="https://192.168.0.1:8080/" target="_blank" rel="noopener">https://192.168.1:8080</a> was requested by the client</strong>.</p>
<p>To fix this you can <strong>use <a href="https://tools.ietf.org/html/rfc7239" target="_blank" rel="noopener">RFC 7239</a> to specify that a load balancer is being used</strong>. To make the application aware of this, you need to <strong>either configure your application server aware of the X-Forwarded headers</strong>, <strong>or for Spring Boot users, you may use <code>server.use-forward-headers</code> property.</strong> </p>
<p>For example, in the former case, Tomcat uses the <a href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html" target="_blank" rel="noopener">RemoteIpValve</a> and Jetty uses <a href="https://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/ForwardedRequestCustomizer.html" target="_blank" rel="noopener">ForwardedRequestCustomizer</a>. Alternatively, Spring users can leverage <a href="https://github.com/spring-projects/spring-framework/blob/v4.3.3.RELEASE/spring-web/src/main/java/org/springframework/web/filter/ForwardedHeaderFilter.java" target="_blank" rel="noopener">ForwardedHeaderFilter</a>.</p>
<p>In the latter case, see the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-use-tomcat-behind-a-proxy-server" target="_blank" rel="noopener">Spring Boot documentation</a> for further details.</p>
<h1 id="Spring-Security-Project-Modules"><a href="#Spring-Security-Project-Modules" class="headerlink" title="Spring Security Project Modules"></a>Spring Security Project Modules</h1><p>To see a full list of available modules that Spring Security provides, please visit: <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#modules" target="_blank" rel="noopener">https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#modules</a>.</p>
<h1 id="Servlet-Security-The-Big-Picture"><a href="#Servlet-Security-The-Big-Picture" class="headerlink" title="Servlet Security: The Big Picture"></a>Servlet Security: The Big Picture</h1><p>This section discusses Spring Security’s high level architecture within Servlet based applications. </p>
<p>Later sections such as <a href="#Authentication-Realizations">Authentication Realizations</a>, <a href="#Authorization-Realizations">Authorization Realizations</a>, <a href="#Protection-Against-Exploits-Realizations">Protection Against Exploits Realizations</a> will build on from this.</p>
<h2 id="A-Review-of-Filters"><a href="#A-Review-of-Filters" class="headerlink" title="A Review of Filters"></a>A Review of <code>Filter</code>s</h2><p>Spring Security’s Servlet support is based on Servlet <code>Filter</code>s, so it is helpful to look at the role of <code>Filter</code>s generally first. The picture below shows <strong>the typical layering of the handlers for a single HTTP request</strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchain.png" alt="Picture from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchain.png" title="Picture from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchain.png"></p>
<p>The client sends a request to the application, and the container creates a <code>FilterChain</code> which contains the <code>Filter</code>s and <code>Servlet</code> that should process the <code>HttpServletRequest</code> based on the path of the request URI. </p>
<blockquote>
<p>In a Spring MVC application the <code>Servlet</code> is an instance of <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-servlet" target="_blank" rel="noopener"><code>DispatcherServlet</code></a>. </p>
</blockquote>
<p>At most one <code>Servlet</code> can handle a single <code>HttpServletRequest</code> and <code>HttpServletResponse</code>. However, <strong>using/having more than one <code>Filter</code> can be used to:</strong></p>
<ul>
<li>Prevent downstream <code>Filter</code>s or the <code>Servlet</code> from being invoked. In this instance the <code>Filter</code> will typically write the <code>HttpServletResponse</code>.</li>
<li>Modify the <code>HttpServletRequest</code> or <code>HttpServletResponse</code> used by the downstream <code>Filter</code>s and <code>Servlet</code></li>
</ul>
<p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something before the rest of the application</span></span><br><span class="line">    chain.doFilter(request, response); <span class="comment">// invoke the rest of the application</span></span><br><span class="line">    <span class="comment">// do something after the rest of the application</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since a <code>Filter</code> only impacts downstream <code>Filter</code>s and the <code>Servlet</code>, <strong>the order each <code>Filter</code> is invoked is extremely important</strong>.</p>
<h2 id="DelegatingFilterProxy"><a href="#DelegatingFilterProxy" class="headerlink" title="DelegatingFilterProxy"></a><code>DelegatingFilterProxy</code></h2><p>Spring provides a <code>Filter</code> implementation named <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/web/filter/DelegatingFilterProxy.html/" target="_blank" rel="noopener"><code>DelegatingFilterProxy</code></a> that allows bridging between the Servlet container’s lifecycle and Spring’s <code>ApplicationContext</code>. The Servlet container allows registering <code>Filter</code>s using its own standards, <strong>but it is not aware of Spring defined Beans.</strong> Therefore, the <code>DelegatingFilterProxy</code> can be useful:</p>
<ul>
<li><code>DelegatingFilterProxy</code> can be registered via standard Servlet container mechanisms, <strong>but delegate all the work to a Spring Bean that implements <code>Filter</code></strong>.</li>
</ul>
<p>Here is a picture of how <code>DelegatingFilterProxy</code> fits into the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-filters-review" target="_blank" rel="noopener"><code>Filter</code>s and the <code>FilterChain</code></a>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/delegatingfilterproxy.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/delegatingfilterproxy.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/delegatingfilterproxy.png"></p>
<p>The pseudo code for <code>DelegatingFilterProxy</code> could look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inside DelegatingFilterProxy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Lazily get Filter that was registered as a Spring Bean</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// For the exampl, delegate is an instance of Bean Filter0</span></span><br><span class="line">    Filter delegate = getFilterBean(someBeanName);</span><br><span class="line">    <span class="comment">// delegate work to the Spring Bean</span></span><br><span class="line">    delegate.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Another benefit of <code>DelegatingFilterProxy</code> is that it allows delaying looking Filter bean instances. This is important because the container needs to register the Filter instances before the container can startup.</p>
<h3 id="FilterChainProxy"><a href="#FilterChainProxy" class="headerlink" title="FilterChainProxy"></a><code>FilterChainProxy</code></h3><p>Besides registering a filter bean in your <code>DelegatingFilterProxy</code>, you can also register <code>FilterChainProxy</code>s, which allow you to add a group of filters inside the chain.</p>
<p><code>FilterChainProxy</code> <strong>is a special <code>Filter</code> provided by Spring Security that allows delegating to many <code>Filter</code> instances through <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-securityfilterchain" target="_blank" rel="noopener"><code>SecurityFilterChain</code></a></strong>. Since <code>FilterChainProxy</code> is a Bean, it is typically wrapped in a <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-delegatingfilterproxy" target="_blank" rel="noopener">DelegatingFilterProxy</a>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchainproxy.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchainproxy.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/filterchainproxy.png"></p>
<h3 id="SecurityFilterChain"><a href="#SecurityFilterChain" class="headerlink" title="SecurityFilterChain"></a><code>SecurityFilterChain</code></h3><p><strong><a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/SecurityFilterChain.html" target="_blank" rel="noopener"><code>SecurityFilterChain</code></a> is used by <code>FilterChainProxy</code></strong> to <strong>determine which Spring Security <code>Filter</code>s should be invoked for this request</strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/securityfilterchain.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/securityfilterchain.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/securityfilterchain.png"></p>
<p>where:</p>
<ul>
<li>The <a href="#Security-Filters">Security Filters</a> in <code>SecurityFilterChain</code> are also typically Beans (alike Bean Filters), <strong>but they are registered with <code>FilterChainProxy</code></strong> instead of <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-delegatingfilterproxy" target="_blank" rel="noopener">DelegatingFilterProxy</a>. </li>
</ul>
<p><strong><code>FilterChainProxy</code> provides a number of advantages to registering directly with the Servlet container or <a href="#`Delegatingfilterproxy`"><code>DelegatingFilterProxy</code></a></strong>. </p>
<ol>
<li><p>First, it provides a starting point for all of Spring Security’s Servlet support. For that reason, if you are attempting to troubleshoot Spring Security’s Servlet support, <strong>adding a debug point in <code>FilterChainProxy</code> is a great place to start</strong>.</p>
</li>
<li><p>Second, since <code>FilterChainProxy</code> is central to Spring Security usage it can perform tasks that are not viewed as optional. For example, it clears out the <code>SecurityContext</code> to avoid memory leaks. It also applies Spring Security’s <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-httpfirewall" target="_blank" rel="noopener"><code>HttpFirewall</code></a> to protect applications against certain types of attacks.</p>
</li>
<li><p>In addition, <strong>it provides more flexibility in determining when a <code>SecurityFilterChain</code> should be invoked.</strong> In a Servlet container, <code>Filter</code>s are invoked based upon the URL alone. <strong>However, <code>FilterChainProxy</code> can determine invocation based upon anything in the <code>HttpServletRequest</code> by leveraging the <code>RequestMatcher</code> interface</strong>.</p>
</li>
</ol>
<p>In fact, <strong><code>FilterChainProxy</code> can be used to determine which <code>SecurityFilterChain</code> should be used</strong>. This allows providing a totally separate configuration for different <em>slices</em> if your application.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/multi-securityfilterchain.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/multi-securityfilterchain.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/multi-securityfilterchain.png"></p>
<p>In the above image, <code>FilterChainProxy</code> decides which <code>SecurityFilterChain</code> should be used. </p>
<blockquote>
<p> Note:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>Only the first <code>SecurityFilterChain</code> that matches will be invoked</strong>. <ul>
<li>If a URL of <code>/api/messages/</code> is requested, it will first match on <code>SecurityFilterChain0</code>‘s pattern of <code>/api/**</code>, so only <code>SecurityFilterChain_0</code> will be invoked even though it also matches on <code>SecurityFilterChain_n</code>. If a URL of <code>/messages/</code> is requested, it will not match on <code>SecurityFilterChain_0</code>‘s pattern of <code>/api/**</code>, so <code>FilterChainProxy</code> will continue trying each <code>SecurityFilterChain</code>. Assuming that no other, <code>SecurityFilterChain</code> instances match <code>SecurityFilterChain_n</code> will be invoked.</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Security-Filters"><a href="#Security-Filters" class="headerlink" title="Security Filters"></a>Security Filters</h3><p><strong>The Security Filters are inserted into the <code>FilterChainProxy</code> with the <code>SecurityFilterChain</code> API</strong>. The order of <code>Filter</code>s matters. It is typically not necessary to know the ordering of Spring Security’s <code>Filter</code>s. However, there are times that it is beneficial to know the ordering.</p>
<p>Below is a comprehensive <strong>list of Spring Security Filter ordering that are inserted into the your Spring Boot project</strong>:</p>
<ul>
<li><code>ChannelProcessingFilter</code></li>
<li><code>ConcurrentSessionFilter</code></li>
<li><code>WebAsyncManagerIntegrationFilter</code></li>
<li><code>SecurityContextPersistenceFilter</code></li>
<li><code>HeaderWriterFilter</code></li>
<li><code>CorsFilter</code></li>
<li><code>CsrfFilter</code></li>
<li><code>LogoutFilter</code></li>
<li><code>OAuth2AuthorizationRequestRedirectFilter</code></li>
<li><code>Saml2WebSsoAuthenticationRequestFilter</code></li>
<li><code>X509AuthenticationFilter</code></li>
<li><code>AbstractPreAuthenticatedProcessingFilter</code></li>
<li><code>CasAuthenticationFilter</code></li>
<li><code>OAuth2LoginAuthenticationFilter</code></li>
<li><code>Saml2WebSsoAuthenticationFilter</code></li>
<li><a href="#`usernamepasswordauthenticationfilter`"><code>UsernamePasswordAuthenticationFilter</code></a><ul>
<li>Tries to find a username/password request parameter/POST body and if found, tries to authenticate the user with those values.</li>
</ul>
</li>
<li><code>ConcurrentSessionFilter</code></li>
<li><code>OpenIDAuthenticationFilter</code></li>
<li><code>DefaultLoginPageGeneratingFilter</code><ul>
<li>Generates a login page for you, if you don’t explicitly disable that feature. THIS filter is why you get a default login page when enabling Spring Security.</li>
</ul>
</li>
<li><code>DefaultLogoutPageGeneratingFilter</code><ul>
<li>Generates a logout page for you, if you don’t explicitly disable that feature.</li>
</ul>
</li>
<li><a href="#digestauthenticationfilter"><code>DigestAuthenticationFilter</code></a></li>
<li><code>BearerTokenAuthenticationFilter</code></li>
<li><a href="#`basicauthenticationfilter`"><code>BasicAuthenticationFilter</code></a><ul>
<li>Tries to find a Basic Auth HTTP Header on the request and if found, tries to authenticate the user with the header’s username and password.</li>
</ul>
</li>
<li><code>RequestCacheAwareFilter</code></li>
<li><code>SecurityContextHolderAwareRequestFilter</code></li>
<li><code>JaasApiIntegrationFilter</code></li>
<li><code>RememberMeAuthenticationFilter</code></li>
<li><code>AnonymousAuthenticationFilter</code></li>
<li><code>OAuth2AuthorizationCodeGrantFilter</code></li>
<li><code>SessionManagementFilter</code></li>
<li><a href="#`Exceptiontranslationfilter`"><code>ExceptionTranslationFilter</code></a><ul>
<li>See below section</li>
</ul>
</li>
<li><a href="#filtersecurityinterceptor"><code>FilterSecurityInterceptor</code></a><ul>
<li>Does your authorization (see <a href="#Authorization-Realizations">Authorization Realizations</a>)</li>
</ul>
</li>
<li><code>SwitchUserFilter</code></li>
</ul>
<p><strong>Those filters, for a large part, <em>are</em> Spring Security</strong>. Not more, not less. They do all the work. <strong>What’s left for you is to <em>configure</em> how they do their work</strong>, i.e. which URLs to protect, which to ignore and what database tables to use for authentication.</p>
<h2 id="ExceptionTranslationFilter"><a href="#ExceptionTranslationFilter" class="headerlink" title="ExceptionTranslationFilter"></a><code>ExceptionTranslationFilter</code></h2><p>The <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/access/ExceptionTranslationFilter.html" target="_blank" rel="noopener"><code>ExceptionTranslationFilter</code></a> <strong>allows translation of <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/access/AccessDeniedException.html" target="_blank" rel="noopener"><code>AccessDeniedException</code></a> and <a href="https://docs.spring.io/spring-security/site/docs/current/api//org/springframework/security/core/AuthenticationException.html" target="_blank" rel="noopener"><code>AuthenticationException</code></a> into HTTP responses</strong>.</p>
<p><code>ExceptionTranslationFilter</code> is inserted into the <code>FilterChainProxy</code> as one of the <code>Security Filters</code>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/exceptiontranslationfilter.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/exceptiontranslationfilter.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/architecture/exceptiontranslationfilter.png"></p>
<p>where:</p>
<ul>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png" alt="number 1">First, the <code>ExceptionTranslationFilter</code> invokes <code>FilterChain.doFilter(request, response)</code> to <strong>invoke the rest of the application</strong>.</li>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png" alt="number 2"> If the user is <strong>not authenticated or it is an <code>AuthenticationException</code></strong>, then <em>Start Authentication</em>.<ul>
<li>The <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-securitycontextholder" target="_blank" rel="noopener">SecurityContextHolder</a> is cleared out</li>
<li>The <code>HttpServletRequest</code> is saved in the <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/savedrequest/RequestCache.html" target="_blank" rel="noopener"><code>RequestCache</code></a>. When the user successfully authenticates, the <code>RequestCache</code> is used to replay the original request.</li>
<li>The <code>AuthenticationEntryPoint</code> is used to request credentials from the client. For example, it might redirect to a log in page or send a <code>WWW-Authenticate</code> header.</li>
</ul>
</li>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png" alt="number 3"> Otherwise <strong>if it is an <code>AccessDeniedException</code>, then <em>Access Denied</em></strong>. The <code>AccessDeniedHandler</code> is invoked to handle access denied.</li>
</ul>
<p>However, <strong>if the application does not throw an <code>AccessDeniedException</code> or an <code>AuthenticationException</code>, then <code>ExceptionTranslationFilter</code> does not do anything</strong>.</p>
<p>The pseudocode for <code>ExceptionTranslationFilter</code> looks something like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    filterChain.doFilter(request, response); </span><br><span class="line">&#125; <span class="keyword">catch</span> (AccessDeniedException | AuthenticationException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!authenticated || e <span class="keyword">instanceof</span> AuthenticationException) &#123;</span><br><span class="line">        startAuthentication(); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        accessDenied(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Realizations"><a href="#Realizations" class="headerlink" title="Realizations"></a>Realizations</h1><p>This section shows you how to implement all the theory mentioned above.</p>
<h2 id="Spring-Boot-Spring-Security"><a href="#Spring-Boot-Spring-Security" class="headerlink" title="Spring Boot + Spring Security"></a>Spring Boot + Spring Security</h2><p>If you are using Spring Boot (again, this is assumed in this manual), using Spring Security is as simple as importing one more additional dependency in your <code>pom.xml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>This has already been mentioned in the section <a href="#Getting-Spring-Security">Getting Spring Security</a>. For more details, please revisit that section. </p>
<h3 id="Spring-Boot-Auto-Configurations"><a href="#Spring-Boot-Auto-Configurations" class="headerlink" title="Spring Boot Auto Configurations"></a>Spring Boot Auto Configurations</h3><p>At this point, Spring Boot has added quite a few into your application. </p>
<p>Spring Boot automatically:</p>
<ul>
<li>Enables Spring Security’s default configuration, <strong>which creates a servlet <code>Filter</code> as a bean named <code>springSecurityFilterChain</code></strong>. This bean is responsible for all the security (protecting the application URLs, validating submitted username and passwords, redirecting to the log in form, and so on) within your application.</li>
<li>Creates a <code>UserDetailsService</code> bean with a <strong>username of <code>user</code> and a randomly generated password that is logged to the console</strong>.</li>
<li>Registers the <code>Filter</code> with a bean named <code>springSecurityFilterChain</code> with the Servlet container for every request.</li>
</ul>
<p>Spring Boot is not configuring much, but it does a lot. A summary of the features follows:</p>
<ul>
<li><strong>Require an authenticated user for any interaction</strong> with the application</li>
<li><strong>Generate a default login form</strong> for you</li>
<li>Let the user with a username of <code>user</code> and a password that is logged to the console to authenticate with form-based authentication</li>
<li><strong>Protects the password storage with <code>BCrypt</code></strong></li>
<li>Lets the user log out</li>
<li><a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_blank" rel="noopener">CSRF attack</a> prevention</li>
<li><a href="https://en.wikipedia.org/wiki/Session_fixation" target="_blank" rel="noopener">Session Fixation</a> protection</li>
<li><strong>Security Header integration</strong><ul>
<li><a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security" target="_blank" rel="noopener">HTTP Strict Transport Security</a> for secure requests</li>
<li><a href="https://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx" target="_blank" rel="noopener">X-Content-Type-Options</a> integration</li>
<li>Cache Control (can be overridden later by your application to allow caching of your static resources)</li>
<li><a href="https://msdn.microsoft.com/en-us/library/dd565647(v=vs.85).aspx" target="_blank" rel="noopener">X-XSS-Protection</a> integration</li>
<li>X-Frame-Options integration to help prevent <a href="https://en.wikipedia.org/wiki/Clickjacking" target="_blank" rel="noopener">Clickjacking</a></li>
</ul>
</li>
<li>Integrate with the following Servlet API methods:<ul>
<li><a href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getRemoteUser()" target="_blank" rel="noopener"><code>HttpServletRequest#getRemoteUser()</code></a></li>
<li><a href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getUserPrincipal()" target="_blank" rel="noopener"><code>HttpServletRequest.html#getUserPrincipal()</code></a></li>
<li><a href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#isUserInRole(java.lang.String)" target="_blank" rel="noopener"><code>HttpServletRequest.html#isUserInRole(java.lang.String)</code></a></li>
<li>[<code>HttpServletRequest.html#login(java.lang.String, java.lang.String)</code>](<a href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#login" target="_blank" rel="noopener">https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#login</a>(java.lang.String, java.lang.String))</li>
<li><a href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#logout()" target="_blank" rel="noopener"><code>HttpServletRequest.html#logout()</code></a></li>
</ul>
</li>
</ul>
<p>Now, if you start your application and send a request, this would be the response header that Spring Security has configured for you.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> </span><br><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br><span class="line"><span class="attribute">X-XSS-Protection</span>: 1; mode=block</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache, no-store, max-age=0, must-revalidate</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Expires</span>: 0</span><br><span class="line"><span class="attribute">X-Frame-Options</span>: DENY</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html;charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 88</span><br><span class="line"><span class="attribute">Date</span>: Fri, 24 Jul 2020 06:32:43 GMT</span><br><span class="line"><span class="attribute">Keep-Alive</span>: timeout=60</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br></pre></td></tr></table></figure>

<h2 id="Authentication-Realizations"><a href="#Authentication-Realizations" class="headerlink" title="Authentication Realizations"></a>Authentication Realizations</h2><p>Authentication not only means authenticating the user at login time, but also “remembering” the user as being already authenticated when the user made further requests.</p>
<p>In general, there are two ways to achieve authentication: by using a <em>session</em> or by using a <em>token</em>.</p>
<ul>
<li>A session is composed of:<ul>
<li><code>sid</code> - session id</li>
<li><code>data</code> - all the information you want to store (e.g. user logged in information)</li>
</ul>
</li>
<li>A token is composed of:<ul>
<li><code>token</code> - a token that is representing a certain status</li>
</ul>
</li>
</ul>
<h3 id="Basic-Form-Authentication"><a href="#Basic-Form-Authentication" class="headerlink" title="Basic Form Authentication"></a>Basic Form Authentication</h3><p>If you are implementing this functionality from scratch (i.e. without Spring Security doing work for you), you need to do quite a lot of work.</p>
<p>In summary, you need to:</p>
<ol>
<li>Create all the relevant classes, including your <code>@Controller</code>, <code>@Configuration</code>…</li>
<li>Create a <code>DTO</code>, which contains fields such as:<ul>
<li><code>username</code></li>
<li><code>password</code></li>
<li><code>SESSION_ID</code></li>
</ul>
</li>
<li>Create a <code>service</code>, that achieves:<ul>
<li>Checking whether the user login information is correct</li>
<li>Extracting user information from the <code>SESSION_ID</code></li>
<li>Handling authentication request verification, based on data provided by the object below<ul>
<li>If verified correctly, creates a session with the specified <code>SESSION_ID</code> and the user <code>DTO</code> as data</li>
<li>Provide the <code>SESSION_ID</code> back to be stored in the user’s cookie</li>
</ul>
</li>
</ul>
</li>
<li>Create a <code>request</code> object, that contains:<ul>
<li>necessary request parameters, such as <code>username</code> and <code>password</code></li>
</ul>
</li>
<li>Create a <code>controller</code>, that:<ul>
<li>Uses the <code>request</code> object created above as input argument</li>
<li>Uses the <code>service</code> class you created above for handling authentication verification</li>
</ul>
</li>
</ol>
<p>While the above is achievable and certainly working, things can get complicated when your project scope extends.</p>
<p><strong>With Spring Security, you save a lot of work by</strong>:</p>
<ul>
<li>Already having all the authentication/authorization mechanism and filters implemented (see <a href="#Security-Filters">Security Filters</a>).</li>
</ul>
<p>Therefore, all you need to do is to <strong>configure your Spring Security</strong>.</p>
<h4 id="Configuring-your-Spring-Security"><a href="#Configuring-your-Spring-Security" class="headerlink" title="Configuring your Spring Security"></a>Configuring your Spring Security</h4><p>With the latest Spring Security and/or Spring Boot versions, configuring Spring Security is simple.</p>
<p>In summary, you just need to:</p>
<ol>
<li>Create a class annotated with <code>@EnableWebSecurity</code><ul>
<li>You might want to make it a <code>@Configuration</code> as well, as it configures your application</li>
</ul>
</li>
<li>Extends <code>WebSecurityConfigurer</code><ul>
<li>This basically offers you a configuration DSL/methods. With those methods, <strong>you can specify what URIs in your application to protect or what exploit protections to enable/disable</strong>.</li>
</ul>
</li>
<li>Use the <code>configure()</code> method and specify the configurations you want</li>
</ol>
<p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By overriding the adapter’s configure(HttpSecurity) method, you get a nice little DSL with which you can configure your FilterChain.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()	<span class="comment">//1</span></span><br><span class="line">                    .antMatchers(<span class="string">"/"</span>,<span class="string">"home"</span>).permitAll()</span><br><span class="line">                    .anyRequest().authenticated()</span><br><span class="line">                    .and()</span><br><span class="line">                .formLogin()	<span class="comment">//2</span></span><br><span class="line">                    .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">                    .permitAll()</span><br><span class="line">                    .and()</span><br><span class="line">                .logout()	<span class="comment">//3</span></span><br><span class="line">                    .permitAll()</span><br><span class="line">                    .and()</span><br><span class="line">                .httpBasic();	<span class="comment">//4</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ol>
<li><code>authorizeRequests()</code> authorizes <strong>request</strong> that match certain condition to be passed through<ul>
<li>for all options you can specify with it, you can look at its class <code>ExpressionUrlAuthorizationConfigurer</code></li>
</ul>
</li>
<li><code>formLogin()</code> configures the <strong>login request</strong>, allowing form login<ul>
<li>for all options you can specify with it, you can look at its class <code>FormLoginConfigurer</code></li>
</ul>
</li>
<li><code>logout()</code> configures the <strong>logout request</strong><ul>
<li>for all options you can specify with it, you can look at its class <code>LogoutConfigurer</code></li>
</ul>
</li>
<li><code>httpBasic()</code> allows <strong>Basic Auth</strong>, i.e. sending in an HTTP Basic Auth Header to authenticate<ul>
<li>for all options you can specify with it, you can look at its class<code>HttpBasicConfigurer</code></li>
</ul>
</li>
</ol>
<p>In fact, the Spring Security implementation has:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfigurerAdapter</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">                <span class="title">WebSecurityConfigurer</span>&lt;<span class="title">WebSecurity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                    .anyRequest().authenticated()  <span class="comment">// (1)</span></span><br><span class="line">                    .and()</span><br><span class="line">                .formLogin().and()   <span class="comment">// (2), uses generated login page</span></span><br><span class="line">                .httpBasic();  <span class="comment">// (3)</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where we see the same elements as above, which explains why, if we did not configure anything, we will always be redirected to a generated login page.</p>
<h4 id="Authentication-with-Spring-Security"><a href="#Authentication-with-Spring-Security" class="headerlink" title="Authentication with Spring Security"></a>Authentication with Spring Security</h4><p>When it comes to authentication and Spring Security you have roughly three scenarios:</p>
<ol>
<li>The <strong>default</strong>: You <em>can</em> access the (hashed) password of the user, because you have his details (username, password) saved in e.g. a database table.</li>
<li><strong>Less common</strong>: You <em>cannot</em> access the (hashed) password of the user. This is the case if your users and passwords are stored <em>somewhere</em> else, like in a 3rd party identity management product offering REST services for authentication. Think: <a href="https://www.atlassian.com/software/crowd" target="_blank" rel="noopener">Atlassian Crowd</a>.</li>
<li><strong>Also popular</strong>: You want to use OAuth2 or “Login with Google/Twitter/etc.” (OpenID), likely in combination with JWT. Then none of the following applies and you should go straight to the <a href="https://www.marcobehler.com/guides/spring-security#oauth2" target="_blank" rel="noopener">OAuth2 chapter</a>.</li>
</ol>
<p>The following sections will only discuss the <strong>default</strong> strategy and the <strong>OAuth2</strong> strategy, which has its own section. If you need some information on the second topic, please visit <a href="https://www.marcobehler.com/guides/spring-security" target="_blank" rel="noopener">https://www.marcobehler.com/guides/spring-security</a>.</p>
<hr>
<p>In summary, to use the <strong>default</strong> Spring Security procedure (with some customization), you will need to:</p>
<ol>
<li><strong>Use the <code>config()</code> method</strong> inside a class that extends <code>WebSecurityConfigurerAdapter</code> to configure your Spring Security<ul>
<li>Shown in the section <a href="#Configuring-your-Spring-Security">Configuring your Spring Security</a> above</li>
<li>Based on what you have configured here, some of your code will change below.</li>
</ul>
</li>
<li><strong>Implement the <code>loadUserByUsername</code> method</strong> by creating a class that implements <code>UserDetailsService</code><ul>
<li>At this point, you need to also create a class that implements <code>UserDetails</code>, which is returned by the above method</li>
<li>Since <code>UserDetails</code> needs data (e.g. username/hashed password) from the database, you need to create a service class that achieves this</li>
</ul>
</li>
<li><strong>Choose and create your <code>PasswordEncoder</code></strong> to be injected as a bean<ul>
<li>This will be the default encoder that you will use to hash and decode</li>
</ul>
</li>
<li><strong>Create controllers</strong> that handles the basic setup you have above</li>
</ol>
<hr>
<p>For example, if you have the following configuration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                    .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">                    .anyRequest().authenticated()</span><br><span class="line">                    .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                    .loginPage(<span class="string">"/login"</span>)    <span class="comment">// this is necessary for a customized login error page and logout page as well</span></span><br><span class="line">                    .loginProcessingUrl(<span class="string">"/login"</span>)   <span class="comment">// this has to be the same as the above</span></span><br><span class="line">                    .defaultSuccessUrl(<span class="string">"/"</span>, <span class="keyword">true</span>)   <span class="comment">// redirect after success</span></span><br><span class="line">                    .failureUrl(<span class="string">"/login?error=true"</span>)  <span class="comment">// redirect after failed, adds information for processing</span></span><br><span class="line">                    .and()</span><br><span class="line">                .logout()</span><br><span class="line">                    .logoutUrl(<span class="string">"/logout"</span>)	<span class="comment">// customized logout page</span></span><br><span class="line">                    .logoutSuccessUrl(<span class="string">"/login?logout=true"</span>)	<span class="comment">// redirect after success</span></span><br><span class="line">                    .permitAll()</span><br><span class="line">                    .and()</span><br><span class="line">                .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyUserDetailService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">(PasswordStorage passwordStorage)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passwordStorage.getPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above setup will:</p>
<ul>
<li>allow all access to <code>/</code>, <code>/home</code>, <code>/login*</code> URLs</li>
<li>requires a <code>csrf</code> token when the form is submitted<ul>
<li>this will be enabled unless you specify <code>csrf().disabled()</code></li>
</ul>
</li>
<li>allows a custom <code>login</code> page,<code>login</code> success redirect page, <code>login</code> error page, <code>logout</code> page, <code>logout</code> success redirect page<ul>
<li>Notice, if you want to specify customized page for all three, you need to specify <code>.loginPage()</code>. If you did not specify this, all the redirecting will not work properly either</li>
</ul>
</li>
<li>Injects the two necessary bean into the container to customize the behavior: <code>UserDetailService</code> and <code>PasswordEncoder</code></li>
</ul>
<p>Now, your <code>loadUserByUsername</code> implementation could look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserDetailsImpl(s, <span class="keyword">this</span>.userService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And your corresponding <code>UserDetailsImpl</code> could be:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.testspringsecurity.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.testspringsecurity.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.testspringsecurity.service.UserServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsImpl</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsImpl</span><span class="params">(String username, UserServiceImpl userService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;	<span class="comment">// this will be used when we come to Authorization with Spring Security</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userService.getUserPassword(<span class="keyword">this</span>.username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since the data comes from a database, you need to have the corresponding service classes. Below shows one of them:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// so that if this method gets called, userMapper is already initialized</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserMapper <span class="title">getUserMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserPassword</span><span class="params">(String username)</span></span>&#123;</span><br><span class="line">        String passwd;</span><br><span class="line">        <span class="keyword">if</span>((passwd = getUserMapper().getPassword(username)) == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"User "</span>+username+<span class="string">" not found"</span>); <span class="comment">// this is needed so that error page redirects correctly</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> passwd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Notice that you need to use the <code>UsernameNotFoundException</code> for the default login error handler to respond correctly.</strong></p>
<p>Last but not least, if you have enabled the <code>csrf</code> , you need to make sure that the token is included in your login/logout requests.</p>
<p>Luckily, this token is exposed by <code>HttpServletRequest</code> as a <code>_csrf</code> attribute. So I could get this and renders it together within the template:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span> <span class="comment">// notice that you need to change this to Controller, not RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PasswordStorage passwordStorage;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(@RequestParam(required = <span class="keyword">false</span>)</span> String error, @<span class="title">RequestParam</span><span class="params">(required = <span class="keyword">false</span>)</span> String logout, Map&lt;String, String&gt; map1)</span>&#123;</span><br><span class="line">        map1.put(<span class="string">"_csrf"</span>,((CsrfToken)<span class="keyword">this</span>.request.getAttribute(<span class="string">"_csrf"</span>)).getToken()); <span class="comment">// gets the CSRF token</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(error != <span class="keyword">null</span>)&#123;</span><br><span class="line">            map1.put(<span class="string">"login_status"</span>,<span class="string">"Authentication Failed"</span>); <span class="comment">// this is used for thymeleaf rendering</span></span><br><span class="line">            System.out.println(<span class="string">"Authentication Failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(logout != <span class="keyword">null</span>)&#123;</span><br><span class="line">            map1.put(<span class="string">"logout_status"</span>,<span class="string">"Logout success"</span>); <span class="comment">// this is used for thymeleaf rendering</span></span><br><span class="line">            System.out.println(<span class="string">"Logged out"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">logout</span><span class="params">(Map&lt;String, String&gt; map1)</span></span>&#123;</span><br><span class="line">        map1.put(<span class="string">"_csrf"</span>,((CsrfToken)<span class="keyword">this</span>.request.getAttribute(<span class="string">"_csrf"</span>)).getToken());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"logout"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here <code>Thymeleaf</code> is used to silently include the <code>csrf</code> token. A sample login page html could look like:</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Login Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> <span class="attr">href</span>=<span class="string">"favicon.ico"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;login_status != null&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"$&#123;login_status&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;logout_status != null&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"$&#123;logout_status&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">'f'</span> <span class="attr">action</span>=<span class="string">"login"</span> <span class="attr">method</span>=<span class="string">'POST'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>User:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'text'</span> <span class="attr">name</span>=<span class="string">'username'</span> <span class="attr">value</span>=<span class="string">''</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>Password:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'password'</span> <span class="attr">name</span>=<span class="string">'password'</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Notice this input field --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"_csrf"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;_csrf&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>As a result, requests will be send with a <code>_csrf</code> token.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> For the default configuration, both login and logout only supports a <strong>POST method</strong>. Therefore, you need to either include the token in the header or in the request body.</li>
</ul>
</blockquote>
<h3 id="Authentication-Mechanism"><a href="#Authentication-Mechanism" class="headerlink" title="Authentication Mechanism"></a>Authentication Mechanism</h3><p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/securitycontextholder.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/securitycontextholder.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/securitycontextholder.png"></p>
<hr>
<p>In summary, Spring Security uses <code>SecurityContextHolder</code> that holds information about Authentication:</p>
<ol>
<li><p>You can get the context with</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SecurityContext context = SecurityContextHolder.getContext();</span><br><span class="line">Authentication authentication = context.getAuthentication();</span><br></pre></td></tr></table></figure>
</li>
<li><p>The <code>Authentication</code> contains:</p>
<ul>
<li><code>principal</code> - identifies the user. When authenticating with a username/password this is often an instance of <code>UserDetails</code>.</li>
<li><code>credentials</code> - Often a password. In many cases this will be cleared after the user is authenticated to ensure it is not leaked.</li>
<li><code>authorities</code> - the <code>GrantedAuthority</code>s are high level permissions the user is granted. A few examples are roles or scopes.</li>
</ul>
</li>
<li><p>Authentication process happens with <a href="#`AuthenticationManager`"><code>AuthenticationManager</code></a> which has a common implementation called <a href="#`ProviderManager`"><code>ProviderManager</code></a></p>
</li>
</ol>
<hr>
<h4 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a><code>AuthenticationManager</code></h4><p><code>AuthenticationManager</code> is the <strong>API that defines how Spring Security’s Filters perform authentication</strong>. The <code>Authentication</code> that is returned is then set on the <code>SecurityContextHolder</code> by the controller (i.e. <a href="#A-Review-of-`Filter`s">Spring Security’s <code>Filters</code>s</a>) that invoked the <code>AuthenticationManager</code>. If you are not integrating with <em>Spring Security’s <code>Filters</code>s</em> you can set the <code>SecurityContextHolder</code> directly and are not required to use an <code>AuthenticationManager</code>.</p>
<p>While the implementation of <code>AuthenticationManager</code> could be anything, the most common implementation is <a href="#`providermanager`"><code>ProviderManager</code></a>.</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence</em></strong>, <strong>this holds/manages multiple <code>AuthenticationProviders</code>, which actually authenticates your users</strong></li>
</ul>
<h4 id="ProviderManager"><a href="#ProviderManager" class="headerlink" title="ProviderManager"></a><code>ProviderManager</code></h4><p><code>ProviderManager</code> is the <strong>most commonly used implementation of <code>AuthenticationManager</code></strong>.</p>
<p><code>ProviderManager</code> delegates to <strong>a <code>List</code> of <code>AuthenticationProvider</code>s</strong>. Each <code>AuthenticationProvider</code> has an opportunity to indicate that authentication should be successful, fail, or indicate it cannot make a decision and allow a downstream <code>AuthenticationProvider</code> to decide. If none of the configured <code>AuthenticationProvider</code>s can authenticate, then authentication will fail with a <code>ProviderNotFoundException</code> which is a special <code>AuthenticationException</code> that indicates the <code>ProviderManager</code> was not configured support the type of <code>Authentication</code> that was passed into it.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/providermanager.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/providermanager.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/providermanager.png"></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence</em></strong>, <strong>you can imagine that this holds a list of authentication implementations (<code>AuthenticationProvider</code>) that passes on and authenticating the user’s information from top to bottom</strong>.</li>
</ul>
<h4 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a><code>AuthenticationProvider</code></h4><p>Multiple <code>AuthenticationProvider</code>s can be injected into <code>ProviderManager</code>. Each <code>AuthenticationProvider</code> performs a specific type of authentication. For example, <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-daoauthenticationprovider" target="_blank" rel="noopener"><code>DaoAuthenticationProvider</code></a> supports username/password based authentication while <code>JwtAuthenticationProvider</code> supports authenticating a JWT token.</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong>this is where the actual authentication takes place</strong></li>
</ul>
<h4 id="AuthenticationEntryPoint"><a href="#AuthenticationEntryPoint" class="headerlink" title="AuthenticationEntryPoint"></a><code>AuthenticationEntryPoint</code></h4><p><code>AuthenticationEntryPoint</code> is used to <strong>send an HTTP response that requests credentials from a client.</strong></p>
<p>Sometimes a client will proactively include credentials such as a username/password to request a resource. In these cases, Spring Security does not need to provide an HTTP response that requests credentials from the client since they are already included.</p>
<p>In other cases, a client will make an unauthenticated request to a resource that they are not authorized to access. In this case, an implementation of <code>AuthenticationEntryPoint</code> is used to request credentials from the client. The <code>AuthenticationEntryPoint</code> implementation might perform a <a href="#Basic-Form-Authentication">redirect to a log in page</a>, respond with an <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-basic" target="_blank" rel="noopener">WWW-Authenticate</a> header, etc.</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong>this is the entry point to redirect unauthenticated request to a login page.</strong></li>
</ul>
<h4 id="AbstractAuthenticationProcessingFilter"><a href="#AbstractAuthenticationProcessingFilter" class="headerlink" title="AbstractAuthenticationProcessingFilter"></a><code>AbstractAuthenticationProcessingFilter</code></h4><p><code>AbstractAuthenticationProcessingFilter</code> is used as a <strong>base <code>Filter</code> for authenticating a user’s credentials</strong>. Before the credentials can be authenticated, Spring Security typically requests the credentials using <code>AuthenticationEntryPoint</code>.</p>
<p>Next, the <code>AbstractAuthenticationProcessingFilter</code> can authenticate any authentication requests that are submitted to it.</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong>this is filter that actually triggers <code>AuthenticationEntryPoint</code> if an unauthenticated request happens.</strong></li>
</ul>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/abstractauthenticationprocessingfilter.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/abstractauthenticationprocessingfilter.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/architecture/abstractauthenticationprocessingfilter.png"></p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png" alt="number 1">When the user submits their credentials, the <code>AbstractAuthenticationProcessingFilter</code> <strong>creates an <code>Authentication</code> from the <code>HttpServletRequest</code> to be authenticated</strong>. The type of <code>Authentication</code> created depends on the subclass of <code>AbstractAuthenticationProcessingFilter</code>. For example, <code>UsernamePasswordAuthenticationFilter</code> creates a <code>UsernamePasswordAuthenticationToken</code> from a <em>username</em> and <em>password</em> that are submitted in the <code>HttpServletRequest</code>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png" alt="number 2"> Next, <strong>the <code>Authentication</code> is passed into</strong> the <code>AuthenticationManager</code> to be authenticated.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png" alt="number 3"> If authentication fails, then <em>Failure</em></p>
<ul>
<li>The <code>SecurityContextHolder</code> is cleared out.</li>
<li><code>RememberMeServices.loginFail</code> is invoked. <strong>If remember me is not configured, this is a no-op.</strong></li>
<li><code>AuthenticationFailureHandler</code> is invoked.</li>
</ul>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png" alt="number 4"> If authentication is successful, then <em>Success</em>.</p>
<ul>
<li><code>SessionAuthenticationStrategy</code> is notified of a new log in.</li>
<li><strong>The <code>Authentication</code> is set on the <code>SecurityContextHolder</code></strong>. Later the <code>SecurityContextPersistenceFilter</code> saves the <code>SecurityContext</code> to the <code>HttpSession</code>.</li>
<li><code>RememberMeServices.loginSuccess</code> is invoked. <strong>If remember me is not configured, this is a no-op.</strong></li>
<li><code>ApplicationEventPublisher</code> publishes an <code>InteractiveAuthenticationSuccessEvent</code>.</li>
</ul>
<h4 id="Username-Password-Authentication"><a href="#Username-Password-Authentication" class="headerlink" title="Username/Password Authentication"></a>Username/Password Authentication</h4><p>One of the most common ways to authenticate a user is by validating a username and password. As such, Spring Security provides comprehensive support for authenticating with a username and password.</p>
<p><strong>Reading the Username &amp; Password</strong></p>
<p>Spring Security provides the following built in mechanisms for reading a username and password from the <code>HttpServletRequest</code>:</p>
<ul>
<li><a href="#Basic-Form-Authentication">Form Login</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-basic" target="_blank" rel="noopener">Basic Authentication</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-digest" target="_blank" rel="noopener">Digest Authentication</a></li>
</ul>
<p><strong>Storage Mechanisms</strong></p>
<p>Each of the supported mechanisms for reading a username and password can leverage any of the supported storage mechanisms:</p>
<ul>
<li>Simple Storage with <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-inmemory" target="_blank" rel="noopener">In-Memory Authentication</a></li>
<li>Relational Databases with <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-jdbc" target="_blank" rel="noopener">JDBC Authentication</a></li>
<li>Custom data stores with <a href="#Basic-Form-Authentication">UserDetailsService</a><ul>
<li>This is mentioned in the <a href="#Basic-Form-Authentication">Basic Form Authentication</a> section</li>
</ul>
</li>
<li>LDAP storage with <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-ldap" target="_blank" rel="noopener">LDAP Authentication</a></li>
</ul>
<p>The below <strong>will only discuss the mechanism used by the section Basic Form Authentication. This means only Form Login and <code>UserDetailsService</code> mentioned above will be covered</strong>. For more details on the other options, please visit the official website by clicking the hyperlinks above.</p>
<h3 id="Form-Authentication-Mechanism"><a href="#Form-Authentication-Mechanism" class="headerlink" title="Form Authentication Mechanism"></a>Form Authentication Mechanism</h3><p>Below is a diagram showing what happens in the section <a href="#Basic-Form-Authentication">Basic Form Authentication</a>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/loginurlauthenticationentrypoint.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/loginurlauthenticationentrypoint.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/loginurlauthenticationentrypoint.png"></p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png" alt="number 1"> First, a user makes an unauthenticated request to the resource <code>/private</code> for which it is not authorized.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png" alt="number 2"> Spring Security’s <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authorization-filtersecurityinterceptor" target="_blank" rel="noopener"><code>FilterSecurityInterceptor</code></a> indicates that the unauthenticated request is <em>Denied</em> by <strong>throwing an <code>AccessDeniedException</code></strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png" alt="number 3"> Since the user is not authenticated, <strong><a href="#`exceptiontranslationfilter`"><code>ExceptionTranslationFilter</code></a> initiates <em>Start Authentication</em> and sends a redirect to the log in page with the configured <a href="#`authenticationentrypoint`"><code>AuthenticationEntryPoint</code></a></strong>. In most cases <strong>the <code>AuthenticationEntryPoint</code> is an instance of <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/authentication/LoginUrlAuthenticationEntryPoint.html" target="_blank" rel="noopener"><code>LoginUrlAuthenticationEntryPoint</code></a></strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png" alt="number 4"> The browser will then request the log in page that it was redirected to.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_5.png" alt="number 5"> Something within the application, must <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-form-custom" target="_blank" rel="noopener">render the log in page</a>.</p>
<p>When the username and password are submitted, the <code>UsernamePasswordAuthenticationFilter</code> authenticates the username and password. The <code>UsernamePasswordAuthenticationFilter</code> extends <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-abstractprocessingfilter" target="_blank" rel="noopener">AbstractAuthenticationProcessingFilter</a>, so this diagram should look pretty similar.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/usernamepasswordauthenticationfilter.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/usernamepasswordauthenticationfilter.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/usernamepasswordauthenticationfilter.png"></p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png" alt="number 1"> When the user submits their username and password, the <code>UsernamePasswordAuthenticationFilter</code> <strong>creates a <code>UsernamePasswordAuthenticationToken</code> which is a type of <code>Authentication</code> by extracting the username and password from the <code>HttpServletRequest</code></strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png" alt="number 2"> Next, the <code>UsernamePasswordAuthenticationToken</code> is passed into the <code>AuthenticationManager</code> to be authenticated. The details of what <code>AuthenticationManager</code> look like depend on how the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-unpwd-storage" target="_blank" rel="noopener">user information is stored</a>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png" alt="number 3"> If authentication fails, then <em>Failure</em></p>
<ul>
<li>The <a href="#`securitycontextholder`">SecurityContextHolder</a> is cleared out.</li>
<li><code>RememberMeServices.loginFail</code> is invoked. <strong>If remember me is not configured, this is a no-op.</strong></li>
<li><code>AuthenticationFailureHandler</code> is invoked.</li>
</ul>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png" alt="number 4"> If authentication is successful, then <em>Success</em>.</p>
<ul>
<li><code>SessionAuthenticationStrategy</code> is notified of a new log in.</li>
<li>The <code>Authentication</code> is set on the <a href="#`securitycontextholder`">SecurityContextHolder</a>.</li>
<li><code>RememberMeServices.loginSuccess</code> is invoked. <strong>If remember me is not configured, this is a no-op.</strong></li>
<li><code>ApplicationEventPublisher</code> publishes an <code>InteractiveAuthenticationSuccessEvent</code>.</li>
<li>The <code>AuthenticationSuccessHandler</code> is invoked. Typically this is a <code>SimpleUrlAuthenticationSuccessHandler</code> which will redirect to a request saved by <a href="#`exceptiontranslationfilter`"><code>ExceptionTranslationFilter</code></a> when we redirect to the log in page.</li>
</ul>
<p>Now in the section Basic Form Authentication, we injected the <code>UserDetailService</code> bean into the container. This will do the following:</p>
<ul>
<li><strong><code>DaoAuthenticationProvider</code> will use that bean to authenticate your user information</strong></li>
</ul>
<h4 id="DaoAuthenticationProvider"><a href="#DaoAuthenticationProvider" class="headerlink" title="DaoAuthenticationProvider"></a><code>DaoAuthenticationProvider</code></h4><p><code>DaoAuthenticationProvider</code> is an <a href="#authenticationprovider"><code>AuthenticationProvider</code></a> implementation that leverages a <code>UserDetailsService</code> and <code>PasswordEncoder</code> to authenticate a username and password.</p>
<p>Let’s take a look at how <code>DaoAuthenticationProvider</code> works within Spring Security. The figure explains details of how the <a href="#authenticationmanager"><code>AuthenticationManager</code></a> in figures from <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-unpwd-input" target="_blank" rel="noopener">Reading the Username &amp; Password</a> works.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/daoauthenticationprovider.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/daoauthenticationprovider.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authentication/unpwd/daoauthenticationprovider.png"></p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png" alt="number 1">The authentication <code>Filter</code> from <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-unpwd-input" target="_blank" rel="noopener">Reading the Username &amp; Password</a> <strong>passes a <code>UsernamePasswordAuthenticationToken</code></strong> to the <code>AuthenticationManager</code> which is implemented by <a href="#providermanager"><code>ProviderManager</code></a>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png" alt="number 2"> The <code>ProviderManager</code> is configured to <strong>use an <a href="#authenticationprovider">AuthenticationProvider</a> of type <code>DaoAuthenticationProvider</code></strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png" alt="number 3"> <code>DaoAuthenticationProvider</code> <strong>looks up the <code>UserDetails</code> from the <code>UserDetailsService</code></strong>.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png" alt="number 4"> <code>DaoAuthenticationProvider</code> then <strong>uses the <code>PasswordEncoder</code> to validate the password</strong> on the <code>UserDetails</code> returned in the previous step.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_5.png" alt="number 5"> When authentication is successful, the <a href="#authentication"><code>Authentication</code></a> that is returned is of type <code>UsernamePasswordAuthenticationToken</code> and <strong>has a principal that is the <code>UserDetails</code></strong> returned by the configured <code>UserDetailsService</code>. Ultimately, the <strong>returned <code>UsernamePasswordAuthenticationToken</code> will be set on the <a href="#securitycontextholder"><code>SecurityContextHolder</code></a> by the authentication <code>Filter</code></strong>.</p>
<h4 id="UserDetails-and-UserDetailsService"><a href="#UserDetails-and-UserDetailsService" class="headerlink" title="UserDetails and UserDetailsService"></a><code>UserDetails</code> and <code>UserDetailsService</code></h4><p><a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/UserDetails.html" target="_blank" rel="noopener"><code>UserDetails</code></a> is returned by the <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-userdetailsservice" target="_blank" rel="noopener"><code>UserDetailsService</code></a>. The <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-daoauthenticationprovider" target="_blank" rel="noopener"><code>DaoAuthenticationProvider</code></a> validates the <code>UserDetails</code> and then returns an <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-authentication" target="_blank" rel="noopener"><code>Authentication</code></a> that has a principal that is the <code>UserDetails</code> returned by the configured <code>UserDetailsService</code>.</p>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/UserDetailsService.html" target="_blank" rel="noopener"><code>UserDetailsService</code></a> is used by <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-daoauthenticationprovider" target="_blank" rel="noopener"><code>DaoAuthenticationProvider</code></a> for retrieving a username, password, and other attributes for authenticating with a username and password. Spring Security provides <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-inmemory" target="_blank" rel="noopener">in-memory</a> and <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#servlet-authentication-jdbc" target="_blank" rel="noopener">JDBC</a> built-in implementations of <code>UserDetailsService</code>.</p>
<p>You can define custom authentication by exposing a custom <code>UserDetailsService</code> as a bean. For example, the following will customize authentication assuming that <code>CustomUserDetailsService</code> implements <code>UserDetailsService</code></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong><code>UserDetailsService</code> returns a <code>UserDetails</code> that contains user’s correct login information, so that it can be checked against by the <code>DaoAuthenticationProvider</code></strong></li>
</ul>
<h4 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a><code>PasswordEncoder</code></h4><p>Spring Security’s servlet support storing passwords securely by integrating with <a href="#password-storage-and-encoding"><code>PasswordEncoder</code></a>. Customizing the <code>PasswordEncoder</code> implementation used by Spring Security can be done by exposing a <code>PasswordEncoder</code> Bean.</p>
<p>For example, as demonstrated in the section Basic Form Authentication:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">(PasswordStorage passwordStorage)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> passwordStorage.getPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Authentication-with-Session"><a href="#Authentication-with-Session" class="headerlink" title="Authentication with Session"></a>Authentication with Session</h3><p>By default, sessions will be created by Spring Security for already authenticated users to access resources without authenticating again.</p>
<p>We can <strong>control exactly when our session gets created and how Spring Security will interact with it</strong>:</p>
<ul>
<li><strong><em>always</em></strong> – a session will always be created if one doesn’t already exist</li>
<li><strong><em>ifRequired</em></strong> – a session will be created only if required (<strong>default</strong>)</li>
<li><strong><em>never</em></strong> – the framework will never create a session itself but it will use one if it already exists</li>
<li><strong><em>stateless</em></strong> – no session will be created or used by Spring Security</li>
</ul>
<p>Java configuration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.sessionManagement()</span><br><span class="line">        .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It’s very important to understand that <strong>this configuration only controls what Spring Security does</strong> – not the entire application. Spring Security may not create the session if we instruct it not to, but our app may!</p>
<p>By default, <strong>Spring Security will create a session when it needs one</strong> – this is “<em>ifRequired</em>“.</p>
<p>For <strong>a more stateless application</strong>, the “<em>never</em>” option will ensure that Spring Security itself will not create any session; however, if the application creates one, then Spring Security will make use of it.</p>
<p>Finally, the strictest session creation option – “<em>stateless</em>” – is a <strong>guarantee that the application will not create any session at all</strong>.</p>
<h4 id="Session-Creation-Mechanism"><a href="#Session-Creation-Mechanism" class="headerlink" title="Session Creation Mechanism"></a>Session Creation Mechanism</h4><p>Before executing the Authentication process, Spring Security will run a filter responsible with storing the Security Context between requests – the <code>SecurityContextPersistenceFilter</code>. The context will be stored according to a strategy – <code>HttpSessionSecurityContextRepository</code> by default – which uses the HTTP Session as storage.</p>
<p>For the strict <em><code>create-session=”stateless”</code></em> attribute, this strategy will be replaced with another – <code>NullSecurityContextRepository</code> – and <strong>no session will be created or used</strong> to keep the context.</p>
<h4 id="Maximum-Session"><a href="#Maximum-Session" class="headerlink" title="Maximum Session"></a>Maximum Session</h4><p>You can control how many active sessions a user can have at a time.</p>
<p>When a user that <strong>is already authenticated</strong> tries to <strong>authenticate again</strong>, the application can deal with that event in one of a few ways. It can either invalidate the active session of the user and authenticate the user again with a new session, or allow both sessions to exist concurrently.</p>
<hr>
<p><strong>In summary</strong>, to configure how many concurrent sessions a user can have, you need to:</p>
<ol>
<li>Inject a bean with <code>HttpSessionEventPublisher</code><ul>
<li>This will notify Spring Security session registry when a session is destroyed</li>
</ul>
</li>
<li>Use the <code>configure()</code> method with <code>sessionManagement().maximumSession(&lt;number&gt;)</code></li>
</ol>
<hr>
<p>For example, extending the example from above sections:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                    .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">                    .anyRequest().authenticated()</span><br><span class="line">                    .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                    .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">                    .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                    .defaultSuccessUrl(<span class="string">"/"</span>, <span class="keyword">true</span>)</span><br><span class="line">                    .failureUrl(<span class="string">"/login?error=true"</span>)</span><br><span class="line">                    .and()</span><br><span class="line">                .logout()</span><br><span class="line">                    .logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                    .logoutSuccessUrl(<span class="string">"/login?logout=true"</span>).deleteCookies(<span class="string">"JSESSIONID"</span>)</span><br><span class="line">                    .permitAll()</span><br><span class="line">                    .and()</span><br><span class="line">                .httpBasic()</span><br><span class="line">                    .and()</span><br><span class="line">                .sessionManagement()</span><br><span class="line">                    .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED) <span class="comment">// also the default</span></span><br><span class="line">                    .maximumSessions(<span class="number">1</span>)	<span class="comment">// allows only 1 session</span></span><br><span class="line">                    .maxSessionsPreventsLogin(<span class="keyword">true</span>)</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyUserDetailService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">(PasswordStorage passwordStorage)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passwordStorage.getPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpSessionEventPublisher <span class="title">httpSessionEventPublisher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionEventPublisher();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Session-Timeout"><a href="#Session-Timeout" class="headerlink" title="Session Timeout"></a>Session Timeout</h4><p>By default, a session is active for 15 minutes. After the session has timed out, if the user sends a request with an <strong>expired session id</strong>, they will be redirected to a URL configurable.</p>
<hr>
<p><strong>In summary,</strong> all you have to do is similar to the above:</p>
<ul>
<li>Use the <code>configure()</code> method and specify the expiration URL</li>
<li>Configure the timeout limit with <code>server.servlet.session.timeout</code></li>
</ul>
<hr>
<p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                    .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">                    .anyRequest().authenticated()</span><br><span class="line">                    .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                    .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">                    .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                    .defaultSuccessUrl(<span class="string">"/"</span>, <span class="keyword">true</span>)</span><br><span class="line">                    .failureUrl(<span class="string">"/login?error=true"</span>)</span><br><span class="line">                    .and()</span><br><span class="line">                .logout()</span><br><span class="line">                    .logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">                    .logoutSuccessUrl(<span class="string">"/login?logout=true"</span>).deleteCookies(<span class="string">"JSESSIONID"</span>)</span><br><span class="line">                    .permitAll()</span><br><span class="line">                    .and()</span><br><span class="line">                .httpBasic()</span><br><span class="line">                    .and()</span><br><span class="line">                .sessionManagement()</span><br><span class="line">                    .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED) <span class="comment">// also the default</span></span><br><span class="line">                    .maximumSessions(<span class="number">1</span>)</span><br><span class="line">                    .expiredUrl(<span class="string">"/login?expired=true"</span>)	<span class="comment">// redirect</span></span><br><span class="line">                    .maxSessionsPreventsLogin(<span class="keyword">true</span>)</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyUserDetailService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">(PasswordStorage passwordStorage)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passwordStorage.getPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpSessionEventPublisher <span class="title">httpSessionEventPublisher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionEventPublisher();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then, if you want to change the session timeout period, you can do so:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">session:</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="number">1</span>  <span class="comment"># session time out in minute</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> Since Spring Boot uses Tomcat, we have to keep in mind that <strong>it only supports minute precision for session timeout</strong>, <strong>with a minimum of one minute</strong>. This means that if we specify a timeout value of <em>170s</em> for example, it will result in a 2 minutes timeout.</li>
</ul>
</blockquote>
<h4 id="Session-Tracking"><a href="#Session-Tracking" class="headerlink" title="Session Tracking"></a>Session Tracking</h4><p>When a user gets authenticated, <strong>a session with  <em>JSESSIONID</em> is created.</strong></p>
<p>You can either store your session inside a cookie, or inside your URL parameter when you submit a request.</p>
<p><strong>In general, it is safer to store it inside a cookie</strong>, which also allows additionally security parameters such as:</p>
<ul>
<li><em>httpOnly:</em> if true then browser script won’t be able to access the cookie</li>
<li><em>secure:</em> if true then the cookie will be sent only over HTTPS connection</li>
</ul>
<hr>
<p><strong>In summary</strong>, to configure this, you need to:</p>
<ol>
<li>Obtain the <code>servletContext</code> and call <code>setSessionTrakcingModes()</code></li>
<li>Specify the properties to configure cookie security options:<ul>
<li><code>server.servlet.session.cookie.http-only=true</code></li>
<li><code>server.servlet.session.cookie.secure=true</code></li>
</ul>
</li>
</ol>
<hr>
<p>For example, to set the session tracking to cookie, you need to:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servletContext.setSessionTrackingModes(EnumSet.of(SessionTrackingMode.COOKIE));</span><br></pre></td></tr></table></figure>

<p>and then:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.servlet.session.cookie.http-only</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.secure</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p><strong>The above configuration for cookie security is also the default configuration</strong>.</p>
<h4 id="Session-Fixation"><a href="#Session-Fixation" class="headerlink" title="Session Fixation"></a>Session Fixation</h4><p>The framework offers protection against typical Session Fixation attacks by <strong>configuring what happens to an existing session when the user tries to authenticate again.</strong></p>
<p><strong>By default, Spring Security has this protection enabled (“<em>migrateSession</em>“)</strong> – on authentication a new HTTP Session is created, the old one is invalidated and the attributes from the old session are copied over.</p>
<p>If this is not the desired behavior, two other options are available:</p>
<ul>
<li>when “<em>none</em>” is set, the original session will not be invalidated</li>
<li>when “<em>newSession</em>” is set, a clean session will be created without any of the attributes from the old session being copied over</li>
</ul>
<hr>
<p><strong>In summary,</strong> to configure the above is trivial:</p>
<ul>
<li>Use the <code>configure()</code> method and specify the option <code>sessionFixation()</code> with the desired strategy</li>
</ul>
<hr>
<p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement()</span><br><span class="line">  .sessionFixation().migrateSession()</span><br></pre></td></tr></table></figure>

<h3 id="Remember-Me"><a href="#Remember-Me" class="headerlink" title="Remember Me"></a>Remember Me</h3><p>Remember-me is basically a mechanism to remember login details <strong>between browser sessions</strong>, namely, <strong>refreshing the session as long as the remember-me status has not expired</strong>.</p>
<p>In general, there are two ways that remember-me functionality can be easily integrated with Spring Security + Spring Boot:</p>
<ol>
<li>Using a <code>remember-me</code> cookie<ul>
<li>This, as you will see in the <a href="#Remember-Me---Cookie">Remember Me - Cookie</a> section, is very easy to implement as Spring Security has done most of them for you</li>
<li>However, this has security issues. Since it is a cookie that the server uses to refresh/regenerate session, <strong>a malicious user can use this cookie to access authenticated content easily as well</strong></li>
</ul>
</li>
<li>Using data from a database to store <code>remember-me</code> information<ul>
<li>This is harder to setup, yet it is a more secure way for using <code>remember-me</code></li>
</ul>
</li>
</ol>
<h4 id="Remember-Me-Cookie"><a href="#Remember-Me-Cookie" class="headerlink" title="Remember Me - Cookie"></a>Remember Me - Cookie</h4><hr>
<p><strong>In summary,</strong> all you need to do is:</p>
<ol>
<li>Use the <code>configure()</code> method to configure <code>rememberMe()</code></li>
<li>Add a checkbox with <code>name=remember-me</code> specified<ul>
<li>The parameter name <code>remember-me</code> can also be configured in the first step</li>
</ul>
</li>
</ol>
<hr>
<p>For example, your can have:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .rememberMe()</span><br><span class="line">                    .key(<span class="string">"Test-Key"</span>)</span><br><span class="line">                    .rememberMeParameter(<span class="string">"remember-me1"</span>)</span><br><span class="line">                    .tokenValiditySeconds(<span class="number">600</span>);  <span class="comment">// when this will expire</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// extending from the code above</span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then your html code could look like:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">'f'</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">'POST'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>User:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'text'</span> <span class="attr">name</span>=<span class="string">'username'</span> <span class="attr">value</span>=<span class="string">''</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>Password:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'password'</span> <span class="attr">name</span>=<span class="string">'password'</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>Remember Me:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Notice that the parameter here has to match the rememberMeParamter() specified above --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember-me1"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"_csrf"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;_csrf&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>As a result, your login POST request will look like:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test&amp;password=12345&amp;remember-me1=on&amp;submit=submit&amp;_csrf=72befc82-f007-4890-ac64-0d707d3de1fd</span><br></pre></td></tr></table></figure>

<p>Now, if you logged in correctly, you will get two cookies, the <strong>session</strong> cookie and the <strong>remember-me</strong> cookie.</p>
<p>However, the <strong>Remember Me cookie</strong> contains the following data:</p>
<ul>
<li><strong><em>username</em></strong> – to identify the logged in principal</li>
<li><strong><em>expirationTime</em></strong> – to expire the cookie; default is 2 weeks</li>
<li><strong>MD5 hash</strong> – of the previous 2 values – <em>username</em> and <em>expirationTime</em>, plus the <em>password</em> and the predefined <em>key</em></li>
</ul>
<p>First thing to notice here is that <strong>both the <em>username</em> and the <em>password</em> are part of the cookie</strong> – this means that, <strong>if either is changed, the cookie is no longer valid</strong>. Also, the <em>username</em> can be read from the cookie.</p>
<p>Additionally, it is important to understand that this mechanism is potentially vulnerable if the remember me cookie is captured. <strong>The cookie will be valid and usable</strong> until it expires or the credentials are changed.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> While the above is easy to implement, once the remember-me token gets leaked, other malicious users can easily log-in to your account. <strong>If you need one with a stronger security, please see the section below</strong>, which essentially uses a database.</li>
</ul>
</blockquote>
<h4 id="Remember-Me-Persistence"><a href="#Remember-Me-Persistence" class="headerlink" title="Remember Me - Persistence"></a>Remember Me - Persistence</h4><p>This seems only possible with XML based configuration, as one key step includes setting:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">http</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">remember-me</span> <span class="attr">data-source-ref</span>=<span class="string">"someDataSource"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">http</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>And I could not find the API in <code>RememberMeConfigurer</code> that configures the data source. I might be wrong at this, but if you are fine with using XML based configurations, please continue with: <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#remember-me-persistent-token" target="_blank" rel="noopener">https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#remember-me-persistent-token</a>.</p>
<h3 id="Prevent-Brute-Force-Authentication"><a href="#Prevent-Brute-Force-Authentication" class="headerlink" title="Prevent Brute Force Authentication"></a>Prevent Brute Force Authentication</h3><p>A brute force authentication include <strong>trying each possible username/password combination until a correct one hits</strong>.</p>
<p>In this section, such prevention is implemented by <strong>keeping a record of the number of failed attempts originating from a single IP address</strong>. If that particular IP goes over a set number of requests – it will be blocked for 5 minutes (you can of course customize this).</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> Other ways include directly blocking that account based on the username. However, this can cause issues such as a user accidentally blocking another user’s account unintentionally. In this section, we choose the approach to block that specific IP address, allowing the actual user (hopefully) being unaffected from such accidents.</li>
</ul>
</blockquote>
<hr>
<p><strong>In summary</strong>, all you need to do is:</p>
<ol>
<li>Create <code>AuthenticationSuccessListener</code> and <code>AuthenticationFailureListener</code>s to listen for the authentication event<ul>
<li>The two listeners of course implements their corresponding event listener interfaces. Check the examples below.</li>
</ul>
</li>
<li>Create a <code>LoginAttemptService</code>, which connects to your <code>redis</code> to read/update/delete login attemps information based on IP address</li>
<li>Update the <code>isAccountNonBlocked()</code> method in your <code>UserDetailsImpl</code> class based on the login attemps</li>
</ol>
<hr>
<p>For example, your two listeners look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationFailureListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">AuthenticationFailureBadCredentialsEvent</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginAttemptService loginAttemptService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *<span class="doctag">@param</span> authenticationFailureBadCredentialsEvent used to fetch the IP address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(AuthenticationFailureBadCredentialsEvent authenticationFailureBadCredentialsEvent)</span> </span>&#123;</span><br><span class="line">        WebAuthenticationDetails auth = (WebAuthenticationDetails)authenticationFailureBadCredentialsEvent.getAuthentication().getDetails();</span><br><span class="line">        loginAttemptService.loginFailed(auth.getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationSuccessListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">AuthenticationSuccessEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginAttemptService loginAttemptService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(AuthenticationSuccessEvent e)</span> </span>&#123;</span><br><span class="line">        WebAuthenticationDetails auth = (WebAuthenticationDetails)</span><br><span class="line">                e.getAuthentication().getDetails();</span><br><span class="line"></span><br><span class="line">        loginAttemptService.loginSucceeded(auth.getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above two will be executed once the corresponding event is captured, and they evoke the corresponding methods in <code>LoginAttemptService</code>.</p>
<p>Now, you need to implement your <code>loginAttemptService</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Used to provide API checking current login attempts and block status</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginAttemptService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ATTEMPT = <span class="number">5</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginAttemptService</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Deletes the redis entry if login is successful (redis returns 0 even if the key does not exist)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address Client's IP address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loginSucceeded</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().getOperations().delete(address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If login fails, increase the number of attempts tried</span></span><br><span class="line"><span class="comment">     * If it is the MAX_ATTEMPT number of times, sets the expiration time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address Client's IP address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loginFailed</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().increment(address);</span><br><span class="line">        <span class="keyword">if</span>(Integer.parseInt(redisTemplate.opsForValue().get(address)) == MAX_ATTEMPT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (redisTemplate.opsForValue().getOperations().getExpire(address) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.opsForValue().getOperations().expire(address, <span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if a specific address is blocked for logins. This is configured to block for 5 minutes</span></span><br><span class="line"><span class="comment">     * Try block is necessary because, the Authentication procedure is:</span></span><br><span class="line"><span class="comment">     *  1. Look at isBlocked from UserDetails</span></span><br><span class="line"><span class="comment">     *      1. If blocked, then login fails</span></span><br><span class="line"><span class="comment">     *      2. If not, proceed</span></span><br><span class="line"><span class="comment">     *  2. Proceed to check login credentials</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address the client's IP address</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> whether if the IP address is blocked for all logins</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBlocked</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(Integer.parseInt(redisTemplate.opsForValue().get(address)) &gt;= MAX_ATTEMPT)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(NumberFormatException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This could be useful for frontend to know</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address client's IP address</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Number of attempts left</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">remainingAttempts</span><span class="params">(String address)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> attempts = Integer.parseInt(redisTemplate.opsForValue().get(address));</span><br><span class="line">            <span class="keyword">return</span> MAX_ATTEMPT - attempts;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(NumberFormatException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> MAX_ATTEMPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Of course, the above assumes a redis connection configured in your <code>application.yml</code>.</p>
<p>Lastly, you can update your <code>UserDetailsImpl</code> to reflect the blocking status:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsImpl</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    HttpServletRequest request;</span><br><span class="line">    LoginAttemptService loginAttemptService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this is to prevent NullPointerExceptions</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsImpl</span><span class="params">(String username, UserServiceImpl userService, LoginAttemptService loginAttemptService, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">        <span class="keyword">this</span>.loginAttemptService = loginAttemptService;</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determines whether if account is locked by wrong attempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if attempt &lt; 5; false if attempt &gt;= 5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ip = request.getRemoteAddr();</span><br><span class="line">        <span class="keyword">if</span> (loginAttemptService.isBlocked(ip)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userService.getUserPassword(<span class="keyword">this</span>.username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Authentication-with-Token"><a href="#Authentication-with-Token" class="headerlink" title="Authentication with Token"></a>Authentication with Token</h3><p>:)</p>
<h2 id="Authorization-Realizations"><a href="#Authorization-Realizations" class="headerlink" title="Authorization Realizations"></a>Authorization Realizations</h2><p>While authentication means making sure whether if a user is a legally registered user in your application, <strong>authorization deals with granting that legally registered user the ability to access certain resources/services in your application</strong>.</p>
<p>Some common authorization model includes Role Based Authorization Control and Resource Based Authorization Control. While Role Based Authorization Control might be more straightforward to think of in real life (e.g. a student can visit student residential halls, while a teacher can visit both student and teacher’s residential halls), <strong>which filters authorization based on who is accessing</strong>, it is generally easier to implement access control with Resource Based Authorization Control, <strong>which filters authorization based on what is being accessed</strong>.</p>
<p>The following sections all cover the approach of using Resource Based Authorization Control.</p>
<h3 id="Basic-Authorization-using-SimpleGrantedAuthority"><a href="#Basic-Authorization-using-SimpleGrantedAuthority" class="headerlink" title="Basic Authorization using SimpleGrantedAuthority"></a>Basic Authorization using <code>SimpleGrantedAuthority</code></h3><hr>
<p><strong>In summary</strong>, you need to:</p>
<ol>
<li>Add an additional <code>roles</code> column in your database for storing user informations<ul>
<li>You can also use a separate table, if you want</li>
</ul>
</li>
<li>Create/update your corresponding database mappers, <code>UserDetailsImpl</code>, and <code>UserDetailsService</code><ul>
<li>Specifically, implement the <code>getAuthorities()</code> method in the <code>UserDetailsImpl</code></li>
</ul>
</li>
<li>Update your <code>config()</code> method with <code>antMatcher().hasAuthority()</code> to specify which resource is available to which authority<ul>
<li>More advance matching include using <code>access(&lt;SpEL&gt;)</code>, and of course <code>hasAuthority</code> can be included in that <code>&lt;SpEL&gt;</code></li>
<li>For more details on those <code>SpEL</code>, please visit <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#el-access" target="_blank" rel="noopener">https://docs.spring.io/spring-security/site/docs/current/reference/html5/#el-access</a></li>
</ul>
</li>
</ol>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> In the text above (and in the following sections), you can assume that role has a synonymous meaning as an authority, i.e. a <code>role=admin</code> has a corresponding <code>ROLE_ADMIN</code> authority.</li>
</ul>
</blockquote>
<hr>
<p>For example, your updated database should look like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id	name	password	roles</span><br><span class="line">1	test	&#123;bcrypt&#125;$2a$10$WI2BDuq7V2fzEEUhOasn.2qXsfmkDMiV7f1XVmG1ZToZdilkR7Z8G	admin;user</span><br><span class="line">2	wkkk	&#123;bcrypt&#125;$2a$10$gHDDT.CVYbA9TqvlLA7TZuZGm1RrxeyVeNaby7x8KHHOGx&#x2F;N3efHm	user</span><br></pre></td></tr></table></figure>

<p>and your mechanism for fetching the roles from the database could be:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;SimpleGrantedAuthority&gt; <span class="title">getAuthorities</span><span class="params">(String username)</span></span>&#123;</span><br><span class="line">    String roles;</span><br><span class="line">    <span class="comment">// the mapper implementation is trivial, so it is not shown here</span></span><br><span class="line">    <span class="keyword">if</span>((roles = getUserMapper().getRoles(username)) == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"User "</span>+username+<span class="string">" not found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(String role: roles.split(<span class="string">";"</span>))&#123;	<span class="comment">// you can change this seperator of course</span></span><br><span class="line">        authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(role));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> authorities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, <strong>importantly,</strong> you update your <code>UserDetailsImpl</code> class, as this is the class that Spring Security uses to get data about a user:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.testspringsecurity.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.testspringsecurity.service.LoginAttemptService;</span><br><span class="line"><span class="keyword">import</span> com.example.testspringsecurity.service.UserServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.security.auth.login.AccountLockedException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsImpl</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    HttpServletRequest request;</span><br><span class="line">    LoginAttemptService loginAttemptService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsImpl</span><span class="params">(String username, UserServiceImpl userService, LoginAttemptService loginAttemptService, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">        <span class="keyword">this</span>.loginAttemptService = loginAttemptService;</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gets the authorities by username</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userService.getAuthorities(<span class="keyword">this</span>.username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determines whether if account is locked by wrong attempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if attempt &lt; 5; false if attempt &gt;= 5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ip = request.getRemoteAddr();</span><br><span class="line">        <span class="keyword">if</span> (loginAttemptService.isBlocked(ip)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userService.getUserPassword(<span class="keyword">this</span>.username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lastly, you customize which resource is limited to which role within the <code>configure()</code> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">        .antMatchers(<span class="string">"/api/*"</span>).hasAuthority(<span class="string">"admin"</span>)	<span class="comment">// if you use hasRole(), it will automatically insert ROLE_ prefix</span></span><br><span class="line">        .antMatchers(<span class="string">"/resource*"</span>).hasAuthority(<span class="string">"user"</span>)</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        <span class="comment">// other configurations</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Authorization-Mechanism"><a href="#Authorization-Mechanism" class="headerlink" title="Authorization Mechanism"></a>Authorization Mechanism</h3><h4 id="Authority-GrantedAuthority"><a href="#Authority-GrantedAuthority" class="headerlink" title="Authority/GrantedAuthority"></a>Authority/<code>GrantedAuthority</code></h4><p><a href="#authentication-realizations"><code>Authentication</code></a>, discusses how all <strong><code>Authentication</code></strong> implementations <strong>store a list of <code>GrantedAuthority</code> objects</strong>. These represent the authorities that have been granted to the principal. Those <code>GrantedAuthority</code> objects are inserted into the <code>Authentication</code> object by the <code>AuthenticationManager</code> and <strong>are later read by <code>AccessDecisionManager</code> s when making authorization decisions</strong>.</p>
<p><code>GrantedAuthority</code> is an interface with only one method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">getAuthority</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>This method allows <code>AccessDecisionManager</code> s to obtain a precise <code>String</code> representation of the <code>GrantedAuthority</code>. <strong>By returning a representation as a <code>String</code>, a <code>GrantedAuthority</code> can be easily “read” by most <code>AccessDecisionManager</code> s</strong>. <strong>If a <code>GrantedAuthority</code> cannot be precisely represented as a <code>String</code>, the <code>GrantedAuthority</code> is considered “complex” and <code>getAuthority()</code> must return <code>null</code></strong>.</p>
<ul>
<li>An example of a “complex” <code>GrantedAuthority</code> would be an implementation that <strong>stores a list of operations and authority thresholds that apply to different customer account numbers</strong>. Representing this complex <code>GrantedAuthority</code> as a <code>String</code> would be quite difficult, and as a result the <code>getAuthority()</code> method should return <code>null</code>. This will indicate to any <code>AccessDecisionManager</code> that it will need to specifically support the <code>GrantedAuthority</code> implementation in order to understand its contents.</li>
</ul>
<p><strong>Spring Security includes one concrete <code>GrantedAuthority</code> implementation, <code>SimpleGrantedAuthority</code></strong>. This <strong>allows any user-specified <code>String</code> to be converted into a <code>GrantedAuthority</code></strong>. <strong>All <code>AuthenticationProvider</code> s</strong> included with the security architecture <strong>use <code>SimpleGrantedAuthority</code> to populate the <code>Authentication</code> object.</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong>authorities are stored in objects implementing <code>GrantedAuthority</code>, and an <code>AccessDecisionManager</code> decide, by reading from the <code>GrantedAuthority</code>, whether a request can be accessed by a user.</strong></li>
</ul>
<h4 id="Pre-Invocation-Handling"><a href="#Pre-Invocation-Handling" class="headerlink" title="Pre-Invocation Handling"></a>Pre-Invocation Handling</h4><p>In short, Spring Security deals with access decision by having pre-invocation handling mechanism (determines whether if a resource can be accessed) and a post-invocation handling mechanism (whether if and how a resource should be altered before giving to the user).</p>
<h5 id="AccessDecisionManager"><a href="#AccessDecisionManager" class="headerlink" title="AccessDecisionManager"></a><code>AccessDecisionManager</code></h5><p>Spring Security provides <strong>interceptors which control access to secure objects such as method invocations or web requests</strong>. A pre-invocation decision on whether the invocation is allowed to proceed is made by the <code>AccessDecisionManager</code>.</p>
<p><strong>The <code>AccessDecisionManager</code> is called by the <code>AbstractSecurityInterceptor</code> and is responsible for making final access control decisions</strong>. The <code>AccessDecisionManager</code> interface contains three methods:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object secureObject,</span></span></span><br><span class="line"><span class="function"><span class="params">    Collection&lt;ConfigAttribute&gt; attrs)</span> <span class="keyword">throws</span> AccessDeniedException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class clazz)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>The <code>AccessDecisionManager</code>‘s <code>decide</code> method is passed all the relevant information it needs in order to make an authorization decision</strong>. In particular, passing the secure <code>Object</code> enables those arguments contained in the actual secure object invocation to be inspected. </p>
<ul>
<li>For example, let’s assume the secure object was a <code>MethodInvocation</code>. It would be easy to query the <code>MethodInvocation</code> for any <code>Customer</code> argument, and then implement some sort of security logic in the <code>AccessDecisionManager</code> to ensure the principal is permitted to operate on that customer. Implementations are expected to throw an <code>AccessDeniedException</code> if access is denied.</li>
</ul>
<p><strong>The <code>supports(ConfigAttribute)</code> method is called</strong> by the <code>AbstractSecurityInterceptor</code> <strong>at startup time to determine if the <code>AccessDecisionManager</code> can process the passed <code>ConfigAttribute</code></strong>. The <code>supports(Class)</code> method is called by a security interceptor implementation to ensure the configured <code>AccessDecisionManager</code> supports the type of secure object that the security interceptor will present.</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong>this is where the access decision actually takes place.</strong></li>
</ul>
<h5 id="Voting-Based-AccessDecisionManager"><a href="#Voting-Based-AccessDecisionManager" class="headerlink" title="Voting-Based AccessDecisionManager"></a>Voting-Based <code>AccessDecisionManager</code></h5><p>Whilst users can implement their own <code>AccessDecisionManager</code> to control all aspects of authorization, Spring Security includes several <code>AccessDecisionManager</code> implementations that are based on voting. <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#authz-access-voting" target="_blank" rel="noopener">Voting Decision Manager</a> illustrates the relevant classes.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/access-decision-voting.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/access-decision-voting.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/access-decision-voting.png"></p>
<p>Using this approach, <strong>a series of <code>AccessDecisionVoter</code> implementations are polled on an authorization decision</strong>. The <code>AccessDecisionManager</code> then decides whether or not to throw an <code>AccessDeniedException</code> based on its assessment of the votes.</p>
<p>The <code>AccessDecisionVoter</code> interface has three methods:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attrs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class clazz)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Concrete implementations return an <code>int</code>, with possible values being reflected in the <code>AccessDecisionVoter</code> <strong>static fields <code>ACCESS_ABSTAIN</code>, <code>ACCESS_DENIED</code> and <code>ACCESS_GRANTED</code></strong>. A voting implementation will <strong>return <code>ACCESS_ABSTAIN</code> if it has no opinion on an authorization decision</strong>. If it does have an opinion, it must return either <code>ACCESS_DENIED</code> or <code>ACCESS_GRANTED</code>.</p>
<p>There are <strong>three concrete <code>AccessDecisionManager</code> s provided with Spring Security that tally the votes</strong>. </p>
<ul>
<li>The <code>ConsensusBased</code> (<code>AccessDecisionManager</code>) implementation will grant or deny access based on the consensus of non-abstain votes. Properties are provided to control behavior in the event of an equality of votes or if all votes are abstain. </li>
<li>The <code>AffirmativeBased</code> implementation will grant access if one or more <code>ACCESS_GRANTED</code> votes were received (i.e. a deny vote will be ignored, provided there was at least one grant vote). Like the <code>ConsensusBased</code> implementation, there is a parameter that controls the behavior if all voters abstain. </li>
<li>The <code>UnanimousBased</code> provider expects unanimous <code>ACCESS_GRANTED</code> votes in order to grant access, ignoring abstains. It will deny access if there is any <code>ACCESS_DENIED</code> vote. Like the other implementations, there is a parameter that controls the behavior if all voters abstain.</li>
</ul>
<p><strong>It is possible to implement a custom <code>AccessDecisionManager</code> that tallies votes differently</strong>. For example, votes from a particular <code>AccessDecisionVoter</code> might receive additional weighting, whilst a deny vote from a particular voter may have a veto effect.</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong><em>In one sentence,</em></strong> <strong>some Spring Security implemented <code>AccessDecisionManager</code> uses a voting system, which tally integer vote results from a group of <code>Voters</code>, and decide whether if to throw <code>AccessDeniedException</code>.</strong></li>
</ul>
<h6 id="RoleVoter"><a href="#RoleVoter" class="headerlink" title="RoleVoter"></a><code>RoleVoter</code></h6><p>The most commonly used <code>AccessDecisionVoter</code> provided with Spring Security is the simple <code>RoleVoter</code>, which treats configuration attributes as simple role names and votes to grant access if the user has been assigned that role.</p>
<p><strong>It will vote if any <code>ConfigAttribute</code> begins with the prefix <code>ROLE_</code></strong> (see code snippet below). <strong>It will vote to grant access if there is a <code>GrantedAuthority</code> which returns a <code>String</code> representation (via the <code>getAuthority()</code> method) exactly equal to one or more <code>ConfigAttributes</code> starting with the prefix <code>ROLE_</code></strong>. If there is no exact match of any <code>ConfigAttribute</code> starting with <code>ROLE_</code>, the <code>RoleVoter</code> will vote to deny access. If no <code>ConfigAttribute</code> begins with <code>ROLE_</code>, the voter will abstain.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleVoter</span> <span class="keyword">implements</span> <span class="title">AccessDecisionVoter</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String rolePrefix = <span class="string">"ROLE_"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoleVoter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRolePrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.rolePrefix;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="AuthenticatedVoter"><a href="#AuthenticatedVoter" class="headerlink" title="AuthenticatedVoter"></a><code>AuthenticatedVoter</code></h6><p>Another voter which we’ve implicitly seen is the <code>AuthenticatedVoter</code>, which can be used to <strong>differentiate between anonymous, fully-authenticated and remember-me authenticated users</strong>. Many sites allow certain limited access under remember-me authentication, but require a user to confirm their identity by logging in for full access.</p>
<p>When we’ve used the attribute <code>IS_AUTHENTICATED_ANONYMOUSLY</code> to grant anonymous access, this attribute was being processed by the <code>AuthenticatedVoter</code>. See the Javadoc for this class for more information.</p>
<h6 id="Custom-Voters"><a href="#Custom-Voters" class="headerlink" title="Custom Voters"></a>Custom Voters</h6><p>Obviously, you can also implement a custom <code>AccessDecisionVoter</code> and you can put just about any access-control logic you want in it. It might be specific to your application (business-logic related) or it might implement some security administration logic. <strong>For example, you’ll find a <a href="https://spring.io/blog/2009/01/03/spring-security-customization-part-2-adjusting-secured-session-in-real-time" target="_blank" rel="noopener">blog article</a> on the Spring web site which describes how to use a voter to deny access in real-time to users whose accounts have been suspended</strong>.</p>
<h4 id="Post-Invocation-Handling"><a href="#Post-Invocation-Handling" class="headerlink" title="Post-Invocation Handling"></a>Post-Invocation Handling</h4><p>Whilst <strong>the <code>AccessDecisionManager</code> is called by the <code>AbstractSecurityInterceptor</code> before proceeding</strong> with the secure object invocation, some applications need a way of <strong>modifying the object actually returned by the secure object invocation</strong>. Whilst you could easily implement your own AOP concern to achieve this, Spring Security provides a convenient hook that has several concrete implementations that integrate with its ACL capabilities.</p>
<p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/after-invocation.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/after-invocation.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/after-invocation.png"></p>
<p>Like many other parts of Spring Security, <code>AfterInvocationManager</code> has a single concrete implementation, <code>AfterInvocationProviderManager</code>, <strong>which polls a list of <code>AfterInvocationProvider</code> s</strong>. Each <code>AfterInvocationProvider</code> is allowed to modify the return object or throw an <code>AccessDeniedException</code>. Indeed multiple providers can modify the object, as the result of the previous provider is passed to the next in the list.</p>
<p>Please be aware that if you’re using <code>AfterInvocationManager</code>, <strong>you will still need configuration attributes that allow the <code>MethodSecurityInterceptor</code>‘s <code>AccessDecisionManager</code> to allow an operation</strong>. If you’re using the typical Spring Security included <code>AccessDecisionManager</code> implementations, <strong>having no configuration attributes defined for a particular secure method invocation will cause each <code>AccessDecisionVoter</code> to abstain from voting</strong>. In turn, if the <code>AccessDecisionManager</code> property “<code>allowIfAllAbstainDecisions</code>” is <code>false</code>, an <code>AccessDeniedException</code> will be thrown. You may avoid this potential issue by either:</p>
<ul>
<li>setting “<code>allowIfAllAbstainDecisions</code>” to <code>true</code> (although this is generally not recommended) or</li>
<li>simply ensure that there is at least one configuration attribute that an <code>AccessDecisionVoter</code> will vote to grant access for. </li>
</ul>
<p>This latter (recommended) approach is usually achieved through a <code>ROLE_USER</code> or <code>ROLE_AUTHENTICATED</code> configuration attribute.</p>
<h4 id="Overall-Work-Flow"><a href="#Overall-Work-Flow" class="headerlink" title="Overall Work Flow"></a>Overall Work Flow</h4><p><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authorization/filtersecurityinterceptor.png" alt="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authorization/filtersecurityinterceptor.png" title="Image from https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/servlet/authorization/filtersecurityinterceptor.png"></p>
<ul>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_1.png" alt="number 1"> First, the <code>FilterSecurityInterceptor</code> obtains an Authentication from the <code>SecurityContextHolder</code>.</li>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_2.png" alt="number 2"> Second, <code>FilterSecurityInterceptor</code> creates a <code>FilterInvocation</code> from the <code>HttpServletRequest</code>, <code>HttpServletResponse</code>, and <code>FilterChain</code> that are passed into the <code>FilterSecurityInterceptor</code>.</li>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_3.png" alt="number 3"> Next, it passes the <code>FilterInvocation</code> to <code>SecurityMetadataSource</code> to get the <code>ConfigAttribute</code>s.</li>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_4.png" alt="number 4"> Finally, it passes the <code>Authentication</code>, <code>FilterInvocation</code>, and <code>ConfigAttribute</code>s to the <code>AccessDecisionManager</code>.<ul>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_5.png" alt="number 5"> If authorization is denied, an <code>AccessDeniedException</code> is thrown. In this case the <code>ExceptionTranslationFilter</code> handles the <code>AccessDeniedException</code>.</li>
<li><img src="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/images/icons/number_6.png" alt="number 6"> If access is granted, <code>FilterSecurityInterceptor</code> continues with the <a href="#A-review-of-filters">FilterChain</a> which allows the application to process normally.</li>
</ul>
</li>
</ul>
<p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        .authorizeRequests(authorize -&gt; authorize                                  </span><br><span class="line">            .mvcMatchers(<span class="string">"/resources/**"</span>, <span class="string">"/signup"</span>, <span class="string">"/about"</span>).permitAll()         </span><br><span class="line">            .mvcMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"ADMIN"</span>)                             </span><br><span class="line">            .mvcMatchers(<span class="string">"/db/**"</span>).access(<span class="string">"hasRole('ADMIN') and hasRole('DBA')"</span>)   </span><br><span class="line">            .anyRequest().denyAll()                                                </span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where</p>
<ul>
<li>Any URL that starts with “/admin/“ will be restricted to users who have the role “ROLE_ADMIN”. You will notice that <strong>since we are invoking the <code>hasRole</code> method we do not need to specify the “ROLE_” prefix</strong>.</li>
</ul>
<h3 id="Expression-Based-Access-Control"><a href="#Expression-Based-Access-Control" class="headerlink" title="Expression-Based Access Control"></a>Expression-Based Access Control</h3><p>In short, expression-based access control is built on the same architecture mentioned above but <strong>allows complicated Boolean logic to be encapsulated in a single expression</strong>.</p>
<h4 id="Common-Built-in-Expressions"><a href="#Common-Built-in-Expressions" class="headerlink" title="Common Built-in Expressions"></a>Common Built-in Expressions</h4><p><strong>Some</strong> of the common expressions used are:</p>
<table>
<thead>
<tr>
<th align="left">Expression</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>hasAuthority(String authority)</code></td>
<td align="left">Returns <code>true</code> if the current principal has the specified authority. For example, <code>hasAuthority(&#39;admin&#39;)</code></td>
</tr>
<tr>
<td align="left"><code>hasAnyAuthority(String… authorities)</code></td>
<td align="left">Returns <code>true</code> if the current principal has any of the supplied authorities (given as a comma-separated list of strings)For example, <code>hasAnyAuthority(&#39;admin&#39;, &#39;user&#39;)</code></td>
</tr>
<tr>
<td align="left"><code>principal</code></td>
<td align="left">Allows direct access to the principal object representing the current user</td>
</tr>
<tr>
<td align="left"><code>authentication</code></td>
<td align="left">Allows direct access to the current <code>Authentication</code> object obtained from the <code>SecurityContext</code></td>
</tr>
<tr>
<td align="left"><code>permitAll</code></td>
<td align="left">Always evaluates to <code>true</code></td>
</tr>
<tr>
<td align="left"><code>denyAll</code></td>
<td align="left">Always evaluates to <code>false</code></td>
</tr>
<tr>
<td align="left"><code>isAnonymous()</code></td>
<td align="left">Returns <code>true</code> if the current principal is an anonymous user</td>
</tr>
<tr>
<td align="left"><code>isRememberMe()</code></td>
<td align="left">Returns <code>true</code> if the current principal is a remember-me user</td>
</tr>
<tr>
<td align="left"><code>isAuthenticated()</code></td>
<td align="left">Returns <code>true</code> if the user is not anonymous</td>
</tr>
<tr>
<td align="left"><code>isFullyAuthenticated()</code></td>
<td align="left">Returns <code>true</code> if the user <strong>is not an anonymous or a remember-me user</strong></td>
</tr>
<tr>
<td align="left"><code>hasPermission(Object target, Object permission)</code></td>
<td align="left">Returns <code>true</code> if the user has access to the provided target for the given permission. For example, <code>hasPermission(domainObject, &#39;read&#39;)</code></td>
</tr>
<tr>
<td align="left"><code>hasPermission(Object targetId, String targetType, Object permission)</code></td>
<td align="left">Returns <code>true</code> if the user has access to the provided target for the given permission. For example, <code>hasPermission(1, &#39;com.example.domain.Message&#39;, &#39;read&#39;)</code></td>
</tr>
</tbody></table>
<p>Table from <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#el-common-built-in" target="_blank" rel="noopener">https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#el-common-built-in</a></p>
<p>An example usage would be:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">        .antMatchers(<span class="string">"/api/*"</span>).access(<span class="string">"isFullyAuthenticated() and hasAuthority('admin')"</span>)</span><br><span class="line">        .anyRequest().authenticated();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li>any request to <code>/api/*</code> will need an <code>admin</code> that is <code>fully authenticated</code> (not from a remember-me cookie)</li>
</ul>
<h4 id="Referring-to-Custom-Method-in-Web-Security-Expressions"><a href="#Referring-to-Custom-Method-in-Web-Security-Expressions" class="headerlink" title="Referring to Custom Method in Web Security Expressions"></a>Referring to Custom Method in Web Security Expressions</h4><p>If you want to customize your access logic entirely, you can do so as well!</p>
<hr>
<p><strong>In summary,</strong> this is achieved by:</p>
<ol>
<li>Creating a bean class, which contains a method that returns a <code>boolean</code>, determining whether if an access is permitted or not<ul>
<li>If that class is not injected as a bean, the <code>SpEL</code> cannot find that class in the expression</li>
</ul>
</li>
<li>Refer to that method with <code>@&lt;beanName&gt;.&lt;methodName()&gt;</code></li>
</ol>
<hr>
<p>For example, you can have:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">        .antMatchers(<span class="string">"/api/resource1*"</span>).access(<span class="string">"isFullyAuthenticated() and hasAuthority('admin')"</span>)</span><br><span class="line">        .antMatchers(<span class="string">"/api/resource2"</span>).access(<span class="string">"@myWebSecurity.checkResource2()"</span>)	<span class="comment">// notice here</span></span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then this is the <code>checkResouce2()</code> method inside the <code>MyWebSecurity</code> class</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> If the class has name <code>MyWebSecurity</code>, then the bean has name <code>myWebSecurity</code>, <strong>with the first letter being lower case.</strong></li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebSecurity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkResource2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Authentication authentication = <span class="keyword">this</span>.getAuthentication();</span><br><span class="line">        <span class="keyword">boolean</span> test = <span class="keyword">this</span>.request.isRequestedSessionIdFromCookie();</span><br><span class="line">        <span class="keyword">for</span>(GrantedAuthority authority: authentication.getAuthorities())&#123;</span><br><span class="line">            <span class="keyword">if</span>(authority.getAuthority().equals(<span class="string">"admin"</span>))&#123;	<span class="comment">// only allows admins</span></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    UserDetails userDetails = (UserDetails) authentication.getPrincipal();</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">this</span>.userService.getId(userDetails.getUsername()) == <span class="number">1</span>)&#123;	<span class="comment">// only allows admin with id=1</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Authentication <span class="title">getAuthentication</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SecurityContext context = SecurityContextHolder.getContext();</span><br><span class="line">        Authentication authentication = context.getAuthentication();</span><br><span class="line">        <span class="keyword">return</span> authentication;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above is just a simple example, yet it demonstrates the potential of customizing complex logics for access evaluation as well.</p>
<h5 id="Using-Path-Variable"><a href="#Using-Path-Variable" class="headerlink" title="Using Path Variable"></a>Using Path Variable</h5><p>Sometimes, it might be useful to retrieve parts of the <code>URL</code> to include in your access logic.</p>
<p>For example, consider a RESTful application that looks up a user by id from the URL path in the format <code>/user/{userId}</code>.</p>
<p>You can easily <strong>refer to the path variable by placing it in the pattern</strong>. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http</span><br><span class="line">    .authorizeRequests(authorize -&gt; authorize</span><br><span class="line">        .antMatchers(<span class="string">"/user/&#123;userId&#125;/**"</span>).access(<span class="string">"@webSecurity.checkUserId(#userId)"</span>)</span><br><span class="line">        ...</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>Then all you need to do is to change your <code>checkUserId()</code> method inside your <code>WebSecurity</code> class to take the input <code>userId</code>.</p>
<h4 id="Method-Based-Security-Expressions"><a href="#Method-Based-Security-Expressions" class="headerlink" title="Method Based Security Expressions"></a>Method Based Security Expressions</h4><p>While the above authorizes access based on <code>URL</code>, you can also configure access rights based on which methods will be executed.</p>
<p>In general, Spring Security has:</p>
<ul>
<li><code>@PreAuthorize</code></li>
<li><code>@PostAuthorize</code></li>
<li><code>@PreFilter</code></li>
<li><code>@PostFilter</code></li>
</ul>
<p>To use those annotations, you need to:</p>
<ol>
<li><p>Add the annotation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="comment">// enable the annotations listed above</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(</span><br><span class="line">        prePostEnabled = <span class="keyword">true</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"> 	...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Make sure the condition <strong>does not collide with your <code>config()</code> method inside the class above</strong> (in which the access logics specified in the <code>config()</code> will take precedence)</p>
</li>
</ol>
<h5 id="Using-PreAuthorize-and-PostAuthorize"><a href="#Using-PreAuthorize-and-PostAuthorize" class="headerlink" title="Using @PreAuthorize and @PostAuthorize"></a>Using <code>@PreAuthorize</code> and <code>@PostAuthorize</code></h5><p>The most obviously useful annotation is <code>@PreAuthorize</code> which <strong>decides whether a method can actually be invoked or not</strong>. For example (from the”Contacts” sample application)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('USER')"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(Contact contact)</span></span>;</span><br></pre></td></tr></table></figure>

<p>which means that access will only be allowed for users with the role “ROLE_USER”. Obviously the same thing could easily be achieved using a traditional configuration and a simple configuration attribute for the required role. But what about:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasPermission(#contact, 'admin')"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deletePermission</span><span class="params">(Contact contact, Sid recipient, Permission permission)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Here we’re actually using a method argument as part of the expression to decide whether the current user has the “admin”permission for the given contact. In this way, <strong>you can access any of the method arguments by name as expression variables</strong>.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> <p>The built-in <code>hasPermission()</code> expression is linked into the Spring Security ACL module through the application context, as we’ll in the section <a href="#The-PermissionEvaluator-interface/hasPermission()">The <code>PermissionEvaluator</code> interface/<code>hasPermission()</code></a></p>
</li>
<li><input disabled="" type="checkbox"> <p>Those annotation <strong>will not work if you have already specified access rules with the <code>config()</code> method</strong>. For example, if a request has passed through the conditions you listed:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>,<span class="string">"/login*"</span>).permitAll()</span><br><span class="line">        .antMatchers(<span class="string">"/api/resource1*"</span>).access(<span class="string">"isFullyAuthenticated() and hasAuthority('admin')"</span>)</span><br><span class="line">        .antMatchers(<span class="string">"/api/resource2"</span>).access(<span class="string">"@myWebSecurity.checkResource2()"</span>)</span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And you used a <code>@PreAuthorize()</code> on a request that has already passed through, it will execute regardless of your <code>@PreAuthorize</code> condition.</p>
</li>
</ul>
</blockquote>
<p>As the actual parameter is being automatically resolved by Spring Security, you can also designate those parameters to reduce accidental conflicts:</p>
<ul>
<li><p>You can use the Spring Security <code>@P</code> annotation on an argument</p>
<ul>
<li><p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"#c.name == authentication.name"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(@P(<span class="string">"c"</span>)</span> Contact contact)</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>You can also use the Spring Data <code>@Param</code> annotation on an argument</p>
<ul>
<li><p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"#n == authentication.name"</span>)</span><br><span class="line"><span class="function">Contact <span class="title">findContactByName</span><span class="params">(@Param(<span class="string">"n"</span>)</span> String name)</span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p>Less commonly, you may wish to perform an <strong>access-control check after the method has been invoked. This can be achieved using the <code>@PostAuthorize</code> annotation</strong>. To <strong>access the return value from a method, use the built-in name <code>returnObject</code> in the expression</strong>.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>If the condition evaluated to <code>false</code></strong> in the <code>@PreAuthorize()</code>, you will <strong>get a <code>AccessDeniedException</code> thrown, which you have to handle by yourself.</strong></li>
</ul>
</blockquote>
<h5 id="Using-PreFilter-and-PostFilter"><a href="#Using-PreFilter-and-PostFilter" class="headerlink" title="Using @PreFilter and @PostFilter"></a>Using <code>@PreFilter</code> and <code>@PostFilter</code></h5><p>As you may already be aware, Spring Security supports <strong>filtering of collections and arrays and this can now be achieved using expressions</strong>. This is most commonly performed <strong>on the return value of a method</strong>. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasAuthority('USER')"</span>)</span><br><span class="line"><span class="meta">@PostFilter</span>(<span class="string">"hasPermission(filterObject, 'read') or hasPermission(filterObject, 'admin')"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Contact&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li>The name <strong><code>filterObject</code> refers to the current object in the collection</strong>.</li>
</ul>
<p>When using the <code>@PostFilter</code> annotation, Spring Security <strong>iterates through the returned collection and removes any elements for which the supplied expression is false</strong>. </p>
<p>Technically, you can also <strong>filter before the method call (i.e. filtering the arguments)</strong>, using <code>@PreFilter</code>, though this is a less common requirement. The syntax is just the same, but <strong>if there is more than one argument which is a collection type then you have to select one by name using the <code>filterTarget</code> property of this annotation</strong>.</p>
<ul>
<li><p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreFilter</span>(value = <span class="string">"filterObject != authentication.principal.username"</span>,</span><br><span class="line">  filterTarget = <span class="string">"usernames"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">joinUsernamesAndRoles</span><span class="params">(List&lt;String&gt; usernames, List&lt;String&gt; roles)</span> </span>&#123;</span><br><span class="line"> 	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>Note that filtering is obviously not a substitute for tuning your data retrieval queries. If you are filtering large collections and removing many of the entries then this is likely to be inefficient.</p>
<h5 id="The-PermissionEvaluator-interface-hasPermission"><a href="#The-PermissionEvaluator-interface-hasPermission" class="headerlink" title="The PermissionEvaluator interface/hasPermission()"></a>The <code>PermissionEvaluator</code> interface/<code>hasPermission()</code></h5><p><code>hasPermission()</code> expressions are delegated to an instance of <code>PermissionEvaluator</code>. It is intended to <strong>bridge between the expression system and Spring Security’s ACL system, allowing you to specify authorization constraints on domain objects, based on abstract permissions</strong>. It has no explicit dependencies on the ACL module, so you could swap that out for an alternative implementation if required. The interface has two methods:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Object targetDomainObject,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Object permission)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Serializable targetId,</span></span></span><br><span class="line"><span class="function"><span class="params">                            String targetType, Object permission)</span></span>;</span><br></pre></td></tr></table></figure>

<p>which map directly to the available versions of the expression, with the exception that the first argument (the <code>Authentication</code> object) is not supplied. </p>
<ul>
<li>The first is used in situations where the domain object, to which access is being controlled, is already loaded. Then expression will return true if the current user has the given permission for that object. </li>
<li>The second version is used in cases where the object is not loaded, but its identifier is known. An abstract “type” specifier for the domain object is also required, allowing the correct ACL permissions to be loaded. This has traditionally been the Java class of the object, but does not have to be as long as it is consistent with how the permissions are loaded.</li>
</ul>
<p><strong>To use <code>hasPermission()</code> expressions, you have to explicitly configure a <code>PermissionEvaluator</code> in your application context</strong>. This would look something like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DefaultMethodSecurityExpressionHandler <span class="title">expressionHandler</span><span class="params">(PermissionEvaluator myPermissionEvaluator)</span></span>&#123;</span><br><span class="line">    DefaultMethodSecurityExpressionHandler handler = <span class="keyword">new</span> DefaultMethodSecurityExpressionHandler();</span><br><span class="line">    handler.setPermissionEvaluator(myPermissionEvaluator);</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Where <code>myPermissionEvaluator</code> is the bean which implements <code>PermissionEvaluator</code>. Usually this will be the implementation from the ACL module which is called <code>AclPermissionEvaluator</code></strong>. See the “Contacts” sample application configuration for more details.</p>
<h5 id="Using-Secure"><a href="#Using-Secure" class="headerlink" title="Using @Secure"></a>Using <code>@Secure</code></h5><p>This is basically a shortcut of using <code>@PreAuthorize()</code>, if the conditions are simple.</p>
<p>Alike using <code>@PreAuthorize()</code>/<code>@PreFilter</code>/…, you need to enable the global method security with:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(</span><br><span class="line">        prePostEnabled = <span class="keyword">true</span>,   <span class="comment">// enables @PreAuthorize/... etc</span></span><br><span class="line">        securedEnabled = <span class="keyword">true</span>   <span class="comment">// enables @Secure</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then, you can <strong>use the <code>@Secure</code> annotation to a method (on a class or interface), which would then limit the access to that method accordingly</strong>. </p>
<p><strong>Spring Security’s native annotation support defines a set of attributes for the method</strong>. These will be passed to the <code>AccessDecisionManager</code> for it to make the actual decision:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BankService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured</span>(<span class="string">"IS_AUTHENTICATED_ANONYMOUSLY"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">readAccount</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured</span>(<span class="string">"IS_AUTHENTICATED_ANONYMOUSLY"</span>)</span><br><span class="line">    <span class="keyword">public</span> Account[] findAccounts();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured</span>(<span class="string">"ROLE_TELLER"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">post</span><span class="params">(Account account, <span class="keyword">double</span> amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and the equivalent <code>@PreAuthorize()</code> version would be</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BankService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"isAnonymous()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">readAccount</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"isAnonymous()"</span>)</span><br><span class="line">    <span class="keyword">public</span> Account[] findAccounts();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"hasAuthority('ROLE_TELLER')"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">post</span><span class="params">(Account account, <span class="keyword">double</span> amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, as you have guessed, <strong>the <code>@Secured</code> annotation does not support <code>SpEL</code> expressions</strong>.</p>
<h3 id="Domain-Object-Security-ACLs"><a href="#Domain-Object-Security-ACLs" class="headerlink" title="Domain Object Security (ACLs)"></a>Domain Object Security (ACLs)</h3><p>The above access control strategies are straightforward and simple. However, as you might have noticed, if there are more complex access control needs, where <strong>security decisions need to comprise both who (<code>Authentication</code>), where (<code>MethodInvocation</code>), and what (<code>SomeDomainObject</code>)</strong>, then implementing just using the techniques above would be costly.</p>
<p>While solving such needs can be achieved by using the ACLs, it is a topic more related to controlling access rights of large scale businesses. Since this manual aims to cover the basics instead, please visit the official documentation <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#domain-acls" target="_blank" rel="noopener">https://docs.spring.io/spring-security/site/docs/5.3.3.BUILD-SNAPSHOT/reference/html5/#domain-acls</a> for more information on this topic.</p>
<h2 id="Registration-Realizations"><a href="#Registration-Realizations" class="headerlink" title="Registration Realizations"></a>Registration Realizations</h2><p>Now we have covered authentication (login) and authorization (access control). Registration is another important feature for user interaction, and, in fact, its basic implementation is pretty much the same as the <a href="#Basic-Form-Authorization">Basic Form Authorization</a>, in which you need to get data from a <code>POST</code> request, and after some security checks, insert the data into your database.</p>
<p>However, there are some <strong>additional techniques for registration</strong>, which we will also cover in the following section:</p>
<ul>
<li>account activation with email</li>
<li>resend verification email</li>
<li>resetting password</li>
</ul>
<h3 id="Basic-Form-Registration"><a href="#Basic-Form-Registration" class="headerlink" title="Basic Form Registration"></a>Basic Form Registration</h3><p>Alike other sections, we will first cover the basic registration technique with a form. We will also cover some form input verification techniques here.</p>
<hr>
<p><strong>In summary,</strong> we need to:</p>
<ol>
<li><strong>Create a <code>UserDto</code></strong> (User Data Transfer Object), to encapsulate the information we need from the user</li>
<li>Create your <strong>html template,</strong> that contains a form with the necessary input fields<ul>
<li>Note that for the data binding to occur successfully, you need to specify the <code>name=&lt;fieldNameInUserDto&gt;</code> attribute</li>
</ul>
</li>
<li>Create your <strong>controller class</strong>, to return the registration page for <code>GET</code> request, and to get the data for the <code>POST</code> request</li>
<li>Create your <strong>validation logic for the user input</strong><ul>
<li>This can be done various ways. The most straightforward yet cumbersome way would be programming it directly in your code, which is not recommended.</li>
<li>The second way would be <strong>creating custom validation annotations</strong>, which is a clean and scalable approach. This will be covered here.</li>
</ul>
</li>
<li>Once the information gets validated, implement your corresponding mapper and service classes to <strong>insert the data into your database</strong><ul>
<li>At this point, since it is a simple form registration, we do not (yet) implement account activation with email. This will be covered in the next section.</li>
</ul>
</li>
</ol>
<hr>
<p>First, your <code>UserDto</code> object could look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String matchingPassword;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMatchingPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> matchingPassword;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMatchingPassword</span><span class="params">(String matchingPassword)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.matchingPassword = matchingPassword;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where we see that four input fields - <code>username</code>,<code>email</code>,  <code>password</code>, <code>matchingPassword</code> - will be needed. </p>
<p>Therefore, our corresponding <code>html</code> page would look like:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>form<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- the POST request will be sent to /register --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/register"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"utf8"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Notice that the name field has to match the field name in the UserDto for automatica data binding --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>confirm<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"matchingPassword"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- I am afraid that all post request will need this --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"_csrf"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;_csrf&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/login&#125;"</span>&gt;</span>login<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Notice that:</p>
<ul>
<li>Even if there is no <code>formRegister()</code> in the <code>configure()</code> method for Spring Security filters, <strong>all <code>POST</code> request, regardless where it comes from, will need to have a <code>_csrf</code> token</strong> (unless you do <code>csrf().disable()</code>, which is not recommended).  Therefore, in order for this request to be processed correctly, you need to <strong>include the <code>_csrf</code> token</strong>.</li>
</ul>
<p>Therefore, your controller class would look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Register</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HttpServletRequest request;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserServiceImpl userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/register"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showRegistrationForm</span><span class="params">(Map&lt;String, String&gt; map1)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// puts in the _csrf token</span></span><br><span class="line">        map1.put(<span class="string">"_csrf"</span>,((CsrfToken)<span class="keyword">this</span>.request.getAttribute(<span class="string">"_csrf"</span>)).getToken());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"register"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/register"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">registerUserAccount</span><span class="params">(@ModelAttribute UserDto userDto, BindingResult bindingResult)</span></span>&#123;</span><br><span class="line">        <span class="comment">// at this point, we have not implemented the information validations yet</span></span><br><span class="line">        userService.createUser(userDto);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"registration completed"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Notice:</p>
<ul>
<li>We did not use <code>@RequestBody</code>, but <code>@ModelAttribute</code> annotation for data binding the <code>UserDto</code>. This is because (in my setup), using <code>@RequestBody</code> results in an error of <code>MediaType</code> not supported. <strong>This is because <code>POST</code> request sent data in the form of <code>FORM_URLENCODED_VALUE</code>, which is accepted if you use <code>@ModelAttribute</code> for binding, but not recognized if you use <code>@RequestBody</code>, which takes <code>application/json</code> format.</strong></li>
<li>The <code>UserServiceImpl</code> would contain the implementation to <strong>encode the password</strong> (don’t forget to do this!), and then <strong>send data to the database.</strong> This implementation is not shown here since it is trivial.</li>
</ul>
<p>At this point, your registration workflow is already in shape (without input information checks). If you put some data in your <code>html</code> and press submit, data should be sent to your database and a new user would be created.</p>
<p>However, often some sort of validation will be needed to make sure that the user data looks legit before sending and inserting into your database. To do this, we can <strong>create our custom validation annotations</strong> (quick guides for how to create your custom annotations and how they work can be found at <a href="https://dzone.com/articles/creating-custom-annotations-in-java" target="_blank" rel="noopener">https://dzone.com/articles/creating-custom-annotations-in-java</a> and <a href="https://www.baeldung.com/spring-mvc-custom-validator" target="_blank" rel="noopener">https://www.baeldung.com/spring-mvc-custom-validator</a>).</p>
<p>First, you will need to import necessary dependencies, including:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--   These are also necessary somehow for Validators to work     --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.hibernate.validator/hibernate-validator --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.hibernate.validator/hibernate-validator-annotation-processor --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator-annotation-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Yes, dependencies from <code>hibernate</code> are necessary as well.</p>
<p>Now, you can create your own annotation interface:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)	<span class="comment">// specified where this annotation can be applied</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)	<span class="comment">// when it will be enacted</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = CustEmailValidator<span class="class">.<span class="keyword">class</span>)	// <span class="title">how</span> <span class="title">it</span> <span class="title">will</span> <span class="title">validate</span> <span class="title">the</span> <span class="title">target</span> (<span class="title">a</span> <span class="title">field</span> <span class="title">in</span> <span class="title">this</span> <span class="title">case</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">CustEmailValidation</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "Invalid email"</span>;	<span class="comment">// this is the most common method to have. It means that if there is an error, your error message can be get from the method message().</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// these are here just to comply with the standard, most of the time they will not be used</span></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since we specified <code>@Constraint(validatedBy = CustEmailValidator.class)</code>, we need to of course implement the validation logic with another class <code>CustEmailValidator</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustEmailValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">CustEmailValidation</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// your validation logic here</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// our logic here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// some initialization logic on when this wrapper object is created</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CustEmailValidation constraintAnnotation)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li><p>You can <strong>imagine this annotations as wrappers around your target</strong>: they wrap around your target to access its data, so that they could verify it</p>
</li>
<li><p>You need to implement the <code>ConstraintValidator&lt;AnnotationName, EnactedFieldType&gt;</code></p>
<ul>
<li>Since this annotation is called <code>CustEmailValidator</code>, the <code>AnnotationName</code> is <code>CustEmailValidator</code></li>
<li>Since the target you will wrap around will be <code>String email</code>, which is of type <code>String</code>, your <code>EnactedFieldType</code> will be <code>String</code></li>
</ul>
</li>
<li><p>The <code>isValid()</code> method will have the first argument a reference to your target object, in this case, <code>String s</code> will hold the data of the <code>String email</code>. Of course it has to be like this so that we could use this data to verify if it is legit.</p>
</li>
</ul>
<p>Now, you could apply your custom annotation to your <code>UserDto</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String matchingPassword;</span><br><span class="line">    <span class="comment">// @CustEmailValidation("Hello") will make the message() method return "Hello" instead of "Invalid Email"</span></span><br><span class="line">    <span class="meta">@CustEmailValidation</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMatchingPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> matchingPassword;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMatchingPassword</span><span class="params">(String matchingPassword)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.matchingPassword = matchingPassword;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above verifies the email field, you should also apply verification on other fields if needed, as well as implementing a way of checking whether if the email address has already been taken :).</p>
<p>And, finally, to <strong>fetch the error messages if an error occur</strong>, you can do:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/register"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">registerUserAccount</span><span class="params">(@Valid UserDto userDto, BindingResult bindingResult)</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * One way to get the errors</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">    Validator validator = factory.getValidator();</span><br><span class="line">    Set&lt;ConstraintViolation&lt;UserDto&gt;&gt; violations = validator.validate(userDto);</span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;UserDto&gt; violation : violations) &#123;</span><br><span class="line">        System.out.println(violation.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The second way</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span>(ObjectError error: bindingResult.getAllErrors())&#123;</span><br><span class="line">            System.out.println(error.getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        userService.createUser(userDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"registration completed"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Account-Verification-with-Email"><a href="#Account-Verification-with-Email" class="headerlink" title="Account Verification with Email"></a>Account Verification with Email</h3><p>Again, the idea is simple: once the user submitted the registration form above,  you need to generate <strong>a unique <code>UUID</code> and that registered <code>username</code> pair</strong> to be stored somewhere. Then, you can <strong>send an email to the user’s registered email with <code>someURL/confirmRegistration?token=&lt;thatUUID&gt;</code></strong>. Lastly, you create a controller to map to that request, extract the <code>UUID</code>: if that <code>UUID</code> exists in your storage, you set the <code>enabled</code> status of the user to true (in the below implementation, it sets the SQL <code>enabled</code> entry to <code>1</code>), else, return <code>&quot;link invalid&quot;</code> or equivalent.</p>
<p>Now, detailed implementations for the above may vary, and my implementation will be:</p>
<hr>
<p><strong>In summary,</strong> you will need to:</p>
<ol>
<li><strong>Create a custom <code>ApplicationEvent</code></strong> (I called it <code>OnRegistrationCompleteEvent</code>) once the user has submitted the form successfully<ul>
<li>Another way to do this would be directly program the implementation of setting up the <code>UUID</code> and etc. in a method directly evoked by the controller. While this would also work, the way above shows you another common approach and teaches you how to publish/catch custom events.</li>
</ul>
</li>
<li><strong>Create a custom <code>ApplicationListener</code></strong> that listens to the above event you published. In that listener, you configure your <code>UUID</code> and <code>username</code> pair generation/storage and email sending mechanism<ul>
<li>Of course, to setup the above, we need some additional simple objects</li>
<li>Detailed email setup can be found at <a href="https://www.baeldung.com/spring-email" target="_blank" rel="noopener">https://www.baeldung.com/spring-email</a></li>
</ul>
</li>
<li><strong>Create a class that stores the UUID and <code>username</code> to activate pair</strong>, such as <code>MyVerificationToken</code></li>
<li><strong>Update your <code>controller</code> that maps to <code>POST</code> request for registration</strong>, so that it includes the ability to initialize the token and publish the event you created in step 1</li>
<li><strong>Update your database table</strong> to have the field <code>enabled</code>, to indicate whether if the account has been activated. You should also <strong>update your <code>UserDetailsService</code></strong> <strong>and <code>UserDetailsImpl</code></strong> to reflect the <code>enabled</code> field status</li>
<li><strong>Create corresponding <code>service</code></strong> classes, to set/update the <code>enabled</code> field for a user</li>
<li><strong>Create corresponding <code>service</code> classes</strong>, to store and look up <code>UUID</code> and <code>username</code> pair in that <code>MyVerficationToken</code><ul>
<li>Here I used <code>redis</code> for storing the pair. It is convenient to me because I can also setup an expiration time easily</li>
</ul>
</li>
<li><strong>Create your <code>GET</code> controller for that <code>confirmRegistration?token=</code> link,</strong> which uses the above services above to check and update the <code>enabled</code> status of a user<ul>
<li><strong><em>Don’t forget to configure your Spring Security to allow unauthenticated users to access this URL!</em></strong></li>
</ul>
</li>
<li>OPTIONALLY, you can also <strong>setup a listener for the built-in  <code>AuthenticationFailureDisabledEvent</code>, which will be published if a user tries to login to an account that has not been activated</strong>. This is briefly shown in the end, and you can of course customize your code on top of that.</li>
</ol>
<hr>
<p>For example, first you create your custom <code>ApplicationEvent</code> object to store the necessary information you will later need to process:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Custom event, which will be sent by event published as an object</span></span><br><span class="line"><span class="comment"> * Information contained in this event object can be used to process later on</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnRegistrationCompleteEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Locale locale;</span><br><span class="line">    <span class="keyword">private</span> String appURL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnRegistrationCompleteEvent</span><span class="params">(MyVerificationToken verificationToken, Locale locale, String appURL)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(verificationToken);    <span class="comment">// whatever I set here can be fetched by getSource()</span></span><br><span class="line">        <span class="keyword">this</span>.username = verificationToken.getUsername();</span><br><span class="line">        <span class="keyword">this</span>.locale = locale;</span><br><span class="line">        <span class="keyword">this</span>.appURL = appURL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Locale <span class="title">getLocale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> locale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.locale = locale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppURL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> appURL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppURL</span><span class="params">(String appURL)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.appURL = appURL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, you setup the corresponding listener:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationCompleteListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">OnRegistrationCompleteEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserRegistrationService registrationService;</span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    JavaMailSender javaMailSender;    // <span class="doctag">TODO:</span> implement email sending later</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(OnRegistrationCompleteEvent onRegistrationCompleteEvent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.confirmRegistration(onRegistrationCompleteEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// all your resgistration confirmation logic goes here</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">confirmRegistration</span><span class="params">(OnRegistrationCompleteEvent event)</span></span>&#123;</span><br><span class="line">        MyVerificationToken verificationToken = (MyVerificationToken) event.getSource();</span><br><span class="line">        registrationService.createUserConfirmation(verificationToken.getUsername(),</span><br><span class="line">                verificationToken.getToken(),</span><br><span class="line">                MyVerificationToken.getEXPIRATION());</span><br><span class="line"></span><br><span class="line">        String confirmURL = event.getAppURL() + <span class="string">"/confirmRegistration?token="</span>+verificationToken.getToken();</span><br><span class="line">        System.out.println(confirmURL); <span class="comment">// <span class="doctag">TODO:</span> implement email sending here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>where:</p>
<ul>
<li>For the listener to work in the context, you need to inject it into the container with <code>@Component</code></li>
<li>Email sending mechanism is not shown here, but can be setup easily if you follow the guide at: <a href="https://www.baeldung.com/spring-email" target="_blank" rel="noopener">https://www.baeldung.com/spring-email</a></li>
</ul>
<p>You see that the above two uses the <code>MyVerificationToken</code> object to fetch the information for the UUID and the <code>username</code>, so below is the <code>MyVerificationToken</code> class (you can see it as a DTO):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyVerificationToken</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXPIRATION = <span class="number">3600</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">// make sure the token is not changed once created</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String token;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyVerificationToken</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.token = UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getEXPIRATION</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EXPIRATION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, the basic event handling has been setup, but for it to work, the event has to be published somewhere. And this is done right after the registration has been successful:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/register"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span>   <span class="comment">// using @RequestBody could throw MediaType not supported error</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">registerUserAccount</span><span class="params">(@Valid UserDto userDto, BindingResult bindingResult)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span>(ObjectError error: bindingResult.getAllErrors())&#123;</span><br><span class="line">            System.out.println(error.getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  <span class="comment">// <span class="doctag">TODO:</span> add logic to ensure user does not already exist</span></span><br><span class="line">        userService.createUser(userDto);</span><br><span class="line">        <span class="comment">// publishes the event</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> OnRegistrationCompleteEvent(<span class="keyword">new</span> MyVerificationToken(userDto.getUsername()),</span><br><span class="line">                                                                               request.getLocale(), request.getContextPath()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"registration completed"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After that, it is just some clean up for your previous code. For example, you need to also add the field <code>enabled</code>, which I configured it to use <code>TINYINT(1)</code>, where <code>1</code> would mean <code>true</code> and <code>0</code> would be <code>false</code>. I also set it to be <code>0</code> by default.</p>
<p>Your updated <code>UserDetailsService</code> could look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">(String username)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = Integer.parseInt(userMapper.getEnabled(username));</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(NumberFormatException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;   <span class="comment">// user not found</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setEnabled</span><span class="params">(String username)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getId(username) == -<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// user does not exist</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        userMapper.updateEnabled(username, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and your <code>UserDetailsImpl</code> which is used by Spring Security to check account authentication will look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.isEnabled(<span class="keyword">this</span>.username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you are interested, below is how I set up (in a simple way) the storage/look up service for the <code>UUID</code>/<code>username</code> pair.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRegistrationService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a key-value pair in redis to control UUID confirmations</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username  user to activate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> UUID  generated UUID for that user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secondsToExpire   time for the UUID to expire</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  creation status</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">createUserConfirmation</span><span class="params">(String username, String UUID, <span class="keyword">int</span> secondsToExpire)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(redisTemplate.opsForValue().get(UUID) != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;   <span class="comment">// user already registered/email already sent</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            redisTemplate.opsForValue().set(UUID, username, secondsToExpire, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the user to activate for that UUID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> UUID the UUID for that user to activate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  the username, null if UUID not found</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">activateUser</span><span class="params">(String UUID)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().get(UUID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lastly, your <code>controller</code> for confirming the link that is sent could look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/confirmRegistration"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">confirmRegistration</span><span class="params">(@RequestParam String token)</span></span>&#123;</span><br><span class="line">    String username;</span><br><span class="line">    <span class="keyword">if</span>((username = userRegistrationService.activateUser(token)) == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"user activation not found"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        userService.setEnabled(username);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"registration successful"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Optionally, the listener for that built-in <code>AuthenticationFailureDisabledEvent</code> would look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Used for accounts that are not yet enabled</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDisabledListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">AuthenticationFailureDisabledEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(AuthenticationFailureDisabledEvent authenticationFailureDisabledEvent)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Account disabled"</span>);</span><br><span class="line">        <span class="comment">// your logic here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OAuth2-0-Realizations"><a href="#OAuth2-0-Realizations" class="headerlink" title="OAuth2.0 Realizations"></a>OAuth2.0 Realizations</h2><p>Basically, you need to accomplish two things:</p>
<ul>
<li>obtain OAuth APIs and get necessary user information</li>
<li>configure your Spring Security, so that it authenticates users based on OAuth Login<ul>
<li>this comes in two flavors. For OAuth2.0 API flow that is supported by Spring Security, it can be implemented easily</li>
<li>you can also manually implement the authentication flow, which will be discussed in the following</li>
</ul>
</li>
</ul>
<blockquote>
<p> In summary, you need to <strong>do the following steps</strong>:</p>
<ol>
<li>Create the class <code>CustomAuthenticationProvider implements AuthenticationProvider</code>, and override the <code>public Authentication authenticate(Authentication authentication) throws AuthenticationException</code> method</li>
<li>Configure Spring Security with <code>configure(AuthenticationManagerBuilder auth)</code>, in order to add the above authentication provider into the list of authentication providers used for security checking.</li>
</ol>
</blockquote>
<ol>
<li><p>First, you will need to have a class that does the follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;  <span class="comment">// extends AbstractUserDetailsAuthenticationProvider</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String username = (String) authentication.getPrincipal();</span><br><span class="line">        <span class="comment">// use the request to get extra parameters you need, otherthan the default username/password</span></span><br><span class="line">        String verificationType = request.getParameter(<span class="string">"verificationType"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldAuthenticateAgainstThirdPartySystem(verificationType)) &#123;</span><br><span class="line">            <span class="comment">// use the credentials</span></span><br><span class="line">            <span class="comment">// and authenticate against the third-party system</span></span><br><span class="line">            <span class="comment">// ..</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(successful)&#123;</span><br><span class="line">                <span class="comment">// returning with Authorities automatically sets authentication to success</span></span><br><span class="line">                MyUserDetails userDetails = <span class="keyword">new</span> MyUserDetails(username, userService, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(mappedUsername, password, userDetails.getAuthorities());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UserNotFoundException(<span class="string">"Third Party Authentication Failed"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// let the DaoAuthenticationProvider handle it</span></span><br><span class="line">            <span class="comment">// here I have my own version of the DaoAuthenticationProvider. You could also use the Spring provided one.</span></span><br><span class="line">            DaoAuthenticationProvider provider = <span class="keyword">new</span> MyDaoAuthProvider();</span><br><span class="line">            provider.setPasswordEncoder(bCryptPasswordEncoder()); <span class="comment">// by default, this is null</span></span><br><span class="line">            provider.setUserDetailsService(userDetailsService()); <span class="comment">// by default, this is null</span></span><br><span class="line">            <span class="keyword">return</span> provider.authenticate(authentication);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this intercepts at the stage of username-password authentication (among the chain of authenticators)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authentication.equals(UsernamePasswordAuthenticationToken<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldAuthenticateAgainstThirdPartySystem</span><span class="params">(String verType)</span> <span class="keyword">throws</span> UserNotFoundException</span>&#123;</span><br><span class="line">        <span class="comment">// shouldAuthenticateAgainstThirdParty?</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Notes:</strong></p>
<ul>
<li>basically, the <code>authenticate()</code> method does the job of <strong>authenticating the user</strong></li>
</ul>
</li>
<li><p>Now, to add the above into the list of authenticators, do:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebFiltersConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//..</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Use my authentication provider, so that I could intercept for thirdparty user logins</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomAuthenticationProvider <span class="title">authProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomAuthenticationProvider();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add the providers into the manager</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> </span>&#123;</span><br><span class="line">        auth.authenticationProvider(authProvider());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// other customized settings</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Mechanism-Behind-the-Above-Implementation"><a href="#Mechanism-Behind-the-Above-Implementation" class="headerlink" title="Mechanism Behind the Above Implementation"></a>Mechanism Behind the Above Implementation</h3><p>In short, this is what happens:</p>
<ol>
<li>Spring Security gets the authentication request, and go to the <strong>class <code>ProviderManager</code> to call <code>authenticate</code>.</strong></li>
<li>The above step will <strong>get a list of authentication providers</strong>, and iterate through them with <code>Iterator var8 = this.getProviders().iterator();</code>, calling <code>authenticate</code> method for each <code>AuthenticationProvider</code>.<ul>
<li>e.g. the <code>DaoAuthenticationProvider</code> and the <code>CustomAuthenticationProvider</code> you implemented above</li>
</ul>
</li>
<li>If the <strong>certain provider returned <code>null</code>, then Spring checks if there is a <code>parent</code></strong> of that <code>AuthenticationProvider</code>.<ul>
<li>in this case, the <code>CustomAuthenticationProvider</code> is standalone. Hence whatever you returned there will be the final returned result.</li>
</ul>
</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/learning/2020/07/13/Angular-Manual/" rel="prev" title="Angular Manual">
      <i class="fa fa-chevron-left"></i> Angular Manual
    </a></div>
      <div class="post-nav-item">
    <a href="/learning/2020/11/16/JavaScript-Summary/" rel="next" title="JavaScript Summary">
      JavaScript Summary <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiao Yu</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/learning/lib/anime.min.js"></script>
  <script src="/learning/lib/velocity/velocity.min.js"></script>
  <script src="/learning/lib/velocity/velocity.ui.min.js"></script>

<script src="/learning/js/utils.js"></script>

<script src="/learning/js/motion.js"></script>


<script src="/learning/js/next-boot.js"></script>


  















  

  

</body>
</html>
